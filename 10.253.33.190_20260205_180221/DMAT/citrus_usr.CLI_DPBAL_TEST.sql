-- Object: PROCEDURE citrus_usr.CLI_DPBAL_TEST
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------


CREATE PROC [CITRUS_USR].[CLI_DPBAL_TEST] (@CLTCODE VARCHAR(10))   
AS   



SELECT DISTINCT *,RIGHT(CONVERT(VARCHAR(11),[NEXT AMC DT],113),9) AS MONTH_YEAR INTO #NISE_PARTY FROM (  
SELECT  DPAM_SBA_NO AS CLIENT_CODE ,DPAM_BBO_CODE AS NISE_PARTY_CODE , BROM_DESC,  
CONVERT(DATETIME, CASE WHEN ISNULL(ACCP_VALUE,'')  = '' THEN SUBSTRING(BOACTDT,5,4)+'-'+SUBSTRING(BOACTDT,3,2)+'-'+SUBSTRING(BOACTDT,1,2)+' 00:00:00.000'   
ELSE ISNULL(ACCP_VALUE,'') END) [AMC DATE]  , CHAM_CHARGE_VALUE AS AMC_CHARGE
,CITRUS_USR.FN_GET_NEXTAMC(CONVERT(DATETIME,CONVERT(DATETIME, CASE WHEN ISNULL(ACCP_VALUE,'')  = '' THEN SUBSTRING(BOACTDT,5,4)+'-'+SUBSTRING(BOACTDT,3,2)+'-'+SUBSTRING(BOACTDT,1,2)+' 00:00:00.000'   
ELSE ISNULL(ACCP_VALUE,'') END)),CHAM_CHARGE_TYPE,CHAM_BILL_INTERVAL)[NEXT AMC DT]  
FROM DPS8_PC1 (NOLOCK), DP_ACCT_MSTR (NOLOCK) LEFT OUTER JOIN ACCOUNT_PROPERTIES (NOLOCK) ON ACCP_CLISBA_ID = DPAM_ID AND ACCP_ACCPM_PROP_CD = 'AMC_DT'   
,  CLIENT_DP_BRKG (NOLOCK) , BROKERAGE_MSTR (NOLOCK) , CHARGE_MSTR (NOLOCK) ,PROFILE_CHARGES  (NOLOCK) 
WHERE BOID = DPAM_SBA_NO AND DPAM_ID = CLIDB_DPAM_ID AND CLIDB_BROM_ID = BROM_ID   
AND CHAM_SLAB_NO = PROC_SLAB_NO AND PROC_PROFILE_ID = CLIDB_BROM_ID AND PROC_PROFILE_ID = BROM_ID   
AND GETDATE() BETWEEN CLIDB_EFF_FROM_DT AND CLIDB_EFF_TO_DT   
AND CHAM_CHARGE_TYPE IN ('F','AMCPRO')  
AND DPAM_DELETED_IND = '1' AND CLIDB_DELETED_IND = '1'   
AND BROM_DELETED_IND = '1' AND CHAM_DELETED_IND = '1'  
AND PROC_DELETED_IND = '1'  
AND DPAM_SBA_NO LIKE '120%'  
AND DPAM_STAM_CD = 'ACTIVE' )A  
WHERE NISE_PARTY_CODE =@CLTCODE

SELECT *,DATEADD(YEAR, +1,  [AMC DATE]) ACTUAL_AMC  INTO #TEMP FROM #NISE_PARTY

SELECT T.NISE_PARTY_CODE PARTY_CODE,T.CLIENT_CODE,ISNULL(AMC_CHARGE,0) AS AMC_DUE,
--ISNULL([NEXT AMC DT],'') 
(CASE WHEN [NEXT AMC DT] <=ACTUAL_AMC THEN ACTUAL_AMC ELSE [NEXT AMC DT] END ) AS AMCDATE,
ISNULL(ACTUAL_AMOUNT,'0') AS DP_LEDGER,   
ISNULL(ACCRUAL_BAL,0) ACCRUAL_BAL   
FROM  TBL_CLIENT_MASTER T
LEFT OUTER JOIN   #TEMP  S ON T.CLIENT_CODE =S.CLIENT_CODE
LEFT OUTER JOIN   CITRUS_USR.VW_ACC_CURR_BAL   V  ON T.CLIENT_CODE= V.CLIENT_CODE    
WHERE T.NISE_PARTY_CODE = @CLTCODE


 
--UNION  
--SELECT 'J45628','J45628','0' AS AMC_DUE,'NA' AS AMCDATE,0 AS DP_LEDGER,   
--'0'  
      
      
    --CLI_DPBAL 'RP61'

GO
