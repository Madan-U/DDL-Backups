-- Object: PROCEDURE citrus_usr.CLASS_AUTO_PROCESS_SETUP
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

      
CREATE PROC [citrus_usr].[CLASS_AUTO_PROCESS_SETUP]      
(      
 @BUSINESS_DATE VARCHAR(11)      
)      
AS      
      
DECLARE @PROCESSCURSOR CURSOR,      
  @SETT_NO  VARCHAR(7),       
  @SETT_TYPE  VARCHAR(2),      
  @NEWPROCESS_ID INT      
      
      
SELECT @NEWPROCESS_ID = MAX(PROCESS_ID)       
FROM   TBL_AUTO_PROCESS_MASTER      
      
CREATE TABLE #MASTER_SETUP      
(      
 [PROCESS_ID]  [INT] ,      
 [SETT_NO]   [VARCHAR](20) ,      
 [SETT_TYPE]   [VARCHAR](20) ,      
 [PROCESS_FOR]  [VARCHAR](30) ,      
 [IS_DEPEND_ON]  [VARCHAR](20) ,      
 [NEWPROCESS_ID]  [INT]  ,      
 [BUSINESS_DATE]  [VARCHAR](11)  ,      
 [PROCESS_START_DATE][DATETIME] ,      
 [PROCESS_END_DATE] [DATETIME]       
)      
      
 INSERT INTO #MASTER_SETUP      
 SELECT PROCESS_ID, SETT_NO, SETT_TYPE,       
     PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,      
     BUSINESS_DATE = @BUSINESS_DATE,      
     PROCESS_START_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME),      
     PROCESS_END_DATE=CONVERT(DATETIME,LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME)       
 FROM TBL_AUTO_PROCESS_MASTER T      
 WHERE PROCESS_TYPE = 'DAILY TRX' --'TRADE'      
 AND PROCESS_FREQ = 'ONCE'      
 ORDER BY 1      
      
      
DECLARE @PROCESS_ID     INT,      
  @STARTDATE     DATETIME,      
  @ENDDATE     DATETIME,      
  @PROCESS_REPEAT_INTERVAL INT,      
  @PROCESS_CURSOR    CURSOR,      
  @TEMPPROCESS_ID    INT,      
  @NEWSTARTDATE    DATETIME,      
  @NEWENDDATE     DATETIME      
      
      
CREATE TABLE #DATA      
(      
 PROCESS_ID INT,      
 STARTDATE DATETIME,      
 ENDDATE  DATETIME      
)      
      
SET @PROCESS_CURSOR = CURSOR FOR      
SELECT PROCESS_ID,      
    STARTDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,       
    ENDDATE = LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,      
    PROCESS_REPEAT_INTERVAL      
FROM TBL_AUTO_PROCESS_MASTER      
WHERE PROCESS_FREQ = 'MULTIPLE'      
ORDER BY PROCESS_ID      
OPEN @PROCESS_CURSOR      
FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL      
WHILE @@FETCH_STATUS = 0      
BEGIN      
 SET @TEMPPROCESS_ID = @PROCESS_ID      
 SET @NEWSTARTDATE = @STARTDATE      
 WHILE @NEWSTARTDATE < @ENDDATE AND @@FETCH_STATUS = 0      
 BEGIN       
  SET @NEWENDDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)      
  IF @NEWENDDATE > @ENDDATE      
  BEGIN      
   SET @NEWENDDATE = @ENDDATE      
  END      
  INSERT INTO #DATA VALUES (@PROCESS_ID, @NEWSTARTDATE, @NEWENDDATE)      
  SET @NEWSTARTDATE = DATEADD(MI,@PROCESS_REPEAT_INTERVAL,@NEWSTARTDATE)      
 END      
 FETCH NEXT FROM @PROCESS_CURSOR INTO @PROCESS_ID, @STARTDATE, @ENDDATE, @PROCESS_REPEAT_INTERVAL      
END      
CLOSE @PROCESS_CURSOR      
DEALLOCATE @PROCESS_CURSOR      
      
INSERT INTO #MASTER_SETUP      
SELECT M.PROCESS_ID, M.SETT_NO, M.SETT_TYPE,       
    PROCESS_FOR, IS_DEPEND_ON, NEWPROCESS_ID = 0,      
    BUSINESS_DATE = @BUSINESS_DATE,      
    PROCESS_START_DATE=STARTDATE,      
    PROCESS_END_DATE=ENDDATE      
    FROM TBL_AUTO_PROCESS_MASTER M, #DATA D      
WHERE M.PROCESS_ID = D.PROCESS_ID      
      
TRUNCATE TABLE #DATA      
DROP TABLE #DATA      
      
ALTER TABLE #MASTER_SETUP      
ADD SNO INT IDENTITY(1,1)      
      
UPDATE #MASTER_SETUP SET NEWPROCESS_ID = @NEWPROCESS_ID + SNO      
    
DECLARE @INTLOOP INT      
DECLARE @INTLOOP_MAX INT      
SET @INTLOOP = 1      
SELECT @INTLOOP_MAX =MAX(LEN(IS_DEPEND_ON)-LEN(REPLACE(IS_DEPEND_ON,'#',''))) FROM #MASTER_SETUP      
      
WHILE @INTLOOP <= @INTLOOP_MAX      
BEGIN      
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON = REPLACE(#MASTER_SETUP.IS_DEPEND_ON,'#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',')      
 FROM #MASTER_SETUP M1, #MASTER_SETUP      
 WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'      
 AND #MASTER_SETUP.SETT_NO = M1.SETT_NO      
 AND #MASTER_SETUP.SETT_TYPE = M1.SETT_TYPE      
 AND M1.PROCESS_START_DATE <= #MASTER_SETUP.PROCESS_START_DATE      
 AND #MASTER_SETUP.PROCESS_START_DATE = (SELECT MIN(PROCESS_START_DATE) FROM #MASTER_SETUP M2      
            WHERE M1.PROCESS_ID = M2.PROCESS_ID      
            AND M1.PROCESS_START_DATE <= M2.PROCESS_START_DATE)      
 SET @INTLOOP = @INTLOOP + 1      
END      
      
ALTER TABLE #MASTER_SETUP      
ADD IS_DEPEND_ON_ORG_TEMP VARCHAR(500)      
      
UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP = IS_DEPEND_ON    
      
SELECT @INTLOOP = MIN(NEWPROCESS_ID)  FROM #MASTER_SETUP      
SELECT @INTLOOP_MAX =MAX(NEWPROCESS_ID) FROM #MASTER_SETUP      
      
WHILE @INTLOOP <= @INTLOOP_MAX      
BEGIN      
 UPDATE #MASTER_SETUP SET IS_DEPEND_ON_ORG_TEMP =     
 REPLACE(#MASTER_SETUP.IS_DEPEND_ON_ORG_TEMP + '#' + CONVERT(VARCHAR,M1.NEWPROCESS_ID) + ',',    
 '#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',','')        
 FROM #MASTER_SETUP M1, #MASTER_SETUP      
 WHERE #MASTER_SETUP.IS_DEPEND_ON LIKE '%#' + CONVERT(VARCHAR,M1.PROCESS_ID) + ',%'      
 AND M1.NEWPROCESS_ID = @INTLOOP       
      
 SET @INTLOOP = @INTLOOP + 1      
END        
    
UPDATE #MASTER_SETUP SET IS_DEPEND_ON = IS_DEPEND_ON_ORG_TEMP      
WHERE IS_DEPEND_ON_ORG_TEMP <> ''      
      
DELETE TBL_AUTO_PROCESS_DETAIL      
WHERE PROCESS_DATE = LEFT(GETDATE(),11)      
      
INSERT INTO TBL_AUTO_PROCESS_DETAIL      
SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,@BUSINESS_DATE),      
    EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,      
    SETT_NO,      
    SETT_TYPE,      
    INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,      
    PROCESS_START_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_START_TIME,PROCESS_STARTED_DATE='',      
    PROCESS_END_DATE=LEFT(GETDATE(),11) + ' ' + PROCESS_END_TIME,PROCESS_ENDED_DATE='',      
    PROCESS_FILE_NAME,IS_DEPEND_ON,IS_DEPEND_ON,WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,      
    PROCESS_HALTED_AT=0,PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT,       
    PROCESS_STATUS_ALERT_COUNT=0, PROCESS_STATUS_ALERT_INTERVAL, '',      
    PROCESS_OUTPUT_QUERY,'', PROCESS_ORDER_ID      
FROM TBL_AUTO_PROCESS_MASTER      
WHERE PROCESS_ID NOT IN (SELECT PROCESS_ID FROM #MASTER_SETUP)      
AND SETT_NO <> '<SETNO>'  --and process_for in ('CD01','CD02')    
    
--in  (    
--'DP57900',    
--'DP57904',    
--'DP57907',    
--'DP57909',    
--'DP57910',    
--'DP57919',    
--'DP57924',    
--'DP57926','DUMP')    
      
INSERT INTO TBL_AUTO_PROCESS_DETAIL      
SELECT PROCESS_DATE=LEFT(GETDATE(),11),BUSINESS_DATE=CONVERT(DATETIME,S.BUSINESS_DATE),      
    EXCHANGE,SEGMENT,M.PROCESS_TYPE,M.PROCESS_FOR,S.NEWPROCESS_ID,      
    S.SETT_NO,      
    S.SETT_TYPE,      
    INTERNAL_PROCESS_ID,SUB_PROCESS_ID=0,      
    S.PROCESS_START_DATE,PROCESS_STARTED_DATE='',S.PROCESS_END_DATE,      
    PROCESS_ENDED_DATE='',PROCESS_FILE_NAME,S.IS_DEPEND_ON,S.IS_DEPEND_ON,      
    WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS=0,PROCESS_HALTED_AT=0,      
    PROCESS_HALTED_REASON='',PROCESS_STATUS_ALERT, PROCESS_STATUS_ALERT_COUNT=0,       
    PROCESS_STATUS_ALERT_INTERVAL, '',      
    PROCESS_OUTPUT_QUERY,'', PROCESS_ORDER_ID      
FROM TBL_AUTO_PROCESS_MASTER M, #MASTER_SETUP S      
WHERE M.PROCESS_ID = S.PROCESS_ID      
AND S.SETT_NO <> '<SETNO>'      
      
TRUNCATE TABLE #MASTER_SETUP      
DROP TABLE #MASTER_SETUP      
      
/*      
SET @PROCESSCURSOR = CURSOR FOR      
 SELECT SETT_NO, SETT_TYPE FROM SETT_MST WHERE START_DATE = @BUSINESS_DATE      
 AND SETT_TYPE NOT IN ('O', 'Z')      
 AND RIGHT(SETT_NO,3) > (CASE WHEN SETT_TYPE = 'P' THEN 500 ELSE 0 END)      
 ORDER BY SETT_NO, SETT_TYPE      
OPEN @PROCESSCURSOR      
FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE      
WHILE @@FETCH_STATUS = 0      
BEGIN      
 SELECT @SETT_NO, @SETT_TYPE      
 FETCH NEXT FROM @PROCESSCURSOR INTO @SETT_NO, @SETT_TYPE      
END      
CLOSE @PROCESSCURSOR      
DEALLOCATE @PROCESSCURSOR      
*/

GO
