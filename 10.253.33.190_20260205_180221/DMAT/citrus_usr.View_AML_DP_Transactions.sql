-- Object: VIEW citrus_usr.View_AML_DP_Transactions
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

CREATE View [citrus_usr].[View_AML_DP_Transactions]  
As
SELECT   'CDSL' DEPOSITORY                                                                                                                  
,LEFT(CDSHM_BEN_ACCT_NO,8)  DPID  
,CDSHM_BEN_ACCT_NO BOID  
,CDSHM_ISIN ISINCODE  
,ISIN_NAME [CONAME(SCRIP NAME)]  
,CDSHM_QTY QTY  
,'' CLEARINGCORP  
,LEFT(CDSHM_COUNTER_BOID,8) COUNTERDPID  
,CDSHM_COUNTER_BOID COUNTERBOID  
,'' TRANSACTIONREF  
,CDSHM_TRATM_DESC DESCRIPTION  
,CDSHM_TRATM_CD CATEGORY  
,CDSHM_CDAS_TRAS_TYPE ACTYPECODE  
,'' BALANCETYPE  
,CASE WHEN CDSHM_CDAS_TRAS_TYPE IN ('2') THEN 'OFF MARKET'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('8') THEN 'PLEDGE'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('8') THEN 'UN PLEDGE'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('20') THEN 'IPO CREDIT'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('601') THEN 'DEMAT'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('608') THEN 'DEMAT REJ'  
  WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('701') THEN 'REMAT'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('703') THEN 'REMAT REJ'  
  WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('305') THEN 'EXTERNAL' END  
 BOOKINGCODE  
,CASE WHEN CDSHM_CDAS_TRAS_TYPE IN ('2') THEN 'OFF MARKET'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('8') THEN 'PLEDGE'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('8') THEN 'UN PLEDGE EXTERNAL'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('20') THEN 'IPO CREDIT'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('601') THEN 'DEMAT REQUEST'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('608') THEN 'DEMAT REJECTION / CANCELLATION'  
  WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('701') THEN 'REMAT 1201090000004621'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('703') THEN 'REMAT CANCELLATION / REJECTION'  
  WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('305') THEN 'ON MARKET EXTERNAL TRANSACTIONS' END  
   BOOKINGDESC  
,CDSHM_CDAS_TRAS_TYPE BOOKINGTYPE  
,CDSHM_SETT_TYPE MARKETTYPE  
,CDSHM_SETT_NO SETTLEMENTNO  
,'' BLOCKED  
,'' BLOCKEDCODE  
,'' RELEASEDATE  
, CONVERT(VARCHAR(10),CDSHM_TRAS_DT ,105) TRNDATE  
, CONVERT(VARCHAR(8),CDSHM_TRAS_DT ,108)  TRNTIME  
,CASE WHEN CDSHM_QTY < 0 THEN 'D' ELSE 'C' END  DEBITCREDIT  
,CDSHM_COUNTER_CMBPID COUNTERCMPBID  
,ISNULL(DPTDC_RMKS,'') REMARKS  
,ISNULL(DPTDC_SLIP_NO ,'') DISSLIPNO  
,'' DISREASON  
--,ISNULL(CLOPM_CDSL_RT,0) CLOSINGRT  
 --,citrus_usr.fn_get_clopm_rt(cdshm_isin,cdshm_tras_dt) CLOSINGRT
,0 CLOSINGRT
FROM CDSL_HOLDING_DTLS WITH (NOLOCK)  
LEFT OUTER JOIN DP_TRX_DTLS_CDSL WITH (NOLOCK) ON DPTDC_TRANS_NO = CDSHM_TRANS_NO AND DPTDC_DPAM_ID = CDSHM_DPAM_ID AND DPTDC_ISIN = CDSHM_ISIN AND DPTDC_QTY = CDSHM_QTY   
--LEFT OUTER JOIN CLOSING_PRICE_MSTR_CDSL WITH (NOLOCK) ON CLOPM_ISIN_CD = CDSHM_ISIN AND CLOPM_DT = CDSHM_TRAS_DT   
LEFT OUTER JOIN ISIN_MSTR WITH (NOLOCK) ON ISIN_CD = CDSHM_ISIN  
WHERE CDSHM_TRAS_DT> ='2012-10-01'   
AND CDSHM_TRATM_CD  in('2246','2277','2280','2201','3102','2270','2220','2262')     
AND (CDSHM_BEN_ACCT_NO NOT IN ('1201090000000101'  
,'1201090000000116'  
,'1201090000003024'  
,'1201090000007179'  
,'1201090000008723'  
,'1201090000011183'  
,'1201090000050928'  
,'1201090000252513'  
,'1201090000252528'  
,'1201090000268346'  
,'1201090000287399'  
,'1201090000702981'  
,'1201090000985991'  
,'1201090001101173'  
,'1201090001320629'  
,'1201090001465454'  
,'1201090001473896'  
,'1201090001478972'  
,'1201090001489150'  
,'1201090001705494'  
,'1201090001730035'  
,'1201090001730041'  
,'1201090001730054'  
,'1201090002827983'  
,'1201090002827998'  
,'1201090002828005'  
,'1201090002850297'  
,'1201090002955579'  
,'1201090003197552'  
,'1201090003220399'  
,'1201090003477021'  
,'1201090003484018'  
,'1201090003586755'  
,'1201090003586761'  
,'1201090003586793'  
,'1201090003586801'  
,'1201090003586814'  
,'1201090003677061'  
,'1201090004132827'  
,'1201090004132831'  
,'1201090004306959'  
,'1201090004306963'  
,'1201090004323455'  
,'1201090004358672'  
,'1201090004358687'  
,'1201090004732628'  
,'1201090004733919'  
,'1201090004735517'  
,'1201090004777000'  
,'1201090004778247'  
,'1201090004861027'  
,'1201090004930276'  
,'1201090004948997'  
)  
and  CDSHM_COUNTER_BOID  NOT IN ('1201090000000101'  
,'1201090000000116'  
,'1201090000003024'  
,'1201090000007179'  
,'1201090000008723'  
,'1201090000011183'  
,'1201090000050928'  
,'1201090000252513'  
,'1201090000252528'  
,'1201090000268346'  
,'1201090000287399'  
,'1201090000702981'  
,'1201090000985991'  
,'1201090001101173'  
,'1201090001320629'  
,'1201090001465454'  
,'1201090001473896'  
,'1201090001478972'  
,'1201090001489150'  
,'1201090001705494'  
,'1201090001730035'  
,'1201090001730041'  
,'1201090001730054'  
,'1201090002827983'  
,'1201090002827998'  
,'1201090002828005'  
,'1201090002850297'  
,'1201090002955579'  
,'1201090003197552'  
,'1201090003220399'  
,'1201090003477021'  
,'1201090003484018'  
,'1201090003586755'  
,'1201090003586761'  
,'1201090003586793'  
,'1201090003586801'  
,'1201090003586814'  
,'1201090003677061'  
,'1201090004132827'  
,'1201090004132831'  
,'1201090004306959'  
,'1201090004306963'  
,'1201090004323455'  
,'1201090004358672'  
,'1201090004358687'  
,'1201090004732628'  
,'1201090004733919'  
,'1201090004735517'  
,'1201090004777000'  
,'1201090004778247'  
,'1201090004861027'  
,'1201090004930276'  
,'1201090004948997'))  
and cdshm_tras_dt>='aug 01 2012'  
and isnull(CASE WHEN CDSHM_CDAS_TRAS_TYPE IN ('2') THEN 'OFF MARKET'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('8') THEN 'PLEDGE'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('8') THEN 'UN PLEDGE EXTERNAL'  
WHEN CDSHM_CDAS_TRAS_TYPE IN ('20') THEN 'IPO CREDIT'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('601') THEN 'DEMAT REQUEST'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('608') THEN 'DEMAT REJECTION / CANCELLATION'  
  WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('701') THEN 'REMAT'  
WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('703') THEN 'REMAT CANCELLATION / REJECTION'  

  WHEN CDSHM_CDAS_SUB_TRAS_TYPE IN ('305') THEN 'ON MARKET EXTERNAL TRANSACTIONS' END,'')<>''

GO
