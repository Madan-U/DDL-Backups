-- Object: PROCEDURE citrus_usr.PR_TOMARKMANUAL_AUTOBANKRECO_13112010
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

-- EXEC PR_TOMARKMANUAL_AUTOBANKRECO '4','S','203412','APR 22 2010','JUN 28 2010',0,0,'','' 
-- EXEC PR_TOMARKMANUAL_AUTOBANKRECO '4','','203412','MAY 12 2010','MAY 12 2010',0,23.00,'HDFCCLIENT',''

CREATE PROCEDURE [citrus_usr].[PR_TOMARKMANUAL_AUTOBANKRECO_13112010]
(
 @PA_FIN_ID NUMERIC, 
 @PA_ACTION CHAR(2),
 @PA_DPM_ID NUMERIC,
 @PA_FROM_DT VARCHAR(20),
 @PA_TO_DT VARCHAR(20),
 @PA_CREDIT VARCHAR(20),
 @PA_DEBIT VARCHAR(20),
 @PA_ACCT_CD VARCHAR(20),
 @PA_OUT VARCHAR(20) OUT
)
AS
BEGIN 
DECLARE
@P_SQL VARCHAR(8000),
@P_SQL1 VARCHAR(8000)

set dateformat dmy
SET @P_SQL = ''
SET @P_SQL1 = ''

 IF(@PA_ACTION = 'S')
 BEGIN 
  SET @P_SQL = ' SELECT AUTOM_SNO,AUTOM_ACCNO,convert(varchar,AUTOM_TRNSDT,103) AUTOM_TRNSDT,AUTOM_TRNSID,AUTOM_CHQNO,AUTOM_NARRATION,AUTOM_DEBIT,AUTOM_CREDIT,
                     AUTOM_BOOKDT,AUTOM_FLAG FROM AUTORECO_MSTR 
                         WHERE AUTOM_TRNSDT BETWEEN '''+@PA_FROM_DT+''' AND '''+@PA_TO_DT+'''
AND ISNULL(AUTOM_RECOFLAG,'''')<>''Y'' '
                           --AND AUTOM_CHQNO NOT IN 
						 --(SELECT LDG_INSTRUMENT_NO FROM LEDGER'+CONVERT(VARCHAR,@PA_FIN_ID)+ ' 
						  --WHERE LDG_INSTRUMENT_NO IS NOT NULL AND LDG_INSTRUMENT_NO <> '''' 
                                                --AND LDG_DELETED_IND = 1)' 
  
  EXEC (@P_SQL)
 END

 IF(@PA_ACTION = 'US')
 BEGIN

SET @P_SQL = ' SELECT AUTOM_SNO,AUTOM_ACCNO,convert(varchar,AUTOM_TRNSDT,103) AUTOM_TRNSDT,AUTOM_TRNSID,AUTOM_CHQNO,AUTOM_NARRATION,AUTOM_DEBIT,AUTOM_CREDIT,
                     AUTOM_BOOKDT,AUTOM_FLAG FROM AUTORECO_MSTR 
                         WHERE AUTOM_TRNSDT BETWEEN '''+@PA_FROM_DT+''' AND '''+@PA_TO_DT+'''
AND ISNULL(AUTOM_RECOFLAG,'''')=''Y'' '
                           --AND AUTOM_CHQNO NOT IN 
						 --(SELECT LDG_INSTRUMENT_NO FROM LEDGER'+CONVERT(VARCHAR,@PA_FIN_ID)+ ' 
						  --WHERE LDG_INSTRUMENT_NO IS NOT NULL AND LDG_INSTRUMENT_NO <> '''' 
                                                --AND LDG_DELETED_IND = 1)' 
  PRINT  (@P_SQL)
  EXEC (@P_SQL)
 END 
 ELSE
 BEGIN 
  SET @P_SQL1 = 'SELECT DISTINCT CASE WHEN A.LDG_VOUCHER_TYPE = 1 THEN ''PAYMENT'' WHEN A.LDG_VOUCHER_TYPE = 2 THEN ''RECIEPT'' WHEN A.LDG_VOUCHER_TYPE = 4 THEN ''CONTRA'' END LDG_VOUCHER_TYPE
					,CONVERT(VARCHAR(11),A.LDG_VOUCHER_DT,103) LDG_VOUCHER_DT 
					,CONVERT(VARCHAR,A.LDG_VOUCHER_NO) LDG_VOUCHER_NO 
					,ISNULL(A.LDG_NARRATION,'''') LDG_NARRATION
					,ISNULL(B.LDG_INSTRUMENT_NO,'''') LDG_INSTRUMENT_NO
					,'' CLI AC NO : ''  + ISNULL(B.LDG_ACCOUNT_NO ,'''') + '' BO ID : '' + ISNULL(DPAM_SBA_NO ,'''') + '' NAME : '' + ISNULL(DPAM_SBA_NAME ,'''') FINA_ACC_NAME
					,A.LDG_AMOUNT
					,A.ACCTNO
					,A.ORD
				FROM (SELECT LDG_VOUCHER_TYPE , CONVERT(VARCHAR(11),LDG_VOUCHER_DT,103) LDG_VOUCHER_DT,LDG_VOUCHER_NO 
						,LDG_NARRATION , LDG_INSTRUMENT_NO,FINA_ACC_NAME, LDG_AMOUNT , FINA_ACC_CODE ACCTNO , LDG_VOUCHER_DT ORD  
					  FROM LEDGER' + CONVERT(VARCHAR,@PA_FIN_ID) +   ' B ,FIN_ACCOUNT_MSTR,DP_MSTR 
                      WHERE ' + case when @PA_ACTION = 'US' then  ' ISNULL(LDG_BANK_CL_DATE,''1900-01-01 00:00:00.000'') <> ''1900-01-01 00:00:00.000'' '  else  ' ISNULL(LDG_BANK_CL_DATE,''1900-01-01 00:00:00.000'') = ''1900-01-01 00:00:00.000'' ' end 
						+ ' AND LDG_VOUCHER_TYPE  IN  (''1'',''2'',''4'') 
						AND LDG_VOUCHER_DT BETWEEN '''  + @PA_FROM_DT + ''' AND ''' +   @PA_TO_DT  + '''
						AND LDG_ACCOUNT_ID=FINA_ACC_ID  
						AND LDG_DPM_ID = DPM_ID  
						AND DEFAULT_DP=DPM_EXCSM_ID 
						AND LDG_DELETED_IND = 1 
						AND FINA_ACC_TYPE=''B''
						AND DPM_ID = ''' + CONVERT(VARCHAR,@PA_DPM_ID  ) +'''
						AND FINA_ACC_CODE = ''' + @PA_ACCT_CD + '''
                        AND (ABS('''+ @PA_CREDIT + ''') = ABS(B.LDG_AMOUNT) OR ABS('''+ @PA_DEBIT +''') = ABS(B.LDG_AMOUNT))  ) A 
                     , LEDGER' + CONVERT(VARCHAR,@PA_FIN_ID)   + ' B LEFT OUTER JOIN DP_ACCT_MSTR  ON LDG_ACCOUNT_ID = DPAM_ID 
                            LEFT OUTER JOIN CLIENT_BANK_ACCTS ON CLIBA_CLISBA_ID = DPAM_ID AND CLIBA_DELETED_IND = 1 
                            LEFT OUTER JOIN BANK_MSTR ON BANM_ID = CLIBA_BANM_ID AND BANM_DELETED_IND = 1  
				WHERE B.LDG_VOUCHER_NO = A.LDG_VOUCHER_NO
				AND   B.LDG_VOUCHER_TYPE = A.LDG_VOUCHER_TYPE
				AND   B.LDG_ACCOUNT_TYPE IN (''P'') AND LDG_DELETED_IND = 1
				AND   B.LDG_VOUCHER_TYPE  IN  (''1'',''2'',''4'') 
               
      UNION

				SELECT DISTINCT CASE WHEN A.LDG_VOUCHER_TYPE = 1 THEN ''PAYMENT'' WHEN A.LDG_VOUCHER_TYPE = 2 THEN ''RECIEPT'' WHEN A.LDG_VOUCHER_TYPE = 4 THEN ''CONTRA'' END LDG_VOUCHER_TYPE
				,CONVERT(VARCHAR(11),A.LDG_VOUCHER_DT,103) LDG_VOUCHER_DT
				,CONVERT(VARCHAR,A.LDG_VOUCHER_NO) LDG_VOUCHER_NO  
				,ISNULL(A.LDG_NARRATION,'''') LDG_NARRATION
				,ISNULL(B.LDG_INSTRUMENT_NO,'''') LDG_INSTRUMENT_NO
				,'' CLI AC NO : ''  + ISNULL(B.LDG_ACCOUNT_NO ,'''') + '' BO ID : '' + ISNULL(C.FINA_ACC_CODE ,'''') + '' NAME : '' + ISNULL(C.FINA_ACC_NAME ,'''') FINA_ACC_NAME
				,A.LDG_AMOUNT
				,A.ACCTNO
				,A.ORD
				FROM (SELECT LDG_VOUCHER_TYPE , CONVERT(VARCHAR(11),LDG_VOUCHER_DT,103) LDG_VOUCHER_DT,LDG_VOUCHER_NO 
							,LDG_NARRATION , LDG_INSTRUMENT_NO,FINA_ACC_NAME, LDG_AMOUNT , FINA_ACC_CODE ACCTNO , LDG_VOUCHER_DT ORD  
					  FROM LEDGER' + CONVERT(VARCHAR,@PA_FIN_ID) +   ' B ,FIN_ACCOUNT_MSTR,DP_MSTR 
                      WHERE' + case when @PA_ACTION = 'US' then   ' ISNULL(LDG_BANK_CL_DATE,''1900-01-01 00:00:00.000'') <> ''1900-01-01 00:00:00.000'' '  else  ' ISNULL(LDG_BANK_CL_DATE,''1900-01-01 00:00:00.000'') = ''1900-01-01 00:00:00.000'' ' end   
                      + ' AND LDG_VOUCHER_TYPE  IN  (''1'',''2'',''4'')
					  AND LDG_VOUCHER_DT BETWEEN '''  + @PA_FROM_DT + ''' AND ''' +   @PA_TO_DT  + '''
        			  AND LDG_ACCOUNT_ID=FINA_ACC_ID  
					  AND LDG_DPM_ID = DPM_ID  
					  AND DEFAULT_DP=DPM_EXCSM_ID 
					  AND LDG_DELETED_IND = 1 
					  AND FINA_ACC_TYPE=''B''
					  AND DPM_ID = ''' + CONVERT(VARCHAR,@PA_DPM_ID  ) +'''
					  AND FINA_ACC_CODE = ''' + @PA_ACCT_CD + '''
                      AND (ABS('''+ @PA_CREDIT + ''') = ABS(B.LDG_AMOUNT) OR ABS('''+ @PA_DEBIT +''') = ABS(B.LDG_AMOUNT))  ) A 
                 , LEDGER' + CONVERT(VARCHAR,@PA_FIN_ID)   + ' B LEFT OUTER JOIN FIN_ACCOUNT_MSTR C ON LDG_ACCOUNT_ID = FINA_ACC_ID
					--LEFT OUTER JOIN CLIENT_BANK_ACCTS ON CLIBA_CLISBA_ID = DPAM_ID AND CLIBA_DELETED_IND = 1 LEFT OUTER JOIN BANK_MSTR ON BANM_ID = CLIBA_BANM_ID AND BANM_DELETED_IND = 1  
				WHERE B.LDG_VOUCHER_NO = A.LDG_VOUCHER_NO
				AND   B.LDG_VOUCHER_TYPE = A.LDG_VOUCHER_TYPE
				AND   B.LDG_ACCOUNT_TYPE IN (''C'',''G'') AND LDG_DELETED_IND = 1
				AND   B.LDG_VOUCHER_TYPE  IN  (''1'',''2'',''4'') 
           ORDER BY ORD , A.LDG_VOUCHER_TYPE,  A.LDG_VOUCHER_NO'
  PRINT (@P_SQL1)
  EXEC (@P_SQL1)
 END
END

GO
