-- Object: PROCEDURE citrus_usr.E_DIS_Slip_gen_Process_MF
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------


CREATE PROCEDURE [citrus_usr].[E_DIS_Slip_gen_Process_MF]        
--(        
--@DATE DATETIME        
--)        
AS        
---EXEC USP_DIY_POA_PROCESS_LOG_MF '09/14/2018'        
    

        
BEGIN        
        
		    
DECLARE @DATE DATETIME     
SELECT @DATE=CONVERT(VARCHAR(10),GETDATE(),101)    
  
DECLARE @SDATE DATETIME  
  SELECT @SDATE=CONVERT(VARCHAR(10),GETDATE(),120)    


DECLARE @COUNT INT;        
DECLARE @COUNTER INT=1,@TOTALCOUNT INT,@P26 VARCHAR(100), @PA_LOGIN_NAME VARCHAR(50),@PA_SLIP_NO VARCHAR(50),@PA_EXCM_ID VARCHAR(10),        
@PA_VALUES VARCHAR(50),@PA_SETTLM_NO VARCHAR(50),@EXECUTIONNDATE DATETIME,@PA_TR_SETM_TYPE VARCHAR(10),@PA_TR_ACCT_NO VARCHAR(20);        
           
    
SET @EXECUTIONNDATE=  CONVERT(VARCHAR(11),GETDATE(),120)     

DECLARE @PAYIN VARCHAR(8)
SET @PAYIN = REPLACE(LEFT(CONVERT(VARCHAR,GETDATE(), 104), 10),'.','') 
   print @PAYIN
DELETE FROM DIY_POA_PROCESS_LOG_MF WHERE CREATED_DATE= CONVERT(VARCHAR(11),GETDATE(),120)        
       
  --SELECT * FROM DIY_POA_PROCESS_LOG_MF  
  SELECT * INTO #DIY_POA_PROCESS_LOG_MF FROM DIY_POA_PROCESS_LOG_MF WHERE 1=2  

  
INSERT INTO #DIY_POA_PROCESS_LOG_MF        
  SELECT         
  PARTYCODE CLIENTID,DPID ,SYMBOL,ISIN, EXCHANGE=(CASE WHEN EXCHANGE ='1' THEN 'NSE'         
                      WHEN EXCHANGE ='3' THEN 'BSE'        
                      ELSE '' END ) , (CONVERT(FLOAT, CONVERT(DECIMAL(38,3),QUANTITY))) QUANTITY,POASTATUS AS ONL,        
  CREATED_DATE =CONVERT(VARCHAR(11),DATE_TIME_STAMP,120)  ,'','','','',CONVERT(VARCHAR(11),DATE_TIME_STAMP,120),'',ROW_NUMBER() OVER(ORDER BY PARTYCODE),SETT_NO,''   ,TransactionID      
  FROM        
    [172.31.16.75].ANGEL_WMS.DBO.PO_ACCEPTANCE_STATUS A        
    WHERE CONVERT(VARCHAR(11),DATE_TIME_STAMP,103) = CONVERT(VARCHAR(11),GETDATE(),103)      
    --AND CREATIONDATE <=CONVERT(VARCHAR(11),@DATE,120) +' 23:59' AND         
   AND ACTION ='SELL'   AND  ISNULL(CONVERT(FLOAT, QUANTITY),0) <>0    AND PRODUCT_TYPE='MF'   and dpid like '12033201%'
   AND  ISNULL(SYMBOL,'') <> '' AND ISNULL( ISIN,'')  <>''  AND  SETT_NO <>'' --AND LEN(DPID)=16       
   --AND LEFT(DPID,8)='12033201'
 --   GROUP BY  PARTYCODE,EXCHANGE,POASTATUS,SYMBOL,ISIN,DPID,CONVERT(VARCHAR(11),DATE_TIME_STAMP,120),SETT_NO    
         
                
   UPDATE D SET DP_ID = CLTDPID FROM #DIY_POA_PROCESS_LOG_MF D,[AngelFO].BSEMFSS.DBO.MFSS_CLIENT C        
   WHERE D.CL_CODE = C.PARTY_CODE   --AND DEPOSITORY ='CDSL'          
   AND CONVERT(VARCHAR(11),CREATED_DATE,103) = CONVERT(VARCHAR(11),GETDATE(),103)      
    
   INSERT INTO DIY_REPROCESS_LOG_E_DIS_MF_HST  
   SELECT * FROM DIY_REPROCESS_LOG_E_DIS_MF   
   TRUNCATE TABLE DIY_REPROCESS_LOG_E_DIS_MF   
   TRUNCATE TABLE MF_DATA

    
  INSERT INTO MF_DATA
  SELECT * FROM AGMUBODPL3.dmat.citrus_usr.E_DIS_TRXN_DATA T WITH(NOLOCK) where Request_date >=GETDATE()-10
  AND ISIN Like 'INF%' and Partycode in (select CL_CODE from #DIY_POA_PROCESS_LOG_MF WITH(NOLOCK) )
     
 
       
   INSERT INTO  DIY_REPROCESS_LOG_E_DIS_MF    
   SELECT SETT_NO,SETT_TYPE,CL_CODE,SYMBOL,'',SELLTRADEQTY=0,SELLRECQTY=0,  
   SELL_SHORTAGE =QTY  
   ,DP_ID,ISIN ,PROCESS_DATE=GETDATE(),0,'',0,'N',1,ADJ_QTY=QTY ,Tranasction_id
   FROM #DIY_POA_PROCESS_LOG_MF D   WITH(NOLOCK)
   WHERE  EXISTS (SELECT PARTYCODE FROM MF_DATA T WITH(NOLOCK)
   WHERE D.CL_CODE =T.PARTYCODE AND D.ISIN=T.ISIN AND REQUEST_DATE>=GETDATE()-10
   AND DUMMY2=@PAYIN AND ISNULL(VALID,0)=0 AND ISNULL(DUMMY3,'')='')  
    AND LEFT(DP_ID,8)='12033201'

   ---Select * from DIY_REPROCESS_LOG_E_DIS_MF where DP_HOLDing =0

   	UPDATE D   
		   SET   
		   DP_HOLDING =HLD_AC_POS  
		   FROM  
			DIY_REPROCESS_LOG_E_DIS_MF d (nolock)   ,HoldingData h   (nolock) 
		   WHERE 
			DP_ID =HLD_AC_CODE    --AND SETT_NO= @sett_no 
			AND PROCESS_FLAG=0 
		   AND ISIN =HLD_ISIN_CODE   and HLD_AC_TYPE ='11'  
		 
   Delete from DIY_REPROCESS_LOG_E_DIS_MF where DP_HOLDING =0
   

			UPDATE D SET  ADJ_QTY =(CASE WHEN Sell_shortage >DP_HOLDING THEN DP_HOLDING ELSE Sell_shortage END)
		   FROM  DIY_REPROCESS_LOG_E_DIS_MF  D 
		   WHERE  PROCESS_FLAG=0 

  
    EXEC EDIS_TRXN_PROCESS_MF  @SDATE  
  
          
   
   --INSERT INTO E_DIS_PROCESS_DATA_HST  
   --SELECT PARTYCODE,BOID,ISIN,QTY,ANGEL_TRXN_ID,CDSL_TRXN_ID,REQUEST_DATE,SETT_NO,SETT_TYPE,  
   --PROCESS_STATUS,PROCESS_DATE,SLIP_NO  
   --FROM E_DIS_PROCESS_DATA  
     
  --- TRUNCATE TABLE E_DIS_PROCESS_DATA  

 
  
   INSERT INTO E_DIS_PROCESS_DATA  
   SELECT DISTINCT PARTYCODE,BOID, ISIN,(QTY) AS QTY,(ANGEL_TRXN_ID) ANGEL_TRXN_ID, (CDSL_TRXN_ID) CDSL_TRXN_ID,   
   REQUEST_DATE , SETT_NO,SETT_TYPE  ,PROCESS_STATUS ,PROCESS_DATE,''   FROM (
     SELECT DISTINCT PARTYCODE,BOID,N.ISIN,(ADJ_QTY) AS QTY,(ANGEL_TRXN_ID) ANGEL_TRXN_ID, (CDSL_TRXN_ID) CDSL_TRXN_ID,   
   REQUEST_DATE=CONVERT(VARCHAR(11),GETDATE(),120),T.SETT_NO,SETT_TYPE='' ,PROCESS_STATUS=0,PROCESS_DATE=GETDATE(),TRANASCTION_ID 
   FROM HOLD_REP_N_MF N, DIY_REPROCESS_LOG_E_DIS_MF T  
    WHERE T.PARTY_CODE =N.PARTYCODE AND T.ISIN=N.ISIN  )A --AND SETT_NO =@SETT_NO--AND PARTYCODE='A133377'   
   -- GROUP BY PARTYCODE,BOID,N.ISIN,T.SETT_NO  
        
  
    UPDATE T SET EX_QTY =ISNULL(EX_QTY,0)+ALLOCATE_QTY  
   FROM E_DIS_TRXN_DATA T ,HOLD_REP_N_MF N  
   WHERE  T.PARTYCODE =N.PARTYCODE AND T.ISIN=N.ISIN AND T.CDSL_TRXN_ID=N.CDSL_TRXN_ID  
   AND  T.ANGEL_TRXN_ID =N.ANGEL_TRXN_ID AND ISNULL(VALID,0)=0  
  
     
  
    UPDATE T SET VALID =(CASE WHEN T.QTY <>EX_QTY THEN '0' ELSE '1' END),PEND_QTY=T.QTY-EX_QTY  
   FROM E_DIS_TRXN_DATA T ,HOLD_REP_N_MF N  
   WHERE  T.PARTYCODE =N.PARTYCODE AND T.ISIN=N.ISIN AND T.CDSL_TRXN_ID=N.CDSL_TRXN_ID  
   AND  T.ANGEL_TRXN_ID =N.ANGEL_TRXN_ID AND ISNULL(VALID,0)=0  
     
  
   ---SELECT  * INTO E_DIS_PROCESS_DATA_MF FROM E_DIS_PROCESS_DATA WHERE 1=2  

CREATE TABLE #FINALTABLE (SNO INT,PA_LOGIN_NAME VARCHAR(16),PA_SLIP_NO INT,PA_EXCM_ID INT,PA_TR_SETM_TYPE INT,
PA_VALUES VARCHAR(2000),PA_SETTLM_NO VARCHAR(10),PA_TR_ACCT_NO VARCHAR(10),ANGEL_TRXN_ID VARCHAR(50), CDSL_TRXN_ID VARCHAR(50),ISIN VARCHAR(16),PARTYCODE  VARCHAR(16),
ID INT IDENTITY(1,1)  PRIMARY KEY)     
    
 
	
INSERT INTO   #FINALTABLE  
 SELECT SNO,BOID PA_LOGIN_NAME,(SELECT SRNO FROM TBL_PROCESSSRNO) PA_SLIP_NO,4 AS PA_EXCM_ID,        
 '52' AS PA_TR_SETM_TYPE,        
 'A|*~|'+ISIN+'|*~|'+CONVERT(VARCHAR(10),CAST(QTY AS NUMERIC(18,3)))+'|*~|*|~*' PA_VALUES,        
 SETT_NO PA_SETTLM_NO,        
'' AS PA_TR_ACCT_NO  ,ANGEL_TRXN_ID, CDSL_TRXN_ID,ISIN,PARTYCODE 
 FROM E_DIS_PROCESS_DATA       
 WHERE CONVERT(VARCHAR(11),PROCESS_DATE,103) =CONVERT(VARCHAR(11),GETDATE(),103)     AND QTY >0
 AND ISIN LIKE 'INF%' AND PROCESS_STATUS='0' ---AND  POA_STATUS_BO =''  AND  BO_VALIDATION ='Y' AND DP_VALID <> ''        
---- AND SETT_TYPE ='W'      
 
          
 --ALTER TABLE #FINALTABLE ADD ID INT IDENTITY(1,1) PRIMARY KEY         
     
    
       
DECLARE @P33 VARCHAR(100) ,@ucc varchar(11)    
    
 SELECT @TOTALCOUNT= COUNT(*) FROM #FINALTABLE        
        
 WHILE(@COUNTER<=@TOTALCOUNT)        
        
 BEGIN        
 SELECT  @PA_LOGIN_NAME= PA_LOGIN_NAME,@PA_SLIP_NO='E'+CONVERT(VARCHAR(100),(PA_SLIP_NO+@COUNTER)),@PA_EXCM_ID=PA_EXCM_ID,@PA_VALUES=PA_VALUES,        
 @PA_SETTLM_NO=PA_SETTLM_NO,@PA_TR_SETM_TYPE=PA_TR_SETM_TYPE,@PA_TR_ACCT_NO=PA_TR_ACCT_NO,@ucc=partycode FROM #FINALTABLE  WHERE ID=@COUNTER        
        
 SET @P26=@PA_VALUES      
 EXEC pr_ins_upd_trx_cdsl_sp_PreEDIS_AngelPre @PA_ID='0',@PA_TAB='NP',@PA_ACTION='INS',@PA_LOGIN_NAME=@PA_LOGIN_NAME,@PA_DPM_DPID='12033201',    
 @PA_DPAM_ACCT_NO=@PA_LOGIN_NAME,@PA_SLIP_NO=@PA_SLIP_NO,@PA_MKT_TYPE='',@PA_SETTLM_NO=@PA_SETTLM_NO,    
 @PA_REQ_DT=@EXECUTIONNDATE,@PA_CM_ID='612',@PA_EXCM_ID='4',@PA_CASH_TRF='NA',@PA_EXE_DT=@EXECUTIONNDATE,@PA_TR_CMBPID='',    
 @PA_TR_DP_ID='',@PA_TR_SETM_TYPE='52',@PA_TR_SETM_NO='',@PA_TR_ACCT_NO='',@PA_VALUES=@PA_VALUES,    
 @PA_RMKS='',@PA_TRDREASONCD='0',@PA_PAYMODE='',@PA_BANKACNO='',@PA_BANKACNAME='',@PA_BANKBRNAME='',@PA_TRANSFEREENAME='',    
 @PA_DOI='',@PA_CHQREFNO='', @PA_UCC=@UCC,@PA_EXID='11',@PA_SEGID='01',@PA_CMID='M50082',@PA_EID='',@PA_TMCMID='612' , @PA_CHK_YN=1,@ROWDELIMITER='*|~*',@COLDELIMITER='|*~|',@PA_ERRMSG=@P33 OUTPUT    
 SELECT @P33    
    
    
        
--UPDATE DIY_POA_PROCESS_LOG_MF SET DP_PROCESS_DT=@DATE WHERE SRNO=(SELECT SRNO FROM #FINALTABLE WHERE ID=@COUNTER)        
SET @COUNTER=@COUNTER+1        
        
END     
  
 IF ( @PA_SLIP_NO IS NOT NULL OR @PA_SLIP_NO <> '')  
     BEGIN   
    UPDATE TBL_PROCESSSRNO SET SRNO = SRNO+@TOTALCOUNT  
   
 END  
   
        
END     
  
     UPDATE D SET SLIP_NO='E'+CONVERT(VARCHAR(100),(PA_SLIP_NO+ID)),PROCESS_STATUS =1 FROM #FINALTABLE (NOLOCK) F,
	 E_DIS_PROCESS_DATA (NOLOCK) D WHERE BOID= PA_LOGIN_NAME    
   AND F.ISIN=D.ISIN  AND D.SNO=F.SNO
   AND SETT_NO= PA_SETTLM_NO AND PROCESS_STATUS=0  AND F.ANGEL_TRXN_ID =D.ANGEL_TRXN_ID AND D.CDSL_TRXN_ID=F.CDSL_TRXN_ID   
  
  EXEC PR_CDSL_PRETRADE_EDIS_RESPONSE_ANGEL '',''

GO
