-- Object: PROCEDURE citrus_usr.DPSCHEME_CHANGE
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

  --Altered this SP under SRE-39285    
CREATE PROC [citrus_usr].[DPSCHEME_CHANGE] (@PARTY_CODE VARCHAR(10),@DPID VARCHAR(25),@BROKPLAN VARCHAR(50),@USERID VARCHAR(20))      
AS       
     
  --Exec citrus_usr.DPSCHEME_CHANGE 'df','1203320324554611','ITRADE PREMIER PRO','Test'    
    
IF ( (ISNULL(@PARTY_CODE,'')='') OR (ISNULL(@DPID,'')='')  )      
 BEGIN      
         
    SELECT REMARKS= 'PARTY CODE OR DP ID CANNOT BLANK'        
         
   RETURN      
 END     
 
 IF ( len(@DPID)<>16  )      
 BEGIN      
         
    SELECT REMARKS= 'INVALID DPID LENGTH'        
         
   RETURN      
 END 

    
      
DECLARE @OLDPLAN VARCHAR(50)      
SELECT @OLDPLAN=BROM_DESC        
FROM CLIENT_DP_BRKG C, DP_ACCT_MSTR M,BROKERAGE_MSTR B      
WHERE CLIDB_DELETED_IND = 1 AND DPAM_ID = CLIDB_DPAM_ID  AND DPAM_SBA_NO=@DPID   AND DPAM_BBO_CODE=@PARTY_CODE    
AND CLIDB_BROM_ID=BROM_ID       
    
AND GETDATE () BETWEEN CLIDB_EFF_FROM_DT AND ISNULL (CLIDB_EFF_TO_DT , 'DEC 31 2099')      
      
IF (@OLDPLAN=@BROKPLAN)      
 BEGIN      
         
    SELECT REMARKS= 'CURRENT PLAN AND NEW PLAN BOTH ARE SAME'        
         
   RETURN      
 END      
      
DECLARE @DPAMID INT       
      
      
SELECT @DPAMID=DPAM_ID FROM DP_ACCT_MSTR  WHERE DPAM_SBA_NO=@DPID   AND DPAM_BBO_CODE=@PARTY_CODE    
   
IF (@DPAMID IS NULL or @DPAMID='')      
      
BEGIN      
         
    SELECT REMARKS= 'ENTER VALID DP ID OR PARTY CODE '        
         
   RETURN      
 END      
      
      
      
DECLARE @BROKID INT       
      
SELECT  @BROKID =BROM_ID      
FROM BROKERAGE_MSTR WHERE BROM_DESC =@BROKPLAN      
      
IF (@BROKID IS NULL OR @BROKID ='')      
      
BEGIN      
         
    SELECT REMARKS= 'INVALID BROKERAGE PLAN'        
         
   RETURN      
 END      
      
      
      
UPDATE C       
SET  C.CLIDB_EFF_TO_DT = CONVERT(VARCHAR(11),GETDATE()-1,120)  +' 23:59:59'     FROM CLIENT_DP_BRKG C       
WHERE C.CLIDB_DELETED_IND = 1 AND  C.CLIDB_DPAM_ID =@DPAMID      
AND GETDATE () BETWEEN C.CLIDB_EFF_FROM_DT AND ISNULL (C.CLIDB_EFF_TO_DT , 'DEC 31 2099')      
      
       
INSERT INTO CLIENT_DP_BRKG VALUES (@DPAMID,@BROKID,'BROK_M',GETDATE(),'BROK_M',GETDATE(),1,CONVERT(DATE,GETDATE()),'2100-12-31 00:00:00.000')      
      
INSERT INTO TBL_BROK_MOD (PARTYCODE,DPID,BROKPLAN_OLD,BROKPLAN,MODIFIED_BY,MODIFIED_ON) VALUES( @PARTY_CODE,@DPID,@OLDPLAN,@BROKPLAN,@USERID,GETDATE())      
      
 SELECT  REMARKS=@BROKPLAN + ' ADDED FOR CLIENT: '+@DPID

GO
