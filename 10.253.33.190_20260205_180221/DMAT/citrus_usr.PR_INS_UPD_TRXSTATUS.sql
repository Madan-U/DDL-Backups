-- Object: PROCEDURE citrus_usr.PR_INS_UPD_TRXSTATUS
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

--exec PR_INS_UPD_TRXSTATUS @pa_login_name='HH',@pa_tab='DEMAT_STAT',@pa_Excsm_Id=3,@pa_taskid=1560
CREATE PROCEDURE [citrus_usr].[PR_INS_UPD_TRXSTATUS]  
(  
 @PA_LOGIN_NAME VARCHAR(25)  
,@PA_TAB VARCHAR(20)  
,@PA_EXCSM_ID   NUMERIC(10)  
,@PA_TASKID    NUMERIC(10)  
)  
AS   
BEGIN  
DECLARE @L_DPMDPID  VARCHAR(50)  
       , @L_DPM_ID  VARCHAR(50)
       , @l_id BIGINT
	   ,@l_id_mak BIGINT  
  
  
IF @PA_TAB='INTERDP_STAT'  
--  
BEGIN   
 --  
 SELECT TOP 1 @L_DPMDPID=LEFT(TMPIDS_BOID,8) ,@L_DPM_ID=DPM_ID FROM TMP_ID_SUMMARY,DP_MSTR WHERE dpm_dpid = LEFT(TMPIDS_BOID,8) AND DPM_DELETED_IND=1  
  
 UPDATE T SET T.TMPIDS_DPM_ID=@L_DPM_ID,T.TMPIDS_DPAM_ID=DPAM_ID FROM TMP_ID_SUMMARY T,DP_ACCT_MSTR D   
 WHERE TMPIDS_BOID=DPAM_SBA_NO AND DPAM_DELETED_IND=1 AND DPAM_DPM_ID=@L_DPM_ID  
  
 IF @L_DPM_ID<>''   
 BEGIN   
  
 INSERT INTO INTERDP_STATUS_MSTR  
 (  
  IDS_BOID ,  
  IDS_ISIN_ALPHA ,  
  IDS_ISIN_SHORT_NM ,  
  IDS_NSDL_CMBP_DPID ,  
  IDS_NSDL_SETT_ID ,  
  IDS_NSDL_CLTID ,  
  IDS_SENDER_TRX_REFNO ,  
  IDS_QTY ,  
  IDS_BS_FLG ,  
  IDS_EXEC_DT ,  
  IDS_TRX_STAT_CD ,  
  IDS_INT_REF_NO ,  
  IDS_ERR_CD1 ,  
  IDS_ERR_CD2 ,  
  IDS_ERR_CD3 ,  
  IDS_ERR_CD4 ,  
  IDS_ERR_DESC1 ,  
  IDS_ERR_DESC2 ,  
  IDS_ERR_DESC3 ,  
  IDS_ERR_DESC4 ,   
  IDS_TRX_DT ,  
  IDS_LST_MOD_DT ,  
  IDS_DPAM_ID ,  
  IDS_DPM_ID ,  
  IDS_CHARGE ,  
  IDS_DP_CHARGE,
  IDS_CTR_SETTL_ID   
 )  
  
 SELECT  
  TMPIDS_BOID ,  
  TMPIDS_ISIN_ALPHA ,  
  TMPIDS_ISIN_SHORT_NM ,  
  TMPIDS_NSDL_CMBP_DPID ,  
  TMPIDS_NSDL_SETT_ID ,  
  TMPIDS_NSDL_CLTID ,  
  TMPIDS_SENDER_TRX_REFNO ,  
  TMPIDS_QTY ,  
  TMPIDS_BS_FLG ,  
  TMPIDS_EXEC_DT ,  
  TMPIDS_TRX_STAT_CD ,  
  TMPIDS_INT_REF_NO ,  
  TMPIDS_ERR_CD1 ,  
  TMPIDS_ERR_CD2 ,  
  TMPIDS_ERR_CD3 ,  
  TMPIDS_ERR_CD4 ,  
  TMPIDS_ERR_DESC1 ,  
  TMPIDS_ERR_DESC2 ,  
  TMPIDS_ERR_DESC3 ,  
  TMPIDS_ERR_DESC4 ,   
  TMPIDS_TRX_DT ,  
  TMPIDS_LST_MOD_DT ,  
  TMPIDS_DPAM_ID ,  
  TMPIDS_DPM_ID ,  
  TMPIDS_CHARGE ,  
  TMPIDS_DP_CHARGE,
  TMPIDS_CTR_SETTL_ID   
 FROM TMP_ID_SUMMARY A  
 WHERE NOT EXISTS   
 (  
 SELECT IDS_BOID,IDS_ISIN_ALPHA,IDS_TRX_DT,IDS_SENDER_TRX_REFNO,IDS_INT_REF_NO FROM   
 INTERDP_STATUS_MSTR B  
 WHERE B.IDS_DPAM_ID=A.TMPIDS_DPAM_ID AND B.IDS_ISIN_ALPHA=A.TMPIDS_ISIN_ALPHA AND B.IDS_TRX_DT=A.TMPIDS_TRX_DT  
 and B.IDS_SENDER_TRX_REFNO = A.TMPIDS_SENDER_TRX_REFNO AND B.IDS_INT_REF_NO = A.TMPIDS_INT_REF_NO
 )  
 AND ISNULL(TMPIDS_DPAM_ID,0)<>0


update dp_trx_dtls_cdsl 
set DPTDC_STATUS = isnull(TMPIDS_TRX_STAT_CD,DPTDC_STATUS),
	DPTDC_ERRMSG = TMPIDS_ERR_DESC1
from dp_trx_dtls_cdsl,TMP_ID_SUMMARY
where dptdc_dpam_id = TMPIDS_DPAM_ID AND dptdc_isin = TMPIDS_ISIN_ALPHA AND DPTDC_EXECUTION_DT = TMPIDS_TRX_DT  
and DPTDC_TRANS_NO =  TMPIDS_SENDER_TRX_REFNO
and isnull(dptdc_trans_no,'') <> '' and DPTDC_INTERNAL_TRASTM = 'ID'
and dptdc_deleted_ind = 1 
--BOCM,BOBO,CMBO,CMCM,id,np,ep
						

  
 IF EXISTS (SELECT TMPIDS_BOID,TMPIDS_ISIN_ALPHA FROM TMP_ID_SUMMARY WHERE  ISNULL(TMPIDS_DPAM_ID,0)=0)   
  BEGIN  
  --  
     UPDATE FILETASK SET USERMSG= 'ERROR : Following Client Not Mapped ' + citrus_usr.fn_merge_str('ID_DP49',0,'')  
     WHERE  task_id = @PA_TASKID  
  --   
  END  
--  
 END   
  
END  
  
IF @PA_TAB='OFFMKT_STAT'  
--  
BEGIN   
--  
SELECT TOP 1 @L_DPMDPID=LEFT(TMPOFFX_BO_ID,8) ,@L_DPM_ID=DPM_ID FROM TMP_OFFMKT_TRXFER,DP_MSTR WHERE dpm_dpid = LEFT(TMPOFFX_BO_ID,8) AND DPM_DELETED_IND=1  
  
UPDATE T SET T.TMPOFFX_DPM_ID=@L_DPM_ID,T.TMPOFFX_DPAM_ID=DPAM_ID FROM TMP_OFFMKT_TRXFER T,DP_ACCT_MSTR D   
WHERE TMPOFFX_BO_ID=DPAM_SBA_NO AND DPAM_DELETED_IND=1 AND DPAM_DPM_ID=@L_DPM_ID  
  
IF @L_DPM_ID<>''   
BEGIN   
--  
INSERT INTO OFFMKT_STATUS_MSTR  
(  
OFFSM_DPAM_ID ,  
OFFSM_DPID,  
OFFSM_DP_NM ,  
OFFSM_SETTL_DT ,  
OFFSM_TRD_ID ,  
OFFSM_STAT  ,  
OFFSM_SELLER_TXNID ,  
OFFSM_BUYER_TXNID ,  
OFFSM_BS_FLG ,  
OFFSM_TXN_DT , --DDMMYYYY :24HHMISS  
OFFSM_BO_ID ,  
OFFSM_BO_NM ,  
OFFSM_ISIN  ,  
OFFSM_ISIN_NM ,  
OFFSM_CTR_BO_ID  ,  
OFFSM_CTR_DPID ,  
OFFSM_CTR_DP_NM  ,  
OFFSM_QTY ,  
OFFSM_CASH_TRX_FLG ,  
OFFSM_EX_ID  ,  
OFFSM_SETTL_ID ,  
OFFSM_REASON_FORTRD ,  
OFFSM_SELLER_INT_REFNO ,  
OFFSM_BUYER_INT_REFNO ,  
OFFSM_TRD_FORMED_FLG ,  
OFFSM_ERR_CD ,  
OFFSM_ERR_DESC ,  
OFFSM_FREE_BAL,   
OFFSM_CTR_SETTL_ID  
  
)  
SELECT   
TMPOFFX_DPAM_ID,  
TMPOFFX_DPM_ID,  
TMPOFFX_DP_NM,  
TMPOFFX_SETTL_DT,  
TMPOFFX_TRD_ID,  
TMPOFFX_STAT,  
TMPOFFX_SELLER_TXNID,  
TMPOFFX_BUYER_TXNID,  
TMPOFFX_BS_FLG,  
TMPOFFX_TXN_DT,  
TMPOFFX_BO_ID,  
TMPOFFX_BO_NM,  
TMPOFFX_ISIN,  
TMPOFFX_ISIN_NM,  
TMPOFFX_CTR_BO_ID,  
TMPOFFX_CTR_DPID,  
TMPOFFX_CTR_DP_NM,  
TMPOFFX_QTY,  
TMPOFFX_CASH_TRX_FLG,  
TMPOFFX_EX_ID,  
TMPOFFX_SETTL_ID,  
TMPOFFX_REASON_FORTRD,  
TMPOFFX_SELLER_INT_REFNO,  
TMPOFFX_BUYER_INT_REFNO,  
TMPOFFX_TRD_FORMED_FLG,  
TMPOFFX_ERR_CD,  
TMPOFFX_ERR_DESC,  
TMPOFFX_FREE_BAL,
TMPOFFX_CTR_SETTL_ID  
FROM TMP_OFFMKT_TRXFER A  
WHERE NOT EXISTS  
(  
SELECT OFFSM_BO_ID,OFFSM_ISIN,OFFSM_TXN_DT   
FROM OFFMKT_STATUS_MSTR B WHERE B.OFFSM_DPAM_ID = A.TMPOFFX_DPAM_ID AND B.OFFSM_ISIN=A.TMPOFFX_ISIN  
AND B.OFFSM_TXN_DT=A.TMPOFFX_TXN_DT  AND B.OFFSM_SELLER_TXNID = A.TMPOFFX_SELLER_TXNID AND B.OFFSM_SELLER_INT_REFNO = A.TMPOFFX_SELLER_INT_REFNO
)  
AND isnull(TMPOFFX_DPAM_ID,0)<>0


update dp_trx_dtls_cdsl 
set DPTDC_STATUS = isnull(TMPOFFX_STAT,DPTDC_STATUS),
	DPTDC_ERRMSG = TMPOFFX_ERR_CD
from dp_trx_dtls_cdsl,TMP_OFFMKT_TRXFER
where dptdc_dpam_id = TMPOFFX_DPAM_ID AND dptdc_isin = TMPOFFX_ISIN AND DPTDC_EXECUTION_DT = TMPOFFX_TXN_DT  
and DPTDC_TRANS_NO =  TMPOFFX_SELLER_TXNID
and isnull(dptdc_trans_no,'') <> '' and DPTDC_INTERNAL_TRASTM in('BOCM','BOBO','CMBO','CMCM')
and dptdc_deleted_ind = 1 



  
IF EXISTS (SELECT TMPOFFX_BO_ID,TMPOFFX_ISIN FROM TMP_OFFMKT_TRXFER WHERE  ISNULL(TMPOFFX_DPAM_ID,0)=0)   
  BEGIN  
  --  
     UPDATE FILETASK SET USERMSG= 'ERROR : Following Client Not Mapped ' + citrus_usr.fn_merge_str('OFFSM_DP83',0,'')  
     WHERE  task_id = @PA_TASKID  
  --   
  END  
--  
END   
--  
--  
END   
  
IF @PA_TAB='DEMAT_STAT'  
--  
BEGIN   
-- 
print 'hetal' 
SELECT TOP 1 @L_DPMDPID=LEFT(TMPDS_BO_ID,8) ,@L_DPM_ID=DPM_ID FROM TMP_DMT_SUMMARY,DP_MSTR WHERE   
dpm_dpid = LEFT(TMPDS_BO_ID,8) AND DPM_DELETED_IND=1  
  
UPDATE T SET T.TMPDS_DPM_ID=@L_DPM_ID,T.TMPDS_DPAM_ID=DPAM_ID,
TMPDS_DRN_STATUS = case when ltrim(rtrim(isnull(TMPDS_DRN_STATUS,''))) = 'D' then '1DW' else '1' + ltrim(rtrim(isnull(TMPDS_DRN_STATUS,''))) end
FROM TMP_DMT_SUMMARY T,DP_ACCT_MSTR D   
WHERE TMPDS_BO_ID=DPAM_SBA_NO AND DPAM_DELETED_IND=1 AND DPAM_DPM_ID=@L_DPM_ID  
  print @L_DPM_ID
IF @L_DPM_ID<>''   
--  
BEGIN  
--CHANGED BY JITESH ON 23 FEB 2010
	IF NOT EXISTS(SELECT DMTS_ISIN,DMTS_BO_ID,DMTS_DRN_SETUP_DT,DMTS_DISP_DT FROM TMP_DMT_SUMMARY A, DMT_STATUS_MSTR B   
					WHERE B.DMTS_ISIN=A.TMPDS_ISIN AND B.DMTS_DPAM_ID=A.TMPDS_DPAM_ID  
					AND B.DMTS_DRN_SETUP_DT=A.TMPDS_DRN_SETUP_DT AND B.DMTS_DISP_DT=A.TMPDS_DISP_DT  AND B.DMTS_DMT_REQ_NO = A.TMPDS_DMT_REQ_NO
					AND B.DMTS_DMT_REQ_FRM_NOS = A.TMPDS_DMT_REQ_FRM_NOS)
	BEGIN
			
		INSERT INTO DMT_STATUS_MSTR  
		(  
		DMTS_DMT_REQ_NO,   
		DMTS_RTA_ID ,  
		DMTS_DMT_REQ_QTY ,  
		DMTS_DMT_ACCP_QTY ,  
		DMTS_DMT_REJ_QTY ,  
		DMTS_ISIN ,  
		DMTS_ISIN_SHRT_NM ,  
		DMTS_AGEING_PERIOD ,  
		DMTS_DMT_REQ_FRM_NOS ,  
		DMTS_BO_ID ,  
		DMTS_DISP_DT  ,  
		DMTS_DMT_REQ_RECDT  ,  
		DMTS_DMT_PEND_REASON ,   
		DMTS_DRN_STATUS ,  
		DMTS_DRN_SETUP_DT  ,  
		DMTS_SEC_TYPE_DESC ,  
		DMTS_DRN_CLOSE_DT ,  
		DMTS_NO_CERT ,  
		DMTS_BO_FHNAME  ,  
		DMTS_DRN_REJ_SEQ  ,  
		DMTS_REJ_QTY ,  
		DMTS_REJ_CD  ,  
		DMTS_REJ_REASON,    
		DMTS_DPAM_ID ,  
		DMTS_DPM_ID ,  
		DMTS_CHARGE ,  
		DMTS_DP_CHARGE,
		DMTS_QTYTYP_CD,
		DMTS_QTYTYP_DESC,
		DMTS_LOCKIN_QTY,
		DMTS_LOCKIN_REASONCD,
		DMTS_LOCKIN_REASONDESC   
		)  
		SELECT   
		TMPDS_DMT_REQ_NO,   
		TMPDS_RTA_ID ,  
		TMPDS_DMT_REQ_QTY ,  
		TMPDS_DMT_ACCP_QTY ,  
		TMPDS_DMT_REJ_QTY ,  
		TMPDS_ISIN ,  
		TMPDS_ISIN_SHRT_NM ,  
		TMPDS_AGEING_PERIOD ,  
		TMPDS_DMT_REQ_FRM_NOS ,  
		TMPDS_BO_ID ,  
		TMPDS_DISP_DT  ,  
		TMPDS_DMT_REQ_RECDT  ,  
		TMPDS_DMT_PEND_REASON ,   
		TMPDS_DRN_STATUS,
		TMPDS_DRN_SETUP_DT  ,  
		TMPDS_SEC_TYPE_DESC ,  
		TMPDS_DRN_CLOSE_DT ,  
		TMPDS_NO_CERT ,  
		TMPDS_BO_FHNAME  ,  
		TMPDS_DRN_REJ_SEQ  ,  
		TMPDS_REJ_QTY ,  
		TMPDS_REJ_CD  ,  
		TMPDS_REJ_REASON ,   
		TMPDS_DPAM_ID ,  
		TMPDS_DPM_ID ,  
		TMPDS_CHARGE ,  
		TMPDS_DP_CHARGE,
		TMPDP_QTYTYP_CD,
		TMPDP_QTYTYP_DESC,
		TMPDP_LOCKIN_QTY,
		TMPDP_LOCKIN_REASONCD,
		TMPDP_LOCKIN_REASONDESC   
		FROM  TMP_DMT_SUMMARY A  
		WHERE 
--		NOT EXISTS   
--		(  
--		SELECT DMTS_ISIN,DMTS_BO_ID,DMTS_DRN_SETUP_DT,DMTS_DISP_DT FROM DMT_STATUS_MSTR B   
--		WHERE B.DMTS_ISIN=A.TMPDS_ISIN AND B.DMTS_DPAM_ID=A.TMPDS_DPAM_ID  
--		AND B.DMTS_DRN_SETUP_DT=A.TMPDS_DRN_SETUP_DT AND B.DMTS_DISP_DT=A.TMPDS_DISP_DT  AND B.DMTS_DMT_REQ_NO = A.TMPDS_DMT_REQ_NO
--		AND B.DMTS_DMT_REQ_FRM_NOS = A.TMPDS_DMT_REQ_FRM_NOS
--		)  
--		and 
		isnull(TMPDS_DPAM_ID,0)<>0
		
	END
	ELSE
	BEGIN
		UPDATE DMT_STATUS_MSTR  
		SET DMTS_DRN_STATUS = TMPDS_DRN_STATUS,  		
			DMTS_DRN_CLOSE_DT = TMPDS_DRN_CLOSE_DT,  		
			DMTS_DRN_REJ_SEQ = TMPDS_DRN_REJ_SEQ,  
			DMTS_REJ_QTY = TMPDS_REJ_QTY,  
			DMTS_REJ_CD = TMPDS_REJ_CD,  
			DMTS_REJ_REASON = TMPDS_REJ_REASON,    
			DMTS_QTYTYP_CD = TMPDP_QTYTYP_CD,
			DMTS_QTYTYP_DESC = TMPDP_QTYTYP_DESC,
			DMTS_LOCKIN_QTY = TMPDP_LOCKIN_QTY,
			DMTS_LOCKIN_REASONCD = TMPDP_LOCKIN_REASONCD,
			DMTS_LOCKIN_REASONDESC = TMPDP_LOCKIN_REASONDESC
		FROM DMT_STATUS_MSTR B
		,	 TMP_DMT_SUMMARY A
		WHERE B.DMTS_ISIN=A.TMPDS_ISIN AND B.DMTS_DPAM_ID=A.TMPDS_DPAM_ID  
		AND B.DMTS_DRN_SETUP_DT=A.TMPDS_DRN_SETUP_DT AND B.DMTS_DISP_DT=A.TMPDS_DISP_DT  AND B.DMTS_DMT_REQ_NO = A.TMPDS_DMT_REQ_NO
		AND B.DMTS_DMT_REQ_FRM_NOS = A.TMPDS_DMT_REQ_FRM_NOS
	END
--END BY JITESH

UPDATE Demat_request_mstr 
SET DEMRM_TRANSACTION_NO = TMPDS_DMT_REQ_NO
FROM TMP_DMT_SUMMARY,demat_request_mstr
WHERE DEMRM_DPAM_ID=TMPDS_DPAM_ID AND DEMRM_ISIN=TMPDS_ISIN  
AND DEMRM_REQUEST_DT=TMPDS_DRN_SETUP_DT 
AND DEMRM_SLIP_SERIAL_NO = TMPDS_DMT_REQ_FRM_NOS
AND DEMRM_DELETED_IND = 1 



UPDATE Demat_request_mstr 
SET DEMRM_STATUS = TMPDS_DRN_STATUS,DEMRM_COMPANY_OBJ=TMPDS_REJ_CD,DEMRM_CREDIT_RECD = CASE WHEN TMPDS_DRN_STATUS = '1C' and ltrim(rtrim(isnull(TMPDS_REJ_CD,''))) <> '' then 'Y' else DEMRM_CREDIT_RECD end
FROM TMP_DMT_SUMMARY,demat_request_mstr
WHERE DEMRM_DPAM_ID=TMPDS_DPAM_ID AND DEMRM_ISIN=TMPDS_ISIN  
--AND DEMRM_REQUEST_DT=TMPDS_DRN_SETUP_DT 
AND  DEMRM_SLIP_SERIAL_NO = TMPDS_DMT_REQ_FRM_NOS 
AND  DEMRM_TRANSACTION_NO = TMPDS_DMT_REQ_NO 
AND dEMRM_DELETED_IND = 1 



create table #tmpdemat(id INT identity(1,1),Dpam_id bigint,drn_no varchar(20),drf_no varchar(20),Isin_cd varchar(12),request_dt datetime,Exec_dt datetime,Req_Qty numeric (18,3),Conv_qty numeric(18,3),status_cd varchar(20),certificate_cnt int,rej_cd varchar(10))

insert into #tmpdemat(Dpam_id,drn_no,drf_no,Isin_cd,request_dt,Exec_dt,Req_Qty,Conv_qty,status_cd,certificate_cnt,rej_cd)
select TMPDS_DPAM_ID,TMPDS_DMT_REQ_NO,TMPDS_DMT_REQ_FRM_NOS,TMPDS_ISIN,TMPDS_DRN_SETUP_DT,TMPDS_DRN_CLOSE_DT,TMPDS_DMT_REQ_QTY,TMPDS_DMT_ACCP_QTY,TMPDS_DRN_STATUS,TMPDS_NO_CERT,TMPDS_REJ_CD
from TMP_DMT_SUMMARY 
where not exists(SELECT DEMRM_DPAM_ID,DEMRM_ISIN,DEMRM_EXECUTION_DT 
FROM Demat_request_mstr WHERE DEMRM_DPAM_ID= TMPDS_DPAM_ID AND DEMRM_ISIN=TMPDS_ISIN
AND DEMRM_REQUEST_DT=TMPDS_DRN_SETUP_DT  AND DEMRM_SLIP_SERIAL_NO = TMPDS_DMT_REQ_FRM_NOS AND  DEMRM_TRANSACTION_NO = TMPDS_DMT_REQ_NO  AND DEMRM_DELETED_IND = 1)

SELECT @l_id = ISNULL(MAX(demrm_id),0)+1
FROM demat_request_mstr WITH (NOLOCK)

SELECT @l_id_mak = ISNULL(MAX(demrm_id),0)+1
FROM demrm_mak WITH (NOLOCK)

IF @l_id_mak > @l_id
BEGIN
--
		SET  @l_id = @l_id_mak
--
END



insert into demat_request_mstr(DEMRM_ID,DEMRM_ISIN,DEMRM_DPAM_ID,DEMRM_DRF_NO,DEMRM_SLIP_SERIAL_NO,DEMRM_REQUEST_DT,DEMRM_EXECUTION_DT,DEMRM_RESPONSE_DT,DEMRM_QTY,DEMRM_CONVERTED_QTY,DEMRM_STATUS,DEMRM_RMKS,DEMRM_TOTAL_CERTIFICATES,DEMRM_FREE_LOCKEDIN_YN,DEMRM_LOCKIN_REASON_CD,DEMRM_LOCKIN_RELEASE_DT,DEMRM_CREATED_BY,DEMRM_CREATED_DT,DEMRM_LST_UPD_BY,DEMRM_LST_UPD_DT,DEMRM_DELETED_IND,DEMRM_TRANSACTION_NO,DEMRM_ERRMSG,DEMRM_BATCH_NO,DEMRM_INTERNAL_REJ,DEMRM_COMPANY_OBJ,DEMRM_CREDIT_RECD)
select DEMRM_ID= ISNULL(@l_id,0) + ID,  Isin_cd,    Dpam_id,     ISNULL(@l_id,0) + ID,       drf_no,             EXEC_DT,          EXEC_DT,             '',            Req_Qty,     Conv_qty,          status_cd,  '',       certificate_cnt,           'N',                 '',                       '' ,                  @PA_LOGIN_NAME,Getdate(),       @PA_LOGIN_NAME,  Getdate(),1,                        drn_no,'',                        ISNULL(@l_id,0) + id ,null,rej_cd,case when status_cd = 'C' then 'Y' else 'N' end
from #tmpdemat 
where not exists(SELECT DEMRM_DPAM_ID,DEMRM_ISIN,DEMRM_EXECUTION_DT FROM demat_request_mstr  WHERE DEMRM_DPAM_ID=DPAM_ID AND DEMRM_ISIN=Isin_cd 
AND DEMRM_REQUEST_DT=request_dt AND  DEMRM_SLIP_SERIAL_NO = drf_no AND  DEMRM_TRANSACTION_NO = drn_no  AND DEMRM_DELETED_IND = 1)

TRUNCATE TABLE #tmpdemat
DROP TABLE #tmpdemat

--  
IF EXISTS (SELECT TMPDS_BO_ID,TMPDS_ISIN FROM TMP_DMT_SUMMARY WHERE  ISNULL(TMPDS_DPAM_ID,0)=0)   
  BEGIN  
  --  
     UPDATE FILETASK SET USERMSG= 'ERROR : Following Client Not Mapped ' + citrus_usr.fn_merge_str('DMTS_DP24',0,'')  
     WHERE  task_id = @PA_TASKID  
  --   
  END  
--  
END  
--  
--  
END   
  
IF @PA_TAB='REMAT_STAT'  
--  
BEGIN  
--  
SELECT TOP 1 @L_DPMDPID=LEFT(TMPRS_BO_ID,8) ,@L_DPM_ID=DPM_ID FROM TMP_RMT_SUMMARY,DP_MSTR WHERE   
dpm_dpid = LEFT(TMPRS_BO_ID,8) AND DPM_DELETED_IND=1  
  
  
IF @L_DPM_ID<>''   
--  
BEGIN   
--  
UPDATE T SET T.TMPRS_DPM_ID=@L_DPM_ID,T.TMPRS_DPAM_ID=DPAM_ID, 
TMPRS_STAT_CD = '1' + case when ltrim(rtrim(isnull(TMPRS_STAT_CD,''))) = 'D' then 'DW' else ltrim(rtrim(isnull(TMPRS_STAT_CD,''))) end
FROM TMP_RMT_SUMMARY T,DP_ACCT_MSTR D   
WHERE TMPRS_BO_ID=DPAM_SBA_NO AND DPAM_DELETED_IND=1 AND DPAM_DPM_ID=@L_DPM_ID  

INSERT INTO RMT_STATUS_MSTR  
(  
RMTS_RMT_REQ_NO ,  
RMTS_BO_ID ,  
RMTS_ISIN_ALPHA_CD ,  
RMTS_ISIN_SHRT_NM ,  
RMTS_RMT_REF_NO ,  
RMTS_QTY_REQ_FOR_RMT_NOS ,  
RMTS_RRN_STAT_DESC ,  
RMTS_REC_DT ,  
RMTS_NO_DAYS_ELAPSED ,  
RMTS_SEC_TYPE_DESC ,  
RMTS_BO_NM ,  
RMTS_LOT_TYPE_DESC ,  
RMTS_DENM_NO ,  
RMTS_QTY_TYPE_DESC ,  
RMTS_LOCK_REASON_CD ,  
RMTS_LOCK_REASON_DESC ,  
RMTS_DPAM_ID ,  
RMTS_DPM_ID ,  
RMTS_CHARGE ,  
RMTS_DP_CHARGE,
RMTS_SETUP_DT,
RMTS_CONF_DT,
RMTS_STAT_CD,
RMTS_STAT_DESC,
RMTS_LOCKIN_QTY 
)  
SELECT   
TMPRS_RMT_REQ_NO ,  
TMPRS_BO_ID ,  
TMPRS_ISIN_ALPHA_CD ,  
TMPRS_ISIN_SHRT_NM ,  
TMPRS_RMT_REF_NO ,  
TMPRS_QTY_REQ_FOR_RMT_NOS ,  
TMPRS_RRN_STAT_DESC ,  
TMPRS_REC_DT ,  
TMPRS_NO_DAYS_ELAPSED ,  
TMPRS_SEC_TYPE_DESC ,  
TMPRS_BO_NM ,  
TMPRS_LOT_TYPE_DESC ,  
TMPRS_DENM_NO ,  
TMPRS_QTY_TYPE_DESC ,  
TMPRS_LOCK_REASON_CD ,  
TMPRS_LOCK_REASON_DESC ,  
TMPRS_DPAM_ID ,  
TMPRS_DPM_ID ,  
TMPRS_CHARGE ,  
TMPRS_DP_CHARGE,
TMPRS_SETUP_DT,
TMPRS_CONF_DT,
TMPRS_STAT_CD,
TMPRS_STAT_DESC,
TMPRS_LOCKIN_QTY    
FROM TMP_RMT_SUMMARY A  
WHERE NOT EXISTS  
(  
SELECT RMTS_DPAM_ID,RMTS_ISIN_ALPHA_CD,RMTS_REC_DT FROM RMT_STATUS_MSTR B WHERE B.RMTS_DPAM_ID=A.TMPRS_DPAM_ID AND B.RMTS_ISIN_ALPHA_CD=A.TMPRS_ISIN_ALPHA_CD  
AND B.RMTS_SETUP_DT=A.TMPRS_SETUP_DT  AND RMTS_RMT_REF_NO = TMPRS_RMT_REF_NO AND  RMTS_RMT_REQ_NO = TMPRS_RMT_REQ_NO 
)  
and isnull(TMPRS_DPAM_ID,0)<>0


UPDATE remat_request_mstr 
SET REMRM_TRANSACTION_NO = TMPRS_RMT_REQ_NO
FROM TMP_RMT_SUMMARY,remat_request_mstr
WHERE REMRM_DPAM_ID=TMPRS_DPAM_ID AND REMRM_ISIN=TMPRS_ISIN_ALPHA_CD  
AND REMRM_REQUEST_DT=TMPRS_SETUP_DT AND  REMRM_SLIP_SERIAL_NO = TMPRS_RMT_REF_NO  
AND REMRM_DELETED_IND = 1 



UPDATE remat_request_mstr 
SET REMRM_STATUS = TMPRS_STAT_CD
FROM TMP_RMT_SUMMARY,remat_request_mstr
WHERE REMRM_DPAM_ID=TMPRS_DPAM_ID AND REMRM_ISIN=TMPRS_ISIN_ALPHA_CD  
AND REMRM_EXECUTION_DT=TMPRS_REC_DT AND  REMRM_SLIP_SERIAL_NO = TMPRS_RMT_REF_NO AND  REMRM_TRANSACTION_NO = TMPRS_RMT_REQ_NO 
AND REMRM_DELETED_IND = 1 


---new code to be checked
create table #tmpremat(id INT identity(1,1),Dpam_id bigint,rrn_no varchar(20),rrf_no varchar(20),Isin_cd varchar(12),Request_dt datetime,Exec_dt datetime,Qty numeric (18,3),lot_type varchar(2),Free_locked_yn char(1),lock_rsn_cd varchar(10),lockin_qty numeric(18,3),status_cd varchar(20))

insert into #tmpremat(Dpam_id,rrn_no,rrf_no,Isin_cd,Request_dt,Exec_dt,Qty,lot_type,Free_locked_yn,lock_rsn_cd,lockin_qty,status_cd)
select TMPRS_DPAM_ID,TMPRS_RMT_REQ_NO,TMPRS_RMT_REF_NO,TMPRS_ISIN_ALPHA_CD,TMPRS_SETUP_DT,TMPRS_CONF_DT,TMPRS_QTY_REQ_FOR_RMT_NOS,lot_type=case when TMPRS_LOT_TYPE_DESC ='JUMBO' then 'J' else 'M' end,locked=case when TMPRS_LOCK_REASON_CD <> '00' then 'Y' else 'N' end,TMPRS_LOCK_REASON_CD,TMPRS_LOCKIN_QTY,TMPRS_STAT_CD
from TMP_RMT_SUMMARY 
where not exists(SELECT REMRM_DPAM_ID,REMRM_ISIN,REMRM_EXECUTION_DT FROM remat_request_mstr WHERE REMRM_DPAM_ID=TMPRS_DPAM_ID AND REMRM_ISIN=TMPRS_ISIN_ALPHA_CD  
AND REMRM_EXECUTION_DT=TMPRS_REC_DT  AND REMRM_SLIP_SERIAL_NO = TMPRS_RMT_REF_NO AND  REMRM_TRANSACTION_NO = TMPRS_RMT_REQ_NO  AND REMRM_DELETED_IND = 1)




SELECT @l_id = ISNULL(MAX(remrm_id),0)+1
FROM remat_request_mstr WITH (NOLOCK)

SELECT @l_id_mak = ISNULL(MAX(remrm_id),0)+1
FROM remrm_mak WITH (NOLOCK)

IF @l_id_mak > @l_id
BEGIN
--
		SET  @l_id = @l_id_mak
--
END

insert into remat_request_mstr(REMRM_ID,REMRM_DPAM_ID,REMRM_RRF_NO,REMRM_SLIP_SERIAL_NO,REMRM_REQUEST_DT,REMRM_EXECUTION_DT,REMRM_RESPONSE_DT,REMRM_LOT_TYPE,REMRM_QTY,REMRM_FREE_LOCKEDIN_YN,REMRM_LOCKIN_REASON_CD,REMRM_LOCKIN_REASON_DT,REMRM_CONVERTED_QTY,REMRM_STATUS,REMRM_REJECTION_CD,REMRM_RMKS,REMRM_CERTIFICATE_NO,REMRM_CREATED_BY,REMRM_CREATED_DT,REMRM_LST_UPD_BY,REMRM_LST_UPD_DT,REMRM_DELETED_IND,REMRM_ISIN,REMRM_LOCKIN_QTY,REMRM_TRANSACTION_NO,REMRM_ERRMSG,REMRM_BATCH_NO)
select REMRM_ID= ISNULL(@l_id,0) + ID,Dpam_id,ISNULL(@l_id,0) + ID,rrf_no,REQUEST_DT,EXEC_DT,EXEC_DT,LOT_TYPE,QTY,FREE_LOCKED_YN,LOCK_RSN_CD,LOCKIN_REASON_DT='',CONVERTED_QTY=case when status_cd = '1C' THEN QTY ELSE NULL END,status_cd,NULL,'',1,@PA_LOGIN_NAME,Getdate(),@PA_LOGIN_NAME,Getdate(),1,ISIN_CD,lockin_qty,rrn_no,null, ISNULL(@l_id,0)+id
from #tmpremat 
where not exists(SELECT REMRM_DPAM_ID,REMRM_ISIN,REMRM_EXECUTION_DT FROM remat_request_mstr  WHERE REMRM_DPAM_ID=DPAM_ID AND REMRM_ISIN=Isin_cd  
AND REMRM_EXECUTION_DT = exec_dt  and REMRM_SLIP_SERIAL_NO = rrf_no AND  REMRM_TRANSACTION_NO = rrn_no  AND REMRM_DELETED_IND = 1)






/*
UPDATE remat_request_mstr 
SET REMRM_STATUS = TMPRS_RRN_STAT_DESC
FROM TMP_RMT_SUMMARY,remat_request_mstr
WHERE REMRM_DPAM_ID=TMPRS_DPAM_ID AND REMRM_ISIN=TMPRS_ISIN_ALPHA_CD  
AND REMRM_EXECUTION_DT=TMPRS_REC_DT AND  REMRM_SLIP_SERIAL_NO = TMPRS_RMT_REF_NO AND  REMRM_RRF_NO = TMPRS_RMT_REQ_NO 
AND REMRM_DELETED_IND = 1 

create table #tmpremat(id INT identity(1,1),Dpam_id bigint,rrn_no varchar(20),rrf_no varchar(20),Isin_cd varchar(12),Exec_dt datetime,Qty numeric (18,3),lot_type varchar(2),Free_locked_yn char(1),lock_rsn_cd varchar(10),status_cd varchar(20))

insert into #tmpremat(Dpam_id,rrn_no,rrf_no,Isin_cd,Exec_dt,Qty,lot_type,Free_locked_yn,lock_rsn_cd,status_cd)
select TMPRS_DPAM_ID,TMPRS_RMT_REQ_NO,TMPRS_RMT_REF_NO,TMPRS_ISIN_ALPHA_CD,TMPRS_REC_DT,TMPRS_QTY_REQ_FOR_RMT_NOS,lot_type=case when TMPRS_LOT_TYPE_DESC ='JUMBO' then 'J' else 'M' end,locked=case when TMPRS_LOCK_REASON_CD <> '00' then 'Y' else 'N' end,TMPRS_LOCK_REASON_CD,TMPRS_RRN_STAT_DESC =CASE WHEN TMPRS_RRN_STAT_DESC <> '' THEN TMPRS_RRN_STAT_DESC ELSE TMPRS_RRN_STAT_DESC END
from TMP_RMT_SUMMARY 
where not exists(SELECT REMRM_DPAM_ID,REMRM_ISIN,REMRM_EXECUTION_DT FROM remat_request_mstr WHERE REMRM_DPAM_ID=TMPRS_DPAM_ID AND REMRM_ISIN=TMPRS_ISIN_ALPHA_CD  
AND REMRM_EXECUTION_DT=TMPRS_REC_DT  AND REMRM_SLIP_SERIAL_NO = TMPRS_RMT_REF_NO AND  REMRM_RRF_NO = TMPRS_RMT_REQ_NO  AND REMRM_DELETED_IND = 1)




SELECT @l_id = ISNULL(MAX(remrm_id),0)+1
FROM remat_request_mstr WITH (NOLOCK)

SELECT @l_id_mak = ISNULL(MAX(remrm_id),0)+1
FROM remrm_mak WITH (NOLOCK)

IF @l_id_mak > @l_id
BEGIN
--
		SET  @l_id = @l_id_mak
--
END

insert into remat_request_mstr(REMRM_ID,REMRM_DPAM_ID,REMRM_RRF_NO,REMRM_SLIP_SERIAL_NO,REMRM_REQUEST_DT,REMRM_EXECUTION_DT,REMRM_RESPONSE_DT,REMRM_LOT_TYPE,REMRM_QTY,REMRM_FREE_LOCKEDIN_YN,REMRM_LOCKIN_REASON_CD,REMRM_LOCKIN_REASON_DT,REMRM_CONVERTED_QTY,REMRM_STATUS,REMRM_REJECTION_CD,REMRM_RMKS,REMRM_CERTIFICATE_NO,REMRM_CREATED_BY,REMRM_CREATED_DT,REMRM_LST_UPD_BY,REMRM_LST_UPD_DT,REMRM_DELETED_IND,REMRM_ISIN,REMRM_LOCKIN_QTY,REMRM_TRANSACTION_NO,REMRM_ERRMSG,REMRM_BATCH_NO)
select REMRM_ID= ISNULL(@l_id,0) + ID,Dpam_id,rrn_no,rrf_no,EXEC_DT,EXEC_DT,'',LOT_TYPE,QTY,FREE_LOCKED_YN,LOCK_RSN_CD,LOCKIN_REASON_DT='',CONVERTED_QTY=case when RMTS_RRN_STAT_DESC = 'SUCCESS' THEN QTY ELSE NULL END,status_cd,NULL,'',1,@PA_LOGIN_NAME,Getdate(),Getdate(),@PA_LOGIN_NAME,1,ISIN_CD,NULL,rrn_no,null, ISNULL(@l_id,0)+id
from #tmpremat 
where not exists(SELECT REMRM_DPAM_ID,REMRM_ISIN,REMRM_EXECUTION_DT FROM remat_request_mstr  WHERE REMRM_DPAM_ID=TMPRS_DPAM_ID AND REMRM_ISIN=TMPRS_ISIN_ALPHA_CD  
AND REMRM_EXECUTION_DT=TMPRS_REC_DT AND  REMRM_SLIP_SERIAL_NO = TMPRS_RMT_REF_NO AND  rrf_no = TMPRS_RMT_REQ_NO  AND REMRM_DELETED_IND = 1)

*/
--  
IF EXISTS (SELECT TMPRS_BO_ID,TMPRS_ISIN_ALPHA_CD FROM TMP_RMT_SUMMARY WHERE  ISNULL(TMPRS_DPAM_ID,0)=0)   
  BEGIN  
  --  
     UPDATE FILETASK SET USERMSG= 'ERROR : Following Client Not Mapped ' + citrus_usr.fn_merge_str('RMTS_DP27',0,'')  
     WHERE  task_id = @PA_TASKID  
  --   
  END  
--  
--  
END  
--  
END   
  
  
END

GO
