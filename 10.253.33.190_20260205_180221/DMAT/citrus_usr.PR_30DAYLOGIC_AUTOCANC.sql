-- Object: PROCEDURE citrus_usr.PR_30DAYLOGIC_AUTOCANC
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------


--EXEC PR_30DAYLOGIC_AUTOCANC ''
CREATE  PROCEDURE PR_30DAYLOGIC_AUTOCANC
(
@LOGINNAME VARCHAR(30)
)
AS
BEGIN
DECLARE @L_USES_MAXID INT
SELECT @L_USES_MAXID=MAX(USES_ID)+1 FROM USED_SLIP_BLOCK WHERE USES_DELETED_IND=1



SELECT  IDENTITY(INT,1,1) ID, SLIIM_DPM_ID USES_DPM_ID,SLIIM_DPAM_ACCT_NO USES_DPAM_ACCT_NO,SLIIM_SLIP_NO_FR USES_SLIP_NO,
SLIIM_SLIP_NO_TO USES_SLIP_NO_to,SLIIM_TRATM_ID USES_TRANTM_ID,'' USES_SERIES_TYPE,'' USES_USED_DESTR,'MIG' USES_CREATED_BY,GETDATE() USES_CREATED_DT, 
'MIG' USES_LST_UPD_BY,GETDATE() USES_LST_UPD_DT, 1 USES_DELETED_IND ,'' USES_SLIPREMARKS,'' USES_BATCH_NO,
'DP' USES_TRX_INITIATION_FLAG,'CANCELLATION DUE TO OTHER REASONS' USES_DIS_CANCELLATION_FLAG,GETDATE() 
USES_CANCELLATION_DT
,NULL USED_BOOK_NAME,'B' USED_ENTITY_TYPE,NULL USES_SUCCESS_FLAG,NULL USES_ERROR_CODE INTO  #TMP
FROM SLIP_ISSUE_MSTR WHERE   SLIIM_DELETED_IND=1
AND SLIIM_SERIES_TYPE='' AND ISNULL(SLIIM_EXPIRY_DATE,'')<>'' 
AND  CONVERT(VARCHAR(11),GETDATE(),109) =CONVERT(VARCHAR(11),SLIIM_EXPIRY_DATE,109) 

INSERT INTO USED_SLIP_BLOCK
SELECT @L_USES_MAXID+ID,USES_DPM_ID,
USES_DPAM_ACCT_NO,
USES_SLIP_NO,
USES_SLIP_NO_TO,
USES_TRANTM_ID,
USES_SERIES_TYPE,
USES_USED_DESTR,
USES_CREATED_BY,
USES_CREATED_DT,
USES_LST_UPD_BY,
USES_LST_UPD_DT,
USES_DELETED_IND,
USES_SLIPREMARKS,
USES_BATCH_NO,
USES_TRX_INITIATION_FLAG,
USES_DIS_CANCELLATION_FLAG,
USES_CANCELLATION_DT,
USED_BOOK_NAME,
USED_ENTITY_TYPE,
USES_SUCCESS_FLAG,
USES_ERROR_CODE FROM #TMP O
where  NOT EXISTS (SELECT USES_ID FROM USED_SLIP_BLOCK I  WHERE USES_DELETED_IND=1
AND O.USES_SLIP_NO_TO=I.USES_SLIP_NO_TO AND  O.USES_SLIP_NO_TO=I.USES_SLIP_NO_TO
AND O.USES_DPAM_ACCT_NO=I.USES_DPAM_ACCT_NO)


END

GO
