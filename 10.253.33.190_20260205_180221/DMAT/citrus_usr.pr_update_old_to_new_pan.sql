-- Object: PROCEDURE citrus_usr.pr_update_old_to_new_pan
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

-- EXEC PR_UPDATE_OLD_TO_NEW_PAN '1203320116508397','BXOPV9519D' , 'AJZPV5381P','1'
CREATE  PROCEDURE PR_UPDATE_OLD_TO_NEW_PAN
(  @PA_BOID VARCHAR (16),
@PA_OLD_PAN VARCHAR (10),
@PA_NEW_PAN VARCHAR (10),
@PA_HOLDER VARCHAR (1))

AS 
 

INSERT INTO DPS8_PC1_BAK_DND_NEW 
SELECT * , 'PAN UPDATE ' , GETDATE ()  FROM DPS8_PC1 WHERE BOID  =@PA_BOID

INSERT INTO DPS8_PC2_BAK_DND_NEW 
SELECT * , 'PAN UPDATE ' , GETDATE ()   FROM DPS8_PC2 WHERE BOID  =@PA_BOID

DECLARE @PA_ERRMSG VARCHAR (8000),
@PA_CRN_NUMBER VARCHAR (11),
@PA_DPAM_ID VARCHAR (11)


	SELECT @PA_CRN_NUMBER = DPAM_CRN_NO , @PA_DPAM_ID = DPAM_ID    FROM DP_ACCT_MSTR WHERE DPAM_SBA_NO =@PA_BOID 

	--PRINT  @PA_CRN_NUMBER
	--PRINT @PA_DPAM_ID 

IF @PA_HOLDER = 1  
BEGIN 
		 
		 IF     @PA_OLD_PAN = @PA_NEW_PAN
		 BEGIN  
 
		  SET @PA_ERRMSG =  'OLD AND NEW PAN ARE SAME, PLEASE PROVIDE CORRECT PAN DETAILS' 
		   SELECT @PA_ERRMSG       
		  RETURN          
		 END  

		IF NOT EXISTS (SELECT 1 FROM  DP_ACCT_MSTR WHERE DPAM_SBA_NO =@PA_BOID    )    
		 BEGIN  
 
		  SET @PA_ERRMSG =  'BOID' +' : '+ @PA_BOID+'  NOT FOUND, PLEASE RECHECK'
		   SELECT @PA_ERRMSG       
		  RETURN          
		 END  
 

		IF  EXISTS (SELECT 1 FROM  DP_ACCT_MSTR WHERE DPAM_SBA_NO =@PA_BOID   AND DPAM_STAM_CD <> 'ACTIVE' )    
		 BEGIN  
 
		  SET @PA_ERRMSG =  'ACCOUNT IS CLOSED, NO FUTHER ACTION REQUIRED'
		   SELECT @PA_ERRMSG       
		  RETURN          
		 END  
 

		IF  EXISTS (SELECT 1 FROM  ENTITY_PROPERTIES WHERE ENTP_VALUE <>  @PA_OLD_PAN  AND ENTP_ENTPM_CD = 'PAN_GIR_NO'  AND ENTP_ENT_ID = @PA_CRN_NUMBER)    
		 BEGIN  
			PRINT 'OLD'
		  SET @PA_ERRMSG =  'OLD PAN NOT MATCH'
		   SELECT @PA_ERRMSG       
		  RETURN          
		 END  
 

			
			 IF  EXISTS (SELECT 1 FROM  ENTITY_PROPERTIES WHERE ENTP_VALUE =  @PA_OLD_PAN  AND ENTP_ENTPM_CD = 'PAN_GIR_NO'  AND ENTP_ENT_ID = @PA_CRN_NUMBER) 
					 BEGIN 
  
					UPDATE  DPS8_PC1 SET  PANGIR = @PA_NEW_PAN WHERE BOID  =@PA_BOID AND PANGIR = @PA_OLD_PAN
					UPDATE  ENTITY_PROPERTIES SET ENTP_VALUE = @PA_NEW_PAN WHERE ENTP_ENT_ID  = @PA_CRN_NUMBER  AND ENTP_ENTPM_CD = 'PAN_GIR_NO' AND ENTP_VALUE = @PA_OLD_PAN
							 BEGIN  
       
							  SET @PA_ERRMSG =  'ACTION SUCCESSFULLY PERFORM'
							   SELECT @PA_ERRMSG       
         
							 END 
					 END 
			
END 

IF @PA_HOLDER = 2
		
		BEGIN 

			 IF     @PA_OLD_PAN = @PA_NEW_PAN
			 BEGIN  
 
			  SET @PA_ERRMSG =  'OLD AND NEW PAN ARE SAME, PLEASE PROVIDE CORRECT PAN DETAILS' 
			   SELECT @PA_ERRMSG       
			  RETURN          
			 END  

			IF NOT EXISTS (SELECT 1 FROM  DP_ACCT_MSTR WHERE DPAM_SBA_NO =@PA_BOID    )    
				 BEGIN  
 
				  SET @PA_ERRMSG =  'BOID' +' : '+ @PA_BOID+'  NOT FOUND, PLEASE RECHECK'
				   SELECT @PA_ERRMSG       
				  RETURN          
				 END  

			IF NOT EXISTS (SELECT 1 FROM  DPS8_PC2 WHERE BOID  =@PA_BOID    )    
			BEGIN  
 
				  SET @PA_ERRMSG =  'SECOND HOLDER IS NOT PRESENT'+' : '+ @PA_BOID
				   SELECT @PA_ERRMSG       
				  RETURN          
				 END  

			IF  EXISTS (SELECT 1 FROM  DP_ACCT_MSTR WHERE DPAM_SBA_NO =@PA_BOID   AND DPAM_STAM_CD <> 'ACTIVE' )    
				 BEGIN  
 
				  SET @PA_ERRMSG =  'ACCOUNT IS CLOSED, NO FUTHER ACTION REQUIRED'
				   SELECT @PA_ERRMSG       
				  RETURN          
				 END  
 
 --SELECT DPHD_SH_PAN_NO FROM DP_HOLDER_DTLS  WHERE DPHD_DPAM_ID IN(SELECT DPAM_ID   FROM DP_ACCT_MSTR WHERE DPAM_SBA_NO ='1203320069178309') 
			IF  EXISTS (SELECT 1 FROM  DP_HOLDER_DTLS WHERE DPHD_SH_PAN_NO <>  @PA_OLD_PAN  AND DPHD_DPAM_ID = @PA_DPAM_ID  )    
				 BEGIN  
 
				  SET @PA_ERRMSG =  'OLD PAN NOT MATCH'
				   SELECT @PA_ERRMSG       
				  RETURN          
				 END  


			 IF  EXISTS (SELECT 1 FROM  DP_HOLDER_DTLS WHERE DPHD_SH_PAN_NO =  @PA_OLD_PAN  AND DPHD_DPAM_ID = @PA_DPAM_ID  )  
				BEGIN 

				UPDATE  DPS8_PC2 SET  PANGIR = @PA_NEW_PAN WHERE BOID  = @PA_BOID AND  PANGIR =@PA_OLD_PAN
				
				UPDATE DP_HOLDER_DTLS
				SET DPHD_SH_PAN_NO = @PA_NEW_PAN 
				WHERE DPHD_DPAM_ID  =@PA_DPAM_ID 
				AND DPHD_SH_PAN_NO = @PA_OLD_PAN

							BEGIN  
       
							  SET @PA_ERRMSG =  'ACTION SUCCESSFULLY PERFORM'
							   SELECT @PA_ERRMSG       
         
							 END 

				END 

		 END

GO
