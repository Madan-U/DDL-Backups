-- Object: PROCEDURE citrus_usr.SLIP_NO
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

 

CREATE PROC [CITRUS_USR].[SLIP_NO] ( @SLIPNO  VARCHAR(20) )
AS

DECLARE @COUNT INT
 

 --SELECT @COUNT =LEN(@SLIPNO)

 -- IF @COUNT < 9
 --  BEGIN 

 --    SELECT 'PLEASE ENTER VALID SLIP NO!' AS RESULT ,0 AS FLAG    
 -- END


SELECT @COUNT = COUNT(*) FROM SLIP_ISSUE_MSTR  WHERE  CONVERT(NUMERIC,@SLIPNO) BETWEEN   SLIIM_SLIP_NO_FR AND     SLIIM_SLIP_NO_TO AND SLIIM_DELETED_IND=1 
AND SLIIM_EXPIRY_DATE<=GETDATE()
AND ISNULL(SLIIM_SUCCESS_FLAG,'')=''
 
 IF @COUNT >=1
  BEGIN 
   SELECT 'THIS IS OLD SLIP AND IT IS BLOCKED NOW!' AS RESULT ,0 AS FLAG    

     RETURN      
  END  

SELECT @COUNT = COUNT(1) FROM SEBIOLDSLIPDATA WHERE CONVERT(NUMERIC,@SLIPNO) BETWEEN SLIIM_SLIP_NO_FR AND SLIIM_SLIP_NO_TO
IF @COUNT >=1
 BEGIN 

 SELECT 'AS PER SEBI CIRCULAR DIS WAS BLOCKED'  AS RESULT ,0 AS FLAG          
 
RETURN 
END 


DECLARE @COUNT1 INT

 SELECT @COUNT1=COUNT(*)    FROM SLIP_ISSUE_MSTR  WHERE   CONVERT(NUMERIC,@SLIPNO)  BETWEEN   SLIIM_SLIP_NO_FR AND     SLIIM_SLIP_NO_TO AND SLIIM_DELETED_IND=1  
AND ISNULL(SLIIM_EXPIRY_DATE,'JAN  1 1900')<=GETDATE()
AND ISNULL(SLIIM_SUCCESS_FLAG,'')<>''

 IF @COUNT1=0
  BEGIN 
   SELECT 'SLIP NUMBER DOES NOT EXIT'  AS RESULT ,0 AS FLAG       
     
     RETURN      
  END  

DECLARE @ACCOUNTNO  VARCHAR(20)
DECLARE @DPID  VARCHAR(20)

SELECT @ACCOUNTNO=RIGHT(SLIIM_DPAM_ACCT_NO,8)  FROM SLIP_ISSUE_MSTR  WHERE  CONVERT(NUMERIC, @SLIPNO) BETWEEN   SLIIM_SLIP_NO_FR AND     SLIIM_SLIP_NO_TO AND SLIIM_DELETED_IND=1 
AND ISNULL(SLIIM_EXPIRY_DATE,'JAN  1 1900')<=GETDATE()
AND ISNULL(SLIIM_SUCCESS_FLAG,'')<>''
 
 SET @DPID = @ACCOUNTNO

        
 SELECT @COUNT1 =COUNT(FRE_DPAM_ID)   
     FROM  FREEZE_UNFREEZE_DTLS   
         , DP_ACCT_MSTR   
     WHERE DPAM_ID = FRE_DPAM_ID   
     AND RIGHT(DPAM_SBA_NO,8) = @ACCOUNTNO   
     AND DPAM_DELETED_IND = 1 AND LEFT(DPAM_SBA_NO ,8) = @DPID  
     AND FRE_DELETED_IND = 1 AND FRE_ACTION<>'U' AND FRE_ISIN_CODE=''
 IF @COUNT1 >0
    BEGIN          
 SELECT ISNULL(@ACCOUNTNO,'') + ': ACCOUNT FREEZED'  AS RESULT ,0 AS FLAG            
   
  RETURN        
    END     

     
SELECT @COUNT1 =COUNT(BLACM_PAN )  
     FROM  BLACKLISTED_CLIENT_MSTR   
         , DP_ACCT_MSTR , ENTITY_PROPERTIES  
     WHERE ENTP_ENT_ID = DPAM_CRN_NO  
     AND ENTP_ENTPM_CD ='PAN_GIR_NO'  
     AND ENTP_VALUE = BLACM_PAN  
     AND RIGHT(DPAM_SBA_NO,8) = @ACCOUNTNO   
     AND DPAM_DELETED_IND = 1   
      AND BLACM_DELETED_IND = 1   
 IF @COUNT1 >0 
    BEGIN          
  SELECT ISNULL(@ACCOUNTNO,'') + ': ACCOUNT BANNED'  AS RESULT ,0 AS FLAG            
  
  RETURN        
    END     

 SELECT @COUNT1 =COUNT(USES_SLIP_NO)
     FROM  USED_SLIP
         , DP_ACCT_MSTR   
     WHERE RIGHT(DPAM_SBA_NO,8) =  @ACCOUNTNO
	   AND RIGHT(DPAM_SBA_NO,8)=RIGHT(USES_DPAM_ACCT_NO ,8) 
     AND DPAM_DELETED_IND = 1  
     AND USES_SLIP_NO =@SLIPNO

 IF @COUNT1 >0 
    BEGIN          
  SELECT ISNULL(@SLIPNO,'') + ': SLIP ALREADY USED'  AS RESULT ,0 AS FLAG            
   
  RETURN        
    END     



       
SELECT RESULT=SLIIM_DPAM_ACCT_NO ,1 AS FLAG       FROM SLIP_ISSUE_MSTR  WHERE   CONVERT(NUMERIC,@SLIPNO) BETWEEN   SLIIM_SLIP_NO_FR AND     SLIIM_SLIP_NO_TO AND SLIIM_DELETED_IND=1  
AND ISNULL(SLIIM_EXPIRY_DATE,'JAN  1 1900')<=GETDATE()
AND ISNULL(SLIIM_SUCCESS_FLAG,'')<>''

GO
