-- Object: PROCEDURE citrus_usr.PR_IMPORT_CUDM
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------


--BEGIN TRAN
--EXEC PR_IMPORT_CUDM 'CDSL','HO','BULK','D:\BULKINSDBFOLDER_CDSL\UCC_DTLS_MAPPING\BLNG011903_UCC_DATA.LST', '*|~*'  ,'|*~|' ,''   
--ROLLBACK
--SELECT * FROM TEMP_CDSL_UCC_DTLS
--SELECT * FROM CDSL_UCC_DTLS_MSTR
CREATE PROCEDURE [citrus_usr].[PR_IMPORT_CUDM]
(@PA_EXCH          VARCHAR(20)              
,@PA_LOGIN_NAME    VARCHAR(20)              
,@PA_MODE          VARCHAR(10)                                              
,@PA_DB_SOURCE     VARCHAR(250)              
,@ROWDELIMITER     CHAR(4) =     '*|~*'                
,@COLDELIMITER     CHAR(4) =     '|*~|'                
,@PA_ERRMSG        VARCHAR(8000) OUTPUT )            
AS 
BEGIN 
  
TRUNCATE TABLE TEMP_CDSL_UCC_DTLS
DECLARE @@SSQL  VARCHAR(8000)

SET @@SSQL ='BULK INSERT TEMP_CDSL_UCC_DTLS	 FROM ''' + @PA_DB_SOURCE + ''' WITH 
(
FIELDTERMINATOR = ''~'',
ROWTERMINATOR = ''0X0A''
)'

EXEC(@@SSQL)

BEGIN TRANSACTION
DECLARE @L_MASTER NUMERIC,@L_MAKER NUMERIC , @L_CUDM_ID NUMERIC
SELECT @L_MASTER=ISNULL(MAX(CUDM_ID),'0') FROM CDSL_UCC_DTLS_MSTR
SELECT @L_MAKER=ISNULL(MAX(CUDM_ID),'0') FROM CDSL_UCC_DTLS_MAK

IF @L_MASTER>@L_MAKER
BEGIN
SET @L_CUDM_ID=@L_MASTER
END 
ELSE
BEGIN
SET @L_CUDM_ID=@L_MAKER
END
 

SELECT 
IDENTITY(INT,1,1) ID
,TCUD_BOID
,TCUD_UCC
,TCUD_EXID=case when TCUD_EXID='11' then '02' when TCUD_EXID='12' then '01' when TCUD_EXID='29' then '03' else TCUD_EXID end
,TCUD_CMID
,TCUD_TMCD
,TCUD_SEGID
,TCUD_LINKSTATUS
,'' CONSENTFLG
, DPAM_ID
,@PA_LOGIN_NAME CREATEDBY
,GETDATE() CREATEDDT
,@PA_LOGIN_NAME LSTUPDBY
,GETDATE() LSTUPDDT
,1 DELIND
,@L_CUDM_ID CUDMID
INTO #TMP
FROM TEMP_CDSL_UCC_DTLS,DP_ACCT_MSTR WHERE DPAM_SBA_NO=TCUD_BOID AND DPAM_DELETED_IND=1
AND NOT EXISTS 
(
SELECT 1 FROM CDSL_UCC_DTLS_MSTR WHERE CUDM_BOID=TCUD_BOID  
AND CUDM_EXID=TCUD_EXID AND CUDM_CMID=TCUD_CMID AND CUDM_TMCD=TCUD_TMCD AND CUDM_SEGID=TCUD_SEGID

)

AND ISNUMERIC(TCUD_BOID)=1



UPDATE #TMP SET CUDMID=CUDMID+ID  FROM #TMP 

 

INSERT INTO CDSL_UCC_DTLS_MSTR
(
CUDM_ID
,CUDM_BOID
,CUDM_UCC
,CUDM_EXID
,CUDM_CMID
,CUDM_TMCD
,CUDM_SEGID
,CUDM_LINKSTATUS
,CUDM_CONSENTFLG
,CUDM_DPAM_ID
,CUDM_CREATED_BY
,CUDM_CREATED_DT
,CUDM_LST_UPD_BY
,CUDM_LST_UPD_DT
,CUDM_DELETED_IND
)
SELECT CUDMID
,TCUD_BOID
,TCUD_UCC
,TCUD_EXID
,TCUD_CMID
,TCUD_TMCD
,TCUD_SEGID
,TCUD_LINKSTATUS
, CONSENTFLG
, DPAM_ID
, CREATEDBY
, CREATEDDT
,LSTUPDBY
,LSTUPDDT
, DELIND

FROM #TMP

where  NOT EXISTS 
(
SELECT 1 FROM CDSL_UCC_DTLS_MSTR WHERE CUDM_BOID=TCUD_BOID  
AND CUDM_EXID=TCUD_EXID AND CUDM_CMID=TCUD_CMID AND CUDM_TMCD=TCUD_TMCD AND CUDM_SEGID=TCUD_SEGID
)
COMMIT TRANSACTION
DECLARE @L_ERROR VARCHAR(200)
,@T_ERRORSTR VARCHAR(200)

SET @L_ERROR = @@ERROR
IF @L_ERROR <> 0
BEGIN
SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': CAN NOT PROCESS, PLEASE CONTACT YOUR ADMINISTRATOR!'
END
ELSE
BEGIN
SELECT @T_ERRORSTR = ''
END

SET @PA_ERRMSG=@T_ERRORSTR



insert into dps8_pc22
select '22','A',CONVERT(VARCHAR(1),CUDM_LINKSTATUS) ,'A',case when CUDM_EXID='02' then '11' when CUDM_EXID='01' then '12' when CUDM_EXID='03' then '29' else CUDM_EXID end
,CONVERT(VARCHAR(11),CUDM_UCC),CUDM_SEGID,CONVERT(VARCHAR(11),CUDM_CMID),CONVERT(VARCHAR(8),CUDM_TMCD) ,DPAM_SBA_NO ,'' 
FROM CDSL_UCC_DTLS_MSTR, DP_ACCT_MSTR 
WHERE CUDM_DPAM_ID = DPAM_ID AND CUDM_DELETED_IND = 1 AND DPAM_DELETED_IND=1 
AND NOT EXISTS (SELECT 1 FROM dps8_pc22 WHERE BOID = DPAM_SBA_NO 
AND EXCHANGE_ID = case when CUDM_EXID='02' then '11' when CUDM_EXID='01' then '12' when CUDM_EXID='03' then '29' else CUDM_EXID end 
AND CUDM_SEGID =  SEGMENT_CODE 
and UCC  = CUDM_UCC 
and CM_ID = CUDM_CMID
and TM_CODE  = CUDM_TMCD

)


END

GO
