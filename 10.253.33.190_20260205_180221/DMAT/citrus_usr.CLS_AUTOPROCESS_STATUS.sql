-- Object: PROCEDURE citrus_usr.CLS_AUTOPROCESS_STATUS
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

create PROC [citrus_usr].[CLS_AUTOPROCESS_STATUS]          
(          
 @STATUSID VARCHAR(50),          
 @STATUSNAME VARCHAR(50),          
 @FROMDATE VARCHAR(11),          
 @TODATE  VARCHAR(11),          
 @FROMPARTY VARCHAR(10),          
 @TOPARTY VARCHAR(10),          
 @FROMSCRIP VARCHAR(12)='',          
 @TOSCRIP VARCHAR(12)='',          
 @OPT VARCHAR(20)=''        
)         
      
as      
-- EXEC CLS_AUTOPROCESS_STATUS 'BROKER', 'BROKER', 'JAN  6 2015', 'JAN  6 2015', '', '', '', '', ''      
OPEN SYMMETRIC KEY   Key4CertAutoProcess      
     DECRYPTION BY   CERTIFICATE CertAutoProcess       
      
SELECT SNO, PROCESS_DATE=CONVERT(VARCHAR,PROCESS_DATE,103),      
BUSINESS_DATE=CONVERT(VARCHAR,BUSINESS_DATE,103),EXCHANGE,SEGMENT,PROCESS_FOR,      
SETT_NO,SETT_TYPE,      
PROCESS_START_DATE=CONVERT(VARCHAR,PROCESS_START_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_START_DATE,108),      
PROCESS_STARTED_DATE=CONVERT(VARCHAR,PROCESS_STARTED_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_STARTED_DATE,108),      
PROCESS_END_DATE=CONVERT(VARCHAR,PROCESS_END_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_END_DATE,108),      
PROCESS_ENDED_DATE=CONVERT(VARCHAR,PROCESS_ENDED_DATE,103) + ' ' + CONVERT(VARCHAR,PROCESS_ENDED_DATE,108),      
PROCESS_FILE_NAME = PRADNYA.DBO.fn_CLASS_Auto_Process_Replace(MSAJAG.DBO.FN_DATA_DECRYPT('MKTTECH.IN',PROCESS_FILE_NAME),BUSINESS_DATE,MEMBERCODE,D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),      
PROCESS_STATUS=(CASE WHEN PROCESS_STATUS = 100 THEN 'COMPLETTED'      
      WHEN PROCESS_STATUS = 0 THEN 'NOT YET STARTED'       
         WHEN PROCESS_STATUS = 99 THEN 'IN - PROCESS'      
      ELSE 'HALTED DUE TO SOME ERROR'      
    END),REMARK = PROCESS_HALTED_REASON      
FROM TBL_AUTO_PROCESS_detail d (Nolock), owner      
WHERE BUSINESS_DATE >= @FROMDATE      
AND BUSINESS_DATE <= @TODATE    
and 1 = (case when @OPT = '' then 1    
     when @opt = 'A' then 1    
     When @opt = 'P' and PROCESS_STATUS < 99 then 1    
     When @opt = 'C' and PROCESS_STATUS = 100 then 1      
     When @opt = 'I' and PROCESS_STATUS = 99 then 1    
   ELSE 2 END)    
ORDER BY SNO      
CLOSE SYMMETRIC KEY   Key4CertAutoProcess;

GO
