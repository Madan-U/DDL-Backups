-- Object: PROCEDURE citrus_usr.PR_BATCH_RESET_FOR_MARGIN_PLEDGE
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------


CREATE  PROCEDURE [citrus_usr].[PR_BATCH_RESET_FOR_MARGIN_PLEDGE]  
(  
@PA_ID INTEGER,  
@PA_BATCHNO VARCHAR(20),  
@PA_BATCHTYPE VARCHAR(16),  
@PA_TYPE CHAR(50),  
@PA_TRXTYPE VARCHAR(50),
@PA_TRXTYPECDSL VARCHAR(10),  
@PA_ERRMSG VARCHAR(8000) OUTPUT    
)  
AS   
DECLARE @L_DPM_ID INTEGER,  
 @L_ERROR         BIGINT,  
 @T_ERRORSTR VARCHAR(8000) 

SET @L_ERROR=0  
SELECT @L_DPM_ID  =  DPM_ID FROM DP_MSTR WHERE DEFAULT_DP = @PA_ID  AND DPM_DELETED_IND = 1  

BEGIN   

BEGIN TRANSACTION  

  
IF @PA_BATCHTYPE='NSDL'  
BEGIN--1  
	IF @PA_TYPE = 'MARGIN PLEDGE'
	BEGIN
		--SELECT * FROM NSDL_MARGINPLEDGE_DTLS --NMpledgeD_mak
		UPDATE NSDL_MARGINPLEDGE_DTLS SET PLDTM_BATCH_NO = NULL 
		WHERE PLDTM_BATCH_NO = @PA_BATCHNO 
		AND PLDTM_DELETED_IND = 1 
		AND UPPER(PLDTM_TRASTM_CD) = 'CREATEMP'

		UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND = 9, BATCHN_STATUS = 'C' WHERE BATCHN_NO = @PA_BATCHNO AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T'
	END
END
ELSE IF @PA_BATCHTYPE='CDSL'  
BEGIN  
	IF @PA_TYPE = 'MARGIN PLEDGE'
	BEGIN
		--SELECT * FROM CDSL_MARGINPLEDGE_DTLS --CMPLEDGED_MAK

		UPDATE CDSL_MARGINPLEDGE_DTLS SET PLDTCM_BATCH_NO = NULL 
		WHERE PLDTCM_BATCH_NO = @PA_BATCHNO 
		AND PLDTCM_DELETED_IND = 1 
		AND UPPER(PLDTCM_TRASTM_CD) = 'CRTEMP'

		
UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND = 9, BATCHC_STATUS = 'C' 
WHERE BATCHC_NO = @PA_BATCHNO AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='C'

	END
END
SET @L_ERROR = @@ERROR  
IF @L_ERROR <> 0   
BEGIN  
		  IF EXISTS(SELECT ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = @L_ERROR)  
		  BEGIN  
		  --  
			SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': '+ ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = CONVERT(VARCHAR,@L_ERROR)  
		  --  
		  END  
		  ELSE  
		  BEGIN  
		  --  
			SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': CAN NOT PROCESS, PLEASE CONTACT YOUR ADMINISTRATOR!'  
		  --  
				END  
  
		  ROLLBACK TRANSACTION   
		  END  
		  ELSE  
		  BEGIN   
			  COMMIT TRANSACTION  
			  IF ISNULL(@T_ERRORSTR,'') = ''  
			  SELECT @T_ERRORSTR = 'PROCESS DONE SUCCESSFULLY'  
		  END  
		 SET @PA_ERRMSG = @T_ERRORSTR  
END

GO
