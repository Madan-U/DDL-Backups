-- Object: PROCEDURE citrus_usr.PR_BATCH_RESET
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

--begin tran
----[PR_BATCH_RESET] 3,'600033','cdsl','T','CDSL_BTCH_DMAT_CURNO','DMAT',''.
--	[PR_BATCH_RESET] 3,'600037','CDSL','T','CDSL_BTCH_DMAT_CURNO','DMAT',''	
--rollback
CREATE PROCEDURE [citrus_usr].[PR_BATCH_RESET]  
(  
@PA_ID INTEGER,  
@PA_BATCHNO VARCHAR(20),  
@PA_BATCHTYPE  VARCHAR(6),  
@PA_TYPE CHAR(1),  
@PA_TRXTYPE VARCHAR(50),
@PA_TRXTYPECDSL VARCHAR(10),  
@PA_ERRMSG     VARCHAR(8000) OUTPUT    
)  
AS   
DECLARE @L_DPM_ID INTEGER,  
 @L_ERROR         BIGINT,  
 @T_ERRORSTR VARCHAR(8000) 

  
SET @L_ERROR=0  
SELECT @L_DPM_ID  =  DPM_ID FROM DP_MSTR WHERE DEFAULT_DP = @PA_ID  AND DPM_DELETED_IND = 1  

BEGIN   
BEGIN TRANSACTION  
  
IF @PA_BATCHTYPE='NSDL'  
BEGIN--1  
		IF @PA_TYPE = 'C'  
		BEGIN--2
				IF EXISTS(SELECT dpam_id FROM dp_acct_mstr WHERE dpam_batch_no = @PA_BATCHNO AND dpam_dpm_id = @L_DPM_ID AND dpam_sba_no = dpam_acct_no AND dpam_deleted_ind = 1 )  
				BEGIN--3
					UPDATE DP_ACCT_MSTR SET DPAM_BATCH_NO=NULL WHERE DPAM_BATCH_NO =  @PA_BATCHNO AND DPAM_DPM_ID=@L_DPM_ID AND DPAM_DELETED_IND=1 AND DPAM_BATCH_NO <> 1 AND dpam_sba_no = dpam_acct_no  	  
					--DELETE FROM BATCHNO_NSDL_MSTR WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='C'                      			                 
                    UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='C' 
				END--3  
				ELSE   
				BEGIN--4  
					SELECT @T_ERRORSTR = 'CAN NOT PROCESS, CLIENT WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED'  
				END--4 
		END--2   
 
    
		IF @PA_TYPE = 'T'  
			BEGIN
				IF @PA_TRXTYPECDSL='DMAT'
				BEGIN
					IF NOT EXISTS(SELECT DEMRM_ID FROM DEMAT_REQUEST_MSTR WHERE DEMRM_batch_no = @PA_BATCHNO  AND  isnull(DEMRM_status, '') <> 'P' AND DEMRM_deleted_ind = 1)  
						BEGIN
							UPDATE T1 SET T1.DEMRM_BATCH_NO=NULL,T1.DEMRM_status='P' FROM DEMAT_REQUEST_MSTR T1,DP_ACCT_MSTR T2 WHERE T1.DEMRM_BATCH_NO = @PA_BATCHNO AND  T1.DEMRM_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.DEMRM_DELETED_IND=1 AND DPAM_DELETED_IND=1    
							UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T' AND BATCHN_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHN_DELETED_IND=1
						END 
					ELSE
						BEGIN
							SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
						END 
				END


				ELSE IF @PA_TRXTYPECDSL='RMAT'
				BEGIN
					IF NOT EXISTS(SELECT REMRM_ID FROM REMAT_REQUEST_MSTR WHERE REMRM_batch_no = @PA_BATCHNO  AND  isnull(REMRM_status, '') <> 'P' AND REMRM_deleted_ind = 1)  
						BEGIN
							UPDATE T1 SET T1.REMRM_BATCH_NO=NULL,T1.REMRM_status='P' FROM REMAT_REQUEST_MSTR T1,DP_ACCT_MSTR T2 WHERE T1.REMRM_BATCH_NO = @PA_BATCHNO AND  T1.REMRM_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.REMRM_DELETED_IND=1 AND DPAM_DELETED_IND=1    
							UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T' AND BATCHN_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHN_DELETED_IND=1
						END 
					ELSE
						BEGIN
							SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
						END 
				END

				ELSE IF @PA_TRXTYPECDSL='PLEDGE'
				BEGIN
					IF NOT EXISTS(SELECT PLDT_ID FROM nsdl_pledge_dtls WHERE PLDT_batch_no = @PA_BATCHNO  AND  isnull(PLDT_status, '') <> 'P' AND PLDT_deleted_ind = 1)  
						BEGIN
							UPDATE T1 SET T1.PLDT_BATCH_NO=NULL,T1.PLDT_status='P' FROM nsdl_pledge_dtls T1,DP_ACCT_MSTR T2 WHERE T1.PLDT_BATCH_NO = @PA_BATCHNO AND  T1.PLDT_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.PLDT_DELETED_IND=1 AND DPAM_DELETED_IND=1    
							UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T' AND BATCHN_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHN_DELETED_IND=1
						END 
					ELSE
						BEGIN
							SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
						END 
				END

				ELSE
				BEGIN
					IF NOT EXISTS(SELECT dptd_id FROM dp_trx_dtls WHERE dptd_batch_no = @PA_BATCHNO AND dptd_status <> 'P' AND dptd_deleted_ind = 1)  
						BEGIN    
							UPDATE T1 SET T1.DPTD_BATCH_NO=NULL,dptd_status='P' FROM DP_TRX_DTLS T1,DP_ACCT_MSTR T2 WHERE DPTD_BATCH_NO = @PA_BATCHNO AND  T1.DPTD_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND DPTD_DELETED_IND=1 AND DPAM_DELETED_IND=1  
							UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T'  AND BATCHN_DELETED_IND=1
						END 
					ELSE   
						BEGIN
							SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
						END
				END
			END
  
END--1  

ELSE IF @PA_BATCHTYPE='CDSL'  
BEGIN--1 CDSL      
IF @PA_TYPE = 'C'
   
    IF  EXISTS(SELECT dpam_id FROM dp_acct_mstr WHERE dpam_batch_no = @PA_BATCHNO AND dpam_dpm_id = @L_DPM_ID AND dpam_sba_no = dpam_acct_no AND dpam_deleted_ind = 1 )  
    BEGIN --3 CDSL 
    UPDATE DP_ACCT_MSTR SET DPAM_BATCH_NO=NULL WHERE DPAM_BATCH_NO =  @PA_BATCHNO  AND DPAM_DPM_ID=@L_DPM_ID AND DPAM_DELETED_IND=1  AND DPAM_BATCH_NO <>1 AND dpam_sba_no = dpam_acct_no      
    --DELETE FROM BATCHNO_CDSL_MSTR WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='C'      
    UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND=9,BATCHC_STATUS='C' WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='C'
    END --3 CDSL 
    ELSE   
    BEGIN -- 4 CDSL          
     SELECT @T_ERRORSTR = 'CAN NOT PROCESS, CLIENT WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
    END   -- 4 CDSL    

  


	IF @PA_TYPE = 'T'  
	BEGIN-- 5 CDSL
        --- add transaction type condition for cdsl and then uncomment
        IF @PA_TRXTYPECDSL='DMAT'
		BEGIN
            IF NOT EXISTS(SELECT DEMRM_ID FROM DEMAT_REQUEST_MSTR WHERE DEMRM_batch_no = @PA_BATCHNO  AND  isnull(DEMRM_status, '') <> 'P' AND DEMRM_deleted_ind = 1)  
			BEGIN--6 CDSL
			  UPDATE T1 SET T1.DEMRM_BATCH_NO=NULL,T1.DEMRM_status='P' FROM DEMAT_REQUEST_MSTR T1,DP_ACCT_MSTR T2 WHERE T1.DEMRM_BATCH_NO = @PA_BATCHNO AND  T1.DEMRM_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.DEMRM_DELETED_IND=1 AND DPAM_DELETED_IND=1    
			  --DELETE B1 FROM BATCHNO_CDSL_MSTR B1  WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='T' AND BATCHC_TRANS_TYPE = @PA_TRXTYPE 
			  UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND=9,BATCHC_STATUS='C' WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='T' AND BATCHC_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHC_DELETED_IND=1
            END 
            ELSE
            BEGIN
            SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
            END 
		END
        --Changes On 23/07/2010 

        ELSE IF @PA_TRXTYPECDSL='RMAT'
		BEGIN
            IF NOT EXISTS(SELECT REMRM_ID FROM REMAT_REQUEST_MSTR WHERE REMRM_batch_no = @PA_BATCHNO  AND  isnull(REMRM_status, '') <> 'P' AND REMRM_deleted_ind = 1)  
			BEGIN--6 CDSL
			  UPDATE T1 SET T1.REMRM_BATCH_NO=NULL,T1.REMRM_status='P' FROM REMAT_REQUEST_MSTR T1,DP_ACCT_MSTR T2 WHERE T1.REMRM_BATCH_NO = @PA_BATCHNO AND  T1.REMRM_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.REMRM_DELETED_IND=1 AND DPAM_DELETED_IND=1    
			  --DELETE B1 FROM BATCHNO_CDSL_MSTR B1  WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='T' AND BATCHC_TRANS_TYPE = @PA_TRXTYPE 
			  UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND=9,BATCHC_STATUS='C' WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='T' AND BATCHC_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHC_DELETED_IND=1
            END 
            ELSE
            BEGIN
            SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
            END 
		END

		ELSE IF @PA_TRXTYPECDSL='PLEDGE'
		BEGIN
			IF NOT EXISTS(SELECT PLDTC_ID FROM cdsl_pledge_dtls WHERE PLDTC_batch_no = @PA_BATCHNO  AND  isnull(PLDTC_status, '') <> 'P' AND PLDTC_deleted_ind = 1)  
				BEGIN
					UPDATE T1 SET T1.PLDTC_BATCH_NO=NULL,T1.PLDTC_status='P' FROM cdsl_pledge_dtls T1,DP_ACCT_MSTR T2 WHERE T1.PLDTC_BATCH_NO = @PA_BATCHNO AND  T1.PLDTC_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.PLDTC_DELETED_IND=1 AND DPAM_DELETED_IND=1    
					UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND=9,BATCHC_STATUS='C' WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='T' AND BATCHC_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHC_DELETED_IND=1
				END 
			ELSE
				BEGIN
					SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
				END 
		END

        --End
		ELSE
		BEGIN 
			CREATE TABLE #TRXTMP (TRXTYPE VARCHAR(10))
			INSERT INTO #TRXTMP SELECT 'BOBO'
			INSERT INTO #TRXTMP SELECT 'BOCM'
			INSERT INTO #TRXTMP SELECT 'CMBO'
			INSERT INTO #TRXTMP SELECT 'CMCM'
			IF NOT EXISTS(SELECT dptdc_id FROM dp_trx_dtls_cdsl WHERE dptdc_batch_no = @PA_BATCHNO  AND dptdc_status <> 'P' AND dptdc_deleted_ind = 1 and dptdc_internal_trastm in (SELECT case when @PA_TRXTYPECDSL='OFFM' then TRXTYPE else @PA_TRXTYPECDSL end  FROM #TRXTMP ))  
			BEGIN--6 CDSL  
			  UPDATE T1 SET T1.DPTDC_BATCH_NO=NULL,dptdc_status='P' FROM DP_TRX_DTLS_CDSL T1,DP_ACCT_MSTR T2 WHERE DPTDC_BATCH_NO = @PA_BATCHNO AND  T1.DPTDC_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND DPTDC_DELETED_IND=1 AND DPAM_DELETED_IND=1  and dptdc_internal_trastm in (SELECT case when @PA_TRXTYPECDSL='OFFM' then TRXTYPE else @PA_TRXTYPECDSL end  FROM #TRXTMP )    
			  --DELETE B1 FROM BATCHNO_CDSL_MSTR B1  WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='T' AND BATCHC_TRANS_TYPE = @PA_TRXTYPE 
			  UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND=9,BATCHC_STATUS='C' WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='T' AND BATCHC_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHC_DELETED_IND=1
			END  -- 6 CDSL
			ELSE   
			BEGIN  --7 CDSL
			SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
			END
		END 
	END --6 CDSL 
	
              
END  -- 1 CDSL
  
  
  
SET @L_ERROR = @@ERROR  
IF @L_ERROR <> 0   
BEGIN  
  IF EXISTS(SELECT ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = @L_ERROR)  
  BEGIN  
  --  
    SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': '+ ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = CONVERT(VARCHAR,@L_ERROR)  
  --  
  END  
  ELSE  
  BEGIN  
  --  
    SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': CAN NOT PROCESS, PLEASE CONTACT YOUR ADMINISTRATOR!'  
  --  
        END  
  
  ROLLBACK TRANSACTION   
END  
ELSE  
BEGIN   
  COMMIT TRANSACTION  
  IF ISNULL(@T_ERRORSTR,'') = ''  
  SELECT @T_ERRORSTR = 'PROCESS DONE SUCCESSFULLY'  
END  
SET @PA_ERRMSG = @T_ERRORSTR  
  
END

GO
