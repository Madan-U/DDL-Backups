-- Object: PROCEDURE citrus_usr.PR_BULK_CLSR
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------


CREATE PROCEDURE [citrus_usr].[PR_BULK_CLSR]
(
@PA_LOGIN_NAME VARCHAR(100)
,@ROWDELIMITER VARCHAR(10)
,@COLDELIMITER VARCHAR(10)
,@PA_ERRMSG VARCHAR(100) OUTPUT
)
AS
BEGIN

DECLARE @L_MAX_CLSRID INT,@L_MAX_CLSRID_MAK INT,@L_MAX_CLSRID_MSTR INT
SELECT @L_MAX_CLSRID_MSTR= MAX(ISNULL(CLSR_ID,0)) FROM CLOSURE_ACCT_CDSL
SELECT @L_MAX_CLSRID_MAK= MAX(ISNULL(CLSR_ID,0)) FROM CLOSURE_ACCT_CDSL_MAK

IF (@L_MAX_CLSRID_MAK>@L_MAX_CLSRID_MSTR)
BEGIN
SET  @L_MAX_CLSRID=@L_MAX_CLSRID_MAK
END 
ELSE
BEGIN
SET @L_MAX_CLSRID=@L_MAX_CLSRID_MSTR
END

--INSERT INTO CLOSURE_ACCT_MSTR -- SELECT * FROM CLOSURE_ACCT_MSTR
SELECT IDENTITY(INT,1,1) ID ,DPAM_DPM_ID ,TMPBCR_BOID
,TMPBCR_CLSR_SETUP
,TMPBCR_INIBY
,TMPBCR_REASONCD
,TMPBCR_REMBAL
,'' NEWBOID
,TMPBCR_RMKS
,'' REQINT,'' CLSRSTATUS,'' ERRORCD,@PA_LOGIN_NAME CREATEDBY,GETDATE() CREATEDDT,@PA_LOGIN_NAME LSTUPDBY,GETDATE() LSTUPDDT,1 DELIND
,TMPBCR_DATE  ,DPAM_ID INTO #TMP
FROM TMP_BULKCLSR_RESPONSE,DP_ACCT_MSTR WHERE DPAM_SBA_NO=TMPBCR_BOID AND DPAM_DELETED_IND=1



INSERT INTO CLOSURE_ACCT_CDSL
SELECT ISNULL(@L_MAX_CLSRID,'0')+ID,DPAM_DPM_ID ,TMPBCR_BOID
,TMPBCR_CLSR_SETUP
,TMPBCR_INIBY
,TMPBCR_REASONCD
,TMPBCR_REMBAL
,NEWBOID
,TMPBCR_RMKS
, REQINT, CLSRSTATUS, ERRORCD,CREATEDBY,CREATEDDT,LSTUPDBY,LSTUPDDT,DELIND
,TMPBCR_DATE  ,DPAM_ID,NULL  FROM #TMP 
WHERE NOT EXISTS 
(
SELECT 1 FROM CLOSURE_ACCT_CDSL WHERE TMPBCR_BOID=CLSR_BO_ID AND CLSR_DATE=TMPBCR_DATE
)

END

GO
