-- Object: PROCEDURE citrus_usr.PR_CDSL_PREEDIS_RESPONSE
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

--begin tran
--EXEC PR_CDSL_PREEDIS_RESPONSE '5663','HO'
--select * from EDIS_PRE_DPTDC_MAK order by dptdc_created_dt desc
--select * from dptdc_mak where dptdc_slip_no='2905202051990018' order by dptdc_created_dt desc
--commit -- rollback
CREATE PROCEDURE [citrus_usr].[PR_CDSL_PREEDIS_RESPONSE]
(
@PA_REQID VARCHAR(100)
,@PA_LOGINNAMES VARCHAR(100)
)
AS
BEGIN 

SELECT  REQID,REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,3,'{') ,4,','),2,':'),'"','') SLIPSTATUS,
CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,4,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,4,'{') ,1,','),2,':'),'"','')
END INST1TRXREQID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,4,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,4,'{') ,2,','),2,':'),'"','')
END INST1TRXID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,4,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,4,'{') ,3,','),2,':'),'"','')
END INST1STATUS
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,4,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,4,'{') ,4,','),2,':'),'"','')
END INST1ERRORCODE

,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,5,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,5,'{') ,1,','),2,':'),'"','')
END INST2TRXREQID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,5,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,5,'{') ,2,','),2,':'),'"','')
END INST2TRXID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,5,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,5,'{') ,3,','),2,':'),'"','')
END INST2STATUS
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,5,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,5,'{') ,4,','),2,':'),'"','')
END INST2ERRORCODE

,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,6,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,6,'{') ,1,','),2,':'),'"','')
END INST3TRXREQID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,6,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,6,'{') ,2,','),2,':'),'"','')
END INST3TRXID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,6,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,6,'{') ,3,','),2,':'),'"','')
END INST3STATUS
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,6,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,6,'{') ,4,','),2,':'),'"','')
END INST3ERRORCODE

,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,7,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,7,'{') ,1,','),2,':'),'"','')
END INST4TRXREQID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,7,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,7,'{') ,2,','),2,':'),'"','')
END INST4TRXID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,7,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,7,'{') ,3,','),2,':'),'"','')
END INST4STATUS
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,7,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,7,'{') ,4,','),2,':'),'"','')
END INST4ERRORCODE

,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,8,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,8,'{') ,1,','),2,':'),'"','')
END INST5TRXREQID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,8,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,8,'{') ,2,','),2,':'),'"','')
END INST5TRXID
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,8,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,8,'{') ,3,','),2,':'),'"','')
END INST5STATUS
,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,8,'{')='' THEN '' ELSE 
REPLACE(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CITRUS_USR.FN_SPLITVAL_BY(CDSLEDISBYTETR_DEC,8,'{') ,4,','),2,':'),'"','')
END INST5ERRORCODE
,REQTYPE
 INTO #TMP_INST 
FROM TMP_EDIS_RESP WHERE ltrim(rtrim(REQTYPE)) in ('E','F') AND ltrim(rtrim(REQID))=@PA_REQID



UPDATE T SET DPTDC_TRANS_NO=ltrim(rtrim(INST1TRXID)),DPTDC_STATUS=ltrim(rtrim(REQTYPE))   FROM #TMP_INST,EDIS_PRE_DPTDC_MAK T WHERE INST1TRXREQID=CONVERT(VARCHAR,DPTDC_ID)
UPDATE T SET DPTDC_TRANS_NO=ltrim(rtrim(INST2TRXID)),DPTDC_STATUS=ltrim(rtrim(REQTYPE))   FROM #TMP_INST,EDIS_PRE_DPTDC_MAK T WHERE INST2TRXREQID=CONVERT(VARCHAR,DPTDC_ID)
UPDATE T SET DPTDC_TRANS_NO=ltrim(rtrim(INST3TRXID)),DPTDC_STATUS=ltrim(rtrim(REQTYPE))   FROM #TMP_INST,EDIS_PRE_DPTDC_MAK T WHERE INST3TRXREQID=CONVERT(VARCHAR,DPTDC_ID)
UPDATE T SET DPTDC_TRANS_NO=ltrim(rtrim(INST4TRXID)),DPTDC_STATUS=ltrim(rtrim(REQTYPE))   FROM #TMP_INST,EDIS_PRE_DPTDC_MAK T WHERE INST4TRXREQID=CONVERT(VARCHAR,DPTDC_ID)
UPDATE T SET DPTDC_TRANS_NO=ltrim(rtrim(INST5TRXID)),DPTDC_STATUS=ltrim(rtrim(REQTYPE))  FROM #TMP_INST,EDIS_PRE_DPTDC_MAK T WHERE INST5TRXREQID=CONVERT(VARCHAR,DPTDC_ID)



INSERT INTO DPTDC_MAK
SELECT 
DPTDC_ID
,DPTDC_DPAM_ID
,DPTDC_REQUEST_DT
,ltrim(rtrim(DPTDC_TRANS_NO)) --DPTDC_SLIP_NO
,DPTDC_ISIN
,DPTDC_BATCH_NO
,DPTDC_LINE_NO
,DPTDC_QTY
,DPTDC_INTERNAL_REF_NO
,null --DPTDC_TRANS_NO
,DPTDC_MKT_TYPE
,DPTDC_SETTLEMENT_NO
,DPTDC_EXECUTION_DT
,DPTDC_OTHER_SETTLEMENT_TYPE
,DPTDC_OTHER_SETTLEMENT_NO
,DPTDC_COUNTER_DP_ID
,DPTDC_COUNTER_CMBP_ID
,DPTDC_COUNTER_DEMAT_ACCT_NO
,dptdC_trastm_cd
,DPTDC_DTLS_ID
,DPTDC_BOOKING_NARRATION
,DPTDC_BOOKING_TYPE
,DPTDC_CONVERTED_QTY
,DPTDC_REASON_CD
,'P' DPTDC_STATUS
,DPTDC_INTERNAL_TRASTM
,DPTDC_EXCM_ID
,DPTDC_CASH_TRF
,DPTDC_CM_ID
,DPTDC_CREATED_BY
,DPTDC_CREATED_DT
,DPTDC_LST_UPD_BY
,DPTDC_LST_UPD_DT
,DPTDC_DELETED_IND
,dptdc_rmks
,DPTDC_ERRMSG
,DPTDC_BROKERBATCH_NO
,DPTDC_BROKER_INTERNAL_REF_NO
,dptdc_mid_chk
,dptdc_res_cd
,dptdc_res_desc
,DPTDC_PAYMODE
,DPTDC_BANKACNO
,DPTDC_BANKACNAME
,DPTDC_BANKBRNAME
,DPTDC_TRANSFEREENAME
,DPTDC_DOI
,DPTDC_CHQ_REFNO
FROM EDIS_PRE_DPTDC_MAK O WHERE DPTDC_SLIP_NO=ltrim(rtrim(@PA_REQID)) AND ISNULL(DPTDC_TRANS_NO,'0')<>'0'
AND NOT EXISTS (
SELECT 1 FROM DPTDC_MAK I WHERE  I.DPTDC_SLIP_NO=O.DPTDC_TRANS_NO
) 
END

GO
