-- Object: PROCEDURE citrus_usr.PR_UPD_AUTOBANKRECO
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

--begin tran
--exec [PR_UPD_AUTOBANKRECO] 1,''
--rollback

CREATE PROCEDURE [citrus_usr].[PR_UPD_AUTOBANKRECO]
(
 @PA_FINID NUMERIC,
 @PA_OUTPUT VARCHAR(1000) OUTPUT 
)
AS
BEGIN
DECLARE 
  @P_SQL VARCHAR(8000),
  @P_SQL1 VARCHAR(8000)
  
 INSERT INTO AUTORECO_MSTR 
 SELECT * FROM TMP_AUTORECO_MSTR
 WHERE NOT EXISTS(SELECT * FROM AUTORECO_MSTR WHERE citrus_usr.TRIMZERO(CHQ_NO) = citrus_usr.TRIMZERO(AUTOM_CHQNO)
                 AND AUTOM_ACCNO = ACC_NO AND AUTOM_TRNSDT = TRNS_DT AND ISNULL(AUTOM_FLAG,'')=ISNULL(FLAG,''))
  
SET @P_SQL = '' 
 SET @P_SQL = @P_SQL + ' UPDATE T SET T.AUTOM_RECOFLAG=''Y''
					FROM ledger'+CONVERT(VARCHAR,@PA_FINID)+ ', AUTORECO_MSTR T 
					WHERE citrus_usr.TRIMZERO(LDG_INSTRUMENT_NO) = citrus_usr.TRIMZERO(AUTOM_CHQNO) and citrus_usr.TRIMZERO(AUTOM_CHQNO) NOT IN (''0'','''',''CASH'') AND ISNULL(AUTOM_RECOFLAG,'''')='''' '
 

  EXEC (@P_SQL)  

SET @P_SQL = ''
  
  SET @P_SQL = @P_SQL + ' UPDATE L
					SET L.LDG_BANK_CL_DATE = A.AUTOM_TRNSDT 
					FROM ledger'+CONVERT(VARCHAR,@PA_FINID)+ ' L,
					(SELECT LDG_VOUCHER_TYPE, LDG_VOUCHER_NO, AUTOM_TRNSDT, LDG_BANK_CL_DATE, LDG_INSTRUMENT_NO , AUTOM_CHQNO
					FROM ledger'+CONVERT(VARCHAR,@PA_FINID)+ ', AUTORECO_MSTR 
					WHERE citrus_usr.TRIMZERO(LDG_INSTRUMENT_NO) = citrus_usr.TRIMZERO(AUTOM_CHQNO) and citrus_usr.TRIMZERO(AUTOM_CHQNO) NOT IN (''0'','''',''CASH''))A
					WHERE A.LDG_VOUCHER_TYPE = L.LDG_VOUCHER_TYPE AND A.LDG_VOUCHER_NO = L.LDG_VOUCHER_NO and a.ldg_voucher_type in (''1'',''2'',''4'') '
 

  EXEC (@P_SQL)


  


  SET @P_SQL1 = ''
--  SET @P_SQL1 = @P_SQL1 + ' SELECT * FROM TMP_AUTORECO_MSTR WHERE citrus_usr.TRIMZERO(CHQ_NO) NOT IN 
--                     (SELECT citrus_usr.TRIMZERO(LDG_INSTRUMENT_NO) FROM LEDGER'+CONVERT(VARCHAR,@PA_FINID)+ ' 
--                      WHERE LDG_INSTRUMENT_NO IS NOT NULL AND LDG_INSTRUMENT_NO <> '''')' 

SET @P_SQL1 = 'SELECT AUTOM_SNO,AUTOM_ACCNO ACC_NO,AUTOM_TRNSDT TRNS_DT,AUTOM_TRNSID TRNS_ID,AUTOM_CHQNO CHQ_NO,AUTOM_NARRATION DIS ,AUTOM_DEBIT DEBIT,AUTOM_CREDIT CREDIT,AUTOM_BOOKDT BOOK_DT,AUTOM_FLAG flag,AUTOM_RECOFLAG RECOFLAG FROM AUTORECO_MSTR WHERE ISNULL(AUTOM_RECOFLAG,'''')='''' '
  PRINT (@P_SQL1)
  EXEC (@P_SQL1)
   
 
END

GO
