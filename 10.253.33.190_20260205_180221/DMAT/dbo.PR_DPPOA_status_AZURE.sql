-- Object: PROCEDURE dbo.PR_DPPOA_status_AZURE
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------


CREATE PROC PR_DPPOA_status_AZURE
AS
BEGIN
SELECT NISE_PARTY_CODE AS PARTY_CODE,CLIENT_CODE AS DPID,
POA =(CASE WHEN POA_VER IN (1,2) THEN 'ACTIVE' ELSE 'INACTIVE' END),
TEMPLATE_CODE =( CASE WHEN TEMPLATE_CODE ='BSDA' THEN 'BSDA' ELSE 'NORMAL' END),
HOLDING = 0
INTO #T1
 FROM CITRUS_USR.TBL_CLIENT_MASTER A 

 SELECT HLD_AC_CODE,SUM(FREE_QTY)FREE_QTY INTO #H FROM CITRUS_USR.HOLDING  GROUP BY HLD_AC_CODE

 
 CREATE INDEX #cl ON #H(HLD_AC_CODE)

 UPDATE #T1 SET HOLDING =FREE_QTY FROM #T1,#H
 WHERE hld_ac_code=DPID
 

 TRUNCATE TABLE   DPPOA_status_AZURE
 INSERT INTO   DPPOA_status_AZURE
 select PARTY_CODE,dPID,
POA ,
TEMPLATE_CODE  AS ACCOUNT_STATUS
,HOLDING =(CASE WHEN HOLDING >0 THEN 'Y' ELSE 'N' END)
 from #T1 

END

GO
