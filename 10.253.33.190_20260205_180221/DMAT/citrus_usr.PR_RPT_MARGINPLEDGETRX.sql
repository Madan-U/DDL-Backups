-- Object: PROCEDURE citrus_usr.PR_RPT_MARGINPLEDGETRX
-- Server: 10.253.33.190 | DB: DMAT
--------------------------------------------------

--EXEC PR_RPT_MARGINPLEDGETRX 'jAN 01 2021','jAN 05 2021'  ,''
CREATE  PROC [CITRUS_USR].[PR_RPT_MARGINPLEDGETRX](  
@PA_FROM_DT DATETIME, @PA_TO_DT DATETIME     
,@PA_LOGIN_NAME VARCHAR(100)   
)  
AS  
BEGIN  
SELECT DISTINCT CDSHM_TRAS_DT,DPAM_BBO_CODE,CDSHM_BEN_ACCT_NO ,CDSHM_ISIN,ISIN_NAME,CDSHM_TRANS_NO
,CASE WHEN CDSHM_TRATM_CD IN ('2230','2246') AND CDSHM_TRATM_TYPE_DESC = 'PLEDGE' THEN CDSHM_QTY
WHEN CDSHM_TRATM_CD IN ('2280') AND CDSHM_TRATM_TYPE_DESC IN ('UNPLEDGE','CONFISCATE','AUTO PLEDGE','PLEDGE') THEN CDSHM_QTY ELSE 0 END QTY                    
     ,  CASE WHEN  CDSHM_CDAS_SUB_TRAS_TYPE BETWEEN 828 AND 838 THEN 'MARGIN' ELSE  'NORMAL'  END PLEDGETYPE  
     ,           CASE WHEN  CDSHM_CDAS_SUB_TRAS_TYPE BETWEEN 828 AND 838 THEN CDSHM_COUNTER_BOID ELSE  ''  END PLEDGEE
FROM   CDSL_HOLDING_DTLS                     WITH (NOLOCK)
LEFT OUTER JOIN ISIN_MSTR ON ISIN_CD=CDSHM_ISIN
,DP_ACCT_MSTR
WHERE -- CDSHM_BEN_ACCT_NO  BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO  AND
CDSHM_TRATM_CD IN ('2246','2277','2201','2230','5101','2280')  
AND CDSHM_TRAS_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT
AND CDSHM_TRATM_TYPE_DESC IN ('UNPLEDGE','CONFISCATE','AUTO PLEDGE','PLEDGE')
AND CDSHM_DPAM_ID=DPAM_ID AND DPAM_DELETED_IND=1
END

GO
