-- Object: PROCEDURE dbo.usp_fetch_POACLIENTDETAILS
-- Server: 10.253.33.231 | DB: inhouse
--------------------------------------------------

create proc usp_fetch_POACLIENTDETAILS
as BEGIN
SELECT * INTO #TEMP FROM BUYBACK_POACLIENTDETAILS
CREATE INDEX IX_CODE ON #TEMP(CLIENTDP)
SELECT * INTO #POA FROM DMAT.CITRUS_USR.VW_CLIENT_POA_NEW WHERE EXISTS (SELECT * FROM #TEMP T WHERE  T.CLIENTDP=BOID)
SELECT * INTO #DDPI_OLD FROM DMAT.CITRUS_USR.OLD_DDPI_ID WHERE EXISTS (SELECT * FROM #TEMP T WHERE  T.CLIENTDP=CLIENT_CODE)
UPDATE BUYBACK_POACLIENTDETAILS SET POA_FLAG=(CASE WHEN OLD_POA ='Y' AND NEW_POA ='N' THEN '0' ELSE (CASE WHEN NEW_POA ='Y' THEN '1' ELSE '0' END)  END),
DDPI_FLAG =(CASE WHEN DDPI ='Y' THEN '1' ELSE '0' END)
FROM #POA
WHERE BOID=CLIENTDP
UPDATE BUYBACK_POACLIENTDETAILS SET DDPI_FLAG='0'
FROM #DDPI_OLD
WHERE CLIENT_CODE=CLIENTDP
Update D Set POA_flag='0'
from BUYBACK_POACLIENTDETAILS D where POA_flag=1 and DDPI_Flag=1

END

GO
