-- Object: PROCEDURE citrus_usr.PROC_DP_POA_STATUS
-- Server: 10.253.33.231 | DB: DMAT
--------------------------------------------------

CREATE PROCEDURE [citrus_usr].[PROC_DP_POA_STATUS] (@PARTY_CODE VARCHAR(10))
AS    

SELECT  * INTO #CTE FROM TBL_CLIENT_MASTER (nolock) WHERE NISE_PARTY_CODE =@PARTY_CODE

SELECT  T.* INTO #POA FROM TBL_CLIENT_POA T  (nolock),#CTE C WHERE T.CLIENT_CODE=C.CLIENT_CODE 

SELECT DISTINCT PARTY_CODE = NISE_PARTY_CODE,         
CLIENTDP = C.CLIENT_CODE, C.STATUS,    
POA_STATUS = (CASE WHEN MASTER_POA IS NULL THEN 'N' ELSE (CASE WHEN MASTER_POA='2203320000000014' AND POA_STATUS = 'D' THEN 'N' ELSE 'Y' END) END),  
 MAX(POA_DATE_FROM)  POA_DATE_FROM  INTO #FINAL     
FROM #CTE C WITH (NOLOCK)  
LEFT OUTER JOIN  
#POA P WITH (NOLOCK)        
ON C.CLIENT_CODE = P.CLIENT_CODE    
WHERE HOLDER_INDI ='1'  
GROUP BY NISE_PARTY_CODE,C.CLIENT_CODE,C.STATUS,  MASTER_POA,POA_STATUS  


SELECT * FROM #FINAL WHERE POA_STATUS='Y'

GO
