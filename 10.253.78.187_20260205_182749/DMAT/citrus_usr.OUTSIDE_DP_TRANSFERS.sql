-- Object: VIEW citrus_usr.OUTSIDE_DP_TRANSFERS
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------


CREATE VIEW OUTSIDE_DP_TRANSFERS 
AS
SELECT T.*,NISE_PARTY_CODE,COMP_NAME  FROM (
SELECT TD_AC_CODE AS FROM_DP,TD_ISIN_CODE,TD_QTY AS DR,0 AS CR,TD_CURDATE,
LEFT((CASE WHEN TD_COUNTERDP ='' THEN TD_BENEFICIERY ELSE TD_COUNTERDP END),8) AS TO_DP FROM  
SYNERGY_TRXN_DETAILS With(Nolock)
WHERE  TD_DEBIT_CREDIT ='D' AND TD_CURDATE>=CONVERT(VARCHAR(11),GETDATE()-7,120)
AND LEFT((CASE WHEN TD_COUNTERDP ='' THEN TD_BENEFICIERY ELSE TD_COUNTERDP END),8)<>'12033200'
AND TD_BENEFICIERY NOT IN ('1100001100017670','1100001000020972' ,'','1100001100005652')
UNION ALL
SELECT TD_AC_CODE,TD_ISIN_CODE,0 AS DR,TD_QTY AS CR,TD_CURDATE,LEFT((CASE WHEN TD_COUNTERDP ='' THEN TD_BENEFICIERY ELSE TD_COUNTERDP END),8) AS TO_DP FROM  
SYNERGY_TRXN_DETAILS With(Nolock)
WHERE  TD_DEBIT_CREDIT ='C' AND TD_CURDATE>=CONVERT(VARCHAR(11),GETDATE()-7,120)
AND LEFT((CASE WHEN TD_COUNTERDP ='' THEN TD_BENEFICIERY ELSE TD_COUNTERDP END),8)<>'12033200'
AND TD_BENEFICIERY NOT IN ('1100001100017670','1100001000020972' ,'','1100001100005652','1100001100005667') )T ,
TBL_CLIENT_MASTER W With(Nolock), VW_ISIN_MASTER V With(Nolock)
WHERE  T.FROM_DP=CLIENT_CODE  AND FROM_DP NOT IN ('1203320018512051')
AND TD_ISIN_CODE=ISIN

GO
