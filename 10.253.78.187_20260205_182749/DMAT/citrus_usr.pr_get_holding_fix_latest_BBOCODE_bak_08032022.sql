-- Object: PROCEDURE citrus_usr.pr_get_holding_fix_latest_BBOCODE_bak_08032022
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------






--DECLARE @P19 VARCHAR(1)      
--SET @P19=NULL      
--EXEC PR_RPT_STATEMENT @PA_DPTYPE='CDSL',@PA_EXCSMID=3,@PA_FROMDATE='AUG  2 2011',@PA_TODATE='AUG  2 2011'      
--,@PA_FROMACCID='1201090000000101'      
--,@PA_TOACCID='1201090000000101'      
--,@PA_BULK_PRINTFLAG='N'      
--,@PA_STOPBILLCLIENTS_FLAG='N'      
--,@PA_ISINCD='INF732E01037'      
--,@PA_GROUP_CD='|*~|N',@PA_TRANSCLIENTSONLY='N      
--',@PA_HLDG_YN='N',@PA_LOGIN_PR_ENTM_ID='1'      
--,@PA_LOGIN_ENTM_CD_CHAIN='HO|*~|',@PA_SETTM_TYPE=''      
--,@PA_SETTM_NO_FR='',@PA_SETTM_NO_TO=''      
--,@PA_WITHVALUE='N'      
--,@PA_OUTPUT=@P19 OUTPUT      
--SELECT @P19      
      
--EXEC [PR_GET_HOLDING_FIX_LATEST] 3,'MAR 31 2012','MAR 31 2012','0','9999999999999999',''    
--EXEC [PR_GET_HOLDING_FIX_LATEST] 3,'JUN 01 2012','JUN 01 2012','1201090000000101','1201090000000101',''    
--1201090000025122~INE083C01022    

CREATE PROC [citrus_usr].[pr_get_holding_fix_latest_BBOCODE_bak_08032022](@PA_DPM_ID NUMERIC,@PA_FROM_DT DATETIME, @PA_TO_DT DATETIME                        
,@PA_BEN_ACCT_NO_FR VARCHAR(16),@PA_BEN_ACCT_NO_TO VARCHAR(16),@PA_BBO VARCHAR(100),@PA_OUT  VARCHAR(8000) OUT)      
AS      
BEGIN       

  
  DECLARE @L_MIN_TRX_DT DATETIME
DECLARE @L_BASE_HLDG_DT DATETIME

SET @L_MIN_TRX_DT   = ''
SET @L_BASE_HLDG_DT = ''
--VW_HOLDING_BASE_ALL
IF EXISTS(SELECT * FROM  BITMAP_REF_MSTR  WHERE BITRM_PARENT_CD='ARCH' AND BITRM_VALUES ='1')
BEGIN 
SELECT @L_MIN_TRX_DT = MIN(CURR_FR_DT) FROM ARCHIVAL_DETAILS 
SELECT @L_BASE_HLDG_DT = MAX(DPHMCD_HOLDING_DT) FROM VW_HOLDING_BASE_ALL
END 
ELSE 
BEGIN 

SET @L_MIN_TRX_DT = 'AUG 01 2011'
SET @L_BASE_HLDG_DT = 'JUL 31 2011'


END 
      



SELECT DISTINCT DPAM_ID ID , DPAM_SBA_NO SBANO INTO #CLIENTLIST  FROM DP_ACCT_MSTR , ACCOUNT_PROPERTIES WHERE ACCP_CLISBA_ID = DPAM_ID AND 
ACCP_ACCPM_PROP_CD ='BBO_CODE'
AND ACCP_VALUE = @PA_BBO 

/** NEW ADDITION START FOR OPTIMIZATION**/
SELECT DP_ACCT_MSTR.* INTO #DP_ACCT_MSTR  FROM DP_ACCT_MSTR WITH(NOLOCK) , ACCOUNT_PROPERTIES WITH(NOLOCK) WHERE ACCP_CLISBA_ID = DPAM_ID AND 
ACCP_ACCPM_PROP_CD ='BBO_CODE'
AND ACCP_VALUE = @PA_BBO 


CREATE INDEX IX_1 ON #CLIENTLIST(SBANO)

CREATE INDEX IX_C ON #DP_ACCT_MSTR (DPAM_ID)


SELECT C.* INTO #CDSL_HOLDING_DTLS FROM CDSL_HOLDING_DTLS C WITH(NOLOCK) ,#DP_ACCT_MSTR D  WITH(NOLOCK) WHERE DPAM_SBA_NO=CDSHM_BEN_ACCT_NO

SELECT C.* INTO #VW_HOLDING_BASE_ALL FROM VW_HOLDING_BASE_ALL C(NOLOCK),#DP_ACCT_MSTR D (NOLOCK) WHERE DPAM_ID = DPHMCD_DPAM_ID 

/** NEW ADDITION END FOR OPTIMIZATION**/
 


IF EXISTS(SELECT NAME FROM SYSOBJECTS WHERE NAME ='HOLDINGALL')  
DROP TABLE HOLDINGALL  
      
SELECT DISTINCT CDSHM_DPM_ID DPHMCD_DPM_ID      
,CDSHM_DPAM_ID  DPHMCD_DPAM_ID        
,CDSHM_ISIN  DPHMCD_ISIN    
,CONVERT(NUMERIC(18,5),0) DPHMCD_CURR_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_FREE_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_FREEZE_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_PLEDGE_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_DEMAT_PND_VER_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_REMAT_PND_CONF_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_DEMAT_PND_CONF_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_SAFE_KEEPING_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_LOCKIN_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_ELIMINATION_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_EARMARK_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_AVAIL_LEND_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_LEND_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_BORROW_QTY    
INTO #TMP_DP_DAILY_HLDG_CDSL FROM #CDSL_HOLDING_DTLS      WITH (NOLOCK), #CLIENTLIST
WHERE  CDSHM_TRAS_DT >= @L_MIN_TRX_DT      
AND CDSHM_TRAS_DT <= @PA_TO_DT     
AND CDSHM_DPM_ID = @PA_DPM_ID      
AND CDSHM_TRATM_CD IN ('2246','2277','2201','3102','2270','2220','2205')    
--AND CDSHM_ISIN =@PA_ISIN 
   --AND CDSHM_BEN_ACCT_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO 
AND CDSHM_BEN_ACCT_NO = SBANO 


    
INSERT INTO #TMP_DP_DAILY_HLDG_CDSL     
SELECT DISTINCT DPHMCD_DPM_ID , DPHMCD_DPAM_ID , DPHMCD_ISIN     
,CONVERT(NUMERIC(18,5),0) DPHMCD_CURR_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_FREE_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_FREEZE_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_PLEDGE_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_DEMAT_PND_VER_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_REMAT_PND_CONF_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_DEMAT_PND_CONF_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_SAFE_KEEPING_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_LOCKIN_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_ELIMINATION_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_EARMARK_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_AVAIL_LEND_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_LEND_QTY    
,CONVERT(NUMERIC(18,5),0) DPHMCD_BORROW_QTY    
FROM #VW_HOLDING_BASE_ALL A WITH (NOLOCK) ,DP_ACCT_MSTR  WITH (NOLOCK), #CLIENTLIST WHERE DPHMCD_HOLDING_DT =@L_BASE_HLDG_DT    
AND  DPHMCD_DPM_ID = @PA_DPM_ID    
AND DPAM_ID = DPHMCD_DPAM_ID     
--AND DPAM_SBA_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO         
--AND DPHMCD_ISIN =@PA_ISIN 
AND SBANO = DPAM_SBA_NO     
AND NOT EXISTS(SELECT B.DPHMCD_DPAM_ID,B.DPHMCD_ISIN,B.DPHMCD_DPM_ID FROM #TMP_DP_DAILY_HLDG_CDSL B WITH (NOLOCK) WHERE A.DPHMCD_DPM_ID = B.DPHMCD_DPM_ID    
AND A.DPHMCD_DPAM_ID = B.DPHMCD_DPAM_ID AND A.DPHMCD_ISIN = B.DPHMCD_ISIN)    
                      
     
    
    
--CREATE INDEX IX_1 ON #TMP_DP_DAILY_HLDG_CDSL(DPHMCD_DPM_ID,DPHMCD_DPAM_ID,DPHMCD_ISIN)                    
--SELECT * INTO #DEMATPENDIN FROM CDSL_HOLDING_DTLS     WITH(NOLOCK)     
--WHERE CDSHM_TRAS_DT  >=@L_MIN_TRX_DT AND CDSHM_TRAS_DT   <= @PA_TO_DT    
--AND (CDSHM_TRATM_CD IN ('2246','2277','3102')       OR (CDSHM_TRATM_CD IN ('2251') AND CDSHM_TRANS_CDAS_CODE LIKE '%~607~%'))
--AND   CDSHM_BEN_ACCT_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO 
--AND CDSHM_DPM_ID = @PA_DPM_ID    
--


    
SELECT DPHMCD_DPM_ID ,DPHMCD_DPAM_ID , DPHMCD_ISIN                      
,SUM(DPHMCD_CURR_QTY) DPHMCD_CURR_QTY           
 ,SUM(DPHMCD_FREE_QTY) DPHMCD_FREE_QTY                          
 ,SUM(DPHMCD_FREEZE_QTY)   DPHMCD_FREEZE_QTY                        
 ,SUM(DPHMCD_PLEDGE_QTY )   DPHMCD_PLEDGE_QTY                        
 ,SUM(DPHMCD_DEMAT_PND_VER_QTY)    DPHMCD_DEMAT_PND_VER_QTY                        
 ,SUM(DPHMCD_REMAT_PND_CONF_QTY)    DPHMCD_REMAT_PND_CONF_QTY                        
 ,SUM(DPHMCD_DEMAT_PND_CONF_QTY)    DPHMCD_DEMAT_PND_CONF_QTY                        
 ,SUM(DPHMCD_SAFE_KEEPING_QTY )   DPHMCD_SAFE_KEEPING_QTY                        
 ,SUM(DPHMCD_LOCKIN_QTY )   DPHMCD_LOCKIN_QTY                        
 ,SUM(DPHMCD_ELIMINATION_QTY)  DPHMCD_ELIMINATION_QTY                        
 ,SUM(DPHMCD_EARMARK_QTY)    DPHMCD_EARMARK_QTY                        
 ,SUM(DPHMCD_AVAIL_LEND_QTY)    DPHMCD_AVAIL_LEND_QTY                        
 ,SUM(DPHMCD_LEND_QTY)   DPHMCD_LEND_QTY                        
 ,SUM(DPHMCD_BORROW_QTY)   DPHMCD_BORROW_QTY                        
 ,DPHMCD_HOLDING_DT                      
 ,DPHMCD_CNTR_SETTM_ID  INTO #FINALHOLDING   FROM (                      
SELECT DPHMCD_DPM_ID ,DPHMCD_DPAM_ID , DPHMCD_ISIN                      
,DPHMCD_CURR_QTY    
 ,DPHMCD_FREE_QTY    
 ,DPHMCD_FREEZE_QTY    
 ,DPHMCD_PLEDGE_QTY     
 ,0 DPHMCD_DEMAT_PND_VER_QTY    
 ,DPHMCD_REMAT_PND_CONF_QTY    
 ,DPHMCD_DEMAT_PND_CONF_QTY    
 ,DPHMCD_SAFE_KEEPING_QTY     
 ,DPHMCD_LOCKIN_QTY     
 ,DPHMCD_ELIMINATION_QTY    
 ,DPHMCD_EARMARK_QTY    
 ,DPHMCD_AVAIL_LEND_QTY    
 ,DPHMCD_LEND_QTY    
 ,DPHMCD_BORROW_QTY    
 ,@PA_TO_DT DPHMCD_HOLDING_DT                      
 ,'' DPHMCD_CNTR_SETTM_ID                      
FROM (SELECT CDSHM_DPAM_ID  DPHMCD_DPAM_ID,CDSHM_ISIN DPHMCD_ISIN 
,SUM(CASE WHEN CDSHM_TRATM_CD IN ('2246','2277') THEN CDSHM_QTY ELSE 0 END)  DPHMCD_CURR_QTY    
,SUM(CASE WHEN CDSHM_TRATM_CD IN ('2246','2277') THEN CDSHM_QTY ELSE 0 END)  DPHMCD_FREE_QTY                        
,0 DPHMCD_FREEZE_QTY                        
,0 DPHMCD_PLEDGE_QTY                        
,SUM(CASE WHEN CDSHM_TRATM_CD IN ('2201') THEN CDSHM_QTY ELSE 0 END)  DPHMCD_DEMAT_PND_VER_QTY                        
,0 DPHMCD_REMAT_PND_CONF_QTY                        
,0 DPHMCD_DEMAT_PND_CONF_QTY                        
,0 DPHMCD_SAFE_KEEPING_QTY                        
,0 DPHMCD_LOCKIN_QTY                        
,0 DPHMCD_ELIMINATION_QTY                        
,0 DPHMCD_EARMARK_QTY                        
,0 DPHMCD_AVAIL_LEND_QTY                        
,0 DPHMCD_LEND_QTY                        
,0 DPHMCD_BORROW_QTY                        
--,CDSHM_TRG_SETTM_NO  DPHMCD_CNTR_SETTM_ID                  
,'' DPHMCD_CNTR_SETTM_ID                  
,CDSHM_DPM_ID DPHMCD_DPM_ID , CDSHM_TRANS_NO DPHMCD_TRANS_NO                     
FROM   CITRUS_USR.#CDSL_HOLDING_DTLS        WITH(NOLOCK)   , #CLIENTLIST                   
WHERE CDSHM_TRATM_CD IN ('2246','2277','2201')   
--AND (CITRUS_USR.FN_SPLITVAL_BY(SUBSTRING(CDSHM_TRANS_CDAS_CODE,CHARINDEX('D~',CDSHM_TRANS_CDAS_CODE),LEN(CDSHM_TRANS_CDAS_CODE)),2,'~') NOT IN ('33','7')) 
--AND   CDSHM_BEN_ACCT_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
--AND   CDSHM_ISIN = @PA_ISIN              
AND   CDSHM_TRAS_DT  >=@L_MIN_TRX_DT      
AND   CDSHM_TRAS_DT   <= @PA_TO_DT 
AND CDSHM_DPM_ID = @PA_DPM_ID 
AND SBANO =CDSHM_BEN_ACCT_NO
GROUP BY         CDSHM_DPAM_ID  ,CDSHM_ISIN  ,CDSHM_DPM_ID  , CDSHM_TRANS_NO     
UNION  ALL                     
SELECT DPHMCD_DPAM_ID ,DPHMCD_ISIN
,SUM(DPHMCD_CURR_QTY   )             
,SUM(DPHMCD_FREE_QTY   )                     
,SUM(DPHMCD_FREEZE_QTY       )                 
,SUM(DPHMCD_PLEDGE_QTY     )                   
,SUM(DPHMCD_DEMAT_PND_VER_QTY  )                      
,SUM(DPHMCD_REMAT_PND_CONF_QTY  )                      
,SUM(DPHMCD_DEMAT_PND_CONF_QTY  )                      
,SUM(DPHMCD_SAFE_KEEPING_QTY  )                      
,SUM(DPHMCD_LOCKIN_QTY  )                      
,SUM(DPHMCD_ELIMINATION_QTY  )                      
,SUM(DPHMCD_EARMARK_QTY )                       
,SUM(DPHMCD_AVAIL_LEND_QTY)                        
,SUM(DPHMCD_LEND_QTY   )                     
,SUM(DPHMCD_BORROW_QTY )                     
,'' DPHMCD_CNTR_SETTM_ID  ,DPHMCD_DPM_ID , '' DPHMCD_TRANS_NO                     
FROM CITRUS_USR.#VW_HOLDING_BASE_ALL,DP_ACCT_MSTR, #CLIENTLIST WITH(NOLOCK)                      
WHERE DPHMCD_HOLDING_DT =@L_BASE_HLDG_DT    
AND DPHMCD_DPAM_ID = DPAM_ID   
AND DPHMCD_DPM_ID = @PA_DPM_ID
AND DPAM_SBA_NO = SBANO   
--AND DPAM_SBA_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
--AND DPHMCD_ISIN = @PA_ISIN    
GROUP BY         DPHMCD_DPAM_ID,DPHMCD_ISIN ,DPHMCD_DPM_ID 
    
) A      
) B      
                     
GROUP BY DPHMCD_DPM_ID,DPHMCD_HOLDING_DT,DPHMCD_DPAM_ID,DPHMCD_ISIN   ,DPHMCD_CNTR_SETTM_ID                      
HAVING (SUM(DPHMCD_CURR_QTY) <> '0'                        
OR SUM(DPHMCD_FREE_QTY) <> '0'                        
OR SUM(DPHMCD_FREEZE_QTY) <> '0'                        
OR SUM(DPHMCD_PLEDGE_QTY ) <> '0'                        
OR SUM(DPHMCD_DEMAT_PND_VER_QTY)  <> '0'                        
OR SUM(DPHMCD_REMAT_PND_CONF_QTY)  <> '0'                        
OR SUM(DPHMCD_DEMAT_PND_CONF_QTY)  <> '0'                        
OR SUM(DPHMCD_SAFE_KEEPING_QTY ) <> '0'                        
OR SUM(DPHMCD_LOCKIN_QTY ) <> '0'                        
OR SUM(DPHMCD_ELIMINATION_QTY)  <>  '0'                        
OR SUM(DPHMCD_EARMARK_QTY)  <> '0'                        
OR SUM(DPHMCD_AVAIL_LEND_QTY)  <> '0'                        
OR SUM(DPHMCD_LEND_QTY)  <> '0'                        
OR SUM(DPHMCD_BORROW_QTY)  <> '0')       
      
     
    

    
UPDATE A      
SET A.DPHMCD_CURR_QTY = F.DPHMCD_CURR_QTY    
,A.DPHMCD_FREE_QTY= 0--F.DPHMCD_FREE_QTY    
,A.DPHMCD_FREEZE_QTY= F.DPHMCD_FREEZE_QTY    
,A.DPHMCD_PLEDGE_QTY= F.DPHMCD_PLEDGE_QTY    
,A.DPHMCD_DEMAT_PND_VER_QTY  = 0   
,A.DPHMCD_REMAT_PND_CONF_QTY= 0  
,A.DPHMCD_DEMAT_PND_CONF_QTY = 0  
,A.DPHMCD_SAFE_KEEPING_QTY= F.DPHMCD_SAFE_KEEPING_QTY    
,A.DPHMCD_LOCKIN_QTY= F.DPHMCD_LOCKIN_QTY    
,A.DPHMCD_ELIMINATION_QTY= F.DPHMCD_ELIMINATION_QTY    
,A.DPHMCD_EARMARK_QTY= F.DPHMCD_EARMARK_QTY    
,A.DPHMCD_AVAIL_LEND_QTY= F.DPHMCD_AVAIL_LEND_QTY    
,A.DPHMCD_LEND_QTY= F.DPHMCD_LEND_QTY    
,A.DPHMCD_BORROW_QTY= F.DPHMCD_BORROW_QTY    
FROM #TMP_DP_DAILY_HLDG_CDSL   A WITH (NOLOCK), #FINALHOLDING F    WITH (NOLOCK)
WHERE A.DPHMCD_DPAM_ID= F.DPHMCD_DPAM_ID     
AND A.DPHMCD_DPM_ID = F.DPHMCD_DPM_ID     
AND A.DPHMCD_ISIN = F.DPHMCD_ISIN  



/**/
--DROP TABLE #HOLDINGDMTPENFING 
--DROP TABLE #TRASDMTPENFING
--DROP TABLE #TRASDMTCNFREJ
--DROP TABLE #TRASDMTPENFING
--DROP TABLE #FINALDMATPEN
--DROP TABLE #FINALDMATCNFREJ
--DROP TABLE #FINALDEMATHOLDI


CREATE TABLE #FINALREMTHOLDI
(DPHMCD_DPAM_ID NUMERIC,DPHMCD_ISIN VARCHAR(50),TRANS_NO VARCHAR(100),QTY NUMERIC(18,5),RMATPENDING NUMERIC(18,5))

/*REMAT CALCULATION */

 
SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN ,SUM(DPHMCD_REMAT_PND_CONF_QTY) QTY ,'' TRANS_NO  
INTO #HOLDINGDMTPENFING FROM  #VW_HOLDING_BASE_ALL WITH (NOLOCK), DP_ACCT_MSTR  WITH (NOLOCK), #CLIENTLIST
WHERE DPHMCD_DPAM_ID = DPAM_ID AND DPHMCD_HOLDING_DT=@L_BASE_HLDG_DT
--AND DPAM_SBA_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
AND DPHMCD_DPM_ID = @PA_DPM_ID
AND SBANO = DPAM_SBA_NO
GROUP BY DPHMCD_DPAM_ID,DPHMCD_ISIN 
HAVING SUM(DPHMCD_REMAT_PND_CONF_QTY) <> 0 




SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY) QTY ,CDSHM_TRANS_NO INTO #TRASDMTPENFING 
 FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST
WHERE CDSHM_TRATM_CD='2205'
AND SBANO = CDSHM_BEN_ACCT_NO
--AND CDSHM_BEN_ACCT_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
AND CDSHM_DPM_ID = @PA_DPM_ID

AND CDSHM_TRAS_DT BETWEEN @L_MIN_TRX_DT AND @PA_TO_DT
GROUP BY CDSHM_DPAM_ID,CDSHM_ISIN,CDSHM_TRANS_NO



SELECT * 
INTO #TRAS 
FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST
WHERE CDSHM_TRATM_CD IN ('2255','2277')
--AND CDSHM_BEN_ACCT_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
AND CDSHM_DPM_ID = @PA_DPM_ID
AND CDSHM_BEN_ACCT_NO = SBANO

AND CDSHM_TRAS_DT BETWEEN @L_MIN_TRX_DT AND @PA_TO_DT
AND (CDSHM_CDAS_TRAS_TYPE IN ('7','33'))




SELECT CDSHM_TRATM_CD,CDSHM_DPAM_ID , CDSHM_ISIN , CDSHM_TRANS_NO,SUM(CASE WHEN  CDSHM_CDAS_SUB_TRAS_TYPE IN( '709','703') THEN CDSHM_QTY*-1
															ELSE CDSHM_QTY END ) CDSHM_QTY
INTO #TRASDMTCNFREJ FROM #TRAS A WITH (NOLOCK) 
WHERE CDSHM_TRATM_CD IN ('2255','2277') AND CDSHM_CDAS_SUB_TRAS_TYPE IN ('707','709','703','3304','705')
--AND CDSHM_BEN_ACCT_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
AND CDSHM_DPM_ID = @PA_DPM_ID

AND (CDSHM_CDAS_TRAS_TYPE IN ('33','7'))
AND CDSHM_TRAS_DT BETWEEN @L_MIN_TRX_DT AND @PA_TO_DT
AND (CDSHM_TRANS_NO IN (SELECT DISTINCT CDSHM_TRANS_NO FROM #TRASDMTPENFING B )
OR EXISTS(SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN FROM #HOLDINGDMTPENFING WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID 
AND DPHMCD_ISIN = CDSHM_ISIN ))
GROUP BY CDSHM_DPAM_ID,CDSHM_ISIN,CDSHM_TRANS_NO, CDSHM_TRATM_CD





UPDATE TRAS SET CDSHM_TRANS_NO =''
FROM #TRASDMTPENFING TRAS
WHERE EXISTS(SELECT DPHMCD_DPAM_ID , DPHMCD_ISIN FROM #HOLDINGDMTPENFING WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID AND DPHMCD_ISIN = CDSHM_ISIN )


UPDATE TRASCNFREJ SET CDSHM_TRANS_NO =''
FROM #TRASDMTCNFREJ TRASCNFREJ
WHERE EXISTS(SELECT DPHMCD_DPAM_ID , DPHMCD_ISIN FROM #HOLDINGDMTPENFING WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID AND DPHMCD_ISIN = CDSHM_ISIN )


DELETE A FROM #TRASDMTCNFREJ A
WHERE CDSHM_TRATM_CD ='2255'
AND EXISTS(SELECT * FROM #TRASDMTCNFREJ B WHERE A.CDSHM_DPAM_ID = B.CDSHM_DPAM_ID 
AND A.CDSHM_ISIN = B.CDSHM_ISIN
AND A.CDSHM_TRANS_NO = B.CDSHM_TRANS_NO
AND B.CDSHM_TRATM_CD = '2277')

 

SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN,TRANS_NO,SUM(QTY) QTY INTO #FINALDMATPEN FROM (
SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN,QTY,TRANS_NO FROM #HOLDINGDMTPENFING
UNION ALL
SELECT CDSHM_DPAM_ID , CDSHM_ISIN,QTY,CDSHM_TRANS_NO FROM #TRASDMTPENFING) A 
GROUP BY DPHMCD_DPAM_ID,DPHMCD_ISIN,TRANS_NO

SELECT CDSHM_DPAM_ID , CDSHM_ISIN , CDSHM_TRANS_NO ,SUM(CDSHM_QTY) QTY 
INTO #FINALDMATCNFREJ FROM #TRASDMTCNFREJ 
GROUP BY CDSHM_DPAM_ID , CDSHM_ISIN , CDSHM_TRANS_NO

--SELECT * FROM #FINALDMATPEN WHERE DPHMCD_ISIN  = 'INE680B01019' AND DPHMCD_DPAM_ID=549859
--SELECT * FROM #FINALDMATCNFREJ WHERE CDSHM_DPAM_ID = 549859 AND CDSHM_ISIN ='INE680B01019'

--516841	INE115A01026

--DROP TABLE #FINALDEMATHOLDI

INSERT INTO #FINALREMTHOLDI
SELECT A.*,A.QTY-ABS(ISNULL(B.QTY,0)) RMATPENDING 
 FROM #FINALDMATPEN A LEFT OUTER JOIN #FINALDMATCNFREJ B
ON CDSHM_DPAM_ID = DPHMCD_DPAM_ID 
AND CDSHM_ISIN = DPHMCD_ISIN 
AND CDSHM_TRANS_NO = TRANS_NO

--INSERT INTO #FINALREMTHOLDI
--EXEC CITRUS_USR.PR_GETRMTCNFPND @PA_DPM_ID ,@PA_FROM_DT , @PA_TO_DT,@PA_BEN_ACCT_NO_FR ,@PA_BEN_ACCT_NO_TO ,'' ,''



DROP TABLE #HOLDINGDMTPENFING 
DROP TABLE #TRASDMTPENFING  
DROP TABLE #TRAS 
DROP TABLE #TRASDMTCNFREJ 
DROP TABLE #FINALDMATCNFREJ 






UPDATE A      
SET A.DPHMCD_REMAT_PND_CONF_QTY  = CASE WHEN A.DPHMCD_CURR_QTY <> 0  THEN RMATPENDING ELSE 0 END   
--, A.DPHMCD_FREE_QTY  = A.DPHMCD_FREE_QTY - CASE WHEN A.DPHMCD_CURR_QTY = A.DPHMCD_FREE_QTY AND A.DPHMCD_FREE_QTY >= RMATPENDING  THEN RMATPENDING ELSE 0 END   
FROM #TMP_DP_DAILY_HLDG_CDSL   A , #FINALREMTHOLDI F    
WHERE A.DPHMCD_DPAM_ID= F.DPHMCD_DPAM_ID     
AND A.DPHMCD_ISIN = F.DPHMCD_ISIN 
AND RMATPENDING <> 0 

/*REMAT CALCULATION */

 /*DEMAT CALCULATION */

CREATE TABLE #FINALDEMATHOLDI
(DPHMCD_DPAM_ID NUMERIC,DPHMCD_ISIN VARCHAR(50),TRANS_NO VARCHAR(100),QTY NUMERIC(18,5),DMATPENDING NUMERIC(18,5))


SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN ,SUM(DPHMCD_DEMAT_PND_VER_QTY) QTY ,'' TRANS_NO  
INTO #HOLDINGDMTPENFING1 FROM  #VW_HOLDING_BASE_ALL WITH (NOLOCK) , DP_ACCT_MSTR WITH (NOLOCK), #CLIENTLIST
WHERE DPHMCD_DPAM_ID = DPAM_ID AND DPHMCD_HOLDING_DT=@L_BASE_HLDG_DT
--AND DPAM_SBA_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
AND DPAM_SBA_NO = SBANO
AND DPHMCD_DPM_ID = @PA_DPM_ID

GROUP BY DPHMCD_DPAM_ID,DPHMCD_ISIN 
HAVING SUM(DPHMCD_DEMAT_PND_VER_QTY) <> 0 
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)

SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY  ) QTY ,CDSHM_TRANS_NO INTO #TRASDMTPENFING1  FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST
WHERE CDSHM_TRATM_CD IN ('2201')
AND CDSHM_BEN_ACCT_NO = SBANO
--AND CDSHM_BEN_ACCT_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
AND CDSHM_DPM_ID = @PA_DPM_ID

AND CDSHM_TRAS_DT BETWEEN @L_MIN_TRX_DT AND @PA_TO_DT
GROUP BY CDSHM_DPAM_ID,CDSHM_ISIN,CDSHM_TRANS_NO
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)


SELECT * 
INTO #TRAS1 
FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST
WHERE (CDSHM_TRATM_CD IN ('2246','3102')
OR CDSHM_TRATM_CD ='2251' AND  CDSHM_CDAS_SUB_TRAS_TYPE IN ('607','609'))
--AND CDSHM_BEN_ACCT_NO BETWEEN @PA_BEN_ACCT_NO_FR AND @PA_BEN_ACCT_NO_TO    
AND CDSHM_DPM_ID = @PA_DPM_ID
AND CDSHM_BEN_ACCT_NO = SBANO

AND (CDSHM_CDAS_TRAS_TYPE IN ('32','6'))
AND CDSHM_TRAS_DT BETWEEN @L_MIN_TRX_DT AND @PA_TO_DT
AND (CDSHM_TRANS_NO IN (SELECT DISTINCT CDSHM_TRANS_NO FROM #TRASDMTPENFING1 B )
	OR EXISTS(SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN FROM #HOLDINGDMTPENFING1 WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID 
AND DPHMCD_ISIN = CDSHM_ISIN ))

PRINT CONVERT(VARCHAR(26), GETDATE(), 109)




SELECT CDSHM_TRATM_CD,CDSHM_DPAM_ID , CDSHM_ISIN , CDSHM_TRANS_NO,SUM(CASE WHEN  CDSHM_TRATM_CD = '3102' THEN CDSHM_QTY*-1
															WHEN  CDSHM_TRATM_CD = '2251' THEN CDSHM_QTY*-1 ELSE CDSHM_QTY END ) CDSHM_QTY
INTO #TRASDMTCNFREJ1 FROM #TRAS1 A 
GROUP BY CDSHM_DPAM_ID,CDSHM_ISIN,CDSHM_TRANS_NO, CDSHM_TRATM_CD
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)

UPDATE TRAS1 SET CDSHM_TRANS_NO =''
FROM #TRASDMTPENFING1 TRAS1
WHERE EXISTS(SELECT DPHMCD_DPAM_ID , DPHMCD_ISIN FROM #HOLDINGDMTPENFING1 WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID AND DPHMCD_ISIN = CDSHM_ISIN )
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)

UPDATE TRASCNFREJ1 SET CDSHM_TRANS_NO =''
FROM #TRASDMTCNFREJ1 TRASCNFREJ1
WHERE EXISTS(SELECT DPHMCD_DPAM_ID , DPHMCD_ISIN FROM #HOLDINGDMTPENFING1 WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID AND DPHMCD_ISIN = CDSHM_ISIN )
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)

SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN,TRANS_NO,SUM(QTY) QTY INTO #FINALDMATPEN1 FROM (
SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN,QTY,TRANS_NO FROM #HOLDINGDMTPENFING1
UNION ALL
SELECT CDSHM_DPAM_ID , CDSHM_ISIN,QTY,CDSHM_TRANS_NO FROM #TRASDMTPENFING1) A 
GROUP BY DPHMCD_DPAM_ID,DPHMCD_ISIN,TRANS_NO
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)

SELECT CDSHM_DPAM_ID , CDSHM_ISIN , CDSHM_TRANS_NO ,SUM(CDSHM_QTY) QTY 
INTO #FINALDMATCNFREJ1 FROM #TRASDMTCNFREJ1 
GROUP BY CDSHM_DPAM_ID , CDSHM_ISIN , CDSHM_TRANS_NO
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)
--SELECT * FROM #FINALDMATPEN WHERE DPHMCD_ISIN  = 'INE680B01019' AND DPHMCD_DPAM_ID=549859
--SELECT * FROM #FINALDMATCNFREJ WHERE CDSHM_DPAM_ID = 549859 AND CDSHM_ISIN ='INE680B01019'

--516841	INE115A01026

--DROP TABLE #FINALDEMATHOLDI
INSERT INTO #FINALDEMATHOLDI
SELECT A.*,CASE WHEN CDSHM_ISIN LIKE 'INF%' THEN '0' ELSE A.QTY-ISNULL(B.QTY,0) END DMATPENDING 
FROM #FINALDMATPEN1 A LEFT OUTER JOIN #FINALDMATCNFREJ1 B
ON CDSHM_DPAM_ID = DPHMCD_DPAM_ID 
AND CDSHM_ISIN = DPHMCD_ISIN 
AND CDSHM_TRANS_NO = TRANS_NO
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)


DROP TABLE #HOLDINGDMTPENFING1 
DROP TABLE #TRASDMTPENFING1 
DROP TABLE #TRAS1 
DROP TABLE #TRASDMTCNFREJ1 
DROP TABLE #FINALDMATCNFREJ1 
--INSERT INTO #FINALDEMATHOLDI
--EXEC CITRUS_USR.PR_GETDMACNFPND @PA_DPM_ID ,@PA_FROM_DT , @PA_TO_DT,@PA_BEN_ACCT_NO_FR ,@PA_BEN_ACCT_NO_TO ,'' ,''


SELECT DPHMCD_DPAM_ID , DPHMCD_ISIN , SUM(DMATPENDING) PVERQTY INTO  #PVERQTY
FROM #FINALDEMATHOLDI 
WHERE NOT EXISTS(SELECT 1 FROM #CDSL_HOLDING_DTLS WITH (NOLOCK) , #CLIENTLIST WHERE CDSHM_BEN_ACCT_NO = SBANO AND CDSHM_DPAM_ID = DPHMCD_DPAM_ID AND DPHMCD_ISIN = CDSHM_ISIN 
AND CDSHM_TRAS_DT < =@PA_TO_DT AND CDSHM_TRATM_CD = '2202' AND CDSHM_TRANS_NO = TRANS_NO)
AND DMATPENDING <> 0
GROUP BY  DPHMCD_DPAM_ID , DPHMCD_ISIN
HAVING SUM(DMATPENDING) <> 0

UPDATE A      
SET A.DPHMCD_DEMAT_PND_VER_QTY  = PVERQTY   
FROM #TMP_DP_DAILY_HLDG_CDSL   A , #PVERQTY F    
WHERE A.DPHMCD_DPAM_ID= F.DPHMCD_DPAM_ID     
AND A.DPHMCD_ISIN = F.DPHMCD_ISIN 



SELECT DPHMCD_DPAM_ID , DPHMCD_ISIN , SUM(DMATPENDING) PCONVERQTY INTO  #PCONVERQTY
FROM #FINALDEMATHOLDI 
WHERE EXISTS(SELECT 1 FROM #CDSL_HOLDING_DTLS WITH (NOLOCK) , #CLIENTLIST WHERE CDSHM_BEN_ACCT_NO = SBANO AND  CDSHM_DPAM_ID = DPHMCD_DPAM_ID AND DPHMCD_ISIN = CDSHM_ISIN 
AND CDSHM_TRAS_DT < =@PA_TO_DT AND CDSHM_TRATM_CD = '2202' AND CDSHM_TRANS_NO = TRANS_NO)
AND DMATPENDING <> 0
GROUP BY  DPHMCD_DPAM_ID , DPHMCD_ISIN
HAVING SUM(DMATPENDING) <> 0

UPDATE A      
SET A.DPHMCD_DEMAT_PND_CONF_QTY  = PCONVERQTY   
FROM #TMP_DP_DAILY_HLDG_CDSL   A , #PCONVERQTY F    
WHERE A.DPHMCD_DPAM_ID= F.DPHMCD_DPAM_ID     
AND A.DPHMCD_ISIN = F.DPHMCD_ISIN 



 /*DEMAT CALCULATION */


/*PLEDGE QTY*/


 --593918	INE749A01030
SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN ,SUM(DPHMCD_PLEDGE_QTY) QTY 
INTO #HOLDINGDMTPENFING2 FROM  #VW_HOLDING_BASE_ALL WITH (NOLOCK), DP_ACCT_MSTR WITH (NOLOCK), #CLIENTLIST
WHERE DPHMCD_DPAM_ID = DPAM_ID AND DPHMCD_HOLDING_DT=@L_BASE_HLDG_DT
AND DPAM_SBA_NO = SBANO
GROUP BY DPHMCD_DPAM_ID,DPHMCD_ISIN 
HAVING SUM(DPHMCD_PLEDGE_QTY) <> 0 
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)



SELECT CDSHM_DPAM_ID  ,CDSHM_ISIN 
,CASE WHEN CDSHM_TRATM_CD IN ('2230','2246') AND CDSHM_TRATM_TYPE_DESC = 'PLEDGE' THEN CDSHM_QTY 
WHEN CDSHM_TRATM_CD IN ('2280') AND CDSHM_TRATM_TYPE_DESC IN ('UNPLEDGE','CONFISCATE','AUTO PLEDGE','PLEDGE') THEN CDSHM_QTY ELSE 0 END QTY                    
                  
INTO #TEMPDATA2 FROM   #CDSL_HOLDING_DTLS                     WITH (NOLOCK), #CLIENTLIST
WHERE CDSHM_TRATM_CD IN ('2246','2277','2201','2230','5101','2280')   
AND CDSHM_TRAS_DT BETWEEN @L_MIN_TRX_DT AND @PA_TO_DT
AND CDSHM_BEN_ACCT_NO = SBANO
AND CDSHM_TRATM_TYPE_DESC IN ('UNPLEDGE','CONFISCATE','AUTO PLEDGE','PLEDGE')

SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(QTY) QTY INTO #TRASDMTPENFING2  FROM #TEMPDATA2
GROUP BY CDSHM_DPAM_ID,CDSHM_ISIN

PRINT CONVERT(VARCHAR(26), GETDATE(), 109)


SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN,SUM(QTY) QTY INTO #FINALDMATPEN2 FROM (
SELECT DPHMCD_DPAM_ID,DPHMCD_ISIN,QTY FROM #HOLDINGDMTPENFING2
UNION ALL
SELECT CDSHM_DPAM_ID , CDSHM_ISIN,QTY FROM #TRASDMTPENFING2) A 
GROUP BY DPHMCD_DPAM_ID,DPHMCD_ISIN
PRINT CONVERT(VARCHAR(26), GETDATE(), 109)





UPDATE A      
SET A.DPHMCD_PLEDGE_QTY  = CASE WHEN QTY >= 0 THEN QTY       ELSE 0 END   
FROM #TMP_DP_DAILY_HLDG_CDSL   A , #FINALDMATPEN2 F    
WHERE A.DPHMCD_DPAM_ID= F.DPHMCD_DPAM_ID     
AND A.DPHMCD_ISIN = F.DPHMCD_ISIN 


DROP TABLE #HOLDINGDMTPENFING2 
DROP TABLE #TRASDMTPENFING2 
DROP TABLE #FINALDMATPEN2 
DROP TABLE #TEMPDATA2




/*PLEDGE QTY*/

--UPDATE A SET DPHMCD_LOCKIN_QTY  = DPHMCD_LOCKIN_QTY - ISNULL(DPHMCD_REMAT_PND_CONF_QTY ,0)
--FROM   #TMP_DP_DAILY_HLDG_CDSL   A
--WHERE DPHMCD_LOCKIN_QTY <> 0 
--AND   DPHMCD_REMAT_PND_CONF_QTY <> 0 
--


SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY) QTY INTO #LOCINDATA_CR FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST WHERE 
CDSHM_TRATM_CD IN ('2212','2211')
AND CDSHM_TRAS_DT BETWEEN  @L_MIN_TRX_DT AND @PA_TO_DT
AND CDSHM_CDAS_TRAS_TYPE IN ('12','20','21','22','23')  -- 20 ADDED BY TUSHAR ON JUL 16 2012
AND CDSHM_BEN_ACCT_NO = SBANO
GROUP BY CDSHM_DPAM_ID ,  CDSHM_ISIN 

UPDATE A SET DPHMCD_LOCKIN_QTY = QTY FROM #LOCINDATA_CR , #TMP_DP_DAILY_HLDG_CDSL  A
WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID 
AND DPHMCD_ISIN = CDSHM_ISIN 

--SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY) QTY INTO #LOCINDATA_DR FROM #CDSL_HOLDING_DTLS 
--WHERE CDSHM_TRATM_CD =CASE WHEN CDSHM_CDAS_TRAS_TYPE IN ('21','22','23') THEN '2262' ELSE '2277' END 
--AND CDSHM_TRAS_DT BETWEEN  @L_MIN_TRX_DT AND @PA_TO_DT
--AND CDSHM_CDAS_TRAS_TYPE IN ('21','22','23','7')
--GROUP BY CDSHM_DPAM_ID ,  CDSHM_ISIN 


SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY) QTY INTO #LOCINDATA_DR FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST
WHERE CDSHM_TRATM_CD  IN( '2262','2261') --=CASE WHEN CDSHM_CDAS_TRAS_TYPE IN ('21','22','23') THEN '2262' ELSE '2277' END 
AND CDSHM_TRAS_DT BETWEEN  @L_MIN_TRX_DT AND @PA_TO_DT
AND CDSHM_BEN_ACCT_NO = SBANO
AND CDSHM_CDAS_TRAS_TYPE IN ('21','22','23','12')
GROUP BY CDSHM_DPAM_ID ,  CDSHM_ISIN 

UPDATE A SET DPHMCD_LOCKIN_QTY = DPHMCD_LOCKIN_QTY + QTY FROM #LOCINDATA_DR , #TMP_DP_DAILY_HLDG_CDSL  A
WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID 
AND DPHMCD_ISIN = CDSHM_ISIN 
AND  DPHMCD_LOCKIN_QTY <> 0 

--LOCKIN REMAT

SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY) QTY INTO #LOCINDATA_DR_REMAT FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST 
WHERE CDSHM_TRATM_CD  = '2262' --=CASE WHEN CDSHM_CDAS_TRAS_TYPE IN ('21','22','23') THEN '2262' ELSE '2277' END 
AND CDSHM_TRAS_DT BETWEEN  @L_MIN_TRX_DT AND @PA_TO_DT
AND CDSHM_CDAS_TRAS_TYPE = '7'
AND CDSHM_CDAS_SUB_TRAS_TYPE = '707'
AND SBANO = CDSHM_BEN_ACCT_NO
GROUP BY CDSHM_DPAM_ID ,  CDSHM_ISIN 

UPDATE A SET DPHMCD_LOCKIN_QTY = DPHMCD_LOCKIN_QTY + QTY FROM #LOCINDATA_DR_REMAT , #TMP_DP_DAILY_HLDG_CDSL  A
WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID 
AND DPHMCD_ISIN = CDSHM_ISIN 
AND  DPHMCD_LOCKIN_QTY <> 0 


--LOCKIN REMAT

--LOCKIN REMAT CR

SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY) QTY INTO #LOCINDATA_DR_REMAT_CR FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST
WHERE CDSHM_TRATM_CD  = '2262' --=CASE WHEN CDSHM_CDAS_TRAS_TYPE IN ('21','22','23') THEN '2262' ELSE '2277' END 
AND CDSHM_TRAS_DT BETWEEN  @L_MIN_TRX_DT AND @PA_TO_DT
AND CDSHM_CDAS_TRAS_TYPE = '33'
AND CDSHM_BEN_ACCT_NO = SBANO
AND CDSHM_CDAS_SUB_TRAS_TYPE = '3304'
GROUP BY CDSHM_DPAM_ID ,  CDSHM_ISIN 

UPDATE A SET DPHMCD_LOCKIN_QTY = DPHMCD_LOCKIN_QTY + QTY FROM #LOCINDATA_DR_REMAT_CR , #TMP_DP_DAILY_HLDG_CDSL  A
WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID 
AND DPHMCD_ISIN = CDSHM_ISIN 
AND  DPHMCD_LOCKIN_QTY <> 0  AND DPHMCD_CURR_QTY=0
AND DPHMCD_FREE_QTY=0


--LOCKIN REMAT CR

--AVAIL LENDING

SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY) QTY INTO #AVAILLENDDATA FROM #CDSL_HOLDING_DTLS WITH (NOLOCK), #CLIENTLIST
WHERE CDSHM_TRATM_CD  = '2270' 
AND CDSHM_TRAS_DT BETWEEN  @L_MIN_TRX_DT AND @PA_TO_DT
AND CDSHM_BEN_ACCT_NO = SBANO
AND CDSHM_CDAS_TRAS_TYPE = '8'
AND CDSHM_CDAS_SUB_TRAS_TYPE = '816' 
GROUP BY CDSHM_DPAM_ID ,  CDSHM_ISIN

UPDATE A SET DPHMCD_AVAIL_LEND_QTY = DPHMCD_AVAIL_LEND_QTY - QTY FROM #AVAILLENDDATA , #TMP_DP_DAILY_HLDG_CDSL  A
WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID 
AND DPHMCD_ISIN = CDSHM_ISIN 
AND  DPHMCD_AVAIL_LEND_QTY <> 0 AND DPHMCD_CURR_QTY=0
AND DPHMCD_FREE_QTY=0

--AVAIL LENDING



/*EARLY PAYIN MAY 15 2021*/
SELECT CDSHM_DPAM_ID , CDSHM_ISIN , SUM(CDSHM_QTY) QTY INTO #EARMARKQTY1 
FROM #CDSL_HOLDING_DTLS A WHERE  CDSHM_CDAS_TRAS_TYPE='4' AND 	CDSHM_CDAS_SUB_TRAS_TYPE ='409'  AND CDSHM_TRATM_CD ='2215'
AND NOT EXISTS 
(SELECT 1 FROM #CDSL_HOLDING_DTLS B 
WHERE A.CDSHM_DPAM_ID = B.CDSHM_DPAM_ID 
AND A.CDSHM_ISIN = B.CDSHM_ISIN 
AND A.CDSHM_TRANS_NO = B.CDSHM_TRANS_NO
AND ABS(A.CDSHM_QTY )= ABS(B.CDSHM_QTY)
AND B.CDSHM_TRATM_CD ='2277') 
AND CDSHM_TRAS_DT BETWEEN  @L_MIN_TRX_DT AND @PA_TO_DT
GROUP BY CDSHM_DPAM_ID ,  CDSHM_ISIN




UPDATE A SET DPHMCD_EARMARK_QTY = DPHMCD_EARMARK_QTY + QTY FROM #EARMARKQTY1  , #TMP_DP_DAILY_HLDG_CDSL  A
WHERE DPHMCD_DPAM_ID = CDSHM_DPAM_ID 
AND DPHMCD_ISIN = CDSHM_ISIN 
/*EARLY PAYIN MAY 15 2021*/
    
--UPDATE A SET DPHMCD_FREE_QTY  = DPHMCD_CURR_QTY - ISNULL(DPHMCD_REMAT_PND_CONF_QTY ,0) - ISNULL(DPHMCD_LOCKIN_QTY ,0)
--FROM   #TMP_DP_DAILY_HLDG_CDSL   A
--WHERE DPHMCD_CURR_QTY <>0 

UPDATE A SET DPHMCD_FREE_QTY  = DPHMCD_CURR_QTY - ISNULL(DPHMCD_REMAT_PND_CONF_QTY ,0) - ISNULL(DPHMCD_LOCKIN_QTY ,0) - ISNULL(DPHMCD_PLEDGE_QTY,'0') - ISNULL(DPHMCD_AVAIL_LEND_QTY,'0') -ISNULL(DPHMCD_SAFE_KEEPING_QTY,'0') -ISNULL(DPHMCD_LEND_QTY,'0') - 
  
ISNULL(DPHMCD_BORROW_QTY,'0') - ISNULL(DPHMCD_EARMARK_QTY,'0')    
FROM   #TMP_DP_DAILY_HLDG_CDSL   A    
WHERE DPHMCD_CURR_QTY <>0     



UPDATE A SET DPHMCD_FREE_QTY  = DPHMCD_CURR_QTY 
FROM   #TMP_DP_DAILY_HLDG_CDSL   A    
WHERE DPHMCD_CURR_QTY <>0     
AND DPHMCD_FREEZE_QTY=0
AND DPHMCD_PLEDGE_QTY=0
AND DPHMCD_DEMAT_PND_VER_QTY=0
AND DPHMCD_REMAT_PND_CONF_QTY=0
AND DPHMCD_DEMAT_PND_CONF_QTY=0
AND DPHMCD_SAFE_KEEPING_QTY=0
AND DPHMCD_LOCKIN_QTY=0
AND DPHMCD_ELIMINATION_QTY=0
AND DPHMCD_EARMARK_QTY=0
AND DPHMCD_AVAIL_LEND_QTY=0
AND DPHMCD_LEND_QTY=0
AND DPHMCD_BORROW_QTY=0

/**/   
    
    
UPDATE A SET DPHMCD_REMAT_PND_CONF_QTY  = 0   
FROM   #TMP_DP_DAILY_HLDG_CDSL   A  


SELECT *,@PA_TO_DT DPHMCD_HOLDING_DT 
INTO #HOLDINGALL 
FROM #TMP_DP_DAILY_HLDG_CDSL     
WHERE     
(DPHMCD_CURR_QTY <> '0'                        
OR DPHMCD_FREE_QTY <> '0'                        
OR DPHMCD_FREEZE_QTY <> '0'                        
OR DPHMCD_PLEDGE_QTY  <> '0'                        
OR DPHMCD_DEMAT_PND_VER_QTY  <> '0'                        
OR DPHMCD_REMAT_PND_CONF_QTY  <> '0'                        
OR DPHMCD_DEMAT_PND_CONF_QTY  <> '0'                        
OR DPHMCD_SAFE_KEEPING_QTY  <> '0'                        
OR DPHMCD_LOCKIN_QTY <> '0'                        
OR DPHMCD_ELIMINATION_QTY  <>  '0'                        
OR DPHMCD_EARMARK_QTY  <> '0'                        
OR DPHMCD_AVAIL_LEND_QTY  <> '0'                        
OR DPHMCD_LEND_QTY  <> '0'                        
OR DPHMCD_BORROW_QTY  <> '0') 

SELECT * FROM #HOLDINGALL

DROP TABLE #HOLDINGALL 
DROP TABLE #CLIENTLIST
DROP TABLE #DP_ACCT_MSTR
DROP TABLE #CDSL_HOLDING_DTLS
DROP TABLE #VW_HOLDING_BASE_ALL



      
END

GO
