-- Object: VIEW citrus_usr.spark_view
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

-- BEGIN TRAN
 /* 
ROLLBACK

COMMIT

EXEC PR_RPT_HOLDING 'NSDL',4,'N','MAY 29 2009','10697005','','','N',1 ,'HO|*~|','11','2009093', '2009095',''		

EXEC PR_RPT_HOLDING 'NSDL',4,'N','2009-05-22','1203270000187997','1203270000187997','','Y',83001,'HO|*~|','','','',''	

EXEC [Pr_Rpt_Holding_Csv_Sparkview]	'cdsl','3','Y','OCT  5 2010','','','','N',1,'HO|*~|','','','',''	
*/
 
create view [citrus_usr].[spark_view]

as          
                   
           
 SELECT 
			DPAM_SBA_NAME,
			DPAM_SBA_NO,ISNULL(DPHMC_ISIN,'') DPHMC_ISIN,
			ISNULL(ISIN_NAME,'') ISIN_NAME,
			CONVERT(NUMERIC(18,0),DPHMC_CURR_QTY) DPHMC_CURR_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_FREE_QTY) DPHMC_FREE_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_FREEZE_QTY) DPHMC_FREEZE_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_PLEDGE_QTY) DPHMC_PLEDGE_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_DEMAT_PND_VER_QTY) DPHMC_DEMAT_PND_VER_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_REMAT_PND_CONF_QTY) DPHMC_REMAT_PND_CONF_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_DEMAT_PND_CONF_QTY) DPHMC_DEMAT_PND_CONF_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_SAFE_KEEPING_QTY) DPHMC_SAFE_KEEPING_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_LOCKIN_QTY) DPHMC_LOCKIN_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_ELIMINATION_QTY) DPHMC_ELIMINATION_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_EARMARK_QTY) DPHMC_EARMARK_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_AVAIL_LEND_QTY) DPHMC_AVAIL_LEND_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_LEND_QTY) DPHMC_LEND_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_BORROW_QTY) DPHMC_BORROW_QTY,
			DPAM_ID, 
			HOLDING_DT=CONVERT(VARCHAR(11),getdate(),109), ltrim(rtrim(isnull(SPARK_PARTY_CODE,''))) SPARK_PARTY_CODE                          
FROM 
			DP_HLDG_MSTR_CDSL LEFT OUTER JOIN ISIN_MSTR ON DPHMC_ISIN = ISIN_CD,                    
			--#ACLIST ACCOUNT   LEFT OUTER JOIN  TMP_GET_SPARKPARTYCODE ON DPAM_SBA_NO =  ltrim(rtrim(demat_id)) 
            (SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(3 ,1,0)) ACCOUNT  ,  TMP_GET_SPARKPARTYCODE 
WHERE
			DPHMC_HOLDING_DT = getdate() AND DPHMC_DPM_ID = 3                          
			AND DPHMC_DPAM_ID = ACCOUNT.DPAM_ID               
            AND DPAM_SBA_NO =  ltrim(rtrim(demat_id)) and  isnull(SPARK_PARTY_CODE,'')<>''                              
			AND (DPHMC_HOLDING_DT BETWEEN EFF_FROM AND EFF_TO)                    
			AND (CONVERT(NUMERIC,DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC,'0') AND  CONVERT(NUMERIC,'9999999999999999'))  
			AND ISNULL(DPHMC_CURR_QTY,0) <> 0                           
			AND DPHMC_ISIN LIKE '' + '%'

GO
