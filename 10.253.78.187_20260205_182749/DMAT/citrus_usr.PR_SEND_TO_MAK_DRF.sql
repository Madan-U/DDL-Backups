-- Object: PROCEDURE citrus_usr.PR_SEND_TO_MAK_DRF
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------


CREATE     PROC [citrus_usr].[PR_SEND_TO_MAK_DRF] (@PA_DPM_ID NUMERIC,@PA_SLIP_NO VARCHAR (50),@PA_OUT VARCHAR(1000) OUT)
 AS 
BEGIN
EXEC DRF_BACKUP @PA_SLIP_NO 

DECLARE @PA_ERRMSG VARCHAR (8000)
SET @PA_ERRMSG ='ACTION SUCCESSFULLY DONE' 
IF NOT EXISTS (SELECT 1 FROM DEMRM_MAK  WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO  )    
 BEGIN  
 
  SET @PA_ERRMSG =  'DRF NOT FOUND'
   SELECT @PA_ERRMSG  MSG
   
  RETURN          
 END  
 
 
 
IF   EXISTS (SELECT 1 FROM DEMRM_MAK  WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO  AND DEMRM_DELETED_IND = 0  
AND DEMRM_INTERNAL_REJ <> '' 
and  DEMRM_RES_DESC_INTOBJ = '') 
 BEGIN  
 
  SET @PA_ERRMSG =  'CHECKER NOT DONE FOR THIS DRF '
   SELECT @PA_ERRMSG  MSG
   
  RETURN          
 END  

IF EXISTS (SELECT 1 FROM DEMAT_REQUEST_MSTR  WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO AND DEMRM_BATCH_NO IS NOT NULL AND ISNULL(DEMRM_TRANSACTION_NO ,'') = '')    
 BEGIN  
 --PRINT 'YOGESH'        
  SET @PA_ERRMSG =  'BATCH FOR THIS DRF IS ALREADY EXPORTED'
   SELECT @PA_ERRMSG  MSG
   
  RETURN          
 END     

IF EXISTS (SELECT 1 FROM DEMAT_REQUEST_MSTR  WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO AND DEMRM_BATCH_NO IS NOT NULL AND ISNULL(DEMRM_TRANSACTION_NO ,'') <> '' AND ISNULL(DEMRM_ERRMSG,'') = '' )    
 BEGIN  
 --PRINT 'YOGESH'        
  SET @PA_ERRMSG =  'BATCH FOR THIS DRF IS ALREADY EXPORTED AND RESPONSE UPLOADED'
   SELECT @PA_ERRMSG  MSG
   
  RETURN          
 END     
 
 
 --IF EXISTS (SELECT 1 FROM DEMAT_REQUEST_MSTR  WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO AND ISNULL(DEMRM_TRANSACTION_NO,'0')<> '' AND DEMRM_BATCH_NO IS NOT NULL )    
 --BEGIN       
    
 -- SET @PA_ERRMSG =  'DRN ALREADY GENERATED, CAN NOT PROCESS ' 
     
 --  SELECT @PA_ERRMSG  MSG
   
 -- RETURN          
 --END  
 
  IF EXISTS (SELECT 1 FROM DEMRM_MAK  WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO AND( DEMRM_INTERNAL_REJ <> '' OR DEMRM_RES_DESC_INTOBJ <> ''))    
 BEGIN       
  update  demrm_mak  set demrm_res_cd_intobj = '' , demrm_res_desc_intobj = '', demrm_rmks = ''
 ,demrm_res_cd_compobj = '' , demrm_res_desc_compobj = ''
 ,demrm_lst_upd_by = demrm_created_by ,demrm_lst_upd_dt = DEMRM_CREATED_DT , DEMRM_STATUS = 'P'
   where DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO  and DEMRM_DELETED_IND = 0
     delete  from dmat_dispatch  where disp_demrm_id in ( select demrm_id  from demrm_mak  where DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)
 END   

 UPDATE  DEMAT_REQUEST_MSTR SET  DEMRM_BATCH_NO = NULL , DEMRM_INTERNAL_REJ = ''
, DEMRM_ERRMSG = '', DEMRM_STATUS = 'P', DEMRM_TRANSACTION_NO = ''
 WHERE DEMRM_SLIP_SERIAL_NO  = @PA_SLIP_NO
 

UPDATE  DEMRM_MAK SET DEMRM_LST_UPD_BY=DEMRM_CREATED_BY,
DEMRM_LST_UPD_DT=DEMRM_CREATED_DT,DEMRM_DELETED_IND='0' 
WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO AND DEMRM_DELETED_IND = '1'

UPDATE  DEMRD_MAK SET DEMRD_LST_UPD_BY=DEMRD_CREATED_BY,DEMRD_LST_UPD_DT=DEMRD_CREATED_DT,
DEMRD_DELETED_IND='0' WHERE DEMRD_DEMRM_ID IN(SELECT DEMRM_ID FROM DEMRM_MAK WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)
AND DEMRD_DELETED_IND = '1'

UPDATE  DEMAT_TRAN_TRANM_DTLS_MAK SET DEMTTD_LST_UPD_BY = DEMTTD_CREATED_BY,
DEMTTD_LST_UPD_DT =DEMTTD_CREATED_DT ,DEMTTD_DELETED_IND='0' 
 WHERE DEMTTD_DEMRM_ID IN(SELECT DEMRM_ID FROM DEMRM_MAK WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)
 AND DEMTTD_DELETED_IND = '1'





DELETE FROM DEMAT_TRAN_TRANM_DTLS WHERE DEMTTD_DEMRM_ID IN (SELECT DEMRM_ID FROM DEMAT_REQUEST_MSTR WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)
DELETE FROM DEMAT_REQUEST_DTLS  WHERE DEMRD_DEMRM_ID IN (SELECT DEMRM_ID FROM DEMAT_REQUEST_MSTR WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)
DELETE FROM DEMAT_REQUEST_MSTR  WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO


--PRINT 'DEMRM_MAK DATA'
--SELECT * FROM DEMRM_MAK WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO
--PRINT 'DEMRD_MAK DATA'
--SELECT * FROM DEMRD_MAK WHERE DEMRD_DEMRM_ID IN 
--(SELECT DEMRM_ID FROM DEMRM_MAK WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)
--PRINT 'DEMAT_TRAN_TRANM_DTLS_MAK DATA'
--SELECT * FROM DEMAT_TRAN_TRANM_DTLS_MAK WHERE DEMTTD_DEMRM_ID 
--IN (SELECT DEMRM_ID FROM DEMRM_MAK WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)

--PRINT 'DEMAT_REQUEST_MSTR DATA'
--SELECT * FROM DEMAT_REQUEST_MSTR  WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO
--PRINT 'DEMAT_REQUEST_DTLS DATA'
--SELECT * FROM DEMAT_REQUEST_DTLS  WHERE DEMRD_DEMRM_ID IN 
--(SELECT DEMRM_ID FROM DEMAT_REQUEST_MSTR WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)
--PRINT 'DEMAT_TRAN_TRANM_DTLS DATA'
--SELECT * FROM DEMAT_TRAN_TRANM_DTLS WHERE DEMTTD_DEMRM_ID IN 
--(SELECT DEMRM_ID FROM DEMAT_REQUEST_MSTR WHERE DEMRM_SLIP_SERIAL_NO = @PA_SLIP_NO)

SELECT @PA_ERRMSG  MSG
END

GO
