-- Object: PROCEDURE citrus_usr.PR_RPT_POATRX_SETTWISE
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

---PR_RPT_POATRX_SETTWISE '4' ,'', 'jan 4  2008','may 4 2009',''

 ---PR_RPT_POATRX_SETTWISE '4','','Jan 26 2008','May 26 2009',''

CREATE PROCEDURE [citrus_usr].[PR_RPT_POATRX_SETTWISE](      
@PA_EXCH VARCHAR(100),       
@PA_BATCH_NO VARCHAR(50),      
@PA_FROM_DT VARCHAR(11),       
@PA_TO_DT VARCHAR(11),       
@PA_TRANS_TYPE VARCHAR(100)   
)        
AS        
BEGIN        

	  SELECT DISTINCT CASE WHEN DPTDC_INTERNAL_TRASTM  IN ('BOCM','CMCM','CMBO','BOBO') THEN 'OFFM' ELSE DPTDC_INTERNAL_TRASTM END   ,'' AS DEMRM_FREE_LOCKEDIN_YN
	  --,'0' AS DEMRM_TOTAL_CERTIFICATES 
	  ,CONVERT(VARCHAR,DPTDC_REQUEST_DT,103) REQUEST_DT,      
	  ISNULL(CONVERT(VARCHAR,DPTDC_EXECUTION_DT,103),'') EXECUTION_DT,      
	  --'' SERIES ,      
	  DPTDC_SLIP_NO SLIP_NO,      
	  SRC_CLIENT.DPAM_SBA_NO ACCOUNT_NO,      
	  SRC_CLIENT.DPAM_SBA_NAME CLIENT_NAME        
	  ,CASE WHEN ISNULL(DPTDC_COUNTER_DEMAT_ACCT_NO,'')='' THEN '-NA-' ELSE ISNULL(DPTDC_COUNTER_DEMAT_ACCT_NO,'') END  COUNTER_ACCOUNT         
	  ,CASE WHEN ISNULL(DPTDC_COUNTER_DEMAT_ACCT_NO,'')='' THEN '-NA-' ELSE ISNULL(DST_CLIENT.DPAM_SBA_NAME,'') END  ACCOUNT_NAME        
	  ,CASE WHEN ISNULL(DPTDC_COUNTER_DP_ID,'')='' THEN '-NA-' ELSE ISNULL(DPTDC_COUNTER_DP_ID,'') END   COUNTER_DP         
	  ,CASE WHEN ISNULL(DPTDC_COUNTER_DP_ID,'')='' THEN '-NA-' ELSE ISNULL(DST_DPM.DPM_NAME,'') END   DP_NAME         
	  ,CASE WHEN ISNULL(DPTDC_COUNTER_CMBP_ID,'')='' THEN '-NA-' ELSE ISNULL(DPTDC_COUNTER_CMBP_ID,'') END   CMBPID            
	  ,DPTDC_ISIN DPTD_ISIN,      
	  ISIN_NAME,               
	  ABS(DPTDC_QTY) DPTD_QTY    
	  ,case when isnull(DPTDC_TRANS_NO,'')='' then '-NA-' ELSE ISNULL(DPTDC_TRANS_NO,'') END  TRANSACTION_NO      
	  ,DPTDC_INTERNAL_REF_NO INTERNAL_REF_NO
      ,case when isnull(DPTDC_MKT_TYPE,'')='' then '-NA-' ELSE ISNULL(DPTDC_MKT_TYPE,'') END DPTDC_MKT_TYPE
      ,case when isnull(DPTDC_SETTLEMENT_NO,'')='' then '-NA-' ELSE ISNULL(DPTDC_SETTLEMENT_NO,'') END DPTDC_SETTLEMENT_NO
      ,case when isnull(DPTDC_OTHER_SETTLEMENT_TYPE,'')='' then '-NA-' ELSE ISNULL(DPTDC_OTHER_SETTLEMENT_TYPE,'')END  DPTDC_OTHER_SETTLEMENT_TYPE
      ,case when isnull(DPTDC_OTHER_SETTLEMENT_NO,'')='' then '-NA-' ELSE ISNULL(DPTDC_OTHER_SETTLEMENT_NO,'')END DPTDC_OTHER_SETTLEMENT_NO         
      ,CITRUS_USR.fn_ucc_entp(SRC_CLIENT.DPAM_CRN_NO,'BBO_CODE','') BBO_CODE
      ,VALUATION=CONVERT(NUMERIC(18,2),DPTDC_QTY*ISNULL(CLOPM_CDSL_RT,0))  
	  FROM       
	  DP_TRX_DTLS_CDSL   
      LEFT OUTER JOIN DP_ACCT_MSTR DST_CLIENT ON DST_CLIENT.DPAM_SBA_NO = DPTDC_COUNTER_DEMAT_ACCT_NO         
	  LEFT OUTER JOIN DP_MSTR DST_DPM ON DST_DPM.DPM_DPID = DPTDC_COUNTER_DP_ID   
      LEFT OUTER JOIN ISIN_MSTR ON DPTDC_ISIN = ISIN_CD 
      LEFT OUTER JOIN CLOSING_PRICE_MSTR_CDSL ON DPTDC_ISIN = CLOPM_ISIN_CD 
      AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_CDSL WHERE CLOPM_ISIN_CD = DPTDC_ISIN and CLOPM_DT <= @PA_FROM_DT and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc)       
      
     ,DP_ACCT_MSTR SRC_CLIENT 
     ,DP_MSTR SRC_DPM 
     
	  WHERE DPTDC_DPAM_ID               = SRC_CLIENT.DPAM_ID         
	  AND   SRC_CLIENT.DPAM_DPM_ID      = SRC_DPM.DPM_ID         
	          
	  AND   DPTDC_DELETED_IND           = 1        
	  AND   SRC_CLIENT.DPAM_DELETED_IND = 1        
	  AND   SRC_DPM.DPM_DELETED_IND     = 1  
	  --AND   CONVERT(VARCHAR(11),DPTDC_REQUEST_DT,103) BETWEEN  @PA_FROM_DATE AND @PA_TO_DATE        
      AND   DPTDC_REQUEST_DT BETWEEN  CONVERT(VARCHAR,CONVERT(DATETIME, @PA_FROM_DT,103),106)+' 00:00:00' AND CONVERT(VARCHAR,CONVERT(DATETIME,@PA_TO_DT,103),106)+' 23:59:59'  
	  AND   ISNULL(DPTDC_BATCH_NO,'') <> '' 
      AND   ISNULL(DPTDC_BROKERBATCH_NO,'') <> ''
      AND   NOT EXISTS(SELECT SLIIM_DPAM_ACCT_NO ,SLIIM_SLIP_NO_FR,SLIIM_SLIP_NO_TO FROM SLIP_ISSUE_MSTR 
                       WHERE SLIIM_DPAM_ACCT_NO = SRC_CLIENT.DPAM_SBA_NO 
                       AND ISNUMERIC(REPLACE(DPTDC_SLIP_NO , ISNULL(SLIIM_SERIES_TYPE,''),'')) = 1   
                       AND REPLACE(DPTDC_SLIP_NO , ISNULL(SLIIM_SERIES_TYPE,''),'') 
                       BETWEEN   SLIIM_SLIP_NO_FR AND SLIIM_SLIP_NO_TO     
                       AND SLIIM_DELETED_IND = 1 
                       AND SRC_CLIENT.DPAM_DELETED_IND = 1 )    
      ORDER BY EXECUTION_DT  
         
        
END

GO
