-- Object: PROCEDURE citrus_usr.PR_RPT_GL_previousyear
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------


create  PROCEDURE [citrus_usr].[PR_RPT_GL_previousyear]
@PA_FROM_DT DATETIME
,@PA_TO_DT DATETIME
,@PA_VOUCHER_TYPE VARCHAR (20)
,@PA_GL_CODE VARCHAR (20)
 
AS 
BEGIN 

--select * from financial_yr_mstr


select LDG_VOUCHER_NO INTO #TEMP from ledger11 ,FIN_ACCOUNT_MSTR
where LDG_ACCOUNT_ID = FINA_ACC_ID   
AND LDG_VOUCHER_DT between  @PA_FROM_DT and @PA_TO_DT
and FINA_ACC_CODE  = @PA_GL_CODE AND LDG_NARRATION <> 'Opening Balance'
and LDG_ACCOUNT_TYPE IN ('G','b','C')
--AND LDG_VOUCHER_TYPE = @PA_VOUCHER_TYPE

 --select * from #TEMP

SELECT *   FROM (
select CONVERT (VARCHAR, LDG_VOUCHER_DT, 103) LDG_VOUCHER_DT, LDG_VOUCHER_NO , 
CASE WHEN LDG_VOUCHER_TYPE = '2' THEN 'RECIEPT' 
WHEN  LDG_VOUCHER_TYPE = '1' THEN 'PAYMENT' WHEN  LDG_VOUCHER_TYPE = '3' THEN 'JV' 
ELSE convert(varchar,LDG_VOUCHER_TYPE ) END LDG_VOUCHER_TYPE
,''''+ DPAM_SBA_NO [ACC CODE], DPAM_SBA_NAME [CLIENT NAME], LDG_NARRATION [NARRATION], LDG_AMOUNT [AMOUNT]
,CASE WHEN LDG_AMOUNT < 0 THEN 'DR' ELSE 'CR' END [DR/CR FLAG]
,LDG_INSTRUMENT_NO  CHQ_NO, LDG_CREATED_BY  USER_ID
 from ledger12,dp_acct_mstr where DPAM_ID = LDG_ACCOUNT_ID 
and LDG_VOUCHER_NO in (select LDG_VOUCHER_NO from #TEMP)
 and LDG_DELETED_IND= '1' 
 --AND LDG_VOUCHER_TYPE = @PA_VOUCHER_TYPE
 AND LDG_VOUCHER_DT between  @PA_FROM_DT and @PA_TO_DT
union all
select CONVERT (VARCHAR, LDG_VOUCHER_DT, 103) LDG_VOUCHER_DT , LDG_VOUCHER_NO 
, CASE WHEN LDG_VOUCHER_TYPE = '2' THEN 'RECIEPT' WHEN  LDG_VOUCHER_TYPE = '1' THEN 'PAYMENT' 
WHEN  LDG_VOUCHER_TYPE = '3' THEN 'JV' 
ELSE convert(varchar,LDG_VOUCHER_TYPE )  END LDG_VOUCHER_TYPE 
, FINA_ACC_CODE [ACC CODE], FINA_ACC_NAME [CLIENT NAME], LDG_NARRATION [NARRATION], LDG_AMOUNT [AMOUNT]
,CASE WHEN LDG_AMOUNT < 0 THEN 'DR' ELSE 'CR' END [DR/CR FLAG]
,LDG_INSTRUMENT_NO  CHQ_NO, LDG_CREATED_BY  USER_ID 
 from ledger12,FIN_ACCOUNT_MSTR where FINA_ACC_id = LDG_ACCOUNT_ID 
   AND LDG_VOUCHER_DT between  @PA_FROM_DT and @PA_TO_DT
and LDG_VOUCHER_NO in (select LDG_VOUCHER_NO from #TEMP)
--AND LDG_VOUCHER_TYPE = @PA_VOUCHER_TYPE
and LDG_DELETED_IND= '1')A
ORDER BY 2, 3   






END

GO
