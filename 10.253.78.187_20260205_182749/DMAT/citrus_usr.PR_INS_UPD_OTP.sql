-- Object: PROCEDURE citrus_usr.PR_INS_UPD_OTP
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------



create PROCEDURE [citrus_usr].[PR_INS_UPD_OTP] 
(

@PA_ACTION Varchar(10),
@PA_BOID VARCHAR(20),
@PA_OTP_TYPE VARCHAR(20),
@PA_OTP_MOBILE VARCHAR(20),
@PA_OTPNO VARCHAR(20),
@PA_CMBPID VARCHAR(20),
@PA_TDPID VARCHAR(20),
@PA_LOGINNAMES VARCHAR(20)

)
As
BEGIN

IF @PA_ACTION ='INS_UPD'


  IF @PA_CMBPID <> ''

     IF NOT EXISTS(SELECT OTP_NO FROM OTP_MSTR WHERE  OTP_BOID=@PA_BOID AND OTP_MOBILE = @PA_OTP_MOBILE and OTP_CMBPID = @PA_CMBPID AND OTP_TYPE ='C' AND OTP_DELETED_IND=1)
         INSERT INTO OTP_MSTR
         SELECT @PA_OTP_TYPE,@PA_OTP_MOBILE,@PA_BOID,'',@PA_OTPNO,'0',@PA_LOGINNAMES,GETDATE(),@PA_LOGINNAMES,GETDATE(),1,'', @PA_CMBPID

     ELSE
         UPDATE OTP_MSTR SET OTP_NO = @PA_OTPNO ,OTP_CREATED_DT = GETDATE(),OTP_LST_UPD_DT = GETDATE(),OTP_EXPIRED ='' WHERE  OTP_BOID=@PA_BOID AND OTP_MOBILE = @PA_OTP_MOBILE  AND OTP_CMBPID = @PA_CMBPID and OTP_TYPE ='C' AND  OTP_DELETED_IND=1

  ELSE

     IF NOT EXISTS(SELECT OTP_NO FROM OTP_MSTR WHERE  OTP_BOID=@PA_BOID AND OTP_MOBILE = @PA_OTP_MOBILE and OTP_CTR_BOID = @PA_TDPID AND OTP_TYPE ='C' AND OTP_DELETED_IND=1)
         INSERT INTO OTP_MSTR
         SELECT @PA_OTP_TYPE,@PA_OTP_MOBILE,@PA_BOID,@PA_TDPID,@PA_OTPNO,'0',@PA_LOGINNAMES,GETDATE(),@PA_LOGINNAMES,GETDATE(),1,'',@PA_CMBPID

     ELSE
         UPDATE OTP_MSTR SET OTP_NO = @PA_OTPNO ,OTP_CREATED_DT = GETDATE(),OTP_LST_UPD_DT = GETDATE(),OTP_EXPIRED ='' WHERE  OTP_BOID=@PA_BOID AND OTP_MOBILE = @PA_OTP_MOBILE AND OTP_CTR_BOID = @PA_TDPID and OTP_TYPE ='C' AND  OTP_DELETED_IND=1

Else IF @PA_ACTION ='DEL'

      IF NOT EXISTS(SELECT OTP_NO FROM OTP_MSTR WHERE  OTP_BOID=@PA_BOID AND OTP_MOBILE = @PA_OTP_MOBILE and OTP_CMBPID = @PA_CMBPID AND OTP_TYPE ='D' AND OTP_DELETED_IND=9)
         INSERT INTO OTP_MSTR
         SELECT @PA_OTP_TYPE,@PA_OTP_MOBILE,@PA_BOID,'',@PA_OTPNO,'0',@PA_LOGINNAMES,GETDATE(),@PA_LOGINNAMES,GETDATE(),9,'', @PA_CMBPID

     ELSE
         UPDATE OTP_MSTR SET OTP_NO = @PA_OTPNO ,OTP_CREATED_DT = GETDATE(),OTP_LST_UPD_DT = GETDATE(),OTP_EXPIRED ='' WHERE  OTP_BOID=@PA_BOID AND OTP_MOBILE = @PA_OTP_MOBILE  AND OTP_CMBPID = @PA_CMBPID and OTP_TYPE ='D' AND  OTP_DELETED_IND=9

END

GO
