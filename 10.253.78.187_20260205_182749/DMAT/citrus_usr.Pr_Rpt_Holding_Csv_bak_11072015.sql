-- Object: PROCEDURE citrus_usr.Pr_Rpt_Holding_Csv_bak_11072015
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

-- BEGIN TRAN
 /* 
ROLLBACK

COMMIT

 EXEC [Pr_Rpt_Holding_Csv] 'NSDL',4,'N','MAY 29 2009','10697005','','','N',1 ,'HO|*~|','11','2009093', '2009095',''		

EXEC PR_RPT_HOLDING 'NSDL',4,'N','2009-05-22','1203270000187997','1203270000187997','','Y',83001,'HO|*~|','','','',''	

EXEC [Pr_Rpt_Holding_Csv]	'CDSL','3','Y','','','','','N',1,'HO|*~|','','non poa a/c','',''	
*/
 
create PROC [citrus_usr].[Pr_Rpt_Holding_Csv_bak_11072015]  
			@PA_DPTYPE VARCHAR(4),                    
			@PA_EXCSMID INT,                    
			@PA_ASONDATE CHAR(1),                    
			@PA_FORDATE DATETIME,                    
			@PA_FROMACCID VARCHAR(16),                    
			@PA_TOACCID VARCHAR(16),                    
			@PA_ISINCD VARCHAR(12),              
			@PA_WITHVALUE CHAR(1), --Y/N                    
			@PA_LOGIN_PR_ENTM_ID NUMERIC,                      
			@PA_LOGIN_ENTM_CD_CHAIN  VARCHAR(8000),                      
            @PA_SETTM_TYPE VARCHAR(100),
            @PA_SETTM_NO_FR   VARCHAR(100),
            @PA_SETTM_NO_TO   VARCHAR(100),
			@PA_OUTPUT VARCHAR(8000) OUTPUT                      
AS                          
BEGIN                          
       

if @PA_SETTM_NO_TO = ''
set @PA_SETTM_NO_TO   = @PA_SETTM_NO_FR   
            
                   
DECLARE @@DPMID INT,                          
		@@TMPHOLDING_DT DATETIME
,@@ssql VARCHAR(8000)
set @pa_settm_type  = case when @pa_settm_type ='0' then  '' else  @pa_settm_type  end 

 SELECT @pa_settm_type = SETTM_TYPE FROM SETTLEMENT_TYPE_MSTR WHERE convert(varchar,SETTM_ID) = @pa_settm_type             AND SETTM_DELETED_IND = 1

 set @pa_settm_type = case when @pa_settm_type ='0' then  '' else  @pa_settm_type  end 

  
SELECT @@DPMID = DPM_ID FROM DP_MSTR WHERE DEFAULT_DP = @PA_EXCSMID AND DPM_DELETED_IND =1                          

DECLARE @@L_CHILD_ENTM_ID      NUMERIC                      

SELECT @@L_CHILD_ENTM_ID    =  CITRUS_USR.FN_GET_CHILD(@PA_LOGIN_PR_ENTM_ID , @PA_LOGIN_ENTM_CD_CHAIN)    


/*changed by tushar for ledger balance for client on 21 12 2009*/  


declare @pa_finyearid numeric

SELECT TOP 1 @PA_FORDATE = DPHMC_HOLDING_DT FROM DP_HLDG_MSTR_cdsl WHERE DPHMC_DELETED_IND =1
print @PA_FORDATE
select @pa_finyearid = fin_id from financial_yr_mstr where @PA_FORDATE  between FIN_START_DT and FIN_END_DT and FIN_DELETED_IND = 1 

create Table #temptable        
(        
 account_id [numeric] (19,4), 
 ACCOUNT_NO VARCHAR(20),
 ACCOUNT_NAME VARCHAR(500),       
 account_type varchar(2),        
 amount [numeric](18,2),        
 )   

CREATE TABLE #ACLIST1(dpam_id BIGINT,dpam_sba_no VARCHAR(16),dpam_sba_name VARCHAR(150),eff_from DATETIME,eff_to DATETIME,acct_type varchar(2))
 
	INSERT INTO #ACLIST1 SELECT DPAM_ID,dpam_sba_no,dpam_sba_name,EFF_FROM,EFF_TO,'P' FROM citrus_usr.fn_acct_list(@@DPMID ,@pa_login_pr_entm_id,@@l_child_entm_id)		
 
 
        
 set @@ssql = 'Insert into #temptable'         
 set @@ssql = @@ssql + ' select ldg_account_id,dpam_sba_no,dpam_sba_name,ldg_account_type,SUM(ISNULL(ldg_amount,0)) LDG_AMOUNT'     
 set @@ssql = @@ssql + ' from ledger' + convert(varchar,@pa_finyearid)  + ' , #ACLIST1 account '    
 set @@ssql = @@ssql + ' where ldg_dpm_id = ' + convert(varchar,@@DPMID) + 'and ldg_voucher_dt <= ''' + convert(varchar(11),@PA_FORDATE,109) + ' 23:59:59'''        
 set @@ssql = @@ssql + ' and ISNULL(ldg_trans_type,'''') <> ''O'''        
 set @@ssql = @@ssql + ' and ldg_account_id = account.dpam_id '            
 set @@ssql = @@ssql + ' and ldg_account_type = account.acct_type '            
         
 set @@ssql = @@ssql + ' and isnumeric(dpam_sba_no) = 1 '        
 set @@ssql = @@ssql + ' and (ldg_voucher_dt between eff_from and eff_to) '            
 if @pa_fromaccid <> '' and @pa_toaccid <> ''         
 begin        
   set @@ssql = @@ssql + ' and convert(bigint,dpam_sba_no) >= ' + @PA_FROMACCID + ' and convert(bigint,dpam_sba_no) <= ' + @PA_toACCID         
 end        
 set @@ssql = @@ssql + ' and ldg_account_type = ''P'' '        

   
 set @@ssql = @@ssql + ' and ldg_deleted_ind = 1 '        
 set @@ssql = @@ssql + ' GROUP by ldg_account_id,dpam_sba_no,dpam_sba_name,ldg_account_type'        
         
  print @@ssql
Exec(@@ssql)  
/*changed by tushar for ledger balance for client on 21 12 2009*/                  

CREATE TABLE 
#ACLIST
(
DPAM_ID BIGINT,
DPAM_CRN_NO NUMERIC(10,0),
DPAM_SBA_NO VARCHAR(16),
DPAM_SBA_NAME VARCHAR(150),
EFF_FROM DATETIME,
EFF_TO DATETIME
)  

CREATE TABLE 
#ACLIST_1
(
DPAM_ID BIGINT,
DPAM_CRN_NO NUMERIC(10,0),
DPAM_SBA_NO VARCHAR(16),
DPAM_SBA_NAME VARCHAR(150),
EFF_FROM DATETIME,
EFF_TO DATETIME
) 

  --select entp_value, entp_ent_id  into #entity_properties 
  --from entity_properties where ENTP_ENTPM_CD = 'BBO_CODE'

 select accp_value entp_value,ACCP_CLISBA_ID entp_ent_id into #entity_properties 
 from ACCOUNT_properties where ACCP_ACCPM_PROP_CD = 'bbo_code'
                       
                    
IF @PA_FROMACCID = ''                    

BEGIN                    

			 SET @PA_FROMACCID = '0'                    

			 SET @PA_TOACCID = '99999999999999999'                    

END                      

IF @PA_TOACCID = ''                    

			BEGIN                    

			 SET @PA_TOACCID = @PA_FROMACCID                    
END                    

                        
IF @PA_TOACCID =''                          
BEGIN                          

SET @PA_TOACCID= @PA_FROMACCID               

END                          
              
 IF @PA_WITHVALUE = 'N'              

 BEGIN  
          
  IF @PA_DPTYPE = 'NSDL'                          
  BEGIN              
      IF @PA_ASONDATE = 'Y'                          
      BEGIN                          
        
	SELECT TOP 1 @PA_FORDATE = DPDHM_HOLDING_DT FROM DP_HLDG_MSTR_NSDL WHERE DPDHM_DELETED_IND =1     

    INSERT INTO #ACLIST SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID)    

  PRINT('A')

  SELECT 
DPAM_ID,
DPAM_SBA_NAME ACCTNAME,
DPAM_SBA_NO ACCTNO,
BEN_TYPE=case when BEN.DESCP = 'PLEDGOR NON HOUSE ACCOUNT' then 'PLEDGE' else BEN.DESCP  end  + CASE WHEN LTRIM(RTRIM(DPDHM_SETT_TYPE)) <> '00' AND ISNULL(LTRIM(RTRIM(DPDHM_SETT_TYPE)),'') <> '' THEN ' - ' + SETTM_DESC +'/' + DPDHM_SETT_NO  ELSE '' END,
DPDHM_ISIN ISINCD,
ISIN_NAME,
CONVERT(NUMERIC(18,0),DPDHM_QTY)  QTY,
CASE WHEN DPDHM_BLK_LOCK_FLG = 'F' THEN 'FREE' WHEN  DPDHM_BLK_LOCK_FLG = 'L' THEN 'LOCK' WHEN DPDHM_BLK_LOCK_FLG = 'B' THEN 'BLOCK' ELSE '' END LOCKFLG,
HOLDING_DT=CONVERT(VARCHAR(11),@PA_FORDATE,109)  ,   CMP=ISNULL(convert(numeric(18,2),CLOPM_NSDL_RT),0.00)  , SETTM_DESC    , DPDHM_SETT_NO    setm_no                 

FROM DP_HLDG_MSTR_NSDL                    
LEFT OUTER JOIN  SETTLEMENT_TYPE_MSTR  ON DPDHM_SETT_TYPE  = SETTM_TYPE AND SETTM_DELETED_IND = 1  
LEFT OUTER JOIN  CLOSING_PRICE_MSTR_NSDL ON DPDHM_ISIN = CLOPM_ISIN_CD AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_NSDL WHERE CLOPM_ISIN_CD = DPDHM_ISIN and CLOPM_DT <= @PA_FORDATE and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc)                                                             
LEFT OUTER JOIN ISIN_MSTR ON DPDHM_ISIN = ISIN_CD,                    
#ACLIST ACCOUNT,    
CITRUS_USR.FN_GETSUBTRANSDTLS('BEN_ACCT_TYPE_NSDL') BEN    
WHERE DPDHM_HOLDING_DT = @PA_FORDATE AND DPDHM_DPM_ID = @@DPMID                          
AND DPDHM_DPAM_ID = ACCOUNT.DPAM_ID                      
AND (DPDHM_HOLDING_DT BETWEEN EFF_FROM AND EFF_TO)
and isNUMERIC(DPAM_SBA_NO) = 1 
AND (CONVERT(NUMERIC,DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC,@PA_FROMACCID) AND  CONVERT(NUMERIC,@PA_TOACCID))                          
AND DPDHM_ISIN LIKE @PA_ISINCD + '%'    
AND CASE WHEN ISNULL(@PA_SETTM_TYPE,'')='' THEN '0' ELSE ISNULL(DPDHM_SETT_TYPE,'') END = CASE WHEN ISNULL(@PA_SETTM_TYPE,'')='' THEN '0' ELSE @PA_SETTM_TYPE END
AND CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE ISNULL(DPDHM_SETT_NO,'') END BETWEEN CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE @PA_SETTM_NO_FR END and CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE @PA_SETTM_NO_To END
AND DPDHM_BENF_ACCT_TYP = BEN.CD   
 
AND DPDHM_QTY <> 0  
ORDER BY DPAM_SBA_NO,DPDHM_BENF_ACCT_TYP,DPDHM_SETT_NO                         
         

           
      END                          
      
ELSE                          

      BEGIN  
  
    


SELECT TOP 1 @@TMPHOLDING_DT = CASE WHEN DPDHM_HOLDING_DT > @PA_FORDATE THEN @PA_FORDATE ELSE DPDHM_HOLDING_DT END FROM DP_HLDG_MSTR_NSDL WHERE DPDHM_DELETED_IND =1   
SELECT 
			DPAM_ID=DPDHMD_DPAM_ID,
			DPAM_SBA_NAME ACCTNAME,
			DPAM_SBA_NO ACCTNO,
			BEN_TYPE=case when BEN.DESCP = 'PLEDGOR NON HOUSE ACCOUNT' then 'PLEDGE' else BEN.DESCP  end  + CASE WHEN LTRIM(RTRIM(DPDHMD_SETT_TYPE)) <> '00' AND ISNULL(LTRIM(RTRIM(DPDHMD_SETT_TYPE)),'') <> '' THEN  ' - ' + SETTM_DESC +'/' + DPDHMD_SETT_NO  ELSE '' END,
			DPDHMD_ISIN ISINCD,
			ISIN_NAME,
			CONVERT(NUMERIC(18,0),DPDHMD_QTY) QTY,
			CASE WHEN DPDHMD_BLK_LOCK_FLG = 'F' THEN 'FREE' WHEN  DPDHMD_BLK_LOCK_FLG = 'L' THEN 'LOCK' WHEN DPDHMD_BLK_LOCK_FLG = 'B' THEN 'BLOCK' ELSE '' END LOCKFLG,
			HOLDING_DT=CONVERT(VARCHAR(11),@@TMPHOLDING_DT,109)  ,   CMP=ISNULL(convert(numeric(18,2),CLOPM_NSDL_RT),0.00)    , SETTM_DESC SETTM_DESC, DPDHMD_SETT_NO   setm_no
FROM 
			FN_DAILYHOLDING
			(
						@@DPMID,
						@PA_FORDATE,
						@PA_FROMACCID,
						@PA_TOACCID,
						@PA_ISINCD,
						'',
						@PA_LOGIN_PR_ENTM_ID,
						@@L_CHILD_ENTM_ID
			)
		 LEFT OUTER JOIN  SETTLEMENT_TYPE_MSTR  ON DPDHMD_SETT_TYPE  = SETTM_TYPE AND SETTM_DELETED_IND = 1 
         LEFT OUTER JOIN  CLOSING_PRICE_MSTR_NSDL ON DPDHMD_ISIN = CLOPM_ISIN_CD AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_NSDL WHERE CLOPM_ISIN_CD = DPDHMD_ISIN and CLOPM_DT <= @@TMPHOLDING_DT and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc)                                                             
		 LEFT OUTER JOIN ISIN_MSTR ON DPDHMD_ISIN = ISIN_CD,
		 CITRUS_USR.FN_GETSUBTRANSDTLS('BEN_ACCT_TYPE_NSDL'
         ) BEN      
		 WHERE DPDHMD_BENF_ACCT_TYP = BEN.CD  
         AND CASE WHEN ISNULL(@PA_SETTM_TYPE,'')='' THEN '0' ELSE ISNULL(DPDHMD_SETT_TYPE,'') END = CASE WHEN ISNULL(@PA_SETTM_TYPE,'')='' THEN '0' ELSE @PA_SETTM_TYPE END
		 AND CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE ISNULL(DPDHMD_SETT_NO,'') END BETWEEN CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE @PA_SETTM_NO_FR END and CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE @PA_SETTM_NO_To END
		 ORDER BY DPAM_SBA_NO,DPDHMD_BENF_ACCT_TYP,DPDHMD_SETT_NO                          
					      
END                          
  END                          


 ELSE                          

 BEGIN                          
                      
  IF @PA_ASONDATE = 'Y'                          
  BEGIN  
 SELECT TOP 1 @PA_FORDATE = DPHMC_HOLDING_DT FROM DP_HLDG_MSTR_CDSL WHERE DPHMC_DELETED_IND =1                           
      
PRINT @@DPMID 
PRINT @PA_LOGIN_PR_ENTM_ID 
PRINT @@L_CHILD_ENTM_ID
 
IF @PA_SETTM_NO_TO <> ''
BEGIN  
	INSERT INTO #ACLIST_1 SELECT DPAM_ID,DPAM_CRN_NO,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID)    

	IF (@PA_SETTM_NO_TO = 'POA A/C' or @PA_SETTM_NO_TO = 'NOW - POA') 
	BEGIN
		INSERT INTO #ACLIST
		SELECT A.* FROM #ACLIST_1 A,DP_POA_DTLS B
		WHERE DPPD_DPAM_ID = DPAM_ID 
		AND DPPD_DELETED_IND = 1
	END
	ELSE IF (@PA_SETTM_NO_TO = 'NON POA A/C' or @PA_SETTM_NO_TO = 'NOW - NONPOA')
	BEGIN
PRINT 'JIT'
		/*INSERT INTO #ACLIST
		SELECT A.* FROM #ACLIST_1 A 
		LEFT OUTER JOIN DP_POA_DTLS B 
		ON DPPD_DPAM_ID = DPAM_ID 
		AND DPPD_DELETED_IND = 1*/

		INSERT INTO #ACLIST
		SELECT A.* FROM #ACLIST_1 A 
		where not exists (select DPPD_DPAM_ID from DP_POA_DTLS B where b.DPPD_DPAM_ID = a.DPAM_ID AND DPPD_DELETED_IND = 1)
	END
 END
 ELSE
 BEGIN
	INSERT INTO #ACLIST SELECT DPAM_ID,DPAM_CRN_NO,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID)    
 END

IF (@PA_SETTM_NO_TO = 'NOW - NONPOA' or @PA_SETTM_NO_TO = 'NOW - POA')
BEGIN
-- NOW SELECT FOR POA AND NONPOA -- ADDED CLASS MULTIISIN TABLE

SELECT DISTINCT
			DPAM_SBA_NAME,
			DPAM_SBA_NO,DPHMC_ISIN,
			ISIN_NAME,
			CONVERT(NUMERIC(18,0),DPHMC_CURR_QTY) DPHMC_CURR_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_FREE_QTY) DPHMC_FREE_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_FREEZE_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_PLEDGE_QTY) DPHMC_PLEDGE_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_DEMAT_PND_VER_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_REMAT_PND_CONF_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_DEMAT_PND_CONF_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_SAFE_KEEPING_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_LOCKIN_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_ELIMINATION_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_EARMARK_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_AVAIL_LEND_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_LEND_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_BORROW_QTY),
			DPAM_ID, 
			HOLDING_DT=CONVERT(VARCHAR(11),@PA_FORDATE,109)
			,isnull(ENTP_VALUE,'') AS SPARK_PARTY_CODE
			--,ltrim(rtrim(SPARK_PARTY_CODE)) SPARK_PARTY_CODE  
			--,ISNULL(amount,'0') AMOUNT               
            ,CONVERT(NUMERIC(18,0),DPHMC_CURR_QTY)-CONVERT(NUMERIC(18,0),DPHMC_PLEDGE_QTY) AMOUNT
			,CMP=ISNULL(convert(numeric(18,2),CLOPM_CDSL_RT),0.00) ,SCRIP_CD,SERIES
FROM 
			DP_HLDG_MSTR_CDSL LEFT OUTER JOIN ISIN_MSTR ON DPHMC_ISIN = ISIN_CD 
			LEFT OUTER JOIN CLOSING_PRICE_MSTR_cDSL ON DPHMC_ISIN = CLOPM_ISIN_CD AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_CDSL WHERE CLOPM_ISIN_CD = DPHMC_ISIN and CLOPM_DT <= @PA_FORDATE and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc)   ,                                      
			#ACLIST ACCOUNT   
			--LEFT OUTER JOIN  TMP_GET_SPARKPARTYCODE ON DPAM_SBA_NO =  ltrim(rtrim(demat_id))                        
			LEFT OUTER JOIN #entity_properties ON DPAM_id = ENTP_ENT_ID
            LEFT OUTER JOIN #temptable ON ACCOUNT_ID = DPAM_ID,
            (
				SELECT DISTINCT SCRIP_CD = UPPER(SCRIP_CD),
				SERIES = UPPER(SERIES),ISIN = UPPER(ISIN) 
				FROM [CLASS].MSAJAG.DBO.MULTIISIN WHERE VALID = 1 				
				
            ) t 
WHERE
			DPHMC_HOLDING_DT = @PA_FORDATE AND DPHMC_DPM_ID = @@DPMID                          
			AND DPHMC_DPAM_ID = ACCOUNT.DPAM_ID                      
			AND (DPHMC_HOLDING_DT BETWEEN EFF_FROM AND EFF_TO) 
            AND ISNUMERIC(DPAM_SBA_NO)=1                   
			AND (CONVERT(NUMERIC,DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC,@PA_FROMACCID) AND  CONVERT(NUMERIC,@PA_TOACCID))  
			AND ISNULL(DPHMC_FREE_QTY,0) <> 0        
			AND DPHMC_ISIN = t.ISIN                       
			AND DPHMC_ISIN LIKE @PA_ISINCD + '%'                          
ORDER BY 
			DPAM_SBA_NO,ISIN_NAME,DPHMC_ISIN    


-- NOW SELECT FOR POA AND NONPOA -- ADDED CLASS MULTIISIN TABLE
END 
ELSE
BEGIN
-- FOR REST OF NORMAL , POA AND NON POA

SELECT DISTINCT
			DPAM_SBA_NAME,
			DPAM_SBA_NO,DPHMC_ISIN,
			ISIN_NAME,
			CONVERT(NUMERIC(18,0),DPHMC_CURR_QTY) DPHMC_CURR_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_FREE_QTY) DPHMC_FREE_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_FREEZE_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_PLEDGE_QTY) DPHMC_PLEDGE_QTY,
			CONVERT(NUMERIC(18,0),DPHMC_DEMAT_PND_VER_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_REMAT_PND_CONF_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_DEMAT_PND_CONF_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_SAFE_KEEPING_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_LOCKIN_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_ELIMINATION_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_EARMARK_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_AVAIL_LEND_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_LEND_QTY),
			CONVERT(NUMERIC(18,0),DPHMC_BORROW_QTY),
			DPAM_ID, 
			HOLDING_DT=CONVERT(VARCHAR(11),@PA_FORDATE,109)
			,isnull(ENTP_VALUE,'') AS SPARK_PARTY_CODE
			--,ltrim(rtrim(SPARK_PARTY_CODE)) SPARK_PARTY_CODE  
			--,ISNULL(amount,'0') AMOUNT               
            ,CONVERT(NUMERIC(18,0),DPHMC_CURR_QTY)-CONVERT(NUMERIC(18,0),DPHMC_PLEDGE_QTY) AMOUNT
			,CMP=ISNULL(convert(numeric(18,2),CLOPM_CDSL_RT),0.00) 
FROM 
			DP_HLDG_MSTR_CDSL LEFT OUTER JOIN ISIN_MSTR ON DPHMC_ISIN = ISIN_CD 
			LEFT OUTER JOIN CLOSING_PRICE_MSTR_cDSL ON DPHMC_ISIN = CLOPM_ISIN_CD AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_CDSL WHERE CLOPM_ISIN_CD = DPHMC_ISIN and CLOPM_DT <= @PA_FORDATE and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc)   ,                                      
			#ACLIST ACCOUNT   
			--LEFT OUTER JOIN  TMP_GET_SPARKPARTYCODE ON DPAM_SBA_NO =  ltrim(rtrim(demat_id))                        
			LEFT OUTER JOIN #entity_properties ON DPAM_id = ENTP_ENT_ID
            LEFT OUTER JOIN #temptable ON ACCOUNT_ID = DPAM_ID
WHERE
			DPHMC_HOLDING_DT = @PA_FORDATE AND DPHMC_DPM_ID = @@DPMID                          
			AND DPHMC_DPAM_ID = ACCOUNT.DPAM_ID                      
			AND (DPHMC_HOLDING_DT BETWEEN EFF_FROM AND EFF_TO) 
            AND ISNUMERIC(DPAM_SBA_NO)=1                   
			AND (CONVERT(NUMERIC,DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC,@PA_FROMACCID) AND  CONVERT(NUMERIC,@PA_TOACCID))  
			AND ISNULL(DPHMC_FREE_QTY,0) <> 0                           
			AND DPHMC_ISIN LIKE @PA_ISINCD + '%'                          
ORDER BY 
			DPAM_SBA_NO,ISIN_NAME,DPHMC_ISIN         

-- FOR REST OF NORMAL , POA AND NON POA
END
                  

END                          

ELSE                          

BEGIN                          

 SELECT TOP 1 @@TMPHOLDING_DT = CASE WHEN DPHMC_HOLDING_DT > @PA_FORDATE THEN @PA_FORDATE ELSE DPHMC_HOLDING_DT END FROM DP_HLDG_MSTR_CDSL WHERE DPHMC_DELETED_IND =1   


 INSERT INTO #ACLIST SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID)    
  

SELECT DPAM_SBA_NAME,
DPAM_SBA_NO,
DPHMCD_ISIN,
ISIN_NAME,
CONVERT(NUMERIC(18,0),DPHMCD_CURR_QTY) DPHMCD_CURR_QTY,
CONVERT(NUMERIC(18,0),DPHMCD_FREE_QTY) DPHMCD_FREE_QTY,
CONVERT(NUMERIC(18,0),DPHMCD_FREEZE_QTY) DPHMCD_FREEZE_QTY,
CONVERT(NUMERIC(18,0),DPHMCD_PLEDGE_QTY) DPHMCD_PLEDGE_QTY,
CONVERT(NUMERIC(18,0),DPHMCD_DEMAT_PND_VER_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_REMAT_PND_CONF_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_DEMAT_PND_CONF_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_SAFE_KEEPING_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_LOCKIN_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_ELIMINATION_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_EARMARK_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_AVAIL_LEND_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_LEND_QTY),
CONVERT(NUMERIC(18,0),DPHMCD_BORROW_QTY),
		DPAM_ID,
		HOLDING_DT=CONVERT(VARCHAR(11),@@TMPHOLDING_DT,109),
		--ltrim(rtrim(SPARK_PARTY_CODE)) SPARK_PARTY_CODE  
		isnull(ENTP_VALUE,'') AS SPARK_PARTY_CODE
FROM 
		DP_DAILY_HLDG_CDSL LEFT OUTER JOIN ISIN_MSTR ON DPHMCD_ISIN = ISIN_CD,
		#ACLIST ACCOUNT  
		--LEFT OUTER JOIN  TMP_GET_SPARKPARTYCODE ON DPAM_SBA_NO =  ltrim(rtrim(demat_id))                                     
		LEFT OUTER JOIN #entity_properties ON DPAM_id = ENTP_ENT_ID

WHERE 
		DPHMCD_HOLDING_DT = @PA_FORDATE AND DPHMCD_DPM_ID = @@DPMID                          
		AND DPHMCD_DPAM_ID = ACCOUNT.DPAM_ID                      
		AND (DPHMCD_HOLDING_DT BETWEEN EFF_FROM AND EFF_TO)                    
		AND (CONVERT(NUMERIC,DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC,@PA_FROMACCID) AND  CONVERT(NUMERIC,@PA_TOACCID))   
		AND ISNULL(DPHMCD_CURR_QTY,0) <> 0                           
		AND DPHMCD_ISIN LIKE @PA_ISINCD + '%'                          

 ORDER BY DPAM_SBA_NO,ISIN_NAME,DPHMCD_ISIN                          

END                          
 END                          

 END              


 ELSE --@PA_WITHVALUE ='Y'              

 
BEGIN              

 IF @PA_DPTYPE = 'NSDL'                          
 BEGIN              
   IF @PA_ASONDATE = 'Y'                          
   BEGIN              

  SELECT TOP 1 @PA_FORDATE = DPDHM_HOLDING_DT 

	FROM 
		DP_HLDG_MSTR_NSDL WHERE DPDHM_DELETED_IND =1              
  
PRINT('D')

  INSERT INTO #ACLIST SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID)    
       
	SELECT 
				DPAM_ID=DPDHM_DPAM_ID,
				DPAM_SBA_NAME ACCTNAME,
				DPAM_SBA_NO ACCTNO,
				BEN_TYPE= case when BEN.DESCP = 'PLEDGOR NON HOUSE ACCOUNT' then 'PLEDGE' else BEN.DESCP  end  + CASE WHEN LTRIM(RTRIM(DPDHM_SETT_TYPE)) <> '00' AND ISNULL(LTRIM(RTRIM(DPDHM_SETT_TYPE)),'') <> '' THEN  ' - ' + SETTM_DESC + '/' + DPDHM_SETT_NO  ELSE '' END,
				DPDHM_ISIN ISINCD,
				ISIN_NAME,
				CONVERT(NUMERIC(18,0),DPDHM_QTY)  QTY,
				VALUATION= CONVERT(NUMERIC(18,2),DPDHM_QTY*ISNULL(CLOPM_NSDL_RT,0)),CASE WHEN DPDHM_BLK_LOCK_FLG = 'F' THEN 'FREE' WHEN  DPDHM_BLK_LOCK_FLG = 'L' THEN 'LOCK' WHEN DPDHM_BLK_LOCK_FLG = 'B' THEN 'BLOCK' ELSE '' END LOCKFLG,
				HOLDING_DT=CONVERT(VARCHAR(11),@PA_FORDATE,109),
				CMP=ISNULL(convert(numeric(18,2),CLOPM_NSDL_RT),0.00)   ,
                isnull(SETTM_DESC,'') settm_desc,DPDHM_SETT_NO setm_no
    FROM			
				DP_HLDG_MSTR_NSDL   
				LEFT OUTER JOIN  SETTLEMENT_TYPE_MSTR  ON DPDHM_SETT_TYPE  = SETTM_TYPE AND SETTM_DELETED_IND = 1                                        
				LEFT OUTER JOIN ISIN_MSTR ON DPDHM_ISIN = ISIN_CD              
				LEFT OUTER JOIN CLOSING_PRICE_MSTR_NSDL ON DPDHM_ISIN = CLOPM_ISIN_CD AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_NSDL WHERE CLOPM_ISIN_CD = DPDHM_ISIN and CLOPM_DT <= @PA_FORDATE and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc)                                                                            
				,#ACLIST ACCOUNT,    
				CITRUS_USR.FN_GETSUBTRANSDTLS('BEN_ACCT_TYPE_NSDL') BEN      
    WHERE 
				DPDHM_HOLDING_DT = @PA_FORDATE AND DPDHM_DPM_ID = @@DPMID                          
				AND DPDHM_DPAM_ID = ACCOUNT.DPAM_ID                      
				AND (DPDHM_HOLDING_DT BETWEEN EFF_FROM AND EFF_TO) 
                and  isnumeric(DPAM_SBA_NO)                    = 1
                AND CASE WHEN ISNULL(@PA_SETTM_TYPE,'')='' THEN '0' ELSE ISNULL(DPDHM_SETT_TYPE,'') END = CASE WHEN ISNULL(@PA_SETTM_TYPE,'')='' THEN '0' ELSE @PA_SETTM_TYPE END
		        AND CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE ISNULL(DPDHM_SETT_NO,'') END BETWEEN CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE @PA_SETTM_NO_FR END and CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE @PA_SETTM_NO_To END
		
				AND (CONVERT(NUMERIC,DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC,@PA_FROMACCID) AND  CONVERT(NUMERIC,@PA_TOACCID))                          
				AND DPDHM_ISIN LIKE @PA_ISINCD + '%'    
				AND DPDHM_BENF_ACCT_TYP = BEN.CD      
				AND DPDHM_QTY <> 0          

ORDER BY 
				DPAM_SBA_NO,
				ISIN_NAME,
				DPDHM_ISIN,
				DPDHM_BENF_ACCT_TYP,DPDHM_SETT_NO                          

	   END                          

ELSE
                          
	 BEGIN

PRINT('H')       
 
 SELECT TOP 1 @@TMPHOLDING_DT = CASE WHEN DPDHM_HOLDING_DT > @PA_FORDATE THEN @PA_FORDATE ELSE DPDHM_HOLDING_DT END FROM DP_HLDG_MSTR_NSDL WHERE DPDHM_DELETED_IND =1   
                     
  SELECT 
			DPAM_ID=DPDHMD_DPAM_ID,
			DPAM_SBA_NAME ACCTNAME,
			DPAM_SBA_NO ACCTNO,
			BEN_TYPE=case when BEN.DESCP = 'PLEDGOR NON HOUSE ACCOUNT' then 'PLEDGE' else BEN.DESCP  end  + CASE WHEN LTRIM(RTRIM(DPDHMD_SETT_TYPE)) <> '00' AND ISNULL(LTRIM(RTRIM(DPDHMD_SETT_TYPE)),'') <> '' THEN  ' - ' + SETTM_DESC +'/' + DPDHMD_SETT_NO  ELSE '' END,
			DPDHMD_ISIN ISINCD,
			ISIN_NAME,
			CONVERT(NUMERIC(18,0),DPDHMD_QTY) QTY,
			VALUATION= CONVERT(NUMERIC(18,2),DPDHMD_QTY*ISNULL(CLOPM_NSDL_RT,0)),
			CASE WHEN DPDHMD_BLK_LOCK_FLG = 'F' THEN 'FREE' WHEN  DPDHMD_BLK_LOCK_FLG = 'L' THEN 'LOCK' WHEN DPDHMD_BLK_LOCK_FLG = 'B' THEN 'BLOCK' ELSE '' END LOCKFLG,
			HOLDING_DT=CONVERT(VARCHAR(11),@@TMPHOLDING_DT,109),
			CMP=ISNULL(convert(numeric(18,2),CLOPM_NSDL_RT),0.00)    , SETTM_DESC SETTM_DESC, DPDHMD_SETT_NO     setm_no                    
  FROM 
			FN_DAILYHOLDING
(
			@@DPMID,
			@PA_FORDATE,
			@PA_FROMACCID,
			@PA_TOACCID,
			@PA_ISINCD,
			'',
			@PA_LOGIN_PR_ENTM_ID,
			@@L_CHILD_ENTM_ID
)   
	  LEFT OUTER JOIN  SETTLEMENT_TYPE_MSTR  ON DPDHMD_SETT_TYPE  = SETTM_TYPE AND SETTM_DELETED_IND = 1                              
	  LEFT OUTER JOIN ISIN_MSTR ON DPDHMD_ISIN = ISIN_CD         
	  LEFT OUTER JOIN CLOSING_PRICE_MSTR_NSDL ON DPDHMD_ISIN = CLOPM_ISIN_CD  AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_NSDL WHERE CLOPM_ISIN_CD = DPDHMD_ISIN and CLOPM_DT <= @@TMPHOLDING_DT and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc)                                                                                ,                    
	  CITRUS_USR.FN_GETSUBTRANSDTLS('BEN_ACCT_TYPE_NSDL'
      ) BEN     
  
	WHERE 
			DPDHMD_BENF_ACCT_TYP = BEN.CD     
    AND CASE WHEN ISNULL(@PA_SETTM_TYPE,'')='' THEN '0' ELSE ISNULL(DPDHMD_SETT_TYPE,'') END = CASE WHEN ISNULL(@PA_SETTM_TYPE,'')='' THEN '0' ELSE @PA_SETTM_TYPE END
	  AND CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE ISNULL(DPDHMD_SETT_NO,'') END BETWEEN CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE @PA_SETTM_NO_FR END and CASE WHEN ISNULL(@PA_SETTM_NO_FR,'')='' THEN '0' ELSE @PA_SETTM_NO_To END
	
	ORDER BY 
			DPAM_SBA_NO,
			ISIN_NAME,
			DPDHMD_ISIN,
			DPDHMD_BENF_ACCT_TYP  ,DPDHMD_SETT_NO                        
   
END                          

 END                          
 
ELSE                          

 BEGIN                          

PRINT('F')
   IF @PA_ASONDATE = 'Y'                          
   BEGIN                      
     SELECT TOP 1 @PA_FORDATE = DPHMC_HOLDING_DT FROM DP_HLDG_MSTR_CDSL WHERE DPHMC_DELETED_IND =1              
  


     INSERT INTO #ACLIST SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID)    

     SELECT DISTINCT DPAM_SBA_NAME,DPAM_SBA_NO,DPHMC_ISIN,ISIN_NAME,CONVERT(NUMERIC(18,0),DPHMC_CURR_QTY),VALUATION=CONVERT(NUMERIC(18,2),DPHMC_CURR_QTY*ISNULL(CLOPM_CDSL_RT,0)), CONVERT(NUMERIC(18,0),DPHMC_FREE_QTY),CONVERT(NUMERIC(18,0),DPHMC_FREEZE_QTY)      
     ,CONVERT(NUMERIC(18,0),DPHMC_PLEDGE_QTY),CONVERT(NUMERIC(18,0),DPHMC_DEMAT_PND_VER_QTY),CONVERT(NUMERIC(18,0),DPHMC_REMAT_PND_CONF_QTY),CONVERT(NUMERIC(18,0),DPHMC_DEMAT_PND_CONF_QTY),CONVERT(NUMERIC(18,0),DPHMC_SAFE_KEEPING_QTY),CONVERT(NUMERIC(18,0),DPHMC_LOCKIN_QTY)      
     ,CONVERT(NUMERIC(18,0),DPHMC_ELIMINATION_QTY),CONVERT(NUMERIC(18,0),DPHMC_EARMARK_QTY),CONVERT(NUMERIC(18,0),DPHMC_AVAIL_LEND_QTY),CONVERT(NUMERIC(18,0),DPHMC_LEND_QTY),CONVERT(NUMERIC(18,0),DPHMC_BORROW_QTY),DPAM_ID, HOLDING_DT=CONVERT(VARCHAR(11),@PA_FORDATE,109),CMP=ISNULL(convert(numeric(18,2),CLOPM_CDSL_RT),0.00)    
	, ISNULL(amount,'0') AMOUNT               
     FROM DP_HLDG_MSTR_CDSL               
     LEFT OUTER JOIN ISIN_MSTR ON DPHMC_ISIN = ISIN_CD              
     LEFT OUTER JOIN CLOSING_PRICE_MSTR_cDSL ON DPHMC_ISIN = CLOPM_ISIN_CD AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_CDSL WHERE CLOPM_ISIN_CD = DPHMC_ISIN and CLOPM_DT <= @PA_FORDATE and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc)   ,                    
     #ACLIST ACCOUNT                                
	 LEFT OUTER JOIN #temptable ON ACCOUNT_ID =  ISNULL(DPAM_ID,'0')
     WHERE DPHMC_HOLDING_DT = @PA_FORDATE AND DPHMC_DPM_ID = @@DPMID                          
     AND DPHMC_DPAM_ID = ACCOUNT.DPAM_ID                      
     AND (DPHMC_HOLDING_DT BETWEEN EFF_FROM AND EFF_TO) 
     AND ISNUMERIC(DPAM_SBA_NO)=1                  
     AND (CONVERT(NUMERIC,DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC,@PA_FROMACCID) AND  CONVERT(NUMERIC,@PA_TOACCID))                         
     AND DPHMC_ISIN LIKE @PA_ISINCD + '%'      
     AND ISNULL(DPHMC_CURR_QTY,0) <> 0             
     ORDER BY DPAM_SBA_NO,ISIN_NAME,DPHMC_ISIN                          

   END                          
   ELSE                          
   BEGIN         

   SELECT TOP 1 @@TMPHOLDING_DT = CASE WHEN DPHMC_HOLDING_DT > @PA_FORDATE THEN @PA_FORDATE ELSE DPHMC_HOLDING_DT END FROM DP_HLDG_MSTR_CDSL WHERE DPHMC_DELETED_IND =1   
  
   INSERT INTO #ACLIST SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID)    
                   
     SELECT DPAM_SBA_NAME,DPAM_SBA_NO,DPHMCD_ISIN,ISIN_NAME,CONVERT(NUMERIC(18,0),DPHMCD_CURR_QTY),VALUATION=CONVERT(NUMERIC(18,2),DPHMCD_CURR_QTY*ISNULL(CLOPM_CDSL_RT,0)),CONVERT(NUMERIC(18,0),DPHMCD_FREE_QTY),CONVERT(NUMERIC(18,0),DPHMCD_FREEZE_QTY),CONVERT(NUMERIC(18,0),DPHMCD_PLEDGE_QTY)      
     ,CONVERT(NUMERIC(18,0),DPHMCD_DEMAT_PND_VER_QTY),CONVERT(NUMERIC(18,0),DPHMCD_REMAT_PND_CONF_QTY),CONVERT(NUMERIC(18,0),DPHMCD_DEMAT_PND_CONF_QTY),CONVERT(NUMERIC(18,0),DPHMCD_SAFE_KEEPING_QTY),CONVERT(NUMERIC(18,0),DPHMCD_LOCKIN_QTY)                
    
     ,CONVERT(NUMERIC(18,0),DPHMCD_ELIMINATION_QTY),CONVERT(NUMERIC(18,0),DPHMCD_EARMARK_QTY),CONVERT(NUMERIC(18,0),DPHMCD_AVAIL_LEND_QTY),CONVERT(NUMERIC(18,0),DPHMCD_LEND_QTY),CONVERT(NUMERIC(18,0),DPHMCD_BORROW_QTY),DPAM_ID,HOLDING_DT=CONVERT(VARCHAR(11),@@TMPHOLDING_DT,109),CMP=ISNULL(convert(numeric(18,2),CLOPM_CDSL_RT),0.00)                                     
     FROM DP_DAILY_HLDG_CDSL               
     LEFT OUTER JOIN ISIN_MSTR ON DPHMCD_ISIN = ISIN_CD              
     LEFT OUTER JOIN CLOSING_PRICE_MSTR_cDSL ON DPHMCD_ISIN = CLOPM_ISIN_CD AND ISNULL(CLOPM_DT,'01/01/1900') = ( select top 1 CLOPM_DT from CLOSING_PRICE_MSTR_CDSL WHERE CLOPM_ISIN_CD = DPHMCD_ISIN and CLOPM_DT <= @@TMPHOLDING_DT and CLOPM_DELETED_IND = 1  order by CLOPM_DT desc),                     
     #ACLIST ACCOUNT                                      
     WHERE DPHMCD_HOLDING_DT = @PA_FORDATE AND DPHMCD_DPM_ID = @@DPMID                          
     AND DPHMCD_DPAM_ID = ACCOUNT.DPAM_ID                      
     AND (DPHMCD_HOLDING_DT BETWEEN EFF_FROM AND EFF_TO)                    
     AND (CONVERT(NUMERIC,DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC,@PA_FROMACCID) AND  CONVERT(NUMERIC,@PA_TOACCID))                          
     AND DPHMCD_ISIN LIKE @PA_ISINCD + '%'   
     AND ISNULL(DPHMCD_CURR_QTY,0) <> 0              
     ORDER BY DPAM_SBA_NO,ISIN_NAME,DPHMCD_ISIN                          
         
   END                          
                            
    END             
              
              
END              
	   
  
      TRUNCATE TABLE #ACLIST  
   DROP TABLE #ACLIST             

	exec [pr_import_property_acct] 'bbo_code'  
                          
END

GO
