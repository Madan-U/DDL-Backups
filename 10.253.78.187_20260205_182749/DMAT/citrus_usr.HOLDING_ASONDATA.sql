-- Object: PROCEDURE citrus_usr.HOLDING_ASONDATA
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

CREATE PROCEDURE HOLDING_ASONDATA 
(
@Fdate varchar(15),@Tdate varchar(15) 
)
as 
begin 
  
DECLARE @FromDate DATETIME=CAST(@Fdate  AS DATETIME)  
  
DECLARE @ToDate DATETIME=dateadd(ms, -3, (dateadd(day, +1, convert(varchar, @Tdate, 101))))--DATEADD(DD, -1, DATEADD(D, 1, CONVERT(DATETIME2, @Tdate)))  

 SELECT * INTO #HOLD2 FROM  SYNERGY_HOLDING WHERE HLD_HOLD_DATE>=@FromDate AND HLD_HOLD_DATE<=@ToDate
 
    
  
  SELECT * INTO #CLOSIN1 FROM  VW_ISIN_RATE_MASTER A,
  (SELECT ISIN AS ISIN_NO,MAX(RATE_DATE) RATE  FROM  VW_ISIN_RATE_MASTER WHERE  RATE_DATE <=@ToDate GROUP BY ISIN )B
  WHERE A.ISIN=B.ISIN_NO  AND A.RATE_DATE =B.RATE 

  
 
 SELECT HLD_AC_CODE,SUM(HLD_AC_POS*CLOSE_PRICE)VALUE   FROM #HOLD2 H, #CLOSIN1 WHERE ISIN=HLD_ISIN_CODE
 ---and HLD_AC_CODE='1203320005663611'
   GROUP BY HLD_AC_CODE
   
   END

GO
