-- Object: PROCEDURE citrus_usr.PR_RPT_EOD_COLLECTION_SUMMARY
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

---
--SELECTION CRITERIA :    
--SELECT * FROM FINANCIAL_YR_MSTR  
 --3   JAN 14 2008 SEP 14 2009 1 CR   1    
--RECEIPT DATE FROM  08/09/2009 TO 08/09/2009 STATUS A DR / CR  CR ACCOUNT NO  ALL BATCH NO  ALL USER ID  ALL GROUP CD  ALL   
--EXEC [PR_RPT_EOD_COLLECTION_SUMMARY] 3,'','','','','','',1,'HO|*~|*|~*',''  
CREATE PROCEDURE [citrus_usr].[PR_RPT_EOD_COLLECTION_SUMMARY](@PA_ID  NUMERIC  
                                   ,@PA_FROM_ACCT VARCHAR(100)  
                                   ,@PA_TO_ACCT   VARCHAR(100)  
                                   ,@PA_FROM_DT   DATETIME  
                                  -- ,@PA_TO_DT     DATETIME  
                                   ,@PA_STATUS    CHAR(100)  
                                   ,@PA_CR_DR     CHAR(1)  
                                   ,@PA_BATCH_NO  VARCHAR(10)  
                                   ,@PA_ENTRY_ID  VARCHAR(100)  
                                   , @PA_LOGIN_PR_ENTM_ID NUMERIC                          
                                   , @PA_LOGIN_ENTM_CD_CHAIN  VARCHAR(8000)   
                                   ,@PA_OUT       VARCHAR(8000) OUT )  
AS  
BEGIN  
  
  
DECLARE @@L_CHILD_ENTM_ID NUMERIC  
  , @@DPMID NUMERIC  
  
IF @PA_FROM_ACCT = ''                        
 BEGIN                        
  SET @PA_FROM_ACCT = '0'                        
  SET @PA_TO_ACCT = '99999999999999999'                        
 END                        
 IF @PA_TO_ACCT = ''                        
 BEGIN                    
   SET @PA_TO_ACCT = @PA_FROM_ACCT                        
 END         
  
SELECT @@DPMID = DPM_ID FROM DP_MSTR WITH(NOLOCK) WHERE DPM_EXCSM_ID = DEFAULT_DP  AND DEFAULT_DP = @PA_ID AND DPM_DELETED_IND =1                        
  
CREATE TABLE #LEDGER   
(LDG_DPM_ID NUMERIC  
,LDG_VOUCHER_TYPE INT  
,LDG_BOOK_TYPE_CD VARCHAR(4)  
,LDG_VOUCHER_NO NUMERIC  
,LDG_REF_NO VARCHAR(50)  
,LDG_VOUCHER_DT DATETIME  
,LDG_ACCOUNT_ID NUMERIC  
,LDG_ACCOUNT_TYPE CHAR(1)  
,LDG_AMOUNT NUMERIC(18,4)  
,LDG_NARRATION VARCHAR(250)  
,LDG_STATUS CHAR(1)  
,LDG_CREATED_BY VARCHAR(50)  
,LDG_CREATED_DT DATETIME  
,LDG_LST_UPD_BY VARCHAR(50)  
,LDG_LST_UPD_DT DATETIME  
,LDG_DELETED_IND SMALLINT )   
  

  
DECLARE @@FIN_YR_ID  NUMERIC  
IF EXISTS(SELECT FIN_ID FROM FINANCIAL_YR_MSTR WHERE @PA_FROM_DT  BETWEEN FIN_START_DT AND FIN_END_DT   
AND FIN_DPM_ID = @@DPMID)  
BEGIN  
SELECT @@FIN_YR_ID  = FIN_ID FROM FINANCIAL_YR_MSTR WHERE @PA_FROM_DT BETWEEN FIN_START_DT AND FIN_END_DT   
AND FIN_DPM_ID = @@DPMID  
END  
ELSE   
BEGIN  

SELECT @PA_OUT = 'PLEASE SELECT FROM DATE & TO DATE BETWEEN FINANCIAL YEAR'   
--PRINT @PA_OUT  
RETURN  
END   

DECLARE @@L_SQL VARCHAR(8000)  
SET @@L_SQL = 'INSERT INTO #LEDGER SELECT LDG_DPM_ID   
,LDG_VOUCHER_TYPE   
,LDG_BOOK_TYPE_CD   
,LDG_VOUCHER_NO   
,LDG_REF_NO  
,LDG_VOUCHER_DT   
,LDG_ACCOUNT_ID   
,LDG_ACCOUNT_TYPE   
,LDG_AMOUNT   
,LDG_NARRATION   
,LDG_STATUS   
,LDG_CREATED_BY   
,LDG_CREATED_DT   
,LDG_LST_UPD_BY   
,LDG_LST_UPD_DT   
,LDG_DELETED_IND   FROM LEDGER' + CONVERT(VARCHAR,@@FIN_YR_ID )  
+ ' WHERE convert(varchar(11),LDG_VOUCHER_DT,103) = ''' + convert(varchar(11),@PA_FROM_DT,103) + ''''  
PRINT @@L_SQL  
  
EXEC(@@L_SQL)  
  
  
SELECT @@L_CHILD_ENTM_ID    =  CITRUS_USR.FN_GET_CHILD(@PA_LOGIN_PR_ENTM_ID , @PA_LOGIN_ENTM_CD_CHAIN)  
   
CREATE TABLE #ACLIST(DPAM_ID BIGINT,DPAM_SBA_NO VARCHAR(16),DPAM_SBA_NAME VARCHAR(150),EFF_FROM DATETIME,EFF_TO DATETIME)  
  
INSERT INTO #ACLIST SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,EFF_TO FROM CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID)    
  
  
  
  
Create Table #EOD_IND  
(EOD_DESC      VARCHAR(1000)  
,EOD_PAY_MODE  VARCHAR(100)  
,EOD_DR_AMOUNT    NUMERIC(18,2)  
,EOD_CR_AMOUNT    NUMERIC(18,2)  
,EOD_USER_ID   VARCHAR(100)  
)  
  


  
IF EXISTS(SELECT EXCSM_EXCH_CD FROM EXCH_SEG_MSTR , DP_MSTR WHERE DEFAULT_DP = DPM_EXCSM_ID AND DPM_EXCSM_ID = @PA_ID AND EXCSM_ID = DPM_EXCSM_ID AND EXCSM_ID = 1 AND EXCSM_EXCH_CD = 'CDSL')  
BEGIN  
 INSERT INTO #EOD_IND(EOD_DESC,EOD_PAY_MODE,EOD_DR_AMOUNT,EOD_CR_AMOUNT,EOD_USER_ID)  
 SELECT '1',INWSR_PAY_MODE PAYMENT_MODE   
      , '0' DR_AMOUNT  
      , ISNULL(INWSR_UFCHARGE_COLLECTED,'0') CR_AMOUNT  
      , INWSR_CREATED_BY [ENTRY_ID]  
 FROM   #LEDGER , INWARD_SLIP_REG    
    ,   DP_ACCT_MSTR DPAM  
    ,   DP_MSTR , #ACLIST ACCOUNT  
 WHERE  LDG_CREATED_BY ='INWARDENTRY'    
 AND    ISNULL(INWSR_TRASTM_CD,'') + '_'+ ISNULL(INWSR_SLIP_NO,'') =  LDG_REF_NO  
 AND    INWSR_DPAM_ID     = DPAM.DPAM_ID   and ldg_account_id = INWSR_DPAM_ID 
 AND    ACCOUNT.DPAM_ID = DPAM.DPAM_ID   
 AND    INWSR_DPM_ID      = DPAM.DPAM_DPM_ID   
 AND    DPAM.DPAM_DPM_ID       = DPM_ID   
 AND    DPM_EXCSM_ID      = DEFAULT_DP   
 AND    DPM_EXCSM_ID      = @PA_ID  
 AND    convert(varchar(11),INWSR_CREATED_DT,103) = convert(varchar(11),@PA_FROM_DT,103)  
 AND DPAM.DPAM_SBA_NO >= @PA_FROM_ACCT AND DPAM.DPAM_SBA_NO  <= @PA_TO_ACCT  
 AND    DPM_DELETED_IND   = 1  
 AND    DPAM.DPAM_DELETED_IND  = 1  
 AND    INWSR_DELETED_IND = 1   
 INSERT INTO #EOD_IND(EOD_DESC,EOD_PAY_MODE,EOD_DR_AMOUNT,EOD_CR_AMOUNT,EOD_USER_ID)  
 SELECT '1','AUTO CREDIT ' PAYMENT_MODE   
      , CASE WHEN LDG_AMOUNT < 0 THEN CONVERT(VARCHAR,ABS(LDG_AMOUNT)) ELSE '0' END DR_AMOUNT  
      , CASE WHEN LDG_AMOUNT > 0 THEN CONVERT(VARCHAR,ABS(LDG_AMOUNT)) ELSE '0' END CR_AMOUNT  
      , LDG_CREATED_BY [ENTRY_ID]  
 FROM   #LEDGER ,   DP_ACCT_MSTR DPAM  
    ,   DP_MSTR , #ACLIST ACCOUNT  
 WHERE  LDG_ACCOUNT_ID = DPAM.DPAM_ID AND LDG_VOUCHER_TYPE = '3'  
 AND    LDG_NARRATION  LIKE 'RECOVERED FROM TRADING A/C TOWARDS CURR O/S ON%'  
 AND    ACCOUNT.DPAM_ID = DPAM.DPAM_ID   
 AND    LDG_DPM_ID      = DPAM.DPAM_DPM_ID   
 AND    DPAM.DPAM_DPM_ID       = DPM_ID   
 AND    DPM_EXCSM_ID      = DEFAULT_DP   
 AND    DPM_EXCSM_ID      = @PA_ID  
 AND    convert(varchar(11),ldg_voucher_dt,103) = convert(varchar(11),@PA_FROM_DT,103)  
 AND DPAM.DPAM_SBA_NO >= @PA_FROM_ACCT AND DPAM_SBA_NO  <= @PA_TO_ACCT  
 AND    DPM_DELETED_IND   = 1  
 AND    DPAM.DPAM_DELETED_IND  = 1  
 AND    LDG_DELETED_IND = 1    
 INSERT INTO #EOD_IND(EOD_DESC,EOD_PAY_MODE,EOD_DR_AMOUNT,EOD_CR_AMOUNT,EOD_USER_ID)  
 SELECT '1','AUTO CREDIT ' PAYMENT_MODE   
      , CASE WHEN LDG_AMOUNT < 0 THEN CONVERT(VARCHAR,ABS(LDG_AMOUNT)) ELSE '0' END DR_AMOUNT  
      , CASE WHEN LDG_AMOUNT > 0 THEN CONVERT(VARCHAR,ABS(LDG_AMOUNT)) ELSE '0' END CR_AMOUNT  
      , LDG_CREATED_BY [ENTRY_ID]  
 FROM   #LEDGER ,   DP_ACCT_MSTR DPAM  
    ,   DP_MSTR , #ACLIST ACCOUNT  
 WHERE  LDG_ACCOUNT_ID = DPAM.DPAM_ID AND LDG_VOUCHER_TYPE = '2'  
 AND    LDG_NARRATION  LIKE 'CREDIT RECD. FROM PARTY%'  
 AND    ACCOUNT.DPAM_ID = DPAM.DPAM_ID   
 AND    LDG_DPM_ID      = DPAM.DPAM_DPM_ID   
 AND    DPAM.DPAM_DPM_ID       = DPM_ID   
 AND    DPM_EXCSM_ID      = DEFAULT_DP   
 AND    DPM_EXCSM_ID      = @PA_ID  
 AND    convert(varchar(11),ldg_voucher_dt,103) = convert(varchar(11),@PA_FROM_DT,103)  
 AND    DPAM.DPAM_SBA_NO >= @PA_FROM_ACCT AND DPAM.DPAM_SBA_NO  <= @PA_TO_ACCT  
 AND    DPM_DELETED_IND   = 1  
 AND    DPAM.DPAM_DELETED_IND  = 1  
 AND    LDG_DELETED_IND = 1    
END   
ELSE   
BEGIN  
PRINT 'TT'  
INSERT INTO #EOD_IND (EOD_DESC,EOD_PAY_MODE,EOD_DR_AMOUNT,EOD_CR_AMOUNT,EOD_USER_ID)  
 SELECT '1',INWSR_PAY_MODE PAYMENT_MODE   
      , '0' DR_AMOUNT  
      , ISNULL(INWSR_UFCHARGE_COLLECTED,'0') CR_AMOUNT  
      ,  INWSR_CREATED_BY [ENTRY_ID]  
 FROM    #LEDGER , INWARD_SLIP_REG   
    ,   DP_ACCT_MSTR DPAM  
    ,   DP_MSTR , #ACLIST ACCOUNT  
 WHERE  LDG_CREATED_BY ='INWARDENTRY'    
 AND    ISNULL(INWSR_TRASTM_CD,'') + '_'+ ISNULL(INWSR_SLIP_NO,'') =  LDG_REF_NO  
 AND    INWSR_DPAM_ID     = DPAM.DPAM_ID  AND DPAM.DPAM_ID = ACCOUNT.DPAM_ID     and ldg_account_id = INWSR_DPAM_ID 
 AND    INWSR_DPM_ID      = DPAM.DPAM_DPM_ID   
 AND    DPAM.DPAM_DPM_ID       = DPM_ID   
 AND    DPM_EXCSM_ID      = DEFAULT_DP   
 AND    DPM_EXCSM_ID      = @PA_ID  
 AND    convert(varchar(11),INWSR_CREATED_DT,103) = convert(varchar(11),@PA_FROM_DT,103)  
AND DPAM.DPAM_SBA_NO >= @PA_FROM_ACCT AND DPAM.DPAM_SBA_NO  <= @PA_TO_ACCT  
 AND    DPM_DELETED_IND   = 1  
 AND    DPAM.DPAM_DELETED_IND  = 1  
 AND    INWSR_DELETED_IND = 1   
INSERT INTO #EOD_IND(EOD_DESC,EOD_PAY_MODE,EOD_DR_AMOUNT,EOD_CR_AMOUNT,EOD_USER_ID)  
 SELECT '1','AUTO CREDIT' PAYMENT_MODE   
      , CASE WHEN LDG_AMOUNT < 0 THEN CONVERT(VARCHAR,ABS(LDG_AMOUNT)) ELSE '0' END DR_AMOUNT  
      , CASE WHEN LDG_AMOUNT > 0 THEN CONVERT(VARCHAR,ABS(LDG_AMOUNT)) ELSE '0' END CR_AMOUNT  
      , LDG_CREATED_BY [ENTRY_ID]  
 FROM   #LEDGER ,   DP_ACCT_MSTR DPAM  
    ,   DP_MSTR , #ACLIST ACCOUNT  
 WHERE  LDG_ACCOUNT_ID = DPAM.DPAM_ID AND LDG_VOUCHER_TYPE = '3'  
 AND    LDG_NARRATION  LIKE 'RECOVERED FROM TRADING A/C TOWARDS CURR O/S ON%'  
 AND    ACCOUNT.DPAM_ID = DPAM.DPAM_ID   
 AND    LDG_DPM_ID      = DPAM.DPAM_DPM_ID   
 AND    DPAM.DPAM_DPM_ID       = DPM_ID   
 AND    DPM_EXCSM_ID      = DEFAULT_DP   
 AND    DPM_EXCSM_ID      = @PA_ID  
 AND    convert(varchar(11),ldg_voucher_dt,103) = convert(varchar(11),@PA_FROM_DT,103)  
AND DPAM.DPAM_SBA_NO >= @PA_FROM_ACCT AND DPAM.DPAM_SBA_NO  <= @PA_TO_ACCT  
 AND    DPM_DELETED_IND   = 1  
 AND    DPAM.DPAM_DELETED_IND  = 1  
 AND    LDG_DELETED_IND = 1    
INSERT INTO #EOD_IND(EOD_DESC,EOD_PAY_MODE,EOD_DR_AMOUNT,EOD_CR_AMOUNT,EOD_USER_ID)    
 SELECT '1','AUTO CREDIT ' PAYMENT_MODE   
      , CASE WHEN LDG_AMOUNT < 0 THEN CONVERT(VARCHAR,ABS(LDG_AMOUNT)) ELSE '0' END DR_AMOUNT  
      , CASE WHEN LDG_AMOUNT > 0 THEN CONVERT(VARCHAR,ABS(LDG_AMOUNT)) ELSE '0' END CR_AMOUNT  
      , LDG_CREATED_BY [ENTRY_ID]  
 FROM   #LEDGER ,   DP_ACCT_MSTR DPAM  
    ,   DP_MSTR , #ACLIST ACCOUNT  
 WHERE  LDG_ACCOUNT_ID = DPAM.DPAM_ID AND LDG_VOUCHER_TYPE = '2'  
 AND    LDG_NARRATION  LIKE 'CREDIT RECD. FROM PARTY%'  
 AND    ACCOUNT.DPAM_ID = DPAM.DPAM_ID   
 AND    LDG_DPM_ID      = DPAM.DPAM_DPM_ID   
 AND    DPAM.DPAM_DPM_ID       = DPM_ID   
 AND    DPM_EXCSM_ID      = DEFAULT_DP   
 AND    DPM_EXCSM_ID      = @PA_ID  
 AND    convert(varchar(11),ldg_voucher_dt,103) = convert(varchar(11),@PA_FROM_DT,103)  
 AND    DPAM.DPAM_SBA_NO >= @PA_FROM_ACCT AND DPAM.DPAM_SBA_NO  <= @PA_TO_ACCT  
 AND    DPM_DELETED_IND   = 1  
 AND    DPAM.DPAM_DELETED_IND  = 1  
 AND    LDG_DELETED_IND = 1    
END   
  
INSERT INTO #EOD_IND   
SELECT '2', INWCR_PAY_MODE ,'0' , inwcr_charge_collected , inwcr_created_by FROM inw_client_reg  
where convert(varchar(11),inwcr_created_dt,103) = convert(varchar(11),@PA_FROM_DT,103)   
and inwcr_deleted_ind = 1   
  



SELECT EOD_DESC,EOD_PAY_MODE,SUM(EOD_DR_AMOUNT+EOD_CR_AMOUNT) AMOUNT,EOD_USER_ID INTO #EOD_IND_SUMMARY FROM #EOD_IND  
GROUP BY EOD_DESC,EOD_PAY_MODE,EOD_USER_ID   
  


  
Create Table #EOD_COLLECTION_SUMMARY  
(EOD_DESC      VARCHAR(1000)  
,EOD_USER_ID   VARCHAR(100)  
,EOD_CASH      NUMERIC(18,2)  
,EOD_CHEQUE    NUMERIC(18,2)  
,EOD_DD        NUMERIC(18,2)  
,EOD_OTHERS    NUMERIC(18,2)  
,EOD_AUTO_CR   NUMERIC(18,2)  
,EOD_AUTO_DR   NUMERIC(18,2)  
,EOD_WAIVER    NUMERIC(18,2)  
)  
  
INSERT INTO #EOD_COLLECTION_SUMMARY(EOD_DESC,EOD_USER_ID)  
SELECT DISTINCT EOD_DESC , EOD_USER_ID   
FROM #EOD_IND  
  

UPDATE SUMMARY  
SET  EOD_CASH     = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'CASH' and EOD_IND.EOD_DESC = '1' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID   group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'CASH' THEN AMOUNT ELSE '0' END   
    ,EOD_CHEQUE   = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'CHEQUE' and EOD_IND.EOD_DESC = '1' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'CHEQUE' THEN AMOUNT ELSE '0' END   
    ,EOD_DD       = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'DD' and EOD_IND.EOD_DESC = '1' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'DD' THEN AMOUNT ELSE '0' END    
    ,EOD_OTHERS   = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'OTHERS' and EOD_IND.EOD_DESC = '1' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'OTHERS' THEN AMOUNT ELSE '0' END    
    ,EOD_AUTO_CR  = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'AUTO CREDIT' and EOD_IND.EOD_DESC = '1' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0')--CASE WHEN EOD_PAY_MODE = 'AUTO CREDIT' THEN AMOUNT ELSE '0' END    
    ,EOD_AUTO_DR  = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'AUTO DEBIT' and EOD_IND.EOD_DESC = '1' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'AUTO DEBIT' THEN AMOUNT ELSE '0' END   
    ,EOD_WAIVER   = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'WAIVER' and EOD_IND.EOD_DESC = '1' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'WAIVER' THEN AMOUNT ELSE '0' END  
FROM #EOD_COLLECTION_SUMMARY SUMMARY 
WHERE  SUMMARY.EOD_DESC = '1' 
 


UPDATE SUMMARY  
SET  EOD_CASH     = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'CASH' and EOD_IND.EOD_DESC = '2' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID   group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'CASH' THEN AMOUNT ELSE '0' END   
    ,EOD_CHEQUE   = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'CHEQUE' and EOD_IND.EOD_DESC = '2' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'CHEQUE' THEN AMOUNT ELSE '0' END   
    ,EOD_DD       = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'DD' and EOD_IND.EOD_DESC = '2' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'DD' THEN AMOUNT ELSE '0' END    
    ,EOD_OTHERS   = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'OTHERS' and EOD_IND.EOD_DESC = '2' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'OTHERS' THEN AMOUNT ELSE '0' END    
    ,EOD_AUTO_CR  = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'AUTO CREDIT' and EOD_IND.EOD_DESC = '2' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0')--CASE WHEN EOD_PAY_MODE = 'AUTO CREDIT' THEN AMOUNT ELSE '0' END    
    ,EOD_AUTO_DR  = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'AUTO DEBIT' and EOD_IND.EOD_DESC = '2' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'AUTO DEBIT' THEN AMOUNT ELSE '0' END   
    ,EOD_WAIVER   = isnull((select sum(amount) from #EOD_IND_SUMMARY EOD_IND where EOD_PAY_MODE = 'WAIVER' and EOD_IND.EOD_DESC = '2' and SUMMARY.EOD_USER_ID = EOD_IND.EOD_USER_ID group by EOD_USER_ID),'0') --CASE WHEN EOD_PAY_MODE = 'WAIVER' THEN AMOUNT ELSE '0' END  
FROM #EOD_COLLECTION_SUMMARY SUMMARY 
WHERE  SUMMARY.EOD_DESC = '2'  



SELECT CASE WHEN EOD_DESC ='1' THEN 'Total Miscellaneous Credits:'
            WHEN EOD_DESC ='2' THEN 'Total Upfront Collection:'  END  DESCRIPTION 
,EOD_USER_ID     
,EOD_CASH        
,EOD_CHEQUE      
,EOD_DD          
,EOD_OTHERS      
,EOD_AUTO_CR     
,EOD_AUTO_DR     
,EOD_WAIVER     FROM #EOD_COLLECTION_SUMMARY  
  
  
  
END

GO
