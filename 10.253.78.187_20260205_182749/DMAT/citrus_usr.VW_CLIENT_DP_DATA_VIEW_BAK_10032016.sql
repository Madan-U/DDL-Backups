-- Object: VIEW citrus_usr.VW_CLIENT_DP_DATA_VIEW_BAK_10032016
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------


--SELECT   * FROM VW_CLIENT_DP_DATA_VIEW where ACTIVE_FROM ='01/09/2012'
CREATE VIEW  [citrus_usr].[VW_CLIENT_DP_DATA_VIEW_BAK_10032016]
AS
(SELECT  DISTINCT dpam_bbo_code CM_BLSAVINGCD
,LTRIM(RTRIM(CLIM_NAME1)) + ' ' + ISNULL(LTRIM(RTRIM(CLIM_NAME2)),'') + ' ' + ISNULL(LTRIM(RTRIM(CLIM_NAME3)),'') CM_NAME
,'' CL_BALANCE
,CASE WHEN CLIM_GENDER = 'M' THEN 'MALE' 
				  WHEN CLIM_GENDER = 'F' THEN 'FEMALE' ELSE '' END GENDER 


,OCCUPATION CM_OCCUPATION--OCCUPATION_CODE   
,TAX_DEDUCTION CM_TAXDEDUCTION   
,PAN_GIR_NO CB_PANNO   
,'' KYC_FLAG   
,C_ADR1 CM_ADD1   
,C_ADR2  CM_ADD2   
,C_ADR3 CM_ADD3   
,C_ADR_CITY      CM_CITY   
,C_ADR_STATE  CM_STATE  
,C_ADR_ZIP CM_PIN  
,C_ADR_COUNTRY CM_COUNTRY   
,O_PH1 CM_TELE1   
,'' CM_TELE2   
,case when MOBILE1 ='' then MOBSMS else mobile1 end CM_MOBILE   
,EMAIL1 CM_EMAIL   
,BANM_NAME BK_NAME   
,banm_branch BANK_BRANCH   
,CASE WHEN ISNULL(TMPBA_DP_BANK_CITY,'') <> '' THEN ISNULL(TMPBA_DP_BANK_CITY,'')  ELSE ISNULL(TMPBA_DP_BANK_CITY,'') END BK_CITY   
,CLIBA_AC_NO CM_DIVBANKACNO   
,'' PAYMODE   
,BANM_MICR CM_DIVBANKCODE   
,CLIM_DOB CM_DATEOFBIRTH   
,ISNULL(DPHD_GAU_FNAME,'') + ' ' + ISNULL(DPHD_GAU_MNAME,'') + ' ' + ISNULL(DPHD_GAU_LNAME,'') CO_NAME   
,ISNULL(DPHD_GAU_PAN_NO,'') CO_PANNO   
,ISNULL(LTRIM(RTRIM(DPHD_NOM_FNAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(DPHD_NOM_MNAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(DPHD_NOM_LNAME)),'') CB_NOMINEE   
,'' NOMINEE_RELATION 
,'' CM_CD  
,CLIBA_AC_TYPE BANK_AC_TYPE   
,'' STAT_COMM_MODE   
,'CDSL' DP_TYPE   
,LEFT(DPAM.DPAM_SBA_NO,8) DPID   
,DPAM.DPAM_SBA_NO CLTDPID   
,'' MODE_HOLDING   
,'' HOLDER2_CODE   
,ISNULL(LTRIM(RTRIM(DPHD_SH_FNAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(DPHD_SH_MNAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(DPHD_SH_LNAME)),'')  CM_SECH_NAME   
,DPHD_SH_PAN_NO CB_SECHPANNO   
,'' HOLDER2_KYC_FLAG   
,'' HOLDER3_CODE   
,ISNULL(DPHD_TH_FNAME,'') + ' ' + ISNULL(DPHD_TH_MNAME,'') + ' ' + ISNULL(DPHD_TH_LNAME,'') CM_THIH_NAME   
,LTRIM(RTRIM(DPHD_TH_PAN_NO)) CB_THIRDPANNO   
,'' HOLDER3_KYC_FLAG   
,'' BUY_BROK_TABLE_NO   
,'' SELL_BROK_TABLE_NO   
,'' BROK_EFF_DATE   
,'' NEFTCODE   
,'' CHEQUENAME   
,FAX1 RESIFAX   
,FAX1 OFFICEFAX   
,'' MAPINID   
,'' REMARK   
,'' UCC_STATUS   
,'' ADDEDBY   
,'' ADDEDON   
,BILL_START_DT ACTIVE_FROM   
,'' INACTIVE_FROM   
,CASE WHEN ISNULL(DPPD_ID,0)<> 0 THEN 'Y' ELSE 'N' END   POAFLAG  
,isnull(banm_rtgs_cd,'') BK_BRANCH
,'' POASTATUS
FROM    DP_ACCT_MSTR DPAM WITH(NOLOCK)
		--LEFT OUTER JOIN
		LEFT OUTER JOIN 
(SELECT ACCP_CLISBA_ID 
		, MAX(CASE WHEN ISNULL(ACCP_ACCPM_PROP_CD,'') = 'BILL_START_DT' THEN  ISNULL(ACCP_VALUE,'') ELSE ''END ) BILL_START_DT
		
		 FROM ACCOUNT_PROPERTIES WITH(NOLOCK)
		 WHERE ACCP_DELETED_IND = 1 and ISNULL(ACCP_ACCPM_PROP_CD,'') = 'BILL_START_DT'
		 GROUP BY ACCP_CLISBA_ID) ACPROP ON DPAM_ID = ACPROP.ACCP_CLISBA_ID
--		LEFT OUTER JOIN 
--        CLIENT_DP_BRKG  WITH(NOLOCK)   ON DPAM_ID = CLIDB_DPAM_ID  
--        LEFT OUTER JOIN 
--      	BROKERAGE_MSTR  WITH(NOLOCK) ON BROM_ID = CLIDB_BROM_ID  
        LEFT OUTER JOIN 
		DP_HOLDER_DTLS WITH(NOLOCK) ON  DPAM_ID = DPHD_DPAM_ID AND DPHD_DELETED_IND =1
		LEFT OUTER JOIN 
		DP_POA_DTLS    WITH(NOLOCK) ON   DPAM_ID = DPPD_DPAM_ID  AND DPPD_DELETED_IND =1 and getdate() between dppd_eff_fr_dt and case when dppd_eff_TO_dt = '1900-01-01 00:00:00.000' then 'jan 01 2100' else isnull(dppd_eff_TO_dt,'jan 01 2100') end 
		LEFT OUTER JOIN
		CLIENT_BANK_ACCTS WITH(NOLOCK) ON DPAM_ID = CLIBA_CLISBA_ID AND CLIBA_DELETED_IND = 1
		LEFT OUTER JOIN
		BANK_MSTR    WITH(NOLOCK) ON   CLIBA_BANM_ID      = BANM_ID AND  BANM_DELETED_IND = 1
LEFT OUTER JOIN 
bank_addresses_dtls on banm_micr = TMPBA_DP_BANK and banm_rtgs_cd = TMPBA_DP_BR
--        LEFT OUTER JOIN
--        ACCOUNT_DOCUMENTS ON ACCD_CLISBA_ID = DPAM_ID AND ACCD_DELETED_IND = 1 AND ACCD_ACCDOCM_DOC_ID = 12
		--,CLIENT_CTGRY_MSTR WITH(NOLOCK)
		--,ENTITY_TYPE_MSTR WITH(NOLOCK)
		,STATUS_MSTR WITH(NOLOCK)
		--,SUB_CTGRY_MSTR  WITH(NOLOCK)
		,CLIENT_MSTR WITH(NOLOCK)
		LEFT OUTER JOIN 
        (SELECT ENTAC_ENT_ID 
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'PER_ADR1' THEN  ISNULL(ADR_1,'') ELSE '' END ) P_ADR1
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'PER_ADR1' THEN  ISNULL(ADR_2,'') ELSE ''END ) P_ADR2
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'PER_ADR1' THEN  ISNULL(ADR_3,'') ELSE ''END ) P_ADR3
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'PER_ADR1' THEN  ISNULL(ADR_CITY,'') ELSE ''END ) P_ADR_CITY
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'PER_ADR1' THEN  ISNULL(ADR_STATE,'') ELSE ''END ) P_ADR_STATE
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'PER_ADR1' THEN  ISNULL(ADR_COUNTRY,'') ELSE ''END ) P_ADR_COUNTRY
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'PER_ADR1' THEN  ISNULL(ADR_ZIP,'') ELSE ''END ) P_ADR_ZIP
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'COR_ADR1' THEN  ISNULL(ADR_1,'') ELSE ''END ) C_ADR1
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'COR_ADR1' THEN  ISNULL(ADR_2,'')ELSE '' END ) C_ADR2
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'COR_ADR1' THEN  ISNULL(ADR_3,'') ELSE '' END ) C_ADR3
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'COR_ADR1' THEN  ISNULL(ADR_CITY,'') ELSE ''END ) C_ADR_CITY
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'COR_ADR1' THEN  ISNULL(ADR_STATE,'') ELSE ''END ) C_ADR_STATE
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'COR_ADR1' THEN  ISNULL(ADR_COUNTRY,'') ELSE ''END ) C_ADR_COUNTRY
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'COR_ADR1' THEN  ISNULL(ADR_ZIP,'') ELSE '' END ) C_ADR_ZIP
		 FROM ENTITY_ADR_CONC  WITH(NOLOCK)
			, ADDRESSES  WITH(NOLOCK)
	 	 WHERE ENTAC_ADR_CONC_ID = ADR_ID 
		 AND ENTAC_DELETED_IND = 1
		 AND ADR_DELETED_IND = 1 GROUP BY ENTAC_ENT_ID) ADDR ON CLIM_CRN_NO = ADDR.ENTAC_ENT_ID 
        LEFT OUTER JOIN 
		(SELECT ENTAC_ENT_ID 
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'RES_PH1' THEN  ISNULL(CONC_VALUE,'') ELSE ''END ) R_PH1
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'OFF_PH1' THEN  ISNULL(CONC_VALUE,'') ELSE '' END ) O_PH1
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'MOBILE1' THEN  ISNULL(CONC_VALUE,'') ELSE ''END ) MOBILE1
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'EMAIL1' THEN  ISNULL(CONC_VALUE,'') ELSE ''END ) EMAIL1
		, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'FAX1' THEN  ISNULL(CONC_VALUE,'') ELSE ''END ) FAX1
, MAX(CASE WHEN ISNULL(ENTAC_CONCM_CD,'') = 'MOBSMS' THEN  ISNULL(CONC_VALUE,'') ELSE ''END ) MOBSMS
		
		 FROM ENTITY_ADR_CONC  WITH(NOLOCK)
			, CONTACT_CHANNELS  WITH(NOLOCK) 
	 	 WHERE ENTAC_ADR_CONC_ID = CONC_ID 
		 AND ENTAC_DELETED_IND = 1
		 AND CONC_DELETED_IND = 1 GROUP BY ENTAC_ENT_ID) CONC ON CLIM_CRN_NO = CONC.ENTAC_ENT_ID 
		 LEFT OUTER JOIN 
		(SELECT ENTP_ENT_ID 
		, MAX(CASE WHEN ISNULL(ENTP_ENTPM_CD,'')     = 'NATIONALITY'   THEN  ISNULL(ENTP_VALUE,'') ELSE ''END ) NATIONALITY
		, MAX(CASE WHEN ISNULL(ENTP_ENTPM_CD,'')     = 'ANNUAL_INCOME' THEN  ISNULL(ENTP_VALUE,'') ELSE '' END ) ANNUAL_INCOME
		, MAX(CASE WHEN ISNULL(ENTP_ENTPM_CD,'')     = 'TAX_DEDUCTION' THEN  
CASE WHEN ISNULL(ENTP_VALUE,'') ='COMPANY' THEN '4'
 WHEN ISNULL(ENTP_VALUE,'') ='DOMESTIC COMPANIES' THEN '5'
 WHEN ISNULL(ENTP_VALUE,'') ='DOUBLE TAXATION TREATY' THEN '6'
 WHEN ISNULL(ENTP_VALUE,'') ='FOREIGN COMPANIES' THEN '7'
 WHEN ISNULL(ENTP_VALUE,'') ='HUF' THEN '3'
 WHEN ISNULL(ENTP_VALUE,'') ='INDIVIDUAL' THEN '1'
 WHEN ISNULL(ENTP_VALUE,'') ='NRI WITHOUT REPATRIATION' THEN '8'
WHEN ISNULL(ENTP_VALUE,'') ='NRI WITH REPATRIATION' THEN '3'
 WHEN ISNULL(ENTP_VALUE,'') ='ON BEHALF OF MINOR' THEN '2'
WHEN ISNULL(ENTP_VALUE,'') ='OTHERS' THEN '10'
WHEN ISNULL(ENTP_VALUE,'') ='RESIDENT INDIVIDUAL' THEN '9' ELSE 
case when ISNULL(ENTP_VALUE,'')='' then '10' else ISNULL(ENTP_VALUE,'') end 
 END
ELSE '10' END ) TAX_DEDUCTION
		, MAX(CASE WHEN ISNULL(ENTP_ENTPM_CD,'')     = 'LANGUAGE'      THEN  ISNULL(ENTP_VALUE,'') ELSE ''END ) LANGUAGE
		, MAX(CASE WHEN ISNULL(ENTP_ENTPM_CD,'')     = 'EDUCATION'     THEN  ISNULL(ENTP_VALUE,'') ELSE ''END ) EDUCATION
		, MAX(CASE WHEN ISNULL(ENTP_ENTPM_CD,'')     = 'PAN_GIR_NO'    THEN  ISNULL(ENTP_VALUE,'') ELSE ''END ) PAN_GIR_NO
			, MAX(CASE WHEN ISNULL(ENTP_ENTPM_CD,'') = 'OCCUPATION'    THEN  
CASE WHEN ISNULL(ENTP_VALUE,'') = 'AGGRICULTURE' THEN '4'
WHEN ISNULL(ENTP_VALUE,'') = 'AGRICULTURE' THEN '4'
WHEN ISNULL(ENTP_VALUE,'') = 'BUSINESS' THEN '1'
WHEN ISNULL(ENTP_VALUE,'') = 'HOUSE WIFE' THEN '6'
WHEN ISNULL(ENTP_VALUE,'') = 'HOUSEWIFE' THEN '6'
WHEN ISNULL(ENTP_VALUE,'') = 'OTHERS' THEN '8'
WHEN ISNULL(ENTP_VALUE,'') = 'PROFESSIONAL' THEN '3'
WHEN ISNULL(ENTP_VALUE,'') = 'RETIRED' THEN '5'
WHEN ISNULL(ENTP_VALUE,'') = 'SERVICES' THEN '2'
WHEN ISNULL(ENTP_VALUE,'') = 'SERVICE' THEN '2'
WHEN ISNULL(ENTP_VALUE,'') = 'STUDENT' THEN '7' 
when ISNULL(ENTP_VALUE,'') = 'PRIVATE SECTOR' then '8'
when ISNULL(ENTP_VALUE,'') = 'PUBLIC SECTOR' then '8'
when ISNULL(ENTP_VALUE,'') = 'GOVERNMENT SERVICES' then '8'
ELSE case when ISNULL(ENTP_VALUE,'') ='' then '8' 
else ISNULL(ENTP_VALUE,'')  end
END 
ELSE ''END ) OCCUPATION
		
		 FROM ENTITY_PROPERTIES WITH(NOLOCK)
		 WHERE ENTP_DELETED_IND = 1 and  ISNULL(ENTP_ENTPM_CD,'')     in ( 'TAX_DEDUCTION' ,'OCCUPATION','PAN_GIR_NO')
		 GROUP BY ENTP_ENT_ID) PROP ON CLIM_CRN_NO = PROP.ENTP_ENT_ID  
--LEFT OUTER JOIN 
--		
--(SELECT 
--ENTR_CRN_NO, RE=MAX(CASE WHEN ENTM_ENTTM_CD = 'RE' THEN ENTM_NAME1 ELSE '' END),
--AR=MAX(CASE WHEN ENTM_ENTTM_CD = 'AR' THEN ENTM_NAME1 ELSE '' END),
--BR=MAX(CASE WHEN ENTM_ENTTM_CD = 'BR' THEN ENTM_NAME1 ELSE '' END),
--BA=MAX(CASE WHEN ENTM_ENTTM_CD = 'BA' THEN ENTM_NAME1 ELSE '' END),
--REM=MAX(CASE WHEN ENTM_ENTTM_CD = 'REM' THEN ENTM_NAME1 ELSE '' END),
--ONW=MAX(CASE WHEN ENTM_ENTTM_CD = 'ONW' THEN ENTM_NAME1 ELSE '' END)
--
--FROM   ENTITY_MSTR  WITH(NOLOCK)    
--,ENTITY_RELATIONSHIP    WITH(NOLOCK) 
--WHERE (ENTM_ID = ENTR_HO     
--OR ENTM_ID = ENTR_AR    
--OR ENTM_ID = ENTR_BR    
--OR ENTM_ID = ENTR_SB    
--OR ENTM_ID = ENTR_DL    
--OR ENTM_ID = ENTR_RM    
--OR ENTM_ID = ENTR_DUMMY1    
--OR ENTM_ID = ENTR_DUMMY2    
--OR ENTM_ID = ENTR_DUMMY3    
--OR ENTM_ID = ENTR_DUMMY4    
--OR ENTM_ID = ENTR_DUMMY5    
--OR ENTM_ID = ENTR_DUMMY6    
--OR ENTM_ID = ENTR_DUMMY7    
--OR ENTM_ID = ENTR_DUMMY8    
--OR ENTM_ID = ENTR_DUMMY9    
--OR ENTM_ID = ENTR_DUMMY10)    
--AND ENTM_ENTTM_CD IN ('RE','AR','BR','BA','REM','ONW') 
--GROUP BY ENTR_CRN_NO) RELATIONS ON ENTR_CRN_NO = CLIM_CRN_NO 
--		WHERE DPAM.DPAM_CLICM_CD = CLICM_CD 
--		AND   DPAM.DPAM_ENTTM_CD = ENTTM_CD
		where   DPAM.DPAM_STAM_CD  = STAM_CD
		--AND   DPAM.DPAM_SUBCM_CD = SUBCM_CD
		--AND   CLICM_ID           = SUBCM_CLICM_ID
		AND   CLIM_CRN_NO        = DPAM.DPAM_CRN_NO 
	and DPAM.dpam_subcm_cd not in ('392144','022545','413046','392179','392180')

)

GO
