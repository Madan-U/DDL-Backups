-- Object: PROCEDURE citrus_usr.client_charges_Cdsl_s
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------


    
    
--EXEC [CLIENT_CHARGES_CDSL_S] '00000070' , 'NOV 01 2017' ,'NOV 30 2017'   
    
CREATE   PROCEDURE [citrus_usr].[client_charges_Cdsl_s]      
(       
@PA_FROM_ACCTNO VARCHAR(8)  ,
@PA_FROMDT VARCHAR(20) ,
@PA_TODT VARCHAR(20)       
)      
AS    

DECLARE @L_DPAM_ID VARCHAR (10)
SELECT @L_DPAM_ID= DPAM_ID  FROM DP_ACCT_MSTR WHERE RIGHT(DPAM_SBA_NO,8) = @PA_FROM_ACCTNO

DECLARE @L_BROM_ID VARCHAR (10)
SELECT @L_BROM_ID = CLIDB_BROM_ID  FROM CLIENT_DP_BRKG WHERE CLIDB_DPAM_ID = @L_DPAM_ID
AND CLIDB_DELETED_IND = '1'
AND GETDATE () BETWEEN CLIDB_EFF_FROM_DT AND CLIDB_EFF_TO_DT  
 
  BEGIN   
  
SELECT DPAM_SBA_NO, DPAM_SBA_NAME,STAM_DESC , BROM_DESC ,CLIDB_BROM_ID, CLIDB_EFF_FROM_DT , CLIDB_EFF_TO_DT 
,ISNULL(CITRUS_USR.[FN_FIND_RELATIONS_ACCT_NM](DPAM_SBA_NO,'BL'),'') [BASELOATION]
,CITRUS_USR.FN_ACCT_ENTP(DPAM_ID,'BILL_START_DT') [ACTIVATION DATE]
FROM DP_ACCT_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR, STATUS_MSTR
WHERE CLIDB_DPAM_ID = DPAM_ID AND BROM_ID = CLIDB_BROM_ID AND DPAM_STAM_CD = STAM_CD 
AND DPAM_DELETED_IND = '1' AND DPAM_ID = @L_DPAM_ID
AND CLIDB_DELETED_IND = '1'
AND BROM_DELETED_IND = '1'
AND GETDATE () BETWEEN CLIDB_EFF_FROM_DT AND CLIDB_EFF_TO_DT 
  
 SELECT  'BILL SUMMARY',CLIC_CHARGE_NAME , SUM(CLIC_CHARGE_AMT)AMOUNT , 1 ORDERD FROM CLIENT_CHARGES_CDSL WHERE CLIC_DPAM_ID = @L_DPAM_ID
 AND  CLIC_TRANS_DT BETWEEN @PA_FROMDT AND @PA_TODT AND CLIC_DELETED_IND = '1'
 GROUP BY  CLIC_CHARGE_NAME 
 UNION 
 SELECT  'BILL SUMMARY', 'TOTAL CHARGES', SUM(CLIC_CHARGE_AMT) AMOUNT, 2 ORDERD FROM CLIENT_CHARGES_CDSL WHERE CLIC_DPAM_ID = @L_DPAM_ID
 AND  CLIC_TRANS_DT BETWEEN  @PA_FROMDT AND @PA_TODT AND CLIC_DELETED_IND = '1'
 ORDER BY  ORDERD
  
 SELECT 'TRXDETAILS'CDSHM_BEN_ACCT_NO,CDSHM_TRATM_DESC, CDSHM_TRAS_DT ,CDSHM_ISIN,CDSHM_QTY,
 CDSHM_INTERNAL_TRASTM,CDSHM_CHARGE,CDSHM_DP_CHARGE
 FROM CDSL_HOLDING_DTLS WHERE CDSHM_DPAM_ID = @L_DPAM_ID AND CDSHM_TRAS_DT BETWEEN @PA_FROMDT AND @PA_TODT
 AND CDSHM_CHARGE <> '0'
--SELECT * FROM CHARGE_MSTR  WHERE CHAM_SLAB_NO IN (
--SELECT PROC_SLAB_NO  FROM PROFILE_CHARGES WHERE PROC_PROFILE_ID IN ( 
--SELECT BROM_ID  FROM BROKERAGE_MSTR WHERE BROM_ID  = @L_BROM_ID AND BROM_DELETED_IND = '1')
--AND PROC_DELETED_IND = '1') AND CHAM_DELETED_IND = '1'
SELECT CHAM_SLAB_NAME , CHAM_CHARGE_TYPE,CHAM_CHARGE_BASE,CHAM_BILL_PERIOD PERIOD,CHAM_BILL_INTERVAL ,CHAM_CHARGE_BASEON CQTQ,
 CHAM_VAL_PERS PV,CHAM_CHARGE_VALUE AMOUNT,CHAM_CHARGE_MINVAL MINAMOUNT,CHAM_PER_MIN MINAMOUNT,CHAM_PER_MAX MAXAMOUNT,
 CHAM_POST_TOACCT POST, FINA_ACC_NAME POSTTOACCTNAME FROM CHARGE_MSTR  ,FIN_ACCOUNT_MSTR WHERE CHAM_POST_TOACCT = FINA_ACC_ID 
  AND CHAM_DELETED_IND = FINA_DELETED_IND
   AND CHAM_DELETED_IND = 1 AND  FINA_DELETED_IND  = 1
 AND   CHAM_SLAB_NO IN (
SELECT PROC_SLAB_NO  FROM PROFILE_CHARGES WHERE PROC_PROFILE_ID IN ( 
SELECT BROM_ID  FROM BROKERAGE_MSTR WHERE BROM_ID  = @L_BROM_ID AND BROM_DELETED_IND = '1')
AND PROC_DELETED_IND = '1') AND CHAM_DELETED_IND = '1'
        
    END

GO
