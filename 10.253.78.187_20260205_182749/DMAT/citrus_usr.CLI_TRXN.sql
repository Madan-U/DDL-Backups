-- Object: VIEW citrus_usr.CLI_TRXN
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------


CREATE VIEW [citrus_usr].[CLI_TRXN] 
AS
SELECT TD_CURDATE,TD_AC_CODE AS CLEINT_CODE,COMP_NAME,TD_REFERENCE ,TD_REMARKS,
(CASE WHEN TD_DEBIT_CREDIT ='D' THEN TD_QTY ELSE 0 END) AS DEBIT_QTY,
(CASE WHEN TD_DEBIT_CREDIT ='C' THEN TD_QTY ELSE 0 END) AS CREDIT_QTY,ISIN
 FROM SYNERGY_TRXN_DETAILS S WITH(NOLOCK),VW_ISIN_MASTER V  WITH(NOLOCK) 
 WHERE V.ISIN =TD_ISIN_CODE 
 AND (CASE WHEN TD_BENEFICIERY='' THEN TD_COUNTERDP ELSE TD_BENEFICIERY END) 
 NOT IN (SELECT (CASE WHEN LEN(DPCLTNO)=8 THEN DPID+DPCLTNO ELSE DPCLTNO END) DP  FROM [ANGELDEMAT].MSAJAG.DBO.DELIVERYDP  WITH(NOLOCK)
UNION  
SELECT (CASE WHEN LEN(DPCLTNO)=8 THEN DPID+DPCLTNO ELSE DPCLTNO END) FROM [ANGELDEMAT].BSEDB.DBO.DELIVERYDP  WITH(NOLOCK) )

GO
