-- Object: PROCEDURE citrus_usr.CLASS_AUTO_PROCESS_LISNER_Bak21112019
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

create PROC [citrus_usr].[CLASS_AUTO_PROCESS_LISNER_Bak21112019]  
AS  
  
DECLARE   
  @SNO     NUMERIC(18,0),    
  @BUSINESS_DATE   VARCHAR(11),            
  @PROCESS_FOR   VARCHAR(30),            
  @FILE_DWLOAD_LOCATION VARCHAR(200),            
  @PROCESS_FILE_NAME  VARCHAR(200),            
  @PROCESS_FILE_NAME_NEW VARCHAR(200),            
  @FILE_DWLOAD_PATH VARCHAR(200),            
  @FILE_DWLOAD_USERID  VARCHAR(100),            
  @FILE_DWLOAD_PWD  VARCHAR(100),   
  @PROCESS_CURSOR   CURSOR,  
  @CMD    VARCHAR(MAX),  
  @FLD_FILEDATE   DATETIME,            
  @FLD_FILENAME  VARCHAR(200),  
  @PROCESS_SET  VARCHAR(100),  
  @PROCESS_TYPE  VARCHAR(10),  
  @LST_CNT   INT,  
  @PRC_CNT   INT  
  
SELECT * INTO #FILEDATA  
FROM TBL_AUTO_PROCESS_FILE  
WHERE PROCESS_ON LIKE LEFT(GETDATE(),11) + '%'  
  
UPDATE TBL_AUTO_PROCESS_LISNER_LOG SET PROCESS_FLAG = 2   
FROM #FILEDATA F  
WHERE TBL_AUTO_PROCESS_LISNER_LOG.BUSINESS_DATE = LEFT(FLD_FILEDATE,11)  
AND PROCESS_FILE_NAME = FLD_FILENAME  
  
OPEN SYMMETRIC KEY   KEY4CERTAUTOPROCESS            
     DECRYPTION BY   CERTIFICATE CERTAUTOPROCESS     
SET @PROCESS_CURSOR = CURSOR FOR   
SELECT distinct D.SNO, L.PROCESS_FOR, L.PROCESS_TYPE, L.PROCESS_FILE_NAME, BUSINESS_DATE = LEFT(BUSINESS_DATE,11),   
FILE_DWLOAD_LOCATION=L.PROCESS_FILE_PATH,  
FILE_COPY_LOCATION=citrus_usr.FN_CLASS_AUTO_PROCESS_REPLACE(citrus_usr.FN_DATA_DECRYPT('MKTTECH.IN',M.FILE_DWLOAD_LOCATION),BUSINESS_DATE,'',D.SETT_NO,LTRIM(RTRIM(D.SETT_TYPE))),   
FILE_DWLOAD_USERID=citrus_usr.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_USERID),   
FILE_DWLOAD_PWD=citrus_usr.FN_DATA_DECRYPT('MKTTECH.IN',FILE_DWLOAD_PWD),  
PROCESS_SET  
FROM TBL_AUTO_PROCESS_LISNER L, TBL_AUTO_PROCESS_DETAIL D, TBL_AUTO_PROCESS_MASTER M --, OWNER  
WHERE PROCESS_DATE = LEFT(GETDATE(),11)  
AND L.PROCESS_FOR = D.PROCESS_FOR  
AND L.PROCESS_FOR = M.PROCESS_FOR  
AND L.PROCESS_FOR NOT IN (SELECT P.PROCESS_FOR FROM TBL_AUTO_PROCESS_LISNER_LOG P WHERE P.BUSINESS_DATE = D.BUSINESS_DATE  
      AND P.PROCESS_FOR = D.PROCESS_FOR AND PROCESS_FLAG = 1)  
AND (D.IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100)  
AND GETDATE() BETWEEN CONVERT(DATETIME, LEFT(GETDATE(),11) + ' ' + L.PROCESS_START_TIME) AND CONVERT(DATETIME, LEFT(GETDATE(),11) + ' ' + L.PROCESS_END_TIME)  
AND L.PROCESS_TYPE IN ('F', 'C') AND PROCESS_FREQ = 'RECCUR'  
  
  
  
OPEN @PROCESS_CURSOR  
FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @PROCESS_FOR, @PROCESS_TYPE, @PROCESS_FILE_NAME, @BUSINESS_DATE, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_PATH, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @PROCESS_SET  
WHILE @@FETCH_STATUS = 0  
BEGIN  
 SELECT @LST_CNT = 0   
 SELECT @PRC_CNT = 0  
  
 SELECT @LST_CNT = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_LISNER L WHERE PROCESS_SET = @PROCESS_SET AND PROCESS_TYPE = ''  
  
 SELECT @PRC_CNT = ISNULL(COUNT(1),0) FROM TBL_AUTO_PROCESS_LISNER L, TBL_AUTO_PROCESS_DETAIL D   
 WHERE PROCESS_DATE = LEFT(GETDATE(),11)  
 AND L.PROCESS_FOR = D.PROCESS_FOR  
 AND PROCESS_SET = @PROCESS_SET AND L.PROCESS_TYPE = ''  
 AND (D.IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100)  
--print @LST_CNT  
--print @PRC_CNT  
 IF @LST_CNT = @PRC_CNT  
 BEGIN  
   
  IF @PROCESS_TYPE = 'F'  
  BEGIN  
   SET @FILE_DWLOAD_PATH = REPLACE(@FILE_DWLOAD_PATH, '\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-'),'')  
  
   set @cmd = 'exec xp_cmdshell ''net use "' + @FILE_DWLOAD_PATH + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' , no_output'            
   exec (@cmd)   
  
   SET @CMD = 'EXEC XP_CMDSHELL ''MKDIR "' + @FILE_DWLOAD_PATH+'\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-') + '"'', NO_OUTPUT'            
   EXEC (@CMD)    
  
   set @cmd = 'exec xp_cmdshell ''net use ' + @FILE_DWLOAD_PATH + ' /delete'', no_output'            
   exec (@cmd)      
  
   SET @FILE_DWLOAD_PATH = @FILE_DWLOAD_PATH+'\'+ REPLACE(CONVERT(VARCHAR,CONVERT(DATETIME,@BUSINESS_DATE),103),'/','-')  
  
   set @cmd = 'exec xp_cmdshell ''net use "' + @file_dwload_path + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' , no_output'            
   exec (@cmd)   
  END  
  
  set @cmd = 'exec xp_cmdshell ''net use "' + @file_dwload_location + '" /user:' + @file_dwload_userid + ' ' + @file_dwload_pwd + ' /persistent:y'' , no_output'            
  exec (@cmd)   
    
  SET @PROCESS_FILE_NAME_NEW = @file_dwload_location + '\' + @PROCESS_FILE_NAME     

set @FLD_FILENAME = ''
set @FLD_FILEDATE = ''

--print @PROCESS_FILE_NAME_NEW  
--print @BUSINESS_DATE  

  EXEC CLASS_AUTO_PROCESS_FILE @PROCESS_FILE_NAME_NEW, @BUSINESS_DATE, @FLD_FILEDATE OUTPUT, @FLD_FILENAME OUTPUT                 
  
--print @FLD_FILEDATE
--PRINT @FLD_FILENAME  

  
  IF ISNULL(@FLD_FILENAME,'') <> ''  
  BEGIN  
   IF @PROCESS_TYPE = 'F'  
   BEGIN  
    SET @CMD = 'EXEC XP_CMDSHELL ''Copy "' + @file_dwload_location + '\' + @FLD_FILENAME + ' ' + @file_dwload_path + '\' + @FLD_FILENAME + '"'', NO_OUTPUT'            
    EXEC (@CMD)    
  
    INSERT INTO TBL_AUTO_PROCESS_LISNER_LOG VALUES (@BUSINESS_DATE, @PROCESS_FOR, @FLD_FILENAME, 1, GETDATE())  
   END  
  
/*For History Insert*/

INSERT INTO TBL_AUTO_PROCESS_DETAIL_HST
(
 SNO,PROCESS_DATE,BUSINESS_DATE,EXCHANGE,SEGMENT,PROCESS_TYPE,PROCESS_FOR,PROCESS_ID,SETT_NO,SETT_TYPE,INTERNAL_PROCESS_ID,SUB_PROCESS_ID,PROCESS_START_DATE
,PROCESS_STARTED_DATE,PROCESS_END_DATE,PROCESS_ENDED_DATE,PROCESS_FILE_NAME,IS_DEPEND_ON_ORG,IS_DEPEND_ON,WAIT_PERIOD,APPROX_END_TIME,PROCESS_STATUS
,PROCESS_HALTED_AT,PROCESS_HALTED_REASON,PROCESS_STATUS_ALERT,PROCESS_STATUS_ALERT_COUNT,PROCESS_STATUS_ALERT_INTERVAL,PROCESS_LAST_ALERT_DATE
,PROCESS_OUTPUT_QUERY,ATTACHEMENT_FILE_NAME
)
SELECT DISTINCT
N.SNO,N.PROCESS_DATE,N.BUSINESS_DATE,N.EXCHANGE,N.SEGMENT,N.PROCESS_TYPE,N.PROCESS_FOR,N.PROCESS_ID,N.SETT_NO,N.SETT_TYPE,N.INTERNAL_PROCESS_ID,N.SUB_PROCESS_ID,N.PROCESS_START_DATE
,N.PROCESS_STARTED_DATE,N.PROCESS_END_DATE,N.PROCESS_ENDED_DATE,N.PROCESS_FILE_NAME,N.IS_DEPEND_ON_ORG,N.IS_DEPEND_ON,N.WAIT_PERIOD,N.APPROX_END_TIME
,N.PROCESS_STATUS,N.PROCESS_HALTED_AT,N.PROCESS_HALTED_REASON,N.PROCESS_STATUS_ALERT,N.PROCESS_STATUS_ALERT_COUNT,N.PROCESS_STATUS_ALERT_INTERVAL
,N.PROCESS_LAST_ALERT_DATE,N.PROCESS_OUTPUT_QUERY,N.ATTACHEMENT_FILE_NAME FROM TBL_AUTO_PROCESS_DETAIL N WITH(NOLOCK) 
WHERE 
PROCESS_DATE  LIKE @BUSINESS_DATE + '%'
AND @FLD_FILENAME NOT IN (SELECT FLD_FILENAME FROM TBL_AUTO_PROCESS_FILE_PATH F    
WHERE CONVERT(VARCHAR,F.FLD_FILEDATE,109) LIKE @BUSINESS_DATE + '%'    
AND CONVERT(VARCHAR(11),F.FLD_FILEDATE,109) = CONVERT(VARCHAR(11),N.PROCESS_DATE,109)
AND F.FLD_FILEPATH LIKE @FILE_DWLOAD_PATH + '\' + @FLD_FILENAME + '%'
)
AND N.PROCESS_FOR = @PROCESS_FOR

/*For History Insert*/

   UPDATE TBL_AUTO_PROCESS_DETAIL SET 
   IS_DEPEND_ON =  case when (TBL_AUTO_PROCESS_DETAIL.PROCESS_FOR in ('DPM4900','HOLDING RECO','DUMP') AND PROCESS_STATUS=100) then '' else REPLACE(IS_DEPEND_ON_ORG,'#-1,','')  end ,
   PROCESS_STATUS = case when (TBL_AUTO_PROCESS_DETAIL.PROCESS_FOR in ('DPM4900','HOLDING RECO') 
   AND PROCESS_STATUS=100) then PROCESS_STATUS else 0 end
   , PROCESS_HALTED_REASON = case when (TBL_AUTO_PROCESS_DETAIL.PROCESS_FOR in ('DPM4900','HOLDING RECO') AND PROCESS_STATUS=100) then PROCESS_HALTED_REASON else ''  end
   FROM TBL_AUTO_PROCESS_LISNER L  
   WHERE PROCESS_DATE = LEFT(GETDATE(),11) AND (IS_DEPEND_ON LIKE '%#-1,%' OR PROCESS_STATUS = 100)  
   AND L.PROCESS_FOR = TBL_AUTO_PROCESS_DETAIL.PROCESS_FOR  
   AND PROCESS_SET = @PROCESS_SET  
  END  
  
  set @cmd = 'exec xp_cmdshell ''net use "' + @file_dwload_location + '" /delete'', no_output'            
  exec (@cmd)      
  
  set @cmd = 'exec xp_cmdshell ''net use "' + @file_dwload_path + '" /delete'', no_output'            
  exec (@cmd)     
 END  
  
 FETCH NEXT FROM @PROCESS_CURSOR INTO @SNO, @PROCESS_FOR, @PROCESS_TYPE, @PROCESS_FILE_NAME, @BUSINESS_DATE, @FILE_DWLOAD_LOCATION, @FILE_DWLOAD_PATH, @FILE_DWLOAD_USERID, @FILE_DWLOAD_PWD, @PROCESS_SET  
END  
CLOSE @PROCESS_CURSOR  
DEALLOCATE @PROCESS_CURSOR  
  
CLOSE SYMMETRIC KEY   KEY4CERTAUTOPROCESS;

GO
