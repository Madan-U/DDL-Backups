-- Object: PROCEDURE citrus_usr.PR_SELECT_PENDINGDISNREQ
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------



  
  
--EXEC PR_SELECT_PENDINGDISNREQ '','PASS','0',''  
CREATE PROC [citrus_usr].[PR_SELECT_PENDINGDISNREQ](    
  @PA_REQ_DATE DATETIME      
, @PA_LOGIN_NAME VARCHAR(100)      
, @PA_CHK_YN SMALLINT      
, @PA_ERROR VARCHAR(8000)  OUTPUT      
)      
AS      
BEGIN        
      
DECLARE @L_BR_ID NUMERIC  
SELECT @L_BR_ID = LOGN_ENT_ID FROM LOGIN_NAMES  WHERE LOGN_NAME =@PA_LOGIN_NAME AND LOGN_DELETED_IND = 1   
  
CREATE TABLE #BR_FILTER_CLIENT (DPAM_SBA_NO_BR VARCHAR(16),DPAM_ID_BR NUMERIC)  
print @L_BR_ID  
IF @L_BR_ID = 1   
BEGIN   
  
INSERT INTO #BR_FILTER_CLIENT  
SELECT ENTR_SBA DPAM_SBA_NO_BR  ,DPAM_ID DPAM_ID_BR FROM ENTITY_RELATIONSHIP ,DP_ACCT_MSTR   
WHERE ENTR_DELETED_IND = 1 AND DPAM_SBA_NO = ENTR_SBA   
AND GETDATE() BETWEEN ENTR_FROM_DT AND ISNULL(ENTR_TO_DT,'DEC 31 2100')  
--1201090000062286   
  
END   
ELSE    
BEGIN   
  
INSERT INTO #BR_FILTER_CLIENT  
SELECT ENTR_SBA DPAM_SBA_NO_BR  ,DPAM_ID DPAM_ID_BR FROM ENTITY_RELATIONSHIP ,DP_ACCT_MSTR   
WHERE ENTR_DELETED_IND = 1 AND DPAM_SBA_NO = ENTR_SBA   
AND GETDATE() BETWEEN ENTR_FROM_DT AND ISNULL(ENTR_TO_DT,'DEC 31 2100')  
AND (ENTR_BR = @L_BR_ID OR ENTR_SB = @L_BR_ID)   
  
  
END   
CREATE INDEX IX_1 ON #BR_FILTER_CLIENT(DPAM_SBA_NO_BR,DPAM_ID_BR)  
      
         
--SELECT ID,REQ_SLIP_NO,CONVERT(VARCHAR(11),REQ_DATE,103) REQ_DATE,BOID,BONAME,SHOLDER,THOLDER,CREATED_DT,CREATED_BY,LST_UPD_DT,LST_UPD_BY,DELETED_IND,    
--REMARKS,IMAGEPATH,CHK_REMARKS,SLIP_YN,ISNULL(IMAGEPATH1,'') IMAGEPATH1,ISNULL(IMAGEPATH2,'') IMAGEPATH2,CASE WHEN SLIP_YN = 'D' THEN 'DRF'   
--ELSE 'DIS' END  SLIP_TYPE     
--,IMAGEPATHBINARY,IMAGEPATH1BINARY,IMAGEPATH2BINARY  
--FROM DIS_REQ_DTLS_MAK ,#BR_FILTER_CLIENT    
--WHERE DELETED_IND IN (0,4,6)    AND BOID = DPAM_SBA_NO_BR                        
--AND CASE WHEN @PA_REQ_DATE  = '' THEN '01/01/1900' ELSE REQ_DATE END =  CASE WHEN @PA_REQ_DATE  = '' THEN '01/01/1900'   
--ELSE CONVERT(DATETIME,@PA_REQ_DATE,109)  END      
IF @PA_CHK_YN='0'  
BEGIN  
SELECT DISTINCT ID,ENTM_SHORT_NAME + ' - ' +  ENTM_NAME1  ENTM_NAME1,DPAM_SBA_NAME,DPAM_SBA_NO,CREATED_BY , REMARKS,ISNULL(REQ_SLIP_NO,'') REQ_SLIP_NO  
,CASE WHEN ISNULL(SLIP_YN,'')='S' THEN 'SLIP' ELSE 'LETTER' END SLIP_YN,ISNULL(RECO_YN,'') RECO_YN  
,CASE WHEN ISNULL(RECO_DATETIME,'1900-01-01 00:00:00.000') ='1900-01-01 00:00:00.000' THEN '' ELSE   
REPLACE(ISNULL(RECO_DATETIME,''),'1900-01-01 00:00:00.000','') END  RECO_DATETIME  
,CONVERT(VARCHAR(11),REQ_DATE ,109)  REQ_DATE  
,DATEDIFF(DAY, LST_UPD_DT, GETDATE()+ 1) AGEING  ,convert(varchar(11),LST_UPD_DT,103) LST_UPD_DT
,(SELECT DISTINCT TOP 1 ROL_DESC   
   FROM ROLES,ENTITY_ROLES  
   WHERE ROL_ID = ENTRO_ROL_ID  
   AND ENTRO_DELETED_IND=1  
   AND ENTRO_LOGN_NAME = CREATED_BY) ROLE  
FROM DIS_REQ_DTLS LEFT OUTER JOIN SLIP_ISSUE_MSTR ON SLIIM_DPAM_ACCT_NO=BOID AND SLIIM_DELETED_IND = 1 ,DP_ACCT_MSTR , LOGIN_NAMES , ENTITY_MSTR   
,#BR_FILTER_CLIENT   
WHERE DPAM_SBA_NO = BOID AND ENTM_ID = LOGN_ENT_ID AND LOGN_NAME = CREATED_BY  
AND DELETED_IND = 1  
  
AND DPAM_DELETED_IND =1 AND DPAM_SBA_NO = DPAM_SBA_NO_BR    
AND CASE WHEN @PA_REQ_DATE  = '' THEN '01/01/1900' ELSE @PA_REQ_DATE END =  CASE WHEN @PA_REQ_DATE  = '' THEN '01/01/1900'   
ELSE CONVERT(DATETIME,@PA_REQ_DATE,109)  END      
AND SLIP_YN <> 'D'  
and isnull(RECO_YN,'')<>'Y'
END  
  
IF @PA_CHK_YN='1'  
BEGIN  


SELECT distinct REF_NO,SLIP_NO,CLIENT_ID,ENTITY_NAME,'' SCANIMAGE,RECON_FLAG,CREATED_BY,REMARKS 
,CONVERT(VARCHAR(11),CONVERT(DATETIME,RECON_DATETIME),103) RECON_DATETIME  
,HIGHVAL = CONVERT(NUMERIC(18,2),ISNULL((SELECT SUM(ABS(CLOPM_CDSL_RT*DPTDC_QTY)) 
FROM DPTDC_MAK , CLOSING_LAST_CDSL--CLOSING_PRICE_MSTR_CDSL  
WHERE CLOPM_ISIN_CD = DPTDC_ISIN   --and DPTDC_DPAM_ID=DPAM_ID_BR  
AND DPTDC_DELETED_IND IN (0,-1,1)  
AND DPTDC_SLIP_NO = SLIP_NO),0))  
,HIGHVALYN =  HIGHVAL    
,CASE WHEN (DPTDC_DELETED_IND = 0 AND DPTDC_MID_CHK <> '' AND DPTDC_RES_DESC ='') THEN 'FIRST CHECKER DONE'  
WHEN (DPTDC_DELETED_IND = 0  AND DPTDC_RES_DESC <>'') THEN 'REJECTED'  
WHEN ((DPTDC_DELETED_IND = 0 OR DPTDC_DELETED_IND = -1) AND DPTDC_MID_CHK = '') THEN 'PENDING FOR VERIFICATION'  
WHEN DPTDC_DELETED_IND = 1 THEN 'APPROVED' END MAKSTATUS  

, CASE WHEN (DPTDC_DELETED_IND = 0 AND DPTDC_RES_DESC <> '') THEN  DPTDC_RES_DESC ELSE DPTDC_RMKS END  REMARKS1  
,CASE WHEN (DPTDC_DELETED_IND = 0  AND DPTDC_RES_DESC <>'') THEN CONVERT(VARCHAR(11),DPTDC.DPTDC_LST_UPD_DT ,109) ELSE CONVERT(VARCHAR(11),DPTDC.DPTDC_EXECUTION_DT ,109) END DPTDC_EXECUTION_DT  
,DATEDIFF(DAY, DPTDC.DPTDC_LST_UPD_DT, GETDATE()+ 1) AGEING  ,convert(varchar(11),DPTDC.DPTDC_LST_UPD_DT,103) 
LST_UPD_DT
,(SELECT DISTINCT TOP 1 ROL_DESC   
FROM ROLES,ENTITY_ROLES  
WHERE ROL_ID = ENTRO_ROL_ID  
AND ENTRO_DELETED_IND=1  
AND ENTRO_LOGN_NAME = CREATED_BY) ROLE  
FROM MAKER_SCANCOPY,(SELECT DISTINCT DPTDC_RMKS,DPTDC_DELETED_IND ,DPTDC_MID_CHK,DPTDC_RES_DESC,DPTDC_SLIP_NO  
,CONVERT(VARCHAR(11),DPTDC_CREATED_DT ,109) DPTDC_CREATED_DT  
,CONVERT(VARCHAR(11),DPTDC_EXECUTION_DT ,109) DPTDC_EXECUTION_DT  
,DPTDC_LST_UPD_DT  
,'' HIGHVAL  --CASE WHEN [CITRUS_USR].[FN_GET_HIGH_VAL_NEW]('HIGH_VALUE',DPTDC_SLIP_NO)= 'N' THEN 'NO' ELSE 'YES' END
,DPTDC_DPAM_ID    
 FROM  DPTDC_MAK  
--WHERE DPTDC_LST_UPD_DT BETWEEN   'AUG  7 2013' AND 'AUG  7 2014' + ' 23:59:59' 
)   
DPTDC  
WHERE       
 DELETED_IND = 1      
AND DPTDC_SLIP_NO = SLIP_NO  
AND DPTDC_DELETED_IND IN (0,1) 
and exists  (select DPAM_SBA_NO_BR from #BR_FILTER_CLIENT where CLIENT_ID=DPAM_SBA_NO_BR)
and isnull(RECON_FLAG,'')<>'Y'
--AND ENTITY_NAME LIKE CASE WHEN @L_ENTM_SHORT_NAME = 'HO' THEN '%' ELSE @L_ENTM_SHORT_NAME END  
END  
      
END

GO
