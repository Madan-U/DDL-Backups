-- Object: PROCEDURE citrus_usr.PR_TRXLIST_WITHOUTHLDG
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

-- PR_TRXLIST_WITHOUTHLDG '4','JUN 01 2009','JUN 30 2009','',''
CREATE PROCEDURE [citrus_usr].[PR_TRXLIST_WITHOUTHLDG]
(
@PA_EXCSM_ID INTEGER,
@PA_FROMDT VARCHAR(20),
@PA_TODT VARCHAR(20),
@PA_FROMACCT VARCHAR(20),
@PA_TOACCT VARCHAR(20)
)
AS 
BEGIN 
IF @PA_FROMACCT=''
BEGIN
 SET @PA_FROMACCT='0'
END
IF (@PA_TOACCT='')
BEGIN
 SET @PA_TOACCT='9999999999999999'
END
IF (@PA_FROMACCT<>'0' AND @PA_TOACCT='')
BEGIN
 SET @PA_TOACCT = @PA_FROMACCT

END
SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME FROM 
(
SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME FROM DP_ACCT_MSTR WHERE DPAM_SBA_NO NOT IN (
SELECT DPAM_SBA_NO      
FROM DP_DAILY_HLDG_NSDL D WITH(NOLOCK), (      
SELECT DPAM_SBA_NO,DPAM_SBA_NAME,DPDHMD_DPAM_ID, DPDHMD_BENF_CAT,DPDHMD_BENF_ACCT_TYP, DPDHMD_ISIN, DPDHMD_HOLDING_DT = MAX(DPDHMD_HOLDING_DT)  
,DPDHMD_BLK_LOCK_FLG,DPDHMD_BLK_LOCK_CD,DPDHMD_REL_DT           
FROM DP_DAILY_HLDG_NSDL WITH(NOLOCK),    
( SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME     
FROM CITRUS_USR.FN_ACCT_LIST(@PA_EXCSM_ID,1,0)    
WHERE ISNUMERIC(DPAM_SBA_NO)=1 AND (CONVERT(NUMERIC(18,0),DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC(18,0),@PA_FROMACCT) AND CONVERT(NUMERIC(18,0),@PA_TOACCT)) AND @PA_TODT BETWEEN EFF_FROM AND EFF_TO) ACCOUNT          
WHERE DPDHMD_DPAM_ID = ACCOUNT.DPAM_ID                                              
AND DPDHMD_HOLDING_DT  <= @PA_TODT      
AND DPDHMD_BENF_ACCT_TYP NOT IN('20','30','40')     
AND DPDHMD_ISIN LIKE '' + '%'    

GROUP BY DPAM_SBA_NO,DPAM_SBA_NAME,DPDHMD_DPAM_ID, DPDHMD_BENF_CAT,DPDHMD_BENF_ACCT_TYP, DPDHMD_ISIN  
,DPDHMD_BLK_LOCK_FLG,DPDHMD_BLK_LOCK_CD,DPDHMD_REL_DT       
) D1    
WHERE D.DPDHMD_HOLDING_DT  <= @PA_TODT       
AND D.DPDHMD_HOLDING_DT = D1.DPDHMD_HOLDING_DT      
AND D.DPDHMD_DPAM_ID = D1.DPDHMD_DPAM_ID       
AND D.DPDHMD_BENF_CAT = D1.DPDHMD_BENF_CAT      
AND D.DPDHMD_BENF_ACCT_TYP = D1.DPDHMD_BENF_ACCT_TYP      
AND D.DPDHMD_ISIN = D1.DPDHMD_ISIN        
AND D.DPDHMD_BLK_LOCK_FLG = D1.DPDHMD_BLK_LOCK_FLG        
AND D.DPDHMD_BLK_LOCK_CD = D1.DPDHMD_BLK_LOCK_CD  
AND D.DPDHMD_REL_DT = D1.DPDHMD_REL_DT  
AND D.DPDHMD_DPM_ID = @PA_EXCSM_ID      
AND D.DPDHMD_BENF_ACCT_TYP NOT IN('20','30','40') AND D.DPDHMD_QTY <> 0   )
and isnumeric(DPAM_SBA_NO) = 1 
and CONVERT(NUMERIC(18,0),DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC(18,0),@PA_FROMACCT) AND CONVERT(NUMERIC(18,0),@PA_TOACCT)
AND DPAM_CREATED_DT <= @PA_TODT
) K
WHERE NOT EXISTS (SELECT NSDHM_BEN_ACCT_NO FROM NSDL_HOLDING_DTLS 
WHERE NSDHM_TRANSACTION_DT BETWEEN @PA_FROMDT AND @PA_TODT AND DPAM_SBA_NO = NSDHM_BEN_ACCT_NO) 
and len(dpam_sba_no )= 8
order by dpam_sba_no

END

GO
