-- Object: PROCEDURE citrus_usr.PR_POASIG_IMPUPD
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------



CREATE PROCEDURE [citrus_usr].[PR_POASIG_IMPUPD]
(
@PA_ACTION VARCHAR(10)
)
AS
BEGIN

IF EXISTS (SELECT TMPSIGN_SBA_NO FROM MOSL_BULK_BINARY_POA,TMP_POASIGN_NSDL WHERE IMAGEPATH=TMPSIGN_SBA_NO) 
--IF NOT EXISTS (SELECT TMPSIGN_SBA_NO FROM TMP_POASIGN_NSDL) 
BEGIN
UPDATE M SET IMAGEPATHBINARY=CLI_IMAGE FROM MOSL_BULK_BINARY_POA M ,TMP_POASIGN_NSDL WHERE IMAGEPATH=TMPSIGN_SBA_NO
and TMPSIGN_SBA_NO like 'P%'
--SELECT IDENTITY(NUMERIC,1,1) ID, TMPSIGN_SBA_NO,CLI_IMAGE INTO #TMP FROM TMP_POASIGN_NSDL WHERE TMPSIGN_SBA_NO NOT IN (SELECT IMAGEPATH FROM MOSL_BULK_BINARY_POA)

--INSERT INTO MOSL_BULK_BINARY_POA
--SELECT ID,TMPSIGN_SBA_NO,CLI_IMAGE FROM #TMP WHERE TMPSIGN_SBA_NO NOT IN (SELECT IMAGEPATH FROM MOSL_BULK_BINARY_POA)
END
ELSE
BEGIN

declare @maxid numeric 

select @maxid = MAX(id)+1  FROM MOSL_BULK_BINARY_POA
CREATE TABLE [citrus_usr].[#tmp](
	[ID] [numeric](18, 0) IDENTITY(1,1) NOT NULL,
	[TMPSIGN_SBA_NO] [varchar](135) NULL,
	[CLI_IMAGE] [varbinary](max) NULL,
	idd numeric
)
insert into #tmp
SELECT  TMPSIGN_SBA_NO,CLI_IMAGE,@maxid FROM TMP_POASIGN_NSDL
 WHERE TMPSIGN_SBA_NO NOT IN (SELECT IMAGEPATH FROM MOSL_BULK_BINARY_POA)
and  TMPSIGN_SBA_NO like 'P%'

INSERT INTO MOSL_BULK_BINARY_POA
SELECT ID+@maxid,TMPSIGN_SBA_NO,CLI_IMAGE FROM #TMP WHERE TMPSIGN_SBA_NO NOT IN (SELECT IMAGEPATH FROM MOSL_BULK_BINARY_POA)

--UPDATE M SET IMAGEPATHBINARY=CLI_IMAGE FROM MOSL_BULK_BINARY_POA M ,TMP_POASIGN_NSDL WHERE IMAGEPATH=TMPSIGN_SBA_NO
END

END

GO
