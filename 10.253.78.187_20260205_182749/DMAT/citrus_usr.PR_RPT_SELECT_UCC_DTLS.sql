-- Object: PROCEDURE citrus_usr.PR_RPT_SELECT_UCC_DTLS
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

CREATE PROCEDURE [citrus_usr].[PR_RPT_SELECT_UCC_DTLS]
(
	@PA_ACTION VARCHAR(100),
	@PA_CRN_NO NUMERIC,
	@PA_EXCHANGE_CD VARCHAR(50),
	@PA_SEGMENT_CD VARCHAR(50),
	@PA_DPAM_ID NUMERIC,
	@PA_DPAM_SBA_NO VARCHAR(16),
	@PA_MAKCHAKID VARCHAR(10),
	@PA_CUDM_CONSENTFLG VARCHAR(1),
	@PA_CUDM_ID NUMERIC,
	@PA_UCC VARCHAR(100),
	@PA_CMID VARCHAR(10),
	@PA_TMCD VARCHAR(20),
	@PA_OUTPUT VARCHAR(8000) OUTPUT
)
AS
BEGIN
	DECLARE @DPAM_ID NUMERIC
	SELECT @DPAM_ID = DPAM_ID FROM DP_ACCT_MSTR 
	WHERE ---DPAM_SBA_NO = @PA_DPAM_SBA_NO AND 
	DPAM_CRN_NO = @PA_CRN_NO AND DPAM_DELETED_IND = 1
	print @DPAM_ID
	IF @PA_ACTION = 'SELECT'
	BEGIN
		SELECT TOP 1 CUDM_ID,
			CUDM_BOID,
			CUDM_UCC,
			CUDM_EXID,
			CUDM_CMID,
			CUDM_TMCD,
			CUDM_SEGID,
			CUDM_LINKSTATUS,
			CUDM_CONSENTFLG,
			CUDM_DPAM_ID FROM (
		SELECT CUDM_ID,
			CUDM_BOID,
			CUDM_UCC,
			CUDM_EXID,
			CUDM_CMID,
			CUDM_TMCD,
			CUDM_SEGID,
			CUDM_LINKSTATUS,
			CUDM_CONSENTFLG,
			CUDM_DPAM_ID
			FROM CDSL_UCC_DTLS_MSTR
			WHERE CUDM_DELETED_IND = 1
			--AND CUDM_BOID = @PA_DPAM_SBA_NO
			AND CUDM_DPAM_ID = @PA_DPAM_ID
			AND CUDM_EXID like '%' + @PA_EXCHANGE_CD + '%'
			AND CUDM_SEGID like '%' + @PA_SEGMENT_CD + '%'
			UNION
			SELECT CUDM_ID,
			CUDM_BOID,
			CUDM_UCC,
			CUDM_EXID,
			CUDM_CMID,
			CUDM_TMCD,
			CUDM_SEGID,
			CUDM_LINKSTATUS,
			CUDM_CONSENTFLG,
			CUDM_DPAM_ID
			FROM CDSL_UCC_DTLS_MAK
			WHERE CUDM_DELETED_IND IN (0,4,8)
			--AND CUDM_BOID = @PA_DPAM_SBA_NO
			AND CUDM_DPAM_ID = @PA_DPAM_ID
			AND CUDM_EXID like '%' + @PA_EXCHANGE_CD + '%'
			AND CUDM_SEGID like '%' + @PA_SEGMENT_CD + '%'
			) D ORDER BY D.CUDM_ID
	END
	IF @PA_ACTION = 'SELECT_BY_EXCHANGE_AND_SEGMENT'
	BEGIN
		SELECT CUDM_ID,
			CUDM_BOID,
			CUDM_UCC,
			--CUDM_EXID,
			case when CUDM_EXID='02' then '11' when CUDM_EXID='01' then '12' when CUDM_EXID='03' then '29' else CUDM_EXID end CUDM_EXID,
			CUDM_CMID,
			CUDM_TMCD,
			CUDM_SEGID,
			CUDM_LINKSTATUS,
			CUDM_CONSENTFLG,
			CUDM_DPAM_ID,
			EXCSMD_EXCH_CD,
			SMD_SEGMENT_CD
			FROM CDSL_UCC_DTLS_MSTR,EXCH_SEG_MSTR_DUMMY, SEG_MSTR_DUMMY
			WHERE CUDM_DELETED_IND = 1
			--AND CUDM_BOID = @PA_DPAM_SBA_NO
			AND CUDM_DPAM_ID = @PA_DPAM_ID
			AND CUDM_EXID like '%' + @PA_EXCHANGE_CD + '%'
			AND CUDM_SEGID like '%' + @PA_SEGMENT_CD + '%'
			--AND CUDM_EXID = EXCSMD_EXCH_ID
			AND CUDM_EXID = case when EXCSMD_EXCH_ID='11' then '02' when EXCSMD_EXCH_ID='12' then '01' when EXCSMD_EXCH_ID='29' then '03' else EXCSMD_EXCH_ID end
			AND CUDM_SEGID = SMD_SEGMENT_ID
			AND CUDM_ID NOT IN (SELECT CUDM_ID FROM CDSL_UCC_DTLS_MAK WHERE CUDM_DELETED_IND IN (0,4,8) AND CUDM_DPAM_ID = @PA_DPAM_ID)
			UNION ALL
			SELECT CUDM_ID,
			CUDM_BOID,
			CUDM_UCC,
			--CUDM_EXID,
			case when CUDM_EXID='02' then '11' when CUDM_EXID='01' then '12' when CUDM_EXID='03' then '29' else CUDM_EXID end CUDM_EXID,
			CUDM_CMID,
			CUDM_TMCD,
			CUDM_SEGID,
			CUDM_LINKSTATUS,
			CUDM_CONSENTFLG,
			CUDM_DPAM_ID,
			EXCSMD_EXCH_CD,
			SMD_SEGMENT_CD
			FROM CDSL_UCC_DTLS_MAK,EXCH_SEG_MSTR_DUMMY, SEG_MSTR_DUMMY
			WHERE CUDM_DELETED_IND IN (0,4,8)
			--AND CUDM_BOID = @PA_DPAM_SBA_NO
			AND CUDM_DPAM_ID = @PA_DPAM_ID
			AND CUDM_EXID like '%' + @PA_EXCHANGE_CD + '%'
			AND CUDM_SEGID like '%' + @PA_SEGMENT_CD + '%'
			--AND CUDM_EXID = EXCSMD_EXCH_ID
			AND CUDM_EXID = case when EXCSMD_EXCH_ID='11' then '02' when EXCSMD_EXCH_ID='12' then '01' when EXCSMD_EXCH_ID='29' then '03' else EXCSMD_EXCH_ID end
			AND CUDM_SEGID = SMD_SEGMENT_ID
	END
	IF @PA_ACTION = 'CHECK_UCC_DETAILS'
	BEGIN
		SELECT CUDM_ID FROM CDSL_UCC_DTLS_MAK
				 WHERE --CUDM_BOID = @PA_DPAM_SBA_NO				 AND 
				 CUDM_DPAM_ID = @PA_DPAM_ID
				 AND CUDM_EXID = @PA_EXCHANGE_CD
				 AND CUDM_SEGID = @PA_SEGMENT_CD
				 AND CUDM_CONSENTFLG = @PA_CUDM_CONSENTFLG
				 AND CUDM_DELETED_IND IN (0,4,8)
				 AND CUDM_ID = @PA_CUDM_ID
				 AND CUDM_UCC = @PA_UCC
				 AND CUDM_CMID = @PA_CMID
				 AND CUDM_TMCD = @PA_TMCD
				 --UNION
				 --SELECT CUDM_ID FROM CDSL_UCC_DTLS_MSTR
				 --WHERE CUDM_BOID = @PA_DPAM_SBA_NO
				 --AND CUDM_DPAM_ID = @PA_DPAM_ID
				 --AND CUDM_EXID = @PA_EXCHANGE_CD
				 --AND CUDM_SEGID = @PA_SEGMENT_CD
				 --AND CUDM_CONSENTFLG = @PA_CUDM_CONSENTFLG
				 --AND CUDM_DELETED_IND = 1

	END
END

GO
