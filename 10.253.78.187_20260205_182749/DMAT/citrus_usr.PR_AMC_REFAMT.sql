-- Object: PROCEDURE citrus_usr.PR_AMC_REFAMT
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

--EXEC PR_AMC_REFAMT 'SEP 1 2010', 'SEP 08 2010', '4', 'NSDL',''

CREATE PROCEDURE [citrus_usr].[PR_AMC_REFAMT]
(
 @PA_BILL_STDT DATETIME,
 @PA_BILL_ENDDT DATETIME,
 @PA_DPMID NUMERIC,
 @PA_EXCHANGE_CD VARCHAR(4),
 @PA_OUT VARCHAR(1000) OUTPUT
)
AS
BEGIN 
    DECLARE 
    @L_STDT DATETIME,
    @L_ENDDT DATETIME,
    @L_FINID varchar(1),
    @L_STR VARCHAR(8000)
        
    IF @PA_EXCHANGE_CD = 'CDSL'
    BEGIN
       
		SELECT @L_STDT = FIN_START_DT, @L_ENDDT = FIN_END_DT, @L_FINID = FIN_ID 
		FROM FINANCIAL_YR_MSTR WHERE @PA_BILL_STDT BETWEEN FIN_START_DT AND FIN_END_DT

		SELECT A.* , B.CLIC_CHARGE_NAME , B.CLIC_CHARGE_AMT 
		, CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103) BILLSTARTDT
		, CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103) CLOSEDT
		, CASE WHEN CHAM_CHARGE_TYPE IN ('F','O') THEN CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)) > 12 THEN 'F' ELSE 'O' END ELSE CHAM_CHARGE_TYPE END ORIGINAL
		, CHAM_CHARGE_TYPE 
		, CHAM_BILL_PERIOD, CHAM_BILL_INTERVAL
		,ABS(CASE  WHEN CHAM_CHARGE_TYPE  = 'F' AND CHAM_BILL_PERIOD = 'Y' AND CHAM_BILL_INTERVAL = '12'
			   THEN (CASE WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12 )BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 9 AND 12 THEN 0
					END  )
				WHEN CHAM_CHARGE_TYPE = 'O' --AND GETDATE() BETWEEN CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103) AND CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)
				THEN (CASE WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12 )BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 9 AND 12 THEN 0
					END  ) 
				WHEN CHAM_CHARGE_TYPE = 'AMCPRO' AND CHAM_BILL_PERIOD = 'M' AND CHAM_BILL_INTERVAL = '1'
				THEN (CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 0 AND 2 THEN 0
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*3
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 9 AND 11 THEN (B.CLIC_CHARGE_AMT/12)*9
					END )
				WHEN CHAM_CHARGE_TYPE  = 'AMCPROFIX' AND CHAM_BILL_PERIOD = 'M' AND CHAM_BILL_INTERVAL = '12'
				THEN (CASE WHEN DATEDIFF(MM,@L_STDT,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
					WHEN DATEDIFF(MM,@L_STDT,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN DATEDIFF(MM,@L_STDT,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
					WHEN DATEDIFF(MM,@L_STDT,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)) BETWEEN 9 AND 12 THEN 0
					END  )
				WHEN CHAM_CHARGE_TYPE  = 'AMCPROONE' AND CHAM_BILL_PERIOD = 'M' AND CHAM_BILL_INTERVAL = '1'
				THEN  (CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT)BETWEEN 9 AND 11 THEN (B.CLIC_CHARGE_AMT/12)*9
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*3
 					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 0 AND 2 THEN 0
					END  )  
				ELSE 0 END)   RETURNAMT     
		INTO #TEMPCDSL
		FROM (SELECT (SELECT TOP 1 CLIC_TRANS_DT--,CLIC_CHARGE_AMT, CLIC_CHARGE_NAME 
				FROM CLIENT_CHARGES_CDSL WHERE CLIC_DPAM_ID = DPAM_ID 
				AND  (CLIC_CHARGE_NAME LIKE '%ANNUAL%' OR CLIC_CHARGE_NAME LIKE '%AMC%')
				AND  CLIC_DELETED_IND = 1 ORDER BY CLIC_TRANS_DT DESC)  CLIC_TRANS_DT
		, DPAM_SBA_NO , DPAM_SBA_NAME , DPAM_ID 
		FROM  DP_ACCT_MSTR 
		WHERE DPAM_DELETED_IND = 1 
		AND DPAM_STAM_CD = '05'
		) A
		, CLIENT_CHARGES_CDSL B , CLIENT_DP_BRKG , CHARGE_MSTR , PROFILE_CHARGES 
		WHERE A.DPAM_ID = B.CLIC_DPAM_ID 
		AND A.CLIC_TRANS_DT = B.CLIC_TRANS_DT 
		AND (B.CLIC_CHARGE_NAME LIKE '%ANNUAL%' OR B.CLIC_CHARGE_NAME LIKE '%AMC%')
        AND (CHAM_SLAB_NAME  LIKE '%ANNUAL%' OR CHAM_SLAB_NAME  LIKE '%AMC%')
		AND A.CLIC_TRANS_DT  IS NOT NULL 
		AND CLIC_DPAM_ID = CLIDB_DPAM_ID and CITRUS_USR.FN_UCC_ACCP(clic_DPAM_ID,'ACC_CLOSE_DT','') <>'/  /'
		AND CLIDB_BROM_ID = PROC_PROFILE_ID AND B.CLIC_CHARGE_AMT <> 0
		AND PROC_SLAB_NO = CHAM_SLAB_NO 
		--AND GETDATE() BETWEEN CLIDB_EFF_FROM_DT AND CLIDB_EFF_TO_DT 
		AND CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103) BETWEEN @PA_BILL_STDT AND @PA_BILL_ENDDT
		ORDER BY DPAM_SBA_NO,A.CLIC_TRANS_DT 
        
        DELETE FROM #TEMPCDSL WHERE CHAM_CHARGE_TYPE <> ORIGINAL

   -- 	SELECT * FROM #TEMPCDSL ORDER BY CLOSEDT DESC  
        SET @L_STR = 'select * FROM #TEMPCDSL WHERE DPAM_ID NOT IN (SELECT LDG_ACCOUNT_ID FROM LEDGER' + @L_FINID + ' where LDG_NARRATION = ''PROPORTIONATE REFUND OF AMC CHARGES ON CLOSURE OF DP ACCOUNT'') ORDER BY CLOSEDT DESC' 
		PRINT @L_STR
        EXEC(@L_STR)

    END
    
    IF @PA_EXCHANGE_CD = 'NSDL'
    BEGIN
       
		SELECT @L_STDT = FIN_START_DT, @L_ENDDT = FIN_END_DT, @L_FINID = FIN_ID 
		FROM FINANCIAL_YR_MSTR WHERE @PA_BILL_STDT BETWEEN FIN_START_DT AND FIN_END_DT

		SELECT A.* , B.CLIC_CHARGE_NAME , B.CLIC_CHARGE_AMT 
		, CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103) BILLSTARTDT
		, CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103) CLOSEDT
		, CASE WHEN CHAM_CHARGE_TYPE IN ('F','O') THEN CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)) > 12 THEN 'F' ELSE 'O' END ELSE CHAM_CHARGE_TYPE END ORIGINAL
		, CHAM_CHARGE_TYPE 
		, CHAM_BILL_PERIOD, CHAM_BILL_INTERVAL
		,CASE  WHEN CHAM_CHARGE_TYPE  = 'F' AND CHAM_BILL_PERIOD = 'Y' AND CHAM_BILL_INTERVAL = '12'
			   THEN (CASE WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12 )BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 9 AND 12 THEN 0
					END  )
				WHEN CHAM_CHARGE_TYPE = 'O' --AND GETDATE() BETWEEN CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103) AND CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)
				THEN (CASE WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12 )BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
					WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'BILL_START_DT',''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))%12) BETWEEN 9 AND 12 THEN 0
					END  ) 
				WHEN CHAM_CHARGE_TYPE = 'AMCPRO' AND CHAM_BILL_PERIOD = 'M' AND CHAM_BILL_INTERVAL = '1'
				THEN (CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 0 AND 2 THEN 0
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*3
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 9 AND 11 THEN (B.CLIC_CHARGE_AMT/12)*9
					END )
				WHEN CHAM_CHARGE_TYPE  = 'AMCPROFIX' AND CHAM_BILL_PERIOD = 'M' AND CHAM_BILL_INTERVAL = '12'
				THEN (CASE WHEN DATEDIFF(MM,@L_STDT,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103))BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
					WHEN DATEDIFF(MM,@L_STDT,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN DATEDIFF(MM,@L_STDT,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
					WHEN DATEDIFF(MM,@L_STDT,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103)) BETWEEN 9 AND 12 THEN 0
					END  )
				WHEN CHAM_CHARGE_TYPE  = 'AMCPROONE' AND CHAM_BILL_PERIOD = 'M' AND CHAM_BILL_INTERVAL = '1'
				THEN  (CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT)BETWEEN 9 AND 11 THEN (B.CLIC_CHARGE_AMT/12)*9
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*6
					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*3
 					WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103),@L_ENDDT) BETWEEN 0 AND 2 THEN 0
					END  )  
				ELSE 0 END   RETURNAMT     
		INTO #TEMPNSDL
		FROM (SELECT (SELECT TOP 1 CLIC_TRANS_DT--,CLIC_CHARGE_AMT, CLIC_CHARGE_NAME 
				FROM CLIENT_CHARGES_NSDL WHERE CLIC_DPAM_ID = DPAM_ID 
				AND  (CLIC_CHARGE_NAME LIKE '%ANNUAL%' or CLIC_CHARGE_NAME LIKE '%AMC%')
				AND  CLIC_DELETED_IND = 1 ORDER BY CLIC_TRANS_DT DESC)  CLIC_TRANS_DT
		, DPAM_SBA_NO , DPAM_SBA_NAME , DPAM_ID 
		FROM  DP_ACCT_MSTR 
		WHERE DPAM_DELETED_IND = 1 
		AND DPAM_STAM_CD = '05'
		) A
		, CLIENT_CHARGES_NSDL B , CLIENT_DP_BRKG , CHARGE_MSTR , PROFILE_CHARGES 
		WHERE A.DPAM_ID = B.CLIC_DPAM_ID 
		AND A.CLIC_TRANS_DT = B.CLIC_TRANS_DT 
		AND (B.CLIC_CHARGE_NAME LIKE '%ANNUAL%' or B.CLIC_CHARGE_NAME LIKE '%AMC%')
        AND (CHAM_SLAB_NAME  LIKE '%ANNUAL%' or CHAM_SLAB_NAME  LIKE '%AMC%')
		AND A.CLIC_TRANS_DT  IS NOT NULL 
		AND CLIC_DPAM_ID = CLIDB_DPAM_ID and CITRUS_USR.FN_UCC_ACCP(clic_DPAM_ID,'ACC_CLOSE_DT','') <>'/  /'
		AND CLIDB_BROM_ID = PROC_PROFILE_ID AND B.CLIC_CHARGE_AMT <> 0
		AND PROC_SLAB_NO = CHAM_SLAB_NO 
		--AND GETDATE() BETWEEN CLIDB_EFF_FROM_DT AND CLIDB_EFF_TO_DT 
		AND CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,'ACC_CLOSE_DT',''),103) BETWEEN @PA_BILL_STDT AND @PA_BILL_ENDDT
		ORDER BY DPAM_SBA_NO,A.CLIC_TRANS_DT 

        DELETE FROM #TEMPNSDL WHERE CHAM_CHARGE_TYPE <> ORIGINAL

	    --SET @L_STR = 'SELECT ''01/09/2010'' CLOSEDT, ''01/01/2010'' BILLSTARTDT,''10000004'' DPAM_SBA_NO, 250 RETURNAMT'
--SET @L_STR = @L_STR + ' UNION ALL'
--SET @L_STR = @L_STR + ' SELECT ''01/09/2010'' CLOSEDT, ''01/01/2010'' BILLSTARTDT,''10000004'' DPAM_SBA_NO, 250 RETURNAMT'
SET @L_STR = 'select * FROM #TEMPNSDL WHERE DPAM_ID NOT IN (SELECT LDG_ACCOUNT_ID FROM LEDGER' + @L_FINID + ' where LDG_NARRATION = ''PROPORTIONATE REFUND OF AMC CHARGES ON CLOSURE OF DP ACCOUNT'') ORDER BY CLOSEDT DESC' 
PRINT @L_STR
        EXEC(@L_STR)


    END 

END

GO
