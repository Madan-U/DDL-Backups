-- Object: PROCEDURE citrus_usr.PR_AMC_REFAMT_TEST
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

-- EXEC PR_AMC_REFAMT_test 'APR 01 2009','MAR 31 2011',3,'CDSL',''

CREATE PROCEDURE [citrus_usr].[PR_AMC_REFAMT_TEST]
(
 @PA_BILL_STDT DATETIME,
 @PA_BILL_ENDDT DATETIME,
 @PA_DPMID NUMERIC,
 @PA_EXCHANGE_CD VARCHAR(4),
 @PA_OUT VARCHAR(1000) OUTPUT
)
AS
BEGIN 
    DECLARE 
    @L_STDT varchar(20),
    @L_ENDDT varchar(20),
    @L_FINID NUMERIC,
    @L_TABLE VARCHAR(20),
    @L_SQL VARCHAR(8000)
    
    SET @L_SQL = ''
  --  SET @L_STDT = 'APR 01 2010'
  --  SET @L_ENDDT = 'MAR 31 2010' 
        
--    IF @PA_EXCHANGE_CD = 'CDSL'
--       SET @L_TABLE = 'CLIENT_CHARGES_CDSL'
--
--    IF @PA_EXCHANGE_CD = 'NSDL'
--       SET @L_TABLE = 'CLIENT_CHARGES_NSDL'

    SELECT @L_STDT = FIN_START_DT, @L_ENDDT = FIN_END_DT, @L_FINID = FIN_ID 
    FROM FINANCIAL_YR_MSTR WHERE @PA_BILL_STDT BETWEEN FIN_START_DT AND FIN_END_DT

  SET @L_SQL = @L_SQL +  'SELECT A.* , B.CLIC_CHARGE_NAME , B.CLIC_CHARGE_AMT 
	, CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103) BILLSTARTDT
	, CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103)  CLOSEDT
	, CASE WHEN CHAM_CHARGE_TYPE IN (''F'',''O'') THEN CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103)) > 12 THEN ''F'' ELSE ''O'' END ELSE CHAM_CHARGE_TYPE END ORIGINAL
	, CHAM_CHARGE_TYPE 
	, CHAM_BILL_PERIOD, CHAM_BILL_INTERVAL
	,CASE  WHEN CHAM_CHARGE_TYPE  = ''F'' AND CHAM_BILL_PERIOD = ''Y'' AND CHAM_BILL_INTERVAL = ''12''
		   THEN (CASE WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103))%12 )BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
				WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103))%12) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
				WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''CC_CLOSE_DT'',''''),103))%12) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
				WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''CC_CLOSE_DT'',''''),103))%12) BETWEEN 9 AND 12 THEN 0
				END  )
			WHEN CHAM_CHARGE_TYPE = ''O'' 
			THEN (CASE WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103))%12 )BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
				WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103))%12) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
				WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103))%12) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
				WHEN (DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''BILL_START_DT'',''''),103),CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103))%12) BETWEEN 9 AND 12 THEN 0
				END  ) 
			WHEN CHAM_CHARGE_TYPE = ''AMCPRO'' AND CHAM_BILL_PERIOD = ''M'' AND CHAM_BILL_INTERVAL = ''1''
			THEN (CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103),''' + convert(varchar,@L_ENDDT,103) +''') BETWEEN 0 AND 2 THEN 0
				WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103),''' + convert(varchar,@L_ENDDT,103) +''') BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*3
				WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103),''' + convert(varchar,@L_ENDDT,103) +''') BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*6
				WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103),''' + convert(varchar,@L_ENDDT,103) +''') BETWEEN 9 AND 11 THEN (B.CLIC_CHARGE_AMT/12)*9
				END )
            WHEN CHAM_CHARGE_TYPE  = ''AMCPROFIX'' AND CHAM_BILL_PERIOD = ''M'' AND CHAM_BILL_INTERVAL = ''12''
		    THEN (CASE WHEN DATEDIFF(MM,''' + convert(varchar,@L_STDT,103) + ''',CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103))BETWEEN 0 AND 2 THEN (B.CLIC_CHARGE_AMT/12)*9
				WHEN DATEDIFF(MM,''' + convert(varchar,@L_STDT,103) + ''',CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103)) BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*6
				WHEN DATEDIFF(MM,''' + convert(varchar,@L_STDT,103) + ''',CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103)) BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*3
				WHEN DATEDIFF(MM,''' + convert(varchar,@L_STDT,103) + ''',CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103)) BETWEEN 9 AND 12 THEN 0
				END  )
            WHEN CHAM_CHARGE_TYPE  = ''AMCPROONE'' AND CHAM_BILL_PERIOD = ''M'' AND CHAM_BILL_INTERVAL = ''1''
            THEN  (CASE WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103),''' + convert(varchar,@L_ENDDT,103) +''') BETWEEN 0 AND 2 THEN 0
				WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103),''' + convert(varchar,@L_ENDDT,103) +''') BETWEEN 3 AND 5 THEN (B.CLIC_CHARGE_AMT/12)*3
				WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103),''' + convert(varchar,@L_ENDDT,103) +''') BETWEEN 6 AND 8 THEN (B.CLIC_CHARGE_AMT/12)*6
				WHEN DATEDIFF(MM,CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),103),''' + convert(varchar,@L_ENDDT,103) +''') BETWEEN 9 AND 11 THEN (B.CLIC_CHARGE_AMT/12)*9
				END )  
			ELSE 0 END   RETURNAMT     
	INTO #TEMP123456
	FROM (SELECT (SELECT TOP 1 CLIC_TRANS_DT--,CLIC_CHARGE_AMT, CLIC_CHARGE_NAME 
			FROM '
  IF @PA_EXCHANGE_CD = 'CDSL'
  BEGIN 
   	SET @L_SQL = @L_SQL + 'CLIENT_CHARGES_CDSL ' 
  END
  IF @PA_EXCHANGE_CD = 'NSDL'
  BEGIN 
   	SET @L_SQL = @L_SQL + 'CLIENT_CHARGES_NSDL ' 
  END
  SET @L_SQL = @L_SQL + ' WHERE CLIC_DPAM_ID = DPAM_ID 
			AND  CLIC_CHARGE_NAME LIKE ''%ANNUAL%''
			AND  CLIC_DELETED_IND = 1 ORDER BY CLIC_TRANS_DT DESC)  CLIC_TRANS_DT
	, DPAM_SBA_NO , DPAM_SBA_NAME , DPAM_ID 
	FROM  DP_ACCT_MSTR 
	WHERE DPAM_DELETED_IND = 1 
	AND DPAM_STAM_CD = ''05''
	) A	,' 
  IF @PA_EXCHANGE_CD = 'CDSL'
  BEGIN 
   	SET @L_SQL = @L_SQL + 'CLIENT_CHARGES_CDSL B ' 
  END
  IF @PA_EXCHANGE_CD = 'NSDL'
  BEGIN 
   	SET @L_SQL = @L_SQL + 'CLIENT_CHARGES_NSDL B ' 
  END
   SET @L_SQL = @L_SQL + ' , CLIENT_DP_BRKG , CHARGE_MSTR , PROFILE_CHARGES 
	WHERE A.DPAM_ID = B.CLIC_DPAM_ID 
	AND A.CLIC_TRANS_DT = B.CLIC_TRANS_DT 
	AND B.CLIC_CHARGE_NAME LIKE ''%ANNUAL%'' AND CHAM_SLAB_NAME  LIKE ''%ANNUAL%''
	AND A.CLIC_TRANS_DT  IS NOT NULL 
	AND CLIC_DPAM_ID = CLIDB_DPAM_ID and CITRUS_USR.FN_UCC_ACCP(clic_DPAM_ID,''ACC_CLOSE_DT'','''') <>''/  /''
	AND CLIDB_BROM_ID = PROC_PROFILE_ID AND B.CLIC_CHARGE_AMT <> 0
	AND PROC_SLAB_NO = CHAM_SLAB_NO 
	--AND GETDATE() BETWEEN CLIDB_EFF_FROM_DT AND CLIDB_EFF_TO_DT 
    AND CONVERT(DATETIME,CITRUS_USR.FN_UCC_ACCP(CLIC_DPAM_ID,''ACC_CLOSE_DT'',''''),109) BETWEEN ''' + convert(varchar,@PA_BILL_STDT,109) + ''' AND ''' + convert(varchar,@PA_BILL_ENDDT,109) + '''
	ORDER BY DPAM_SBA_NO,A.CLIC_TRANS_DT '

PRINT @L_SQL
EXEC(@L_SQL)

	DELETE FROM #TEMP123456 WHERE CHAM_CHARGE_TYPE <> ORIGINAL

	SELECT * FROM #TEMP123456 ORDER BY CLOSEDT DESC 

END

GO
