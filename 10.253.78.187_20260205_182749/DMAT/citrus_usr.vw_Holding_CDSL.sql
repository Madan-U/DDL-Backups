-- Object: VIEW citrus_usr.vw_Holding_CDSL
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------

CREATE VIEW [citrus_usr].[vw_Holding_CDSL] AS

SELECT 
	DPHMCD_HOLDING_DT			= ISNULL(DPHMCD_HOLDING_DT,CDSHM_TRAS_DT),
	DPHMCD_DPM_ID				= ISNULL(DPHMCD_DPM_ID,CDSHM_DPM_ID),
	DPHMCD_DPAM_ID				= ISNULL(DPHMCD_DPAM_ID,CDSHM_DPAM_ID),
	DPHMCD_ISIN					= ISNULL(DPHMCD_ISIN,CDSHM_ISIN),
	DPHMCD_CURR_QTY				= ISNULL(DPHMCD_CURR_QTY,0) + CASE WHEN ISNULL(CDSHM_TRAS_DT,'') > ISNULL(DPHMCD_HOLDING_DT,'') THEN ISNULL(RUNNING_BAL_QTY,0) ELSE 0 END,	
	DPHMCD_FREE_QTY				= ISNULL(DPHMCD_FREE_QTY,0),
	DPHMCD_FREEZE_QTY			= ISNULL(DPHMCD_FREEZE_QTY,0),
	DPHMCD_PLEDGE_QTY			= ISNULL(DPHMCD_PLEDGE_QTY,0),
	DPHMCD_DEMAT_PND_VER_QTY	= ISNULL(DPHMCD_DEMAT_PND_VER_QTY,0),
	DPHMCD_REMAT_PND_CONF_QTY	= ISNULL(DPHMCD_REMAT_PND_CONF_QTY,0),
	DPHMCD_DEMAT_PND_CONF_QTY	= ISNULL(DPHMCD_DEMAT_PND_CONF_QTY,0),
	DPHMCD_SAFE_KEEPING_QTY		= ISNULL(DPHMCD_SAFE_KEEPING_QTY,0),
	DPHMCD_LOCKIN_QTY			= ISNULL(DPHMCD_LOCKIN_QTY,0),
	DPHMCD_ELIMINATION_QTY		= ISNULL(DPHMCD_ELIMINATION_QTY,0),
	DPHMCD_EARMARK_QTY			= ISNULL(DPHMCD_EARMARK_QTY,0),
	DPHMCD_AVAIL_LEND_QTY		= ISNULL(DPHMCD_AVAIL_LEND_QTY,0),
	DPHMCD_LEND_QTY				= ISNULL(DPHMCD_LEND_QTY,0),
	DPHMCD_BORROW_QTY			= ISNULL(DPHMCD_BORROW_QTY,0),		
	DPHMCD_DELETED_IND,
	DPHMCD_CNTR_SETTM_ID
FROM
(
	SELECT 
		DPHMCD_HOLDING_DT = CASE WHEN CDSHM_TRAS_DT > = A.DPHMCD_HOLDING_DT THEN CDSHM_TRAS_DT ELSE A.DPHMCD_HOLDING_DT END,
		DPHMCD_DPM_ID,DPHMCD_DPAM_ID,DPHMCD_ISIN,
		DPHMCD_CURR_QTY				= ISNULL(DPHMCD_CURR_QTY,0),
		DPHMCD_FREE_QTY				= ISNULL(DPHMCD_FREE_QTY,0),
		DPHMCD_FREEZE_QTY			= ISNULL(DPHMCD_FREEZE_QTY,0),
		DPHMCD_PLEDGE_QTY			= ISNULL(DPHMCD_PLEDGE_QTY,0),
		DPHMCD_DEMAT_PND_VER_QTY	= ISNULL(DPHMCD_DEMAT_PND_VER_QTY,0),
		DPHMCD_REMAT_PND_CONF_QTY	= ISNULL(DPHMCD_REMAT_PND_CONF_QTY,0),
		DPHMCD_DEMAT_PND_CONF_QTY	= ISNULL(DPHMCD_DEMAT_PND_CONF_QTY,0),
		DPHMCD_SAFE_KEEPING_QTY		= ISNULL(DPHMCD_SAFE_KEEPING_QTY,0),
		DPHMCD_LOCKIN_QTY			= ISNULL(DPHMCD_LOCKIN_QTY,0),
		DPHMCD_ELIMINATION_QTY		= ISNULL(DPHMCD_ELIMINATION_QTY,0),
		DPHMCD_EARMARK_QTY			= ISNULL(DPHMCD_EARMARK_QTY,0),
		DPHMCD_AVAIL_LEND_QTY		= ISNULL(DPHMCD_AVAIL_LEND_QTY,0),
		DPHMCD_LEND_QTY				= ISNULL(DPHMCD_LEND_QTY,0),
		DPHMCD_BORROW_QTY			= ISNULL(DPHMCD_BORROW_QTY,0),
		DPHMCD_DELETED_IND,DPHMCD_CNTR_SETTM_ID 
	FROM DP_DAILY_HLDG_CDSL A (NOLOCK) ,
		(SELECT DISTINCT CDSHM_TRAS_DT FROM CDSL_HOLDING_DTLS (NOLOCK)
		UNION
		SELECT MIN(DPHMCD_HOLDING_DT) FROM DP_DAILY_HLDG_CDSL (NOLOCK)) TRN_DT
	WHERE 
		DPHMCD_HOLDING_DT = (SELECT MIN(DPHMCD_HOLDING_DT) FROM  DP_DAILY_HLDG_CDSL B (NOLOCK))
		AND DPHMCD_CURR_QTY <> 0

) HOLD
FULL OUTER JOIN  
(	
	SELECT 
		A.CDSHM_TRAS_DT,A.CDSHM_DPM_ID,A.CDSHM_DPAM_ID,A.CDSHM_ISIN,
		TRN_QTY=A.CDSHM_QTY, RUNNING_BAL_QTY = SUM(B.CDSHM_QTY)
	FROM 
		(
			SELECT 
				CDSHM_TRAS_DT,CDSHM_DPM_ID,CDSHM_DPAM_ID,CDSHM_ISIN,
				CDSHM_QTY=SUM(CDSHM_QTY)
			FROM 
				CDSL_HOLDING_DTLS (NOLOCK)
			GROUP BY 
				CDSHM_TRAS_DT,CDSHM_DPM_ID,CDSHM_DPAM_ID,CDSHM_ISIN
		) A  INNER JOIN (
									SELECT 
										CDSHM_TRAS_DT,CDSHM_DPM_ID,CDSHM_DPAM_ID,CDSHM_ISIN,
										CDSHM_QTY=SUM(CDSHM_QTY)
									FROM 
										CDSL_HOLDING_DTLS (NOLOCK)
									GROUP BY 
										CDSHM_TRAS_DT,CDSHM_DPM_ID,CDSHM_DPAM_ID,CDSHM_ISIN
								) B 
		ON ( A.CDSHM_DPM_ID = B.CDSHM_DPM_ID
			AND A.CDSHM_DPAM_ID = B.CDSHM_DPAM_ID
			AND A.CDSHM_ISIN = B.CDSHM_ISIN
			AND A.CDSHM_TRAS_DT >= B.CDSHM_TRAS_DT
			)
	GROUP BY 
		A.CDSHM_TRAS_DT,A.CDSHM_DPM_ID,A.CDSHM_DPAM_ID,A.CDSHM_TRAS_DT,A.CDSHM_ISIN,A.CDSHM_QTY
) TRN 
ON (CDSHM_TRAS_DT = DPHMCD_HOLDING_DT  
	AND CDSHM_DPM_ID  = DPHMCD_DPM_ID
	AND CDSHM_DPAM_ID = DPHMCD_DPAM_ID
	AND CDSHM_ISIN = DPHMCD_ISIN)

GO
