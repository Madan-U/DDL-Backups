-- Object: PROCEDURE citrus_usr.pr_toget_SDOS
-- Server: 10.253.78.187 | DB: DMAT
--------------------------------------------------


create  PROCEDURE [citrus_usr].[pr_toget_SDOS]
(
@PA_BOID VARCHAR(16)
,@PA_CONSAMT NUMERIC
,@PA_REF_CUR VARCHAR(100) OUTPUT
)
AS
BEGIN
DECLARE @L_AMT TABLE(AMT VARCHAR(1000))

DECLARE @L_SDRATE VARCHAR(10),@L_SDCALC VARCHAR(20)
,@L_OS VARCHAR,@L_TRATM_ID NUMERIC,@L_FIN_ID NUMERIC,@L_LEDGERTBL VARCHAR(100),@L_SQL VARCHAR(800)
SELECT @L_TRATM_ID= TRANTM_ID FROM TRANSACTION_TYPE_MSTR WHERE TRANTM_CODE='SD' 
SELECT @L_SDRATE=TRASTM_DESC  FROM TRANSACTION_SUB_TYPE_MSTR WHERE TRASTM_CD='EQUITY' AND TRASTM_TRATM_ID=@L_TRATM_ID AND TRASTM_DELETED_IND=1
SELECT @L_SDCALC = CONVERT(NUMERIC(18,2),CONVERT(NUMERIC(18,6),TRASTM_DESC)*@PA_CONSAMT)  FROM TRANSACTION_SUB_TYPE_MSTR WHERE TRASTM_CD='EQUITY' AND TRASTM_TRATM_ID=@L_TRATM_ID AND TRASTM_DELETED_IND=1 

SELECT @L_FIN_ID = FIN_ID FROM FINANCIAL_YR_MSTR WHERE  GETDATE() BETWEEN FIN_START_DT AND FIN_END_DT     
AND FIN_DELETED_IND = 1     
      
    
SET @L_LEDGERTBL = 'LEDGER'+CONVERT(VARCHAR,@L_FIN_ID )    
    
SET @L_SQL = ' SELECT SUM(LDG_AMOUNT)  '
SET @L_SQL = @L_SQL + ' FROM ' + @L_LEDGERTBL   + ',DP_ACCT_MSTR WHERE LDG_ACCOUNT_ID=DPAM_ID AND DPAM_SBA_NO =''' +  @PA_BOID  + ''''
INSERT INTO @L_AMT
--PRINT @L_SQL
EXEC (@L_SQL)

SELECT @PA_REF_CUR=@L_SDRATE+ '|*~|' + ISNULL ((SELECT ISNULL(AMT,'0') FROM @L_AMT) ,0) + '|*~|' + ISNULL(@L_SDCALC,'0')
END

GO
