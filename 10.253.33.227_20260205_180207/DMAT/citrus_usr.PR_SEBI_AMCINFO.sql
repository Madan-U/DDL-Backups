-- Object: PROCEDURE citrus_usr.PR_SEBI_AMCINFO
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

--EXEC PR_SEBI_AMCINFO ''
CREATE PROCEDURE [citrus_usr].[PR_SEBI_AMCINFO]
(
@PA_LOGIN_NAME VARCHAR(30)
)
AS
BEGIN
SELECT CLIC_TRANS_DT,DPAM_SBA_NO , ENTP_VALUE , CLIC_CHARGE_NAME, CLIC_CHARGE_AMT  
INTO #TEMPDATA  
FROM CLIENT_CHARGES_CDSL , DP_ACCT_MSTR , ENTITY_PROPERTIES 
WHERE CLIC_DPAM_ID = DPAM_ID  AND DPAM_CRN_NO = ENTP_ENT_ID 
AND ENTP_ENTPM_CD='PAN_GIR_NO'
AND EXISTS(SELECT 1 FROM CHARGE_MSTR WHERE CHAM_CHARGE_TYPE IN ('O','F','AMCPRO') AND CLIC_CHARGE_NAME = CHAM_SLAB_NAME  AND CHAM_SLAB_NAME NOT LIKE '%ADMIN%'
AND CHAM_SLAB_NAME NOT LIKE '%DOCUMEN%')
AND SUBSTRING(ENTP_VALUE,4,1)='P' and dpam_sba_no <> dpam_acct_no 
and dpam_sba_no like '120%'
AND CLIC_TRANS_DT BETWEEN 'JUL 01 2015' AND 'MAR 31 2017'
ORDER BY 1 DESC


--SELECT DISTINCT CLIC_CHARGE_NAME FROM #TEMPDATA



--SELECT * FROM #TEMPDATA WHERE ENTP_VALUE ='ABJPB1121H' 
--SELECT ENTP_VALUE, COUNT(DISTINCT DPAM_SBA_NO ) FROM #TEMPDATA GROUP BY ENTP_VALUE 
--HAVING COUNT(DISTINCT DPAM_SBA_NO ) > 1

SELECT CASE WHEN CLIC_TRANS_DT BETWEEN 'JUL 01 2015' AND 'MAR 31 2016' THEN '2015-2016'  
WHEN CLIC_TRANS_DT BETWEEN 'APR 01 2016' AND 'MAR 31 2017' THEN '2016-2017'   END  YEAR ,ENTP_VALUE PANNO ,MAX(DPAM_SBA_NO) SBANO , MAX(CLIC_CHARGE_NAME) CHARGENAME, MAX(CLIC_CHARGE_AMT*-1)  AMOUNT
INTO #FINALDATA FROM #TEMPDATA --WHERE ENTP_VALUE ='ABJPB1121H' 
GROUP BY ENTP_VALUE  , CASE WHEN CLIC_TRANS_DT BETWEEN 'JUL 01 2015' AND 'MAR 31 2016' THEN '2015-2016'  
WHEN CLIC_TRANS_DT BETWEEN 'APR 01 2016' AND 'MAR 31 2017' THEN '2016-2017'   END 
--UNION 

SELECT * FROM #FINALDATA  where sbano not like '22%'
UNION 
SELECT YEAR , '','','',SUM(AMOUNT) FROM #FINALDATA  where sbano not like '22%' GROUP  BY YEAR
ORDER BY 3 DESC

END

GO
