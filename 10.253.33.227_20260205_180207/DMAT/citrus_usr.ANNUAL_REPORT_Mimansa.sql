-- Object: PROCEDURE citrus_usr.ANNUAL_REPORT_Mimansa
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------


CREATE PROC [citrus_usr].[ANNUAL_REPORT_Mimansa] 
(@TRANSTYPE VARCHAR(10),@FROMDATE DATETIME ,@TODATE DATETIME)
AS
 
  
IF  @TRANSTYPE='NTNH'
	BEGIN   
		SELECT 
		DPAM_SBA_NO ,   
		CONVERT(VARCHAR(11),@TODATE,112) TRAN_DATE,   
		'NO TRANSACTIONS' NO_TRANS,
		'NO Holding' NO_Hold
		FROM citrus_usr.DP_ACCT_MSTR 
		WHERE  DPAM_STAM_CD ='ACTIVE' AND NOT EXISTS (SELECT 1 
						  FROM citrus_usr.CDSL_HOLDING_DTLS 
						WHERE CDSHM_BEN_ACCT_NO = DPAM_SBA_NO
						AND CDSHM_TRAS_DT BETWEEN @FROMDATE AND @TODATE
		)
		AND  NOT EXISTS (SELECT 1
						  FROM citrus_usr.DP_HLDG_MSTR_CDSL_MONTHEND_HOLDING 
						WHERE DPHMC_DPAM_ID = DPAM_ID AND  DPHMC_HOLDING_DT = @TODATE )
  
	END
 ------------ No Transaction and No Holding 


 IF @TRANSTYPE='NTYH'
	BEGIN 
			 CREATE TABLE #HOLDINGALLFORVIEW  
			  (DPHMCD_DPM_ID NUMERIC  
			  ,DPHMCD_DPAM_ID NUMERIC  
			  ,DPHMCD_ISIN VARCHAR(100)  
			  ,DPHMCD_CURR_QTY NUMERIC(18,3)  
			  ,DPHMCD_FREE_QTY NUMERIC(18,3)  
			  ,DPHMCD_FREEZE_QTY NUMERIC(18,3)  
			  ,DPHMCD_PLEDGE_QTY NUMERIC(18,3)  
			  ,DPHMCD_DEMAT_PND_VER_QTY NUMERIC(18,3)  
			  ,DPHMCD_REMAT_PND_CONF_QTY NUMERIC(18,3)  
			  ,DPHMCD_DEMAT_PND_CONF_QTY NUMERIC(18,3)  
			  ,DPHMCD_SAFE_KEEPING_QTY NUMERIC(18,3)  
			  ,DPHMCD_LOCKIN_QTY NUMERIC(18,3)  
			  ,DPHMCD_ELIMINATION_QTY NUMERIC(18,3)  
			  ,DPHMCD_EARMARK_QTY NUMERIC(18,3)  
			  ,DPHMCD_AVAIL_LEND_QTY NUMERIC(18,3)  
			  ,DPHMCD_LEND_QTY NUMERIC(18,3)  
			  ,DPHMCD_BORROW_QTY NUMERIC(18,3)  
			  ,DPHMCD_HOLDING_DT DATETIME)   


				INSERT INTO #HOLDINGALLFORVIEW(DPHMCD_DPM_ID   
			  ,DPHMCD_DPAM_ID   
			  ,DPHMCD_ISIN   
			  ,DPHMCD_CURR_QTY   
			  ,DPHMCD_FREE_QTY   
			  ,DPHMCD_FREEZE_QTY   
			  ,DPHMCD_PLEDGE_QTY   
			  ,DPHMCD_DEMAT_PND_VER_QTY   
			  ,DPHMCD_REMAT_PND_CONF_QTY   
			  ,DPHMCD_DEMAT_PND_CONF_QTY   
			  ,DPHMCD_SAFE_KEEPING_QTY   
			  ,DPHMCD_LOCKIN_QTY   
			  ,DPHMCD_ELIMINATION_QTY   
			  ,DPHMCD_EARMARK_QTY   
			  ,DPHMCD_AVAIL_LEND_QTY   
			  ,DPHMCD_LEND_QTY   
			  ,DPHMCD_BORROW_QTY   
			  ,DPHMCD_HOLDING_DT)  
			  SELECT  DPHMC_DPM_ID   
			  ,DPHMC_DPAM_ID   
			  ,DPHMC_ISIN   
			  ,DPHMC_CURR_QTY   
			  ,DPHMC_FREE_QTY   
			  ,DPHMC_FREEZE_QTY   
			  ,DPHMC_PLEDGE_QTY   
			  ,DPHMC_DEMAT_PND_VER_QTY   
			  ,DPHMC_REMAT_PND_CONF_QTY   
			  ,DPHMC_DEMAT_PND_CONF_QTY   
			  ,DPHMC_SAFE_KEEPING_QTY   
			  ,DPHMC_LOCKIN_QTY   
			  ,DPHMC_ELIMINATION_QTY   
			  ,DPHMC_EARMARK_QTY   
			  ,DPHMC_AVAIL_LEND_QTY   
			  ,DPHMC_LEND_QTY   
			  ,DPHMC_BORROW_QTY   
			  ,DPHMC_HOLDING_DT FROM citrus_usr.DP_HLDG_MSTR_CDSL_MONTHEND_HOLDING 
			  WHERE  DPHMC_HOLDING_DT = @TODATE
  


			 SELECT distinct  DPAM_SBA_NO BOID , DPHMCD_ISIN ISIN_CD , ISIN_NAME 
			 ,CONVERT(VARCHAR,CASE WHEN LEFT(DPHMCD_ISIN ,3) = 'INF' THEN CONVERT(NUMERIC(18,3),DPHMCD_FREEZE_QTY) ELSE CONVERT(NUMERIC(18,2),DPHMCD_FREEZE_QTY) END )   FREEZE_QTY
			 ,CONVERT(VARCHAR,CASE WHEN LEFT(DPHMCD_ISIN ,3) = 'INF' THEN CONVERT(NUMERIC(18,3),DPHMCD_PLEDGE_QTY) ELSE  CONVERT(NUMERIC(18,2),DPHMCD_PLEDGE_QTY) END ) PLEDGE_QTY
			 ,CONVERT(VARCHAR,CASE WHEN LEFT(DPHMCD_ISIN ,3) = 'INF' THEN CONVERT(NUMERIC(18,3),DPHMCD_FREE_QTY) ELSE CONVERT(NUMERIC(18,2),DPHMCD_FREE_QTY) END )       FREE_QTY    
			 ,CONVERT(VARCHAR,CASE WHEN LEFT(DPHMCD_ISIN ,3) = 'INF' THEN CONVERT(NUMERIC(18,3),DPHMCD_LOCKIN_QTY) ELSE CONVERT(NUMERIC(18,2),DPHMCD_LOCKIN_QTY) END )   LOCKIN_QTY  
			 ,CONVERT(VARCHAR,0)   FILLER0 
			 ,CONVERT(VARCHAR,CASE WHEN LEFT(DPHMCD_ISIN ,3) = 'INF' THEN CONVERT(NUMERIC(18,3),DPHMCD_DEMAT_PND_VER_QTY) ELSE CONVERT(NUMERIC(18,2),DPHMCD_DEMAT_PND_VER_QTY) END )   DPHMCD_DEMAT_PND_VER_QTY    
			 ,CONVERT(VARCHAR,0)  FILLER1
			 ,CONVERT(VARCHAR,0)  FILLER2  
			 ,CONVERT(VARCHAR,0)  FILLER3  
			 ,CONVERT(VARCHAR,0)  FILLER4  
			 ,CONVERT(VARCHAR,ISNULL(CONVERT(NUMERIC(18,2),CLOPM_CDSL_RT),'0')) AS CLOSINGRATE INTO #NOTRANS FROM #HOLDINGALLFORVIEW WITH (NOLOCK)
			 LEFT OUTER JOIN  citrus_usr.CLOSING_PRICE_MSTR_CDSL ON DPHMCD_ISIN = CLOPM_ISIN_CD 
			 AND ISNULL(CLOPM_DT,'01/01/1900') = ( SELECT TOP 1 CLOPM_DT FROM citrus_usr.CLOSING_PRICE_MSTR_CDSL
			  WHERE CLOPM_ISIN_CD = DPHMCD_ISIN AND CLOPM_DT <= @TODATE AND CLOPM_DELETED_IND = 1  ORDER BY CLOPM_DT DESC)                                                             
			 , citrus_usr.DP_ACCT_MSTR WITH (NOLOCK), citrus_usr.ISIN_MSTR WITH (NOLOCK)  
			 WHERE DPHMCD_DPAM_ID = DPAM_ID  AND  ISIN_CD = DPHMCD_ISIN     
			 AND DPAM_DELETED_IND = 1     
			 AND NOT EXISTS (SELECT CLIENT_CODE FROM ANGELOWNACCOUNT WHERE CLIENT_CODE=DPAM_SBA_NO) 
			 order by DPAM_SBA_NO,DPHMCD_ISIN,ISIN_NAME,FREEZE_QTY,PLEDGE_QTY,FREE_QTY,LOCKIN_QTY,DPHMCD_DEMAT_PND_VER_QTY

	 



			 SELECT N.* 
			FROM citrus_usr.DP_ACCT_MSTR D,#NOTRANS N
			WHERE  DPAM_STAM_CD ='ACTIVE' AND NOT EXISTS (SELECT 1 
							  FROM citrus_usr.CDSL_HOLDING_DTLS 
							WHERE CDSHM_BEN_ACCT_NO = DPAM_SBA_NO
							AND CDSHM_TRAS_DT BETWEEN @FROMDATE AND @TODATE 
			)
			AND BOID  = DPAM_SBA_NO 


    END

GO
