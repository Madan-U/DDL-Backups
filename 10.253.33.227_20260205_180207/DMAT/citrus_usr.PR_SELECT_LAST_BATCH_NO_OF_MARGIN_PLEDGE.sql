-- Object: PROCEDURE citrus_usr.PR_SELECT_LAST_BATCH_NO_OF_MARGIN_PLEDGE
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------


create PROCEDURE [citrus_usr].[PR_SELECT_LAST_BATCH_NO_OF_MARGIN_PLEDGE]
(
	@PA_ID INTEGER,  
	@PA_BATCHNO VARCHAR(20),  
	@PA_BATCHTYPE VARCHAR(16),  
	@PA_TYPE CHAR(50),  
	@PA_TRXTYPE VARCHAR(50),
	@PA_TRXTYPECDSL VARCHAR(10),  
	@PA_ERRMSG VARCHAR(8000) OUTPUT   
)
AS 
BEGIN
	IF @PA_TRXTYPE = 'MARGIN PLEDGE'
	BEGIN
		IF @PA_BATCHTYPE='NSDL'
		BEGIN
			SET @PA_TRXTYPE = 'CREATEMP'
		END
		IF @PA_BATCHTYPE='CDSL'
		BEGIN
			SET @PA_TRXTYPE = 'CRTEMP'
		END
	END
	print @PA_TRXTYPE
	print @PA_BATCHTYPE
	print @PA_TYPE
	IF @PA_BATCHTYPE='NSDL'  
	BEGIN 
		IF @PA_TYPE = 'FIND DPID'
		BEGIN
			SELECT DPM_ID FROM DP_MSTR WHERE DPM_DPID= @PA_BATCHNO AND DEFAULT_DP=DPM_EXCSM_ID AND DPM_DELETED_IND=1
		END
		IF @PA_TYPE = 'LAST BATCH NO'
		BEGIN
		print 'pppp'
			SELECT MAX(CONVERT(NUMERIC, PLDTM_BATCH_NO)) MAXBATCH 
			FROM NSDL_MARGINPLEDGE_DTLS 
			WHERE ISNUMERIC(PLDTM_BATCH_NO) = 1 
			AND PLDTM_DELETED_IND = 1  
			AND UPPER(PLDTM_TRASTM_CD) = UPPER(@PA_TRXTYPE)
		END
	END
	IF @PA_BATCHTYPE='CDSL'  
	BEGIN 
		IF @PA_TYPE = 'FIND DPID'
		BEGIN
			SELECT DPM_ID FROM DP_MSTR WHERE DPM_DPID= @PA_BATCHNO AND DEFAULT_DP=DPM_EXCSM_ID AND DPM_DELETED_IND=1
		END
		IF @PA_TYPE = 'LAST BATCH NO'
		BEGIN
			SELECT MAX(CONVERT(NUMERIC, PLDTCM_BATCH_NO)) MAXBATCH 
			FROM CDSL_MARGINPLEDGE_DTLS 
			WHERE ISNUMERIC(PLDTCM_BATCH_NO) = 1 
			AND PLDTCM_DELETED_IND = 1  
			AND UPPER(PLDTCM_TRASTM_CD) = UPPER(@PA_TRXTYPE)
		END
	END
END

GO
