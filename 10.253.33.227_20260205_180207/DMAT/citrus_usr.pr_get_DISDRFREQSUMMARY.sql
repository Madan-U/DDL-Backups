-- Object: PROCEDURE citrus_usr.pr_get_DISDRFREQSUMMARY
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

CREATE PROC PR_GET_DISDRFREQSUMMARY    
AS    
BEGIN     
CREATE TABLE #DISDRFREQSUMMARY(DESCRIPTION VARCHAR(100),DISDRFSLIP VARCHAR(100),NOOFRECORDS NUMERIC,BRBA VARCHAR(250))    
--INSERT INTO #DISDRFREQSUMMARY     
--SELECT '','DIS','DRF','DIS REQUISITION'  ,''  
--INSERT INTO #DISDRFREQSUMMARY     
--SELECT 'RECEIVED','','',''   ,''  
--INSERT INTO #DISDRFREQSUMMARY     
--SELECT 'UPDATED','','',''   ,''  
--INSERT INTO #DISDRFREQSUMMARY     
--SELECT 'OBJECTED','','',''   ,''  
  
SELECT DPAMID INTO #DPAMLIST FROM (  
SELECT DPTDC_DPAM_ID DPAMID  FROM DPTDC_MAK WHERE CONVERT(VARCHAR(11),DPTDC_REQUEST_DT ,109) = CONVERT(VARCHAR(11),GETDATE(),109)      
UNION ALL   
SELECT DEMRM_DPAM_ID FROM DEMRM_MAK WHERE CONVERT(VARCHAR(11),DEMRM_REQUEST_DT ,109) = CONVERT(VARCHAR(11),GETDATE(),109)  
UNION ALL   
SELECT DPAM_ID FROM SLIIM_MAK , DP_ACCT_MSTR WHERE DPAM_SBA_NO = SLIIM_DPAM_ACCT_NO   
AND CONVERT(VARCHAR(11),SLIIM_DT ,109) = CONVERT(VARCHAR(11),GETDATE(),109)   )  DPAMLIST  
  
  
SELECT DPAMID , ISNULL(BA.ENTM_SHORT_NAME,ISNULL(BR.ENTM_SHORT_NAME,'')) BRBA INTO #FILTEREDLIST  FROM DP_ACCT_MSTR , #DPAMLIST , ENTITY_RELATIONSHIP   
LEFT OUTER JOIN  ENTITY_MSTR  BA ON BA.ENTM_ID = ENTR_SB   
LEFT OUTER JOIN  ENTITY_MSTR BR  ON BR.ENTM_ID = ENTR_BR  
WHERE ENTR_SBA = DPAM_SBA_NO AND DPAM_ID = DPAMID  
    
  INSERT INTO #DISDRFREQSUMMARY  
SELECT 'RECEIVED','DIS',   NOOFRECORDS,  BRBA    
FROM ( SELECT BRBA,COUNT(DISTINCT DPTDC_SLIP_NO) NOOFRECORDS     
FROM DPTDC_MAK,#FILTEREDLIST WHERE DPAMID = DPTDC_DPAM_ID AND DPTDC_DELETED_IND = 0    
AND CONVERT(VARCHAR(11),DPTDC_REQUEST_DT ,109) = CONVERT(VARCHAR(11),GETDATE(),109) GROUP BY BRBA)    DISTOTAL  
  
    
INSERT INTO #DISDRFREQSUMMARY  
SELECT 'UPDATED','DIS', DIS =  NOOFRECORDS, BRBA = BRBA    
FROM ( SELECT BRBA,COUNT(DISTINCT DPTDC_SLIP_NO) NOOFRECORDS FROM DP_TRX_DTLS_CDSL ,#FILTEREDLIST WHERE DPAMID = DPTDC_DPAM_ID AND DPTDC_DELETED_IND = 1   
AND ISNULL(DPTDC_BATCH_NO,'') <> ''  AND DPTDC_REQUEST_DT= CONVERT(VARCHAR(11),GETDATE(),109) GROUP BY BRBA )  DISTOTAL  
    
INSERT INTO #DISDRFREQSUMMARY  
SELECT 'OBJECTED','DIS', DIS =  NOOFRECORDS, BRBA = BRBA    
FROM ( SELECT BRBA,COUNT(DISTINCT DPTDC_SLIP_NO) NOOFRECORDS FROM DPTDC_MAK ,#FILTEREDLIST WHERE DPAMID = DPTDC_DPAM_ID AND DPTDC_DELETED_IND = 0 AND  ISNULL(DPTDC_RES_CD,'') <> ''  AND DPTDC_REQUEST_DT = CONVERT(VARCHAR(11),GETDATE(),109) GROUP BY BRBA) 
  DISTOTAL  
    
    
INSERT INTO #DISDRFREQSUMMARY  
SELECT 'RECEIVED','DRF', DIS =  NOOFRECORDS, BRBA = BRBA    
FROM  ( SELECT BRBA,COUNT(DISTINCT DEMRM_SLIP_SERIAL_NO) NOOFRECORDS     
FROM DEMRM_MAK,#FILTEREDLIST WHERE DPAMID = DEMRM_DPAM_ID AND DEMRM_DELETED_IND = 0  AND CONVERT(VARCHAR(11),DEMRM_REQUEST_DT ,109) = CONVERT(VARCHAR(11),GETDATE(),109) GROUP BY BRBA)     DRFTOTAL  
    
INSERT INTO #DISDRFREQSUMMARY  
SELECT 'UPDATED','DRF', DIS =  NOOFRECORDS, BRBA = BRBA    
FROM (SELECT BRBA,COUNT(DISTINCT DEMRM_SLIP_SERIAL_NO) NOOFRECORDS FROM DEMAT_REQUEST_MSTR,#FILTEREDLIST WHERE DPAMID = DEMRM_DPAM_ID AND  DEMRM_DELETED_IND = 1 AND ISNULL(DEMRM_BATCH_NO,'') <> ''  AND DEMRM_REQUEST_DT= CONVERT(VARCHAR(11),GETDATE(),109) 
GROUP BY BRBA)   DRFTOTAL  
    
INSERT INTO #DISDRFREQSUMMARY  
SELECT 'OBJECTED','DRF', DIS =  NOOFRECORDS, BRBA = BRBA    
FROM   (SELECT BRBA,COUNT(DISTINCT DEMRM_SLIP_SERIAL_NO) NOOFRECORDS FROM DEMRM_MAK,#FILTEREDLIST WHERE DPAMID = DEMRM_DPAM_ID AND  DEMRM_DELETED_IND = 0 AND  (ISNULL(DEMRM_RES_CD_COMPOBJ,'') <> '' OR ISNULL(DEMRM_RES_CD_INTOBJ ,'') <>'' )   AND DEMRM_REQUEST_DT = CONVERT(VARCHAR(11),GETDATE(),109) GROUP BY BRBA)    DRFTOTAL  
    
INSERT INTO #DISDRFREQSUMMARY  
SELECT 'RECEIVED','DIS REQUISITION', DIS =  NOOFRECORDS, BRBA = BRBA    
FROM   ( SELECT BRBA,COUNT(SLIIM_DPAM_ACCT_NO) NOOFRECORDS     
FROM SLIIM_MAK ,#FILTEREDLIST , DP_ACCT_MSTR WHERE DPAM_ID = DPAMID AND DPAM_SBA_NO = SLIIM_DPAM_ACCT_NO AND  SLIIM_DELETED_IND = 0  AND CONVERT(VARCHAR(11),SLIIM_DT ,109) = CONVERT(VARCHAR(11),GETDATE(),109)  GROUP BY BRBA )    A  
   
INSERT INTO #DISDRFREQSUMMARY  
SELECT 'UPDATED','DIS REQUISITION', DIS =  NOOFRECORDS, BRBA = BRBA    
FROM (SELECT BRBA,COUNT( SLIIM_DPAM_ACCT_NO) NOOFRECORDS FROM SLIP_ISSUE_MSTR  ,#FILTEREDLIST , DP_ACCT_MSTR  WHERE DPAM_ID = DPAMID AND DPAM_SBA_NO = SLIIM_DPAM_ACCT_NO AND SLIIM_DELETED_IND = 1  AND SLIIM_DT= CONVERT(VARCHAR(11),GETDATE(),109)  GROUP BY
 BRBA )   A   
    
INSERT INTO #DISDRFREQSUMMARY  
SELECT 'OBJECTED','DIS REQUISITION', DIS =  NOOFRECORDS, BRBA = BRBA    
FROM (SELECT BRBA,COUNT( SLIIM_DPAM_ACCT_NO) NOOFRECORDS FROM SLIIM_MAK ,#FILTEREDLIST , DP_ACCT_MSTR  WHERE DPAM_ID = DPAMID AND DPAM_SBA_NO = SLIIM_DPAM_ACCT_NO AND  SLIIM_DELETED_IND = 3 AND SLIIM_DT = CONVERT(VARCHAR(11),GETDATE(),109 ) GROUP BY BRBA)
    A  
    
    
    
SELECT * FROM #DISDRFREQSUMMARY   ORDER BY  4   
DROP TABLE #DISDRFREQSUMMARY    
    
    
END

GO
