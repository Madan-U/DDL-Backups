-- Object: PROCEDURE citrus_usr.PR_BILLING_BO_CSV_bak_08122020
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------


--1489--
--select * from dp_mstr
--[PR_BILLING_BO_CSV] 'sep 04 2012','sep 05 2012','12010900','Y','Y','P','B','comm'  

CREATE PROCEDURE [citrus_usr].[PR_BILLING_BO_CSV_bak_08122020]  
(@PA_BILLING_FROM_DT DATETIME  
,@PA_BILLING_TO_DT   DATETIME  
,@PA_DP_ID          VARCHAR(16)  
,@PA_BILLING_STATUS  CHAR(1)  
,@PA_POSTED_FLG      CHAR(1)  
,@PA_BILL_POST_SHW_BILL   CHAR(1)  
,@PA_B2B_OUTSTANDING_FLG CHAR(1)
,@PA_LOGIN_NAME   VARCHAR(20)  
)  
AS  
BEGIN  
--  


	
SET NOCOUNT ON
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
    
  DECLARE  @DPPOSTACCOUNT NUMERIC(10,0)  
         , @L_FIN_ID      INT  
         , @L_REF_NO      VARCHAR(16)  
         , @L_SQL         VARCHAR(8000)  
         , @L_DPM_ID      INT  
         , @L_VOUCHER_NO  INT  
         , @BROKERGL_ACC_CD VARCHAR(20)  
         , @DP_NAME VARCHAR(10)   
  		 , @@l_posting_dt datetime    
		 , @@l_totalamt numeric(18,2)     


         SELECT @BROKERGL_ACC_CD = BITRM_VALUES FROM BITMAP_REF_MSTR WHERE BITRM_PARENT_CD='BROKER_GL_ACCNO' 
		CREATE TABLE  #MAIN_BILL  
		(FROMDT     DATETIME  
		,TODT       DATETIME              
		,CLTCODE varchar(100)
		, fina_acc_code   VARCHAR(100)  
		,DRCR       CHAR(1)  
		,AMOUNT     numeric(18,2)    ,dpam_sba_no varchar(20)
		)   

create table #exceptionclient(entm_id numeric,entm_enttm_cd varchar(100),sba varchar(100))



if convert(varchar(11),DATEADD(s,-1,DATEADD(mm, DATEDIFF(m,0,@pa_billing_from_dt)+1,0)),109) <> @pa_billing_from_dt
begin
insert into #exceptionclient
select entm_id ,entm_enttm_cd,entr_sba   from entity_mstr with(nolock)
, exceptionclientforpost with(nolock)
, entity_relationship    with(nolock)
where entm_enttm_cd in ('br','ba') and replace(replace(entm_short_name ,'_br',''),'_ba','') = brcode
and (entr_br = entm_id  or entr_sb= entm_id ) 
and getdate() between ENTR_FROM_DT and isnull(ENTR_TO_DT,'dec 31 2900')
end 
else 
begin

insert into #exceptionclient
select entm_id ,entm_enttm_cd,entr_sba   from entity_mstr with(nolock)
, exceptionclientforpost with(nolock)
, entity_relationship    with(nolock)
where entm_enttm_cd in ('br','ba') and replace(replace(entm_short_name ,'_br',''),'_ba','') = brcode
and brcode ='RNASIK'
and (entr_br = entm_id  or entr_sb= entm_id ) 
and getdate() between ENTR_FROM_DT and isnull(ENTR_TO_DT,'dec 31 2900')


end 

   
	if @PA_LOGIN_NAME='EQ'
						begin

						SELECT 						
						@@l_totalamt=abs(SUM(CLIC_CHARGE_AMT)) +  abs(SUM(CLIC_CHARGE_AMT*0.1236))
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'DEMAT COURIER CHARGE',
						'DEMAT REJECTION CHARGE',
						'TRANSACTION CHARGES'--,'SERVICE TAX'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
								and dpam_subcm_cd not in ('392144'
								,'022545'
								,'413046'
								,'392179'
								,'392180') and ISNULL(ACCP_VALUE ,'')<>''
AND NOT EXISTS(SELECT SBA FROM #exceptionclient WHERE SBA = DPAM_SBA_NO )


						

						insert into #MAIN_BILL
						SELECT 
						
						@PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
						ISNULL(ACCP_VALUE ,'') CLTCODE , fina_acc_code=CLIC_DPAM_ID , 'D' DRCR
 ,abs(SUM(CLIC_CHARGE_AMT))+abs(SUM(CLIC_CHARGE_AMT*0.1236)) AMOUNT ,DPAM_SBA_NO
						--DPM_DPID,DPAM_SBA_NO , ISNULL(ACCP_VALUE ,'') [BBOCODE],BROM_DESC SCHEME, SUM(CLIC_CHARGE_AMT) AMOUNT
						--,CONVERT(NUMERIC(18,2),SUM(CLIC_CHARGE_AMT)*0.1236) ST  
						--,CASE WHEN [CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BR') <>'' 
						--		THEN REPLACE([CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BR') ,'_BR','')
						--		ELSE REPLACE([CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BA'),'_BA','') END 
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'DEMAT COURIER CHARGE',
						'DEMAT REJECTION CHARGE',
						'TRANSACTION CHARGES'--,'SERVICE TAX'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
								and dpam_subcm_cd not in ('392144'
								,'022545'
								,'413046'
								,'392179'
								,'392180') and ISNULL(ACCP_VALUE ,'')<>''
AND NOT EXISTS(SELECT SBA FROM #exceptionclient WHERE SBA = DPAM_SBA_NO )
						GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 
						--GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 

IF EXISTS(SELECT isnull(DPAM_SBA_NO,'') FROM #MAIN_BILL)
BEGIN
--INSERT INTO #MAIN_BILL
--SELECT @PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
--ISNULL(@BROKERGL_ACC_CD ,'') CLTCODE , FINA_ACC_CODE=@BROKERGL_ACC_CD ,
-- 'C' DRCR ,@@L_TOTALAMT AMOUNT ,@BROKERGL_ACC_CD DPAM_SBA_NO 

INSERT INTO #MAIN_BILL
SELECT @PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
ISNULL(@BROKERGL_ACC_CD ,'') CLTCODE , FINA_ACC_CODE=@BROKERGL_ACC_CD ,
 'C' DRCR ,( SELECT SUM(AMOUNT) FROM #MAIN_BILL ) AMOUNT ,@BROKERGL_ACC_CD DPAM_SBA_NO 




END 

select CONVERT(VARCHAR(11),@PA_BILLING_FROM_DT,103) FROMDT ,CONVERT(VARCHAR(11),@PA_BILLING_TO_DT,103) TODT ,
CLTCODE,fina_acc_code,drcr,AMOUNT,DPAM_SBA_NO
from #MAIN_BILL ,[192.168.100.245].msajag.dbo.Vw_to_getactiveClt_Class
where cltcode=cl_code


end
if @PA_LOGIN_NAME='EQCR'
						begin

						SELECT 						
						@@l_totalamt=abs(SUM(CLIC_CHARGE_AMT))  +abs(SUM(CLIC_CHARGE_AMT*0.1236))  
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'DEMAT COURIER CHARGE',
						'DEMAT REJECTION CHARGE',
						'TRANSACTION CHARGES'--,'SERVICE TAX'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
--								and dpam_subcm_cd not in ('392144'
--								,'022545'
--								,'413046'
--								,'392179'
--								,'392180') 
and ISNULL(ACCP_VALUE ,'')<>''
AND NOT EXISTS(SELECT SBA FROM #exceptionclient WHERE SBA = DPAM_SBA_NO )


						

						insert into #MAIN_BILL
						SELECT 
						
						@PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
						ISNULL(ACCP_VALUE ,'') CLTCODE , fina_acc_code=CLIC_DPAM_ID , 'C' DRCR 
,abs(SUM(CLIC_CHARGE_AMT)) +abs(SUM(CLIC_CHARGE_AMT*0.1236)) AMOUNT ,DPAM_SBA_NO
						--DPM_DPID,DPAM_SBA_NO , ISNULL(ACCP_VALUE ,'') [BBOCODE],BROM_DESC SCHEME, SUM(CLIC_CHARGE_AMT) AMOUNT
						--,CONVERT(NUMERIC(18,2),SUM(CLIC_CHARGE_AMT)*0.1236) ST  
						--,CASE WHEN [CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BR') <>'' 
						--		THEN REPLACE([CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BR') ,'_BR','')
						--		ELSE REPLACE([CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BA'),'_BA','') END 
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'DEMAT COURIER CHARGE',
						'DEMAT REJECTION CHARGE',
						'TRANSACTION CHARGES'--,'SERVICE TAX'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
--								and dpam_subcm_cd not in ('392144'
--								,'022545'
--								,'413046'
--								,'392179'
--								,'392180') 
and ISNULL(ACCP_VALUE ,'')<>''
AND NOT EXISTS(SELECT SBA FROM #exceptionclient WHERE SBA = DPAM_SBA_NO )
						GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 
						--GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 


 
select CONVERT(VARCHAR(11),@PA_BILLING_FROM_DT,103) FROMDT ,CONVERT(VARCHAR(11),@PA_BILLING_TO_DT,103) TODT ,
CLTCODE,fina_acc_code,drcr,AMOUNT,DPAM_SBA_NO
 from #MAIN_BILL 
,[192.168.100.245].msajag.dbo.Vw_to_getactiveClt_Class
where cltcode=cl_code

end
	if @PA_LOGIN_NAME='COMM'
						begin


					    SELECT 						
						@@l_totalamt=abs(SUM(CLIC_CHARGE_AMT))  +abs(SUM(CLIC_CHARGE_AMT*0.1236))
						
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'DEMAT COURIER CHARGE',
						'DEMAT REJECTION CHARGE',
						'TRANSACTION CHARGES'--,'SERVICE TAX'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
								and dpam_subcm_cd  in ('392144'
								,'022545'
								,'413046'
								,'392179'
								,'392180') and ISNULL(ACCP_VALUE ,'')<>''
AND NOT EXISTS(SELECT SBA FROM #exceptionclient WHERE SBA = DPAM_SBA_NO )
						

						insert into #MAIN_BILL

								SELECT 
								
								@PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
								ISNULL(ACCP_VALUE ,'') CLTCODE , fina_acc_code=CLIC_DPAM_ID , 'D' DRCR 
,abs(SUM(CLIC_CHARGE_AMT)) +abs(SUM(CLIC_CHARGE_AMT*0.1236)) AMOUNT ,DPAM_SBA_NO
								--DPM_DPID,DPAM_SBA_NO , ISNULL(ACCP_VALUE ,'') [BBOCODE],BROM_DESC SCHEME, SUM(CLIC_CHARGE_AMT) AMOUNT
								--,CONVERT(NUMERIC(18,2),SUM(CLIC_CHARGE_AMT)*0.1236) ST  
								--,CASE WHEN [CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BR') <>'' 
								--		THEN REPLACE([CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BR') ,'_BR','')
								--		ELSE REPLACE([CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BA'),'_BA','') END 
								FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
								AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

								WHERE CLIC_DPAM_ID = DPAM_ID 
								AND DPM_ID = DPAM_DPM_ID 
								AND BROM_ID = CLIDB_BROM_ID 
								AND CLIDB_DPAM_ID = DPAM_ID 
								AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
								AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
								AND CLIC_CHARGE_NAME IN (
								'DEMAT COURIER CHARGE',
								'DEMAT REJECTION CHARGE',
								'TRANSACTION CHARGES'--,'SERVICE TAX'
								)
								AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
								and dpam_subcm_cd in ('392144'
								,'022545'
								,'413046'
								,'392179'
								,'392180') and ISNULL(ACCP_VALUE ,'')<>''
AND NOT EXISTS(SELECT SBA FROM #exceptionclient WHERE SBA = DPAM_SBA_NO )
								GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 						
						
IF EXISTS(SELECT isnull(DPAM_SBA_NO,'') FROM #MAIN_BILL)
BEGIN
--insert into #MAIN_BILL
--select @PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
--						ISNULL(@BROKERGL_ACC_CD ,'') CLTCODE , fina_acc_code=@BROKERGL_ACC_CD ,
--'C' DRCR ,@@l_totalamt AMOUNT ,@BROKERGL_ACC_CD DPAM_SBA_NO 
--CHANGE BY TUSHAR TO MATCH TOTAL AMONUNT 

insert into #MAIN_BILL
select @PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
						ISNULL(@BROKERGL_ACC_CD ,'') CLTCODE , fina_acc_code=@BROKERGL_ACC_CD ,
'C' DRCR ,( SELECT SUM(AMOUNT) FROM #MAIN_BILL )AMOUNT ,@BROKERGL_ACC_CD DPAM_SBA_NO 

end

select CONVERT(VARCHAR(11),@PA_BILLING_FROM_DT,103) FROMDT ,CONVERT(VARCHAR(11),@PA_BILLING_TO_DT,103) TODT ,
CLTCODE,fina_acc_code,drcr,AMOUNT,DPAM_SBA_NO from #MAIN_BILL 
,[192.168.3.7].msajag.dbo.Vw_to_getactiveClt_Class
where cltcode=cl_code

end

--	if @PA_LOGIN_NAME='COMMCR'
--						begin
--
--
--					    SELECT 						
--						@@l_totalamt=abs(SUM(CLIC_CHARGE_AMT)) +abs(SUM(CLIC_CHARGE_AMT*0.1236)) 
--						
--						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
--						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR
--
--						WHERE CLIC_DPAM_ID = DPAM_ID 
--						AND DPM_ID = DPAM_DPM_ID 
--						AND BROM_ID = CLIDB_BROM_ID 
--						AND CLIDB_DPAM_ID = DPAM_ID 
--						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
--						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
--						AND CLIC_CHARGE_NAME IN (
--						'DEMAT COURIER CHARGE',
--						'DEMAT REJECTION CHARGE',
--						'TRANSACTION CHARGES'--,'SERVICE TAX'
--						)
--						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
--								and dpam_subcm_cd  in ('392144'
--								,'022545'
--								,'413046'
--								,'392179'
--								,'392180') and ISNULL(ACCP_VALUE ,'')<>''
--						
--
--						insert into #MAIN_BILL
--
--								SELECT 
--								
--								@PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
--								ISNULL(ACCP_VALUE ,'') CLTCODE , fina_acc_code=CLIC_DPAM_ID , 'C' DRCR 
--,abs(SUM(CLIC_CHARGE_AMT))+abs(SUM(CLIC_CHARGE_AMT*0.1236)) AMOUNT ,DPAM_SBA_NO
--								--DPM_DPID,DPAM_SBA_NO , ISNULL(ACCP_VALUE ,'') [BBOCODE],BROM_DESC SCHEME, SUM(CLIC_CHARGE_AMT) AMOUNT
--								--,CONVERT(NUMERIC(18,2),SUM(CLIC_CHARGE_AMT)*0.1236) ST  
--								--,CASE WHEN [CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BR') <>'' 
--								--		THEN REPLACE([CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BR') ,'_BR','')
--								--		ELSE REPLACE([CITRUS_USR].[FN_FIND_RELATIONS_ACCTLVL_BILL](CLIC_DPAM_ID , 'BA'),'_BA','') END 
--								FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
--								AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR
--
--								WHERE CLIC_DPAM_ID = DPAM_ID 
--								AND DPM_ID = DPAM_DPM_ID 
--								AND BROM_ID = CLIDB_BROM_ID 
--								AND CLIDB_DPAM_ID = DPAM_ID 
--								AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
--								AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
--								AND CLIC_CHARGE_NAME IN (
--								'DEMAT COURIER CHARGE',
--								'DEMAT REJECTION CHARGE',
--								'TRANSACTION CHARGES'--,'SERVICE TAX'
--								)
--								AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
--								and dpam_subcm_cd in ('392144'
--								,'022545'
--								,'413046'
--								,'392179'
--								,'392180') and ISNULL(ACCP_VALUE ,'')<>''
--								GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 						
--						
--
--
--
--select CONVERT(VARCHAR(11),@PA_BILLING_FROM_DT,103) FROMDT ,CONVERT(VARCHAR(11),@PA_BILLING_TO_DT,103) TODT ,
--CLTCODE,fina_acc_code,drcr,AMOUNT,DPAM_SBA_NO from #MAIN_BILL 
--
--end
TRUNCATE TABLE #exceptionclient
drop table #exceptionclient

--  
END

GO
