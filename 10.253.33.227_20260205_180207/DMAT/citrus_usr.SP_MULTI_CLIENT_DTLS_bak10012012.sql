-- Object: PROCEDURE citrus_usr.SP_MULTI_CLIENT_DTLS_bak10012012
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

--select * from dp_acct_mstr
--select * from client_mstr 



--sELECT * FROM ACCOUNT_PROPERTIES WHERE ACCP_ACCPM_PROP_CD LIKE  '%SMS%'



--SP_MULTI_CLIENT_DTLS '10000037','10000037',4,1,0
--SP_MULTI_CLIENT_DTLS '1234567890123456','1234567890123456',3,1,0
create PROCEDURE [citrus_usr].[SP_MULTI_CLIENT_DTLS_bak10012012]
( 
@PA_FROM_ACCTNO VARCHAR(16),
@PA_TO_ACCTNO VARCHAR(16),
@PA_EXCSMID INT,
@pa_login_pr_entm_id numeric,              
@pa_login_entm_cd_chain  varchar(8000)   
)
AS
BEGIN -- MAIN
 IF @PA_FROM_ACCTNO = ''            
 BEGIN            
  SET @PA_FROM_ACCTNO = '0'            
  SET @PA_TO_ACCTNO = '99999999999999999'            
 END            
 IF @PA_TO_ACCTNO = ''            
 BEGIN        
   SET @PA_TO_ACCTNO = @PA_FROM_ACCTNO            
 END    

DECLARE @@DPMID INT                     
SELECT @@DPMID = DPM_ID FROM DP_MSTR WHERE DEFAULT_DP = @PA_EXCSMID AND DPM_DELETED_IND =1    
DECLARE @@L_CHILD_ENTM_ID      NUMERIC              
SELECT @@L_CHILD_ENTM_ID    =  CITRUS_USR.FN_GET_CHILD(@PA_LOGIN_PR_ENTM_ID , @PA_LOGIN_ENTM_CD_CHAIN)  


		SELECT STAM_DESC [STATUS]
		,CLICM_DESC  [CATEGORY]
		,SUBCM_DESC  [SUBCATEGORY]
		,ENTTM_DESC  [TYPE]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'PER_ADR1'),1) [PADDRESS1]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'PER_ADR1'),2)+ ' '+ISNULL(CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'PER_ADR1'),3),'')  [PADDRESS2]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'PER_ADR1'),4) [PCITY]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'PER_ADR1'),5) [PSTATE]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'PER_ADR1'),6) [PCOUNTRY]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'PER_ADR1'),7) [PPIN CODE]
		,CITRUS_USR.FN_CONC_VALUE(DPAM.DPAM_CRN_NO,'RES_PH1') [RESPHONENO]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'COR_ADR1'),1) [CADDRESS1]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'COR_ADR1'),2)+' '+ISNULL(CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'COR_ADR1'),3),'') [CADDRESS2]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'COR_ADR1'),4) [CCITY]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'COR_ADR1'),5) [CSTATE]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'COR_ADR1'),6) [CCOUNTRY]
		,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'COR_ADR1'),7) [CPIN CODE]
		,CITRUS_USR.FN_CONC_VALUE(DPAM.DPAM_CRN_NO,'OFF_PH1') [OFFPHONENO]
		,case when CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),1) <> '' then  CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),1) else CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),1) end [BADDRESS1]
		,case when CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),1) <> '' then  CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),2)+ ' ' +ISNULL(CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),3),'') else CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),2)+ ' ' +ISNULL(CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),3),'')  end [BADDRESS2]
		,case when CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),1) <> '' then  CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),4) else CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),4) end  [BCITY]
		,case when CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),1) <> '' then  CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),5) else CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),5)  end [BSTATE]
		,case when CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),1) <> '' then  CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),6) else CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),6)  end [BCOUNTRY]
		,case when CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),1) <> '' then  CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'COR_ADR1'),7) else CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),7)  end [BPIN CODE]
		,CITRUS_USR.FN_CONC_VALUE(BANM_ID,'OFF_PH1') [OFFPHONENO]
		,CITRUS_USR.FN_CONC_VALUE(DPAM.DPAM_CRN_NO,'MOBILE1') [MOBILE]
		,ISNULL(CITRUS_USR.FN_CONC_VALUE(DPAM.DPAM_CRN_NO,'EMAIL1'),'') [EMAIL]
		,ISNULL(CITRUS_USR.FN_FIND_RELATIONS(DPAM.DPAM_CRN_NO,'BR'),'') BRANCH
		,DPAM.DPAM_SBA_NO CLIENTID
		,CLIM_SHORT_NAME SHORTNAME
		,CONVERT(VARCHAR(11),CLIM_CREATED_DT ,105) ACTDT
		,CLIM_NAME1 + ' ' + isnull(CLIM_NAME2,'') + ' ' + isnull(CLIM_NAME3,'')  CLIM_NAME1
		,CLIBA_AC_NO
		,CLIBA_AC_TYPE
		,BANM_NAME
		,isnull(BANM_MICR,'') BANM_MICR
		,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM.DPAM_CRN_NO,'PAN_GIR_NO',''),'') PAN  
		,CASE WHEN ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM.DPAM_CRN_NO,'PAN_GIR_NO',''),'') <> '' THEN 'VERIFIED' ELSE '' END PANFLAG  
		,CASE WHEN ISNULL(CITRUS_USR.FN_ACCT_ENTP(DPAM.DPAM_CRN_NO,'SMS_FLAG'),'') = '1' THEN 'AVAILABLE' ELSE '' END SMS  
        ,ISNULL(CITRUS_USR.FN_ACCT_ENTP(DPAM.DPAM_CRN_NO,'SEBI_REG_NO'),'') SEBI_REG_NO
        ,ISNULL(CITRUS_USR.FN_ACCT_ENTPd(DPAM.DPAM_CRN_NO,'RBI_REF_NO','RBI_APP_DT'),'') RBI_APP_DATE
        ,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM.DPAM_CRN_NO,'OCCUPATION',''),'') OCCUPATION 
		--	,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM.DPAM_CRN_NO,'SMS_FLAG',''),'') SMS 
		,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM.DPAM_CRN_NO,'TAX_DEDUCTION',''),'') TAXDEDUCTION 
	    --, citrus_usr.fn_get_listing('TAX_DEDUCTION',isnull(citrus_usr.fn_ucc_entp(DPAM.DPAM_CRN_NO,'TAX_DEDUCTION',''),''))  TAXDEDUCTION 
		,ISNULL(DPPD_FNAME,'') DPPD_FNAME 
		,ISNULL(DPHD_SH_FNAME,'') DPHD_SH_FNAME
		,ISNULL(DPHD_SH_MNAME,'') DPHD_SH_MNAME
		,ISNULL(DPHD_SH_LNAME,'') DPHD_SH_LNAME
		,CASE WHEN ISNULL(DPHD_SH_DOB,'JAN 01 1900') ='JAN 01 1900' THEN '' ELSE ISNULL(DPHD_SH_DOB,'') END DPHD_SH_DOB
        ,isnull(DPHD_FH_FTHNAME,'') DPHD_FH_FTHNAME 
		,ISNULL(DPHD_SH_PAN_NO,'')  DPHD_SH_PAN_NO
		,ISNULL(DPHD_TH_FNAME,'') DPHD_TH_FNAME
		,ISNULL(DPHD_TH_MNAME,'') DPHD_TH_MNAME
		,ISNULL(DPHD_TH_LNAME,'') DPHD_TH_LNAME
		,CASE WHEN ISNULL(DPHD_TH_DOB,'JAN 01 1900') ='JAN 01 1900' THEN '' ELSE ISNULL(DPHD_TH_DOB,'') END DPHD_TH_DOB
		,ISNULL(DPHD_TH_PAN_NO ,'') DPHD_TH_PAN_NO
        ,CASE WHEN ISNULL(DPHD_NOM_DOB,'JAN 01 1900') ='JAN 01 1900' THEN '' ELSE ISNULL(DPHD_NOM_DOB,'') END DPHD_NOM_DOB
		,ISNULL(DPHD_NOM_PAN_NO,'')  DPHD_NOM_PAN_NO
		,ISNULL(DPHD_NOM_FNAME,'') DPHD_NOM_FNAME
		,ISNULL(DPHD_NOM_MNAME,'') DPHD_NOM_MNAME
		,ISNULL(DPHD_NOM_LNAME,'') DPHD_NOM_LNAME
		,CITRUS_USR.FN_ADDR_VALUE(DPAM.DPAM_CRN_NO,'FAX1') fax1
		FROM DP_ACCT_MSTR DPAM
		LEFT OUTER JOIN 
		DP_HOLDER_DTLS ON  DPAM_ID = DPHD_DPAM_ID AND DPHD_DELETED_IND =1
		LEFT OUTER JOIN 
		DP_POA_DTLS    ON   DPAM_ID = DPPD_DPAM_ID  AND DPPD_DELETED_IND =1
		,CLIENT_CTGRY_MSTR
		,ENTITY_TYPE_MSTR
		,STATUS_MSTR
		,SUB_CTGRY_MSTR 
		,CLIENT_MSTR
		,CLIENT_BANK_ACCTS
		,BANK_MSTR    
		,CITRUS_USR.FN_ACCT_LIST(@@DPMID ,@PA_LOGIN_PR_ENTM_ID,@@L_CHILD_ENTM_ID) ACCOUNT         
		WHERE DPAM.DPAM_SBA_NO  BETWEEN @PA_FROM_ACCTNO AND @PA_TO_ACCTNO
		AND   DPAM.DPAM_CLICM_CD = CLICM_CD 
		AND   DPAM.DPAM_ENTTM_CD = ENTTM_CD
		AND   DPAM.DPAM_STAM_CD  = STAM_CD
		AND   DPAM.DPAM_SUBCM_CD = SUBCM_CD
		AND   CLICM_ID           = SUBCM_CLICM_ID
		AND   CLIM_CRN_NO        = DPAM.DPAM_CRN_NO 
		AND   CLIBA_CLISBA_ID    = DPAM.DPAM_ID
		AND   CLIBA_BANM_ID      = BANM_ID     
		AND   DPAM.DPAM_ID       = ACCOUNT.DPAM_ID

END -- MAIN

GO
