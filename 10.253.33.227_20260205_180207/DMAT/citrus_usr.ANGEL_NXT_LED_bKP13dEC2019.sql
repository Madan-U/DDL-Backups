-- Object: PROCEDURE citrus_usr.ANGEL_NXT_LED_bKP13dEC2019
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

cREATE PROC [citrus_usr].[ANGEL_NXT_LED_bKP13dEC2019] 
(@FROM_FIN_YEAR VARCHAR(4),@TO_FIN_YEAR VARCHAR(4),@DP_ID VARCHAR(16) ,@LTYPE VARCHAR(15))

AS
---Request From : Angel Next Team
---- Devleoper : Siva Kumar
--- For Led : EXEC CITRUS_USR.ANGEL_NXT_LED '2018' ,'2019' ,'1203320012480091' ,'L'
--- For Accural : ANGEL_NXT_LED '2018' ,'2019' ,'1203320012480091', 'A'

DECLARE  @LEDGER VARCHAR(50),@STRSQL NVARCHAR(MAX)

IF (@LTYPE ='L' ) 
		BEGIN 

			SELECT  @LEDGER='CITRUS_USR.LEDGER'+CONVERT(VARCHAR(2),FIN_ID)  
			FROM Financial_Yr_Mstr WHERE YEAR(FIN_START_DT) = @FROM_FIN_YEAR AND YEAR(FIN_END_DT) =@TO_FIN_YEAR

			SET @STRSQL = ' SELECT * FROM ( '
			SET @STRSQL = @STRSQL + ' SELECT  CASE WHEN LDG_ACCOUNT_TYPE =''P'' THEN DPAM_SBA_NO  ' 
			SET @STRSQL = @STRSQL + ' ELSE '''' END  '
			SET @STRSQL = @STRSQL + ' LD_CLIENTCD     '
			SET @STRSQL = @STRSQL + ' ,convert(varchar(12),LDG_VOUCHER_DT,105)  LD_DT ,CONVERT(NUMERIC(18,4),LDG_AMOUNT  ) LD_AMOUNT,CASE WHEN LDG_AMOUNT < 0 THEN LDG_AMOUNT END LD_AMOUNT_D,0 LD_AMOUNT_C '   
			SET @STRSQL = @STRSQL + ' ,LDG_NARRATION  LD_PARTICULAR,LDG_INSTRUMENT_NO  LD_CHEQUENO  '   
			SET @STRSQL = @STRSQL + ' ,CASE WHEN LDG_AMOUNT < 0 THEN ''D'' ELSE ''C'' END   LD_DEBITFLAG   '      
			SET @STRSQL = @STRSQL + ' ,(CASE WHEN LDG_VOUCHER_TYPE =1 THEN ''P'' '   
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =2 THEN ''R''  '     
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =3 THEN ''J'' '   
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =5 THEN ''B'' ELSE '''' END) LD_DOCUMENTTYPE '       
			SET @STRSQL = @STRSQL + ' ,LDG_VOUCHER_NO  LD_DOCUMENTNO,'''' LD_ENTRYNO ,'''' LD_COSTCENTER,LDG_CREATED_BY  MKRID ,LDG_LST_UPD_DT  MKRDT  '    
			SET @STRSQL = @STRSQL + ' ,YEAR(LDG_VOUCHER_DT) LD_ACCYEAR    '     
			SET @STRSQL = @STRSQL + ' ,LEFT(DPAM_SBA_NO,8) LD_DPID   '      
			SET @STRSQL = @STRSQL + ' ,'''' LD_COMMONDT    '     
			SET @STRSQL = @STRSQL + ' ,'''' LD_COMMON     '    
			SET @STRSQL = @STRSQL + ' FROM  ' +@LEDGER  + '  WITH(NOLOCK) '   
			SET @STRSQL = @STRSQL + ' LEFT OUTER JOIN  CITRUS_USR.DP_ACCT_MSTR  WITH(NOLOCK)ON  LDG_ACCOUNT_ID  = DPAM_ID '     
			--SET @STRSQL = @STRSQL + ' LEFT OUTER JOIN  CITRUS_USR.FIN_ACCOUNT_MSTR   WITH(NOLOCK)ON  LDG_ACCOUNT_ID  =   FINA_ACC_ID '    
			SET @STRSQL = @STRSQL + ' WHERE LDG_DELETED_IND=1  )A '
			SET @STRSQL = @STRSQL + ' WHERE  LD_DEBITFLAG=''D'' and LD_CLIENTCD = ''' + @DP_ID   + '''    '

			
			
			SET @STRSQL = @STRSQL + ' UNION   SELECT * FROM (  SELECT  CASE WHEN LDG_ACCOUNT_TYPE =''P'' THEN DPAM_SBA_NO  ' 
			SET @STRSQL = @STRSQL + ' ELSE '''' END  '
			SET @STRSQL = @STRSQL + ' LD_CLIENTCD     '
			SET @STRSQL = @STRSQL + ' ,convert(varchar(12),LDG_VOUCHER_DT,105)  LD_DT ,CONVERT(NUMERIC(18,4),LDG_AMOUNT  ) LD_AMOUNT ,0 LD_AMOUNT_D,CASE WHEN LDG_AMOUNT > 0 THEN LDG_AMOUNT END LD_AMOUNT_C '   

			SET @STRSQL = @STRSQL + ' ,LDG_NARRATION  LD_PARTICULAR,LDG_INSTRUMENT_NO  LD_CHEQUENO  '   
			SET @STRSQL = @STRSQL + ' ,CASE WHEN LDG_AMOUNT < 0 THEN ''D'' ELSE ''C'' END   LD_DEBITFLAG   '      
			SET @STRSQL = @STRSQL + ' ,(CASE WHEN LDG_VOUCHER_TYPE =1 THEN ''P'' '   
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =2 THEN ''R''  '     
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =3 THEN ''J'' '   
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =5 THEN ''B'' ELSE '''' END) LD_DOCUMENTTYPE '       
			SET @STRSQL = @STRSQL + ' ,LDG_VOUCHER_NO  LD_DOCUMENTNO,'''' LD_ENTRYNO ,'''' LD_COSTCENTER,LDG_CREATED_BY  MKRID ,LDG_LST_UPD_DT  MKRDT  '    
			SET @STRSQL = @STRSQL + ' ,YEAR(LDG_VOUCHER_DT) LD_ACCYEAR    '     
			SET @STRSQL = @STRSQL + ' ,LEFT(DPAM_SBA_NO,8) LD_DPID   '      
			SET @STRSQL = @STRSQL + ' ,'''' LD_COMMONDT    '     
			SET @STRSQL = @STRSQL + ' ,'''' LD_COMMON     '    
			SET @STRSQL = @STRSQL + ' FROM  ' +@LEDGER  + '  WITH(NOLOCK) '   
			SET @STRSQL = @STRSQL + ' LEFT OUTER JOIN  CITRUS_USR.DP_ACCT_MSTR  WITH(NOLOCK)ON  LDG_ACCOUNT_ID  = DPAM_ID '     
			--SET @STRSQL = @STRSQL + ' LEFT OUTER JOIN  CITRUS_USR.FIN_ACCOUNT_MSTR   WITH(NOLOCK)ON  LDG_ACCOUNT_ID  =   FINA_ACC_ID '    
			SET @STRSQL = @STRSQL + ' WHERE LDG_DELETED_IND=1  )A '
			SET @STRSQL = @STRSQL + ' WHERE  LD_DEBITFLAG=''C'' and LD_CLIENTCD = ''' + @DP_ID   + ''' ORDER BY LD_DT   '

			Print @LEDGER
			PRINT (@STRSQL)
			EXEC (@STRSQL)

		END

IF (@LTYPE ='A' )
     BEGIN 

	   SELECT * INTO #DP FROM DP_ACCT_MSTR WHERE DPAM_SBA_NO = @DP_ID
		DECLARE @FROMDATE DATETIME,@TODATE DATETIME

		SELECT @FROMDATE = CITRUS_USR.UFN_GETFIRSTDAYOFMONTH(GETDATE())   
		SELECT @TODATE = DBO.UFN_GETLASTDAYOFMONTH(GETDATE())


   SELECT CLIENT_CODE,PARTY_CODE ,TR_TYPE,SUM(BROK_BAL)*-1 CHARGES_DETAILS FROM (
	   SELECT DPAM_BBO_CODE AS PARTY_CODE, DPAM_SBA_NO CLIENT_CODE,
	   (CASE WHEN  CLIC_CHARGE_NAME ='TRANSACTION CHARGES' THEN 'TRANSACTION_CHARGES' ELSE 'OTHER_CHARGES' END)
	   TR_TYPE, CLIC_CHARGE_AMT BROK_BAL, '0' CURR_BAL  FROM     
		  #DP , CLIENT_CHARGES_CDSL WHERE CLIC_DPAM_ID = DPAM_ID 
		  AND DPAM_SBA_NO = @DP_ID AND CLIC_TRANS_DT BETWEEN CITRUS_USR.UFN_GETFIRSTDAYOFMONTH(GETDATE())    
		  AND DBO.UFN_GETLASTDAYOFMONTH(GETDATE())-- GROUP BY DPAM_SBA_NO,DPAM_BBO_CODE     
		  UNION ALL
		  SELECT DPAM_BBO_CODE AS PARTY_CODE, DPAM_SBA_NO CLIENT_CODE, 
		  (CASE WHEN  CLIC_CHARGE_NAME ='TRANSACTION CHARGES' THEN 'TRANSACTION_CHARGES' ELSE 'OTHER_CHARGES' END)
		  TR_TYPE, CLIC_CHARGE_AMT BROK_BAL, '0' CURR_BAL  FROM     
		  #DP , CLIENT_CHARGES_CDSL WHERE CLIC_DPAM_ID = DPAM_ID AND DPAM_SBA_NO = @DP_ID
		  AND CLIC_TRANS_DT BETWEEN CITRUS_USR.UFN_GETFIRSTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE()))    
		  AND DBO.UFN_GETLASTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE())) 
		  AND NOT EXISTS (SELECT LDG_ACCOUNT_ID FROM LEDGER5 WHERE LDG_ACCOUNT_ID=DPAM_ID AND LDG_DELETED_IND=1 AND LDG_VOUCHER_TYPE='5'
		  AND LDG_VOUCHER_DT=DBO.UFN_GETLASTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE()))))A
		  GROUP BY CLIENT_CODE,PARTY_CODE ,TR_TYPE

    END

GO
