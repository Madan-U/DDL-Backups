-- Object: PROCEDURE citrus_usr.Edis_trxn_process_mf
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

CREATE PROC [citrus_usr].[Edis_trxn_process_mf] (@DATE DATETIME)
AS

TRUNCATE TABLE HOLD_REP_N_MF
DECLARE @PDATE VARCHAR(8)
SET  @PDATE = REPLACE(LEFT(CONVERT(VARCHAR,GETDATE(), 104), 10),'.','') 
 

	 SELECT PARTY_CODE,ISIN,ADJ_QTY ,DP_ID,ROW_NUMBER()OVER(ORDER BY PARTY_CODE,ISIN DESC) SR_NO INTO #PLD1 FROM DIY_REPROCESS_LOG_E_DIS_MF WITH(NOLOCK)
	

	 	 SELECT DISTINCT PARTYCODE,BOID,ISIN,QTY= (CASE WHEN CAST(ISNULL(PEND_QTY,0)AS FLOAT)>0 THEN CAST(ISNULL(PEND_QTY,0) AS FLOAT) ELSE CAST(QTY AS FLOAT) END ) , ANGEL_TRXN_ID,	
		 CDSL_TRXN_ID,REQUEST_DATE, ROW_NUMBER()OVER(ORDER BY PARTYCODE,BOID,ISIN,REQUEST_DATE DESC) AS SRNO INTO  #FINAL_DUMP
		 FROM MF_DATA T
		 WHERE EXISTS (SELECT PARTY_CODE FROM DIY_REPROCESS_LOG_E_DIS_MF D WHERE D.PARTY_CODE =T.PARTYCODE
		  AND D.ISIN=T.ISIN AND REQUEST_DATE>=GETDATE()-10
   AND DUMMY2=@PDATE AND ISNULL(VALID,0)=0  ) --AND ISNULL(VALID,0)=0 AND ISNULL(DUMMY3,'')=''
		 -- ORDER BY PARTYCODE,REQUEST_DATE

 CREATE INDEX #T ON #PLD1
 (SR_NO)

 CREATE INDEX #FIN1 ON #FINAL_DUMP
 (PARTYCODE,ISIN )

 ALTER TABLE #FINAL_DUMP
 ADD ALLOCATE_QTY FLOAT


 DECLARE @CNT3 INT  ,@ISIN3 VARCHAR(15),@QTY3  INT ,@NEWQTY3 INT,@NEWID3 VARCHAR(25) ,@NEWSNO3 INT  ,@PARTY_CODE VARCHAR(10)
,@ID3 INT  ,@PARTY_CODE3 VARCHAR(10),@OLDID3 VARCHAR(25),@NEWSNO31 INT ,@NEWCNT3 INT ,@EXCHANGE3 VARCHAR(15) ,@ID31 INT,@QTYN FLOAT
 
 SELECT @CNT3=COUNT(*) FROM #PLD1 

  SET @ID3 =1

WHILE (@ID3<=@CNT3)

	  BEGIN   --SELECT * FROM #PLD1
	          
			 SELECT @ISIN3=ISIN,@QTY3=ROUND(ADJ_QTY,0) ,@NEWID3 =DP_ID ,@PARTY_CODE=PARTY_CODE FROM #PLD1  WHERE SR_NO =@ID3  
			    
				
				SELECT * INTO  #FINAL_DATA FROM (
				SELECT ROW_NUMBER() OVER (ORDER BY REQUEST_DATE DESC) SR_NO , * 
				FROM #FINAL_DUMP WHERE ISIN =@ISIN3  AND BOID= @NEWID3 AND PARTYCODE=@PARTY_CODE)A
				ORDER BY SR_NO  

				INSERT INTO HOLD_REP_N_MF   
					SELECT * FROM (
				SELECT SR_NO,	PARTYCODE,	BOID	,ISIN,	QTY,	ANGEL_TRXN_ID,	CDSL_TRXN_ID,	REQUEST_DATE,SRNO,
					(SELECT SUM(QTY) 
									FROM #FINAL_DATA B 
									WHERE B.SR_NO <= A.SR_NO) AS B 
							FROM #FINAL_DATA A
							) A
							WHERE B<@QTY3
				
				IF( @@ROWCOUNT =0)
				   
				    BEGIN 
					
				INSERT INTO HOLD_REP_N_MF
				--SELECT SR_NO,SRNO, ISIN ,CLIENTID ,@QTY3  ,0 FROM 	#FINAL_DATA WHERE SR_NO=1 
				SELECT SR_NO,	PARTYCODE,	BOID	,ISIN,	QTY,	ANGEL_TRXN_ID,	CDSL_TRXN_ID,	REQUEST_DATE, SRNO,@QTY3  FROM #FINAL_DATA WHERE SR_NO=1 

			END

				ELSE 

				   BEGIN 
				 
				    SELECT @NEWID3=MAX(SR_NO),@NEWQTY3=SUM(QTY) FROM HOLD_REP_N_MF WHERE ISIN =@ISIN3  AND BOID= @NEWID3 AND PARTYCODE =@PARTY_CODE
		
					INSERT INTO HOLD_REP_N_MF
		           SELECT  SR_NO,	PARTYCODE,	BOID	,ISIN,	QTY,	ANGEL_TRXN_ID,	CDSL_TRXN_ID,	REQUEST_DATE,SRNO, @QTY3-@NEWQTY3  FROM 	#FINAL_DATA WHERE SR_NO=@NEWID3+1
		
		
		            END  



              SET @NEWSNO31=@NEWSNO31+1

                  
				 DROP TABLE #FINAL_DATA




   	  SET @ID3 =@ID3 +1 
	  PRINT @ID3
	END 		

	
 --SELECT * FROM HOLD_REP_N_MF
 ----SELECT * FROM #FINAL_DUMP

GO
