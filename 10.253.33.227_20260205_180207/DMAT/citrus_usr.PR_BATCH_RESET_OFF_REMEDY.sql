-- Object: PROCEDURE citrus_usr.PR_BATCH_RESET_OFF_REMEDY
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

CREATE PROCEDURE [citrus_usr].[PR_BATCH_RESET_OFF_REMEDY]  
(  
@PA_ID INTEGER,  
@PA_BATCHNO VARCHAR(20),  
@PA_BATCHTYPE  VARCHAR(16),  
@PA_TYPE CHAR(11),  
@PA_TRXTYPE VARCHAR(50),
@PA_TRXTYPECDSL VARCHAR(10),  
@PA_ERRMSG     VARCHAR(8000) OUTPUT    
)  
AS   
DECLARE @L_DPM_ID INTEGER,  
 @L_ERROR         BIGINT,  
 @T_ERRORSTR VARCHAR(8000) 

  
SET @L_ERROR=0  
SELECT @L_DPM_ID  =  DPM_ID FROM DP_MSTR WHERE DEFAULT_DP = @PA_ID  AND DPM_DELETED_IND = 1  

BEGIN   
BEGIN TRANSACTION  
  
IF @PA_BATCHTYPE='NSDL'  
BEGIN--1  
	IF @PA_TYPE = 'RRE'
	begin   

		IF  EXISTS( select isnull(EOFFMN_BATCH_NO,'0') from ERR_OFFMKT_MSTR_NSDL where  EOFFMN_BATCH_NO = @PA_BATCHNO  )  
		BEGIN  
		update s set EOFFMN_BATCH_NO = null      from ERR_OFFMKT_MSTR_NSDL s where  EOFFMN_BATCH_NO = @PA_BATCHNO  
		END  
		ELSE   
		BEGIN           
		 SELECT @T_ERRORSTR = 'CAN NOT PROCESS,  BATCH NO ' + @PA_BATCHNO  + ' IS NOT FOUND'  
		END       
	end

END  
ELSE IF @PA_BATCHTYPE='CDSL'  
BEGIN    
	IF @PA_TYPE = 'RRE'
	begin   

				IF  EXISTS( select isnull(EOFFM_BATCH_NO,'0') from ERR_OFFMKT_MSTR where  EOFFM_BATCH_NO = @PA_BATCHNO )  
		BEGIN  
		update s set EOFFM_BATCH_NO = null     from ERR_OFFMKT_MSTR s where  EOFFM_BATCH_NO = @PA_BATCHNO  
		END  
		ELSE   
		BEGIN           
		 	 SELECT @T_ERRORSTR = 'CAN NOT PROCESS,   BATCH NO  ' + @PA_BATCHNO  + ' IS NOT FOUND'  
		END   
	end

end  
  
SET @L_ERROR = @@ERROR  
IF @L_ERROR <> 0   
BEGIN  
  IF EXISTS(SELECT ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = @L_ERROR)  
  BEGIN  
  --  
    SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': '+ ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = CONVERT(VARCHAR,@L_ERROR)  
  --  
  END  
  ELSE  
  BEGIN  
  --  
    SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': CAN NOT PROCESS, PLEASE CONTACT YOUR ADMINISTRATOR!'  
  --  
        END  
  
  ROLLBACK TRANSACTION   
END  
ELSE  
BEGIN   
  COMMIT TRANSACTION  
  IF ISNULL(@T_ERRORSTR,'') = ''  
  SELECT @T_ERRORSTR = 'PROCESS DONE SUCCESSFULLY'  
END  
SET @PA_ERRMSG = @T_ERRORSTR  
  
END

GO
