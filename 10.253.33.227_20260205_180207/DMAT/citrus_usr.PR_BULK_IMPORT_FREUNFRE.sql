-- Object: PROCEDURE citrus_usr.PR_BULK_IMPORT_FREUNFRE
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------


CREATE PROCEDURE [citrus_usr].[PR_BULK_IMPORT_FREUNFRE]
(
@PA_LOGINNAMES VARCHAR(800)
)
AS
BEGIN


INSERT INTO BULK_FREUNFRE_MSTR
SELECT TMPB_FU_BOID
,TMPB_FU_RMKS
--,CONVERT(VARCHAR(11),GETDATE(),109)
,TMPB_FU_CREATED_DT
,TMPB_FU , 'BULK'
--,GETDATE()
,TMPB_FU_CREATED_DT
, 'BULK'
--,GETDATE()
,TMPB_FU_CREATED_DT
,1
 FROM TMPBULK_FREUNFRE_MSTR
 WHERE NOT EXISTS (SELECT 1 FROM BULK_FREUNFRE_MSTR 
							WHERE TMPB_FU_BOID=B_FU_BOID  
							AND TMPB_FU_RMKS= B_FU_RMKS  
							AND TMPB_FU=B_FU 
							--AND B_FU_DT=CONVERT(VARCHAR(11),GETDATE(),109)
							AND B_FU_DT=TMPB_FU_CREATED_DT
				   )
 
 DECLARE @FRE_ID INT
 SELECT @FRE_ID= MAX(FRE_ID) FROM FREEZE_UNFREEZE_DTLS

 IF ISNULL(@FRE_ID , '') = '' 
 BEGIN
	SET @FRE_ID = 1
 END

 --SELECT IDENTITY(INT,1,1) ID, case when B_FU = 'FREEZE' then 'F' when B_FU = 'UNFREEZE' then 'U' else B_FU end   FRE_ACTION,
 --'A' FRE_TYPE,B_FU_DT FRE_EXEC_DATE, '3' FRE_DPMID,DPAM_ID FRE_DPAM_ID , '' FRE_ISIN_CODE,0.00000 FRE_QTY,'A' FRE_STATUS,
 --'A' FRE_LEVEL,'BULK' FRE_CREATED_BY,B_FU_DT FRE_CREATED_DT,'BULK' FRE_LST_UPD_BY,'DEC 31 2100' FRE_LST_UPD_DT,
 --'1' FRE_DELETED_IND,NULL FRE_BATCH_NO,'A' FRE_REQ_INT_BY,NULL FRE_TRNS_NO, B_FU_RMKS FRE_RMKS,'02' FRE_FOR
 --INTO #TMP
 -- FROM BULK_FREUNFRE_MSTR,DP_ACCT_MSTR,TMPBULK_FREUNFRE_MSTR 
 --WHERE DPAM_SBA_NO=B_FU_BOID AND TMPB_FU_BOID = B_FU_BOID AND B_FU = TMPB_FU --AND TMPB_FU_CREATED_DT = B_CREATED_DT

 
 
 SELECT IDENTITY(INT,1,1) ID, case when TMPB_FU = 'FREEZE' then 'F' when TMPB_FU = 'UNFREEZE' then 'U' else TMPB_FU end   FRE_ACTION,
 'A' FRE_TYPE,TMPB_FU_CREATED_DT FRE_EXEC_DATE, '3' FRE_DPMID,DPAM_ID FRE_DPAM_ID , '' FRE_ISIN_CODE,0.00000 FRE_QTY,'A' FRE_STATUS,
 'A' FRE_LEVEL,'BULK' FRE_CREATED_BY,TMPB_FU_CREATED_DT FRE_CREATED_DT,'BULK' FRE_LST_UPD_BY,'DEC 31 2100' FRE_LST_UPD_DT,
 '1' FRE_DELETED_IND,NULL FRE_BATCH_NO,'A' FRE_REQ_INT_BY,NULL FRE_TRNS_NO, case when TMPB_FU = 'FREEZE' then  TMPB_FU_RMKS when TMPB_FU = 'UNFREEZE' then '' else TMPB_FU_RMKS end  FRE_RMKS,'02' FRE_FOR
 INTO #TMP
  FROM  DP_ACCT_MSTR,TMPBULK_FREUNFRE_MSTR 
 WHERE DPAM_SBA_NO=TMPB_FU_BOID   
 
 

 UPDATE M SET M.fre_lst_upd_dt = T.TMPB_FU_CREATED_DT 
 FROM  FREEZE_UNFREEZE_DTLS M,TMPBULK_FREUNFRE_MSTR T, #TMP TT 
 WHERE M.fre_Dpam_id =TT.FRE_DPAM_ID 
 AND TT.FRE_ACTION = case when TMPB_FU = 'FREEZE' then 'F' when TMPB_FU = 'UNFREEZE' then 'U' else TMPB_FU end
  AND M.FRE_ACTION <> case when TMPB_FU = 'FREEZE' then 'F' when TMPB_FU = 'UNFREEZE' then 'U' else TMPB_FU end
 and m.fre_lst_upd_dt = '2100-12-31 00:00:00.000'



 INSERT INTO FREEZE_UNFREEZE_DTLS
 SELECT ID + @FRE_ID
,FRE_ACTION
,FRE_TYPE
,FRE_EXEC_DATE
,FRE_DPMID
,FRE_DPAM_ID
,FRE_ISIN_CODE
,FRE_QTY
,FRE_STATUS
,FRE_LEVEL
,FRE_CREATED_BY
,FRE_CREATED_DT
,FRE_LST_UPD_BY
,FRE_LST_UPD_DT
,FRE_DELETED_IND
,FRE_BATCH_NO
,FRE_REQ_INT_BY
,FRE_TRNS_NO
,FRE_RMKS
,FRE_FOR  FROM #TMP T
WHERE NOT EXISTS (
SELECT 1 FROM FREEZE_UNFREEZE_DTLS M WHERE M.fre_action=T.FRE_ACTION 
AND M.FRE_DPAM_ID=T.FRE_DPAM_ID 
 AND M.FRE_EXEC_DATE=T.FRE_EXEC_DATE
 AND M.FRE_RMKS=T.FRE_RMKS and m.fre_lst_upd_dt =  '2100-12-31 00:00:00.000'
)


END

GO
