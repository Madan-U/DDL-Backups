-- Object: PROCEDURE citrus_usr.PR_BULK_NOMINEE_TPA
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

--begin tran
--exec PR_BULK_NOMINEE_TPA 'HO'
--select * from client_list_modified  order by clic_mod_created_dt desc
--select * from client_list_modified where clic_mod_dpam_sba_no='1203320150988108'
--select * from dp_acct_mstr where dpam_sba_no='1203320150988108'
--select * from Nominee_Multi where Nom_dpam_id=12513854
--Select * from Nominee_Multi_mak where Nom_dpam_id=12513854
--select * from name_change_reason_cd where nmcrcd_sba_no='1203320150988108'
--commit
CREATE PROCEDURE [citrus_usr].[PR_BULK_NOMINEE_TPA]
(
@PA_LOGINNAMES VARCHAR(100)
)
AS
BEGIN
DECLARE @C CURSOR ,
@NAME VARCHAR(100),@MIDDLENAME VARCHAR(100),@SEARCHNAME VARCHAR(100),@SUFFIX VARCHAR(100),@FTHNAME VARCHAR(100),@ADDR1 VARCHAR(100),@ADDR2 VARCHAR(100),@ADDR3 VARCHAR(100)
,@CITY VARCHAR(100),@STATE VARCHAR(100),@COUNTRY VARCHAR(100),@PINCODE VARCHAR(100),@PRIPHIND VARCHAR(100),@PRIPHNUM VARCHAR(100),@ALTPHIND VARCHAR(100),@ALTPHNUM VARCHAR(100),
@ADDPHONES VARCHAR(100),@FAX VARCHAR(100),@PANGIR VARCHAR(100),@EMAIL VARCHAR(100),@UNQIDNUM VARCHAR(100),@BOID VARCHAR(100),@RES_SEC_FLG VARCHAR(100)
,@NOM_SR_NO VARCHAR(100),@REL_WITH_BO VARCHAR(100),@PERC_OF_SHARES VARCHAR(100),@STATECODE VARCHAR(100),@COUNTRYCODE VARCHAR(100),@DPAM_ID NUMERIC,@dob varchar(8),@crnno numeric

SET @C = CURSOR FAST_FORWARD FOR

SELECT NAME,MIDDLENAME,SEARCHNAME,SUFFIX,FTHNAME
,case when DATEOFBIRTH <> '' then convert(datetime,(left(DATEOFBIRTH,2)+'/'+substring(DATEOFBIRTH,3,2) + '/' + right(DATEOFBIRTH,4)),103) else DATEOFBIRTH end
,ADDR1,ADDR2,ADDR3,CITY,STATE,COUNTRY,PINCODE,PRIPHIND,PRIPHNUM,ALTPHIND,ALTPHNUM,ADDPHONES,FAX
,PANGIR,EMAIL,UNQIDNUM,BOID,RES_SEC_FLG,NOM_SR_NO,REL_WITH_BO,PERC_OF_SHARES,STATECODE,COUNTRYCODE,DPAM_ID,DPAM_CRN_NO FROM DPS8_PC6_TP,DP_ACCT_MSTR
WHERE DPAM_SBA_NO=BOID AND DPAM_DELETED_IND=1
--and not exists (select 1 from Nominee_Multi where Nom_DPAM_SBA_NO=DPAM_SBA_NO)
and not exists (select 1 from client_list_modified where clic_mod_dpam_sba_no=DPAM_SBA_NO and clic_mod_action in ('NOMINEE1'))
--and boid='1203320147900148'

OPEN @C

FETCH NEXT FROM @C INTO @NAME ,@MIDDLENAME ,@SEARCHNAME ,@SUFFIX ,@FTHNAME ,@dob,@ADDR1 ,@ADDR2 ,@ADDR3 
,@CITY ,@STATE ,@COUNTRY ,@PINCODE ,@PRIPHIND ,@PRIPHNUM ,@ALTPHIND ,@ALTPHNUM ,
@ADDPHONES ,@FAX ,@PANGIR ,@EMAIL ,@UNQIDNUM ,@BOID ,@RES_SEC_FLG 
,@NOM_SR_NO ,@REL_WITH_BO ,@PERC_OF_SHARES ,@STATECODE ,@COUNTRYCODE ,@DPAM_ID  ,@crnno

WHILE @@FETCH_STATUS=0
BEGIN

DECLARE @P38 VARCHAR(8000)
SET @P38=''
EXEC PR_INS_UPD_NOMMULTI_MOD 
'0','INS',@PA_LOGINNAMES,@DPAM_ID,@BOID
,@NOM_SR_NO,@NAME,@MIDDLENAME,@SEARCHNAME,@FTHNAME
,@dob,@ADDR1,@ADDR2,
@ADDR3,@CITY,@STATE,@COUNTRY,@PINCODE,
@PRIPHIND,@PRIPHNUM,@ALTPHIND,@ALTPHNUM,@ADDPHONES,@FAX,@PANGIR,
@UNQIDNUM,@EMAIL,@REL_WITH_BO,@PERC_OF_SHARES,@RES_SEC_FLG,'0','1',''
,'1','05~CHANGE OF NOMINEE','','',''

--insert into name_change_reason_cd
--select @crnno,@BOID,'05','CHANGE OF NOMINEE',getdate(),'HO',getdate(),'HO','1','NOMINEE1'

update t set dpam_subcm_cd='012103'  from  DP_ACCT_MSTR t where dpam_sba_no=@BOID

insert into client_list_modified
select @BOID,'','Sub Status',getdate(),getdate(),'HO',getdate(),'HO',getdate(),'1',0 


FETCH NEXT FROM @C INTO @NAME ,@MIDDLENAME ,@SEARCHNAME ,@SUFFIX ,@FTHNAME ,@dob,@ADDR1 ,@ADDR2 ,@ADDR3 
,@CITY ,@STATE ,@COUNTRY ,@PINCODE ,@PRIPHIND ,@PRIPHNUM ,@ALTPHIND ,@ALTPHNUM ,
@ADDPHONES ,@FAX ,@PANGIR ,@EMAIL ,@UNQIDNUM ,@BOID ,@RES_SEC_FLG 
,@NOM_SR_NO ,@REL_WITH_BO ,@PERC_OF_SHARES ,@STATECODE ,@COUNTRYCODE ,@DPAM_ID ,@crnno
END

CLOSE @C
DEALLOCATE @C

END

GO
