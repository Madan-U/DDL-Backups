-- Object: PROCEDURE citrus_usr.DP_HOLD_POA_MKT
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------


        
        
CREATE PROC [citrus_usr].[DP_HOLD_POA_MKT] --(@SETT_NO VARCHAR(12),@SETT_TYPE VARCHAR(3))        
AS         
        
  
  
SELECT SETT_NO,SETT_TYPE INTO #SETT FROM [ANGELDEMAT].MSAJAG.DBO.SETT_MST  WITH(NOLOCK)     
WHERE SEC_PAYIN >=CONVERT(VARCHAR(11),GETDATE(),120)      
AND START_DATE <=CONVERT(VARCHAR(11),GETDATE(),120)      
      
CREATE INDEX #S ON #SETT(SETT_NO,SETT_TYPE)       
   
      
SELECT DISTINCT M.PARTY_CODE,M.CLTDPNO,I_ISIN INTO #CLT1  FROM [ANGELDEMAT].MSAJAG.DBO.MULTICLTID M WITH(NOLOCK),        
[ANGELDEMAT].MSAJAG.DBO.DELIVERYCLT D  WITH(NOLOCK)  ,#SETT S  WITH(NOLOCK)     
WHERE D.SETT_NO=S.SETT_NO  AND D.PARTY_CODE=M.PARTY_CODE AND D.SETT_TYPE=S.SETT_TYPE         
 AND INOUT ='I'      
        
CREATE INDEX #CL ON #CLT1 ( CLTDPNO,I_ISIN)        
        
SELECT  PARTY_CODE='PARTY',DPID=LEFT(HLD_AC_CODE,8),CLTDPID=HLD_AC_CODE,SCRIP_CD=NULL,SERIES=NULL,ISIN=HLD_ISIN_CODE,        
FREEBAL=FLOOR(FREE_QTY),CURRBAL=0,FREEZEBAL=0,LOCKINBAL=0,PLEDGEBAL=0,DPVBAL=0,DPCBAL=0,RPCBAL=0,ELIMBAL=0,EARMARKBAL=0,        
REMLOCKBAL=0,TOTALBALANCE=FLOOR(FREE_QTY),  TRDATE=        
LEFT(HLD_HOLD_DATE,4) + '-' + SUBSTRING(HLD_HOLD_DATE,5,2) + '-' + RIGHT(HLD_HOLD_DATE,2) FROM  HOLDING   H WITH(NOLOCK),        
#CLT1 C WITH(NOLOCK)        
WHERE FREE_QTY>0    AND HLD_AC_CODE =CLTDPNO AND HLD_ISIN_CODE =I_ISIN

GO
