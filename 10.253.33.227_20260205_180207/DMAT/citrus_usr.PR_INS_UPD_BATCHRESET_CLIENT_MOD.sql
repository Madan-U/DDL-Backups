-- Object: PROCEDURE citrus_usr.PR_INS_UPD_BATCHRESET_CLIENT_MOD
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------


CREATE  procedure [citrus_usr].[PR_INS_UPD_BATCHRESET_CLIENT_MOD]
(
	@PA_ID INTEGER,  
	@PA_BATCHNO VARCHAR(20),  
	@PA_BATCHTYPE VARCHAR(5),
	@PA_MODI_TYPE VARCHAR(50),   
	@PA_BATCH_RESET_MODE VARCHAR(50),   
	@PA_SBA_NO varchar(16),  
	@PA_ERRMSG VARCHAR(8000) OUTPUT 
)
as 
BEGIN

	DECLARE @L_DPM_ID INTEGER,  
	@L_ERROR         BIGINT,  
	@T_ERRORSTR VARCHAR(8000) 

	SET @L_ERROR=0  
	SELECT @L_DPM_ID = DPM_ID FROM DP_MSTR WHERE DEFAULT_DP = @PA_ID AND DPM_DELETED_IND = 1  

	IF @PA_BATCHTYPE='NSDL'  
	BEGIN  
		IF @PA_BATCH_RESET_MODE = 'ALL'
		BEGIN
			BEGIN TRANSACTION
	
			UPDATE M SET M.CLIC_MOD_BATCH_NO = '0' 
			FROM CLIENT_LIST_MODIFIED M, DP_ACCT_MSTR
			WHERE M.CLIC_MOD_BATCH_NO = @PA_BATCHNO 
			AND M.CLIC_MOD_DELETED_IND = 1
			AND M.CLIC_MOD_DPAM_SBA_NO = DPAM_SBA_NO
			AND DPAM_dpm_ID = @L_DPM_ID
		END
		ELSE
		BEGIN
			BEGIN TRANSACTION

			UPDATE M SET M.CLIC_MOD_BATCH_NO = '0' 
			FROM CLIENT_LIST_MODIFIED M, DP_ACCT_MSTR
			WHERE M.CLIC_MOD_BATCH_NO = @PA_BATCHNO 
			AND M.CLIC_MOD_ACTION = @PA_MODI_TYPE
			AND M.CLIC_MOD_DPAM_SBA_NO = @PA_SBA_NO
			AND M.CLIC_MOD_DELETED_IND = 1
			AND M.CLIC_MOD_DPAM_SBA_NO = DPAM_SBA_NO
			AND DPAM_dpm_ID = @L_DPM_ID
		END
	END
	ELSE
	BEGIN
		IF @PA_BATCH_RESET_MODE = 'ALL'
		BEGIN
			BEGIN TRANSACTION

			UPDATE M SET M.CLIC_MOD_BATCH_NO = '0' 
			FROM CLIENT_LIST_MODIFIED M, DP_ACCT_MSTR
			WHERE M.CLIC_MOD_BATCH_NO = @PA_BATCHNO 
			AND M.CLIC_MOD_DELETED_IND = 1
			AND M.CLIC_MOD_DPAM_SBA_NO = DPAM_SBA_NO
			AND DPAM_dpm_ID = @L_DPM_ID
		END
		ELSE
		BEGIN
			BEGIN TRANSACTION

			UPDATE M SET M.CLIC_MOD_BATCH_NO = '0' 
			FROM CLIENT_LIST_MODIFIED M, DP_ACCT_MSTR
			WHERE M.CLIC_MOD_BATCH_NO = @PA_BATCHNO 
			AND M.CLIC_MOD_ACTION = @PA_MODI_TYPE
			AND M.CLIC_MOD_DPAM_SBA_NO = @PA_SBA_NO
			AND M.CLIC_MOD_DELETED_IND = 1
			AND M.CLIC_MOD_DPAM_SBA_NO = DPAM_SBA_NO
			AND DPAM_dpm_ID = @L_DPM_ID
		END
	END

	SET @L_ERROR = @@ERROR  
	IF @L_ERROR <> 0   
	BEGIN  
	  IF EXISTS(SELECT ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = @L_ERROR)  
	  BEGIN  
	  --  
		SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': '+ ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = CONVERT(VARCHAR,@L_ERROR)  
	  --  
	  END  
	  ELSE  
	  BEGIN  
	  --  
		SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': CAN NOT PROCESS, PLEASE CONTACT YOUR ADMINISTRATOR!'  
	  --  
	  END  
	  
	  ROLLBACK TRANSACTION   
	END  
	ELSE  
	BEGIN   
	  COMMIT TRANSACTION  
	  IF ISNULL(@T_ERRORSTR,'') = ''  
	  SELECT @T_ERRORSTR = 'PROCESS DONE SUCCESSFULLY'  
	END  
	SET @PA_ERRMSG = @T_ERRORSTR 

end

GO
