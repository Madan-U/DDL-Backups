-- Object: PROCEDURE citrus_usr.PR_SD_BO_CSV
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

Create PROCEDURE [citrus_usr].[PR_SD_BO_CSV]  
(@PA_BILLING_FROM_DT DATETIME  
,@PA_BILLING_TO_DT   DATETIME  
,@PA_DP_ID          VARCHAR(16)  
,@PA_BILLING_STATUS  CHAR(1)  
,@PA_POSTED_FLG      CHAR(1)  
,@PA_BILL_POST_SHW_BILL   CHAR(1)  
,@PA_B2B_OUTSTANDING_FLG CHAR(1)
,@PA_LOGIN_NAME   VARCHAR(20)  
)  
AS  
BEGIN  
--  


	
SET NOCOUNT ON
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
    
  DECLARE  @DPPOSTACCOUNT NUMERIC(10,0)  
         , @L_FIN_ID      INT  
         , @L_REF_NO      VARCHAR(16)  
         , @L_SQL         VARCHAR(8000)  
         , @L_DPM_ID      INT  
         , @L_VOUCHER_NO  INT  
         , @BROKERGL_ACC_CD VARCHAR(20)  
         , @DP_NAME VARCHAR(10)   
  		 , @@L_POSTING_DT DATETIME    
		 , @@L_TOTALAMT NUMERIC(18,2)     


         SELECT @BROKERGL_ACC_CD = BITRM_VALUES FROM BITMAP_REF_MSTR WHERE BITRM_PARENT_CD='SD' 
		CREATE TABLE  #MAIN_BILL  
		(FROMDT     DATETIME  
		,TODT       DATETIME              
		,CLTCODE VARCHAR(100)
		, FINA_ACC_CODE   VARCHAR(100)  
		,DRCR       CHAR(1)  
		,AMOUNT     NUMERIC(18,2)    ,DPAM_SBA_NO VARCHAR(20)
		)   

   
	IF @PA_LOGIN_NAME='EQ'
						BEGIN

						SELECT 						
						@@L_TOTALAMT=ABS(SUM(CLIC_CHARGE_AMT)) +  ABS(SUM(CLIC_CHARGE_AMT*0.1500))
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'STAMP DUTY CHARGES'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
						AND ISNULL(ACCP_VALUE ,'')<>'' AND CLIC_FLG='M'



						

						INSERT INTO #MAIN_BILL
						SELECT 
						
						@PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
						ISNULL(ACCP_VALUE ,'') CLTCODE , FINA_ACC_CODE=CLIC_DPAM_ID , 'D' DRCR
 ,ABS(SUM(CLIC_CHARGE_AMT))+ABS(SUM(CLIC_CHARGE_AMT*0.1500)) AMOUNT ,DPAM_SBA_NO
				 
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'STAMP DUTY CHARGES'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT
								AND ISNULL(ACCP_VALUE ,'')<>'' AND CLIC_FLG='M'

						GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 
				

IF EXISTS(SELECT ISNULL(DPAM_SBA_NO,'') FROM #MAIN_BILL)
BEGIN


INSERT INTO #MAIN_BILL
SELECT @PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
ISNULL(@BROKERGL_ACC_CD ,'') CLTCODE , FINA_ACC_CODE=@BROKERGL_ACC_CD ,
 'C' DRCR ,( SELECT SUM(AMOUNT) FROM #MAIN_BILL ) AMOUNT ,@BROKERGL_ACC_CD DPAM_SBA_NO 




END 

SELECT CONVERT(VARCHAR(11),@PA_BILLING_FROM_DT,103) FROMDT ,CONVERT(VARCHAR(11),@PA_BILLING_TO_DT,103) TODT ,
CLTCODE,FINA_ACC_CODE,DRCR,AMOUNT,DPAM_SBA_NO
FROM #MAIN_BILL --,[192.168.100.100].MSAJAG.DBO.VW_TO_GETACTIVECLT_CLASS
--WHERE CLTCODE=CL_CODE


END
IF @PA_LOGIN_NAME='EQCR'
						BEGIN

						SELECT 						
						@@L_TOTALAMT=ABS(SUM(CLIC_CHARGE_AMT))  +ABS(SUM(CLIC_CHARGE_AMT*0.1500))  
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'STAMP DUTY CHARGES'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT

AND ISNULL(ACCP_VALUE ,'')<>'' AND CLIC_FLG='M'



						

						INSERT INTO #MAIN_BILL
						SELECT 
						
						@PA_BILLING_FROM_DT FROMDT ,@PA_BILLING_TO_DT TODT ,
						ISNULL(ACCP_VALUE ,'') CLTCODE , FINA_ACC_CODE=CLIC_DPAM_ID , 'C' DRCR 
,ABS(SUM(CLIC_CHARGE_AMT)) +ABS(SUM(CLIC_CHARGE_AMT*0.1500)) AMOUNT ,DPAM_SBA_NO
		
						FROM   CLIENT_CHARGES_CDSL LEFT OUTER JOIN ACCOUNT_PROPERTIES ON ACCP_CLISBA_ID = CLIC_DPAM_ID AND ACCP_ACCPM_PROP_CD = 'BBO_CODE' 
						AND ACCP_DELETED_IND = 1 ,DP_ACCT_MSTR, DP_MSTR , CLIENT_DP_BRKG , BROKERAGE_MSTR

						WHERE CLIC_DPAM_ID = DPAM_ID 
						AND DPM_ID = DPAM_DPM_ID 
						AND BROM_ID = CLIDB_BROM_ID 
						AND CLIDB_DPAM_ID = DPAM_ID 
						AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT
						AND ISNULL(CLIDB_EFF_TO_DT,'DEC 31 2100')
						AND CLIC_CHARGE_NAME IN (
						'STAMP DUTY CHARGES'
						)
						AND  CLIC_TRANS_DT BETWEEN @PA_BILLING_FROM_DT AND @PA_BILLING_TO_DT

AND ISNULL(ACCP_VALUE ,'')<>'' AND CLIC_FLG='M'

						GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 
						--GROUP BY CLIC_DPAM_ID , DPM_DPID,DPAM_SBA_NO,BROM_DESC,ISNULL(ACCP_VALUE ,'')  ORDER BY 1,2 


 
SELECT CONVERT(VARCHAR(11),@PA_BILLING_FROM_DT,103) FROMDT ,CONVERT(VARCHAR(11),@PA_BILLING_TO_DT,103) TODT ,
CLTCODE,FINA_ACC_CODE,DRCR,AMOUNT,DPAM_SBA_NO
 FROM #MAIN_BILL 
--,[192.168.100.100].MSAJAG.DBO.VW_TO_GETACTIVECLT_CLASS
--WHERE CLTCODE=CL_CODE

END
	



--  
END

GO
