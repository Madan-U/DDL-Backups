-- Object: PROCEDURE dbo.USP_GET_ALL_CLIENT_DP_REPORT_IPARTNER_NXT
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------

/*
USP_GET_ALL_CLIENT_DP_REPORT_IPARTNER_NXT
*/
CREATE PROCEDURE [dbo].[USP_GET_ALL_CLIENT_DP_REPORT_IPARTNER_NXT]
(
	@SUB_BROKER VARCHAR(100)='ET',
	@Party_code VARCHAR(50) = NULL
)
AS --USP_GET_ALL_CLIENT_DP_REPORT_IPARTNER 'JJRU'
BEGIN

SELECT CL_CODE INTO #CLT FROM INTRANET.RISK.DBO.CLIENT_DETAILS 
WHERE SUB_BROKER = @SUB_BROKER AND PARTY_CODE = @PARTY_CODE

CREATE INDEX #IX_CL ON #CLT(CL_CODE)





/**** LEDGER BALANCE ****/
SELECT PARTY_CODE,CLIENT_CODE    
,SUM(CURR_BAL) ACTUAL_AMOUNT  
, SUM(BROK_BAL) ACCRUAL_BAL,'0' AS BRANCH_CODE  INTO #LEDBALANCE  
FROM (
SELECT DPAM_BBO_CODE AS PARTY_CODE, DPAM_SBA_NO CLIENT_CODE, SUM(CLIC_CHARGE_AMT)*-1 BROK_BAL, '0' CURR_BAL  FROM     
  CITRUS_USR.DP_ACCT_MSTR , CITRUS_USR.CLIENT_CHARGES_CDSL ,#CLT C WHERE 
  CL_CODE =DPAM_BBO_CODE AND
  CLIC_DPAM_ID = DPAM_ID AND CLIC_TRANS_DT BETWEEN CITRUS_USR.UFN_GETFIRSTDAYOFMONTH(GETDATE())    
  AND DBO.UFN_GETLASTDAYOFMONTH(GETDATE()) GROUP BY DPAM_SBA_NO,DPAM_BBO_CODE     
  UNION ALL
  SELECT DPAM_BBO_CODE AS PARTY_CODE, DPAM_SBA_NO CLIENT_CODE, SUM(CLIC_CHARGE_AMT)*-1 BROK_BAL, '0' CURR_BAL  FROM     
  CITRUS_USR.DP_ACCT_MSTR , CITRUS_USR.CLIENT_CHARGES_CDSL,#CLT C WHERE CL_CODE =DPAM_BBO_CODE AND CLIC_DPAM_ID = DPAM_ID 
  AND CLIC_TRANS_DT BETWEEN CITRUS_USR.UFN_GETFIRSTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE()))    
  AND DBO.UFN_GETLASTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE())) 
  AND NOT EXISTS (SELECT LDG_ACCOUNT_ID FROM CITRUS_USR.LEDGER5 WHERE LDG_ACCOUNT_ID=DPAM_ID AND LDG_DELETED_IND=1 AND LDG_VOUCHER_TYPE='5'
  AND LDG_VOUCHER_DT=DBO.UFN_GETLASTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE())))
  GROUP BY DPAM_SBA_NO,DPAM_BBO_CODE 
  UNION ALL    
  SELECT DPAM_BBO_CODE AS PARTY_CODE,DPAM_SBA_NO CLIENT_CODE,0 BROK_BAL  , SUM(LDG_AMOUNT)*-1 CURR_BAL     
  FROM CITRUS_USR.LEDGER5 , CITRUS_USR.DP_ACCT_MSTR ,#CLT C WHERE CL_CODE =DPAM_BBO_CODE AND LDG_ACCOUNT_ID = DPAM_ID AND LDG_ACCOUNT_TYPE ='P' AND LDG_DELETED_IND = 1 
  AND DPAM_DELETED_IND = 1 
  GROUP BY DPAM_SBA_NO,DPAM_BBO_CODE )   BALANCE   
GROUP BY PARTY_CODE,CLIENT_CODE   



/*** END******/


SELECT DISTINCT 
	 CLIENT_ID
	,FIRST_HOLD_NAME
	,DPID
	,ISNULL(POA_VER,0) AS POA_VER
	,CONVERT(VARCHAR(15),ACTIVE_DATE,103) AS ACTIVE_DATE
	,T1.BROM_DESC AMC_SCHEME
    ,ISNULL(DP_LEDGER,0) AS DP_LEDGER
	,ISNULL(ACCRUAL_CHARGES,0) AS ACCRUAL_CHARGES
	,ACCOUNT_STATUS
	,CLIENT_SUB_TYPE
	,DATE_OF_BIRTH AS DATE_OF_BIRTH
	,NOMINEE 
	,PercentShare
	,NomineeDOB
	--,T1.BROM_DESC SCHEME 
FROM #CLT C
	INNER JOIN (
			SELECT T.NISE_PARTY_CODE AS CLIENT_ID,FIRST_HOLD_NAME,T.CLIENT_CODE  AS DPID ,POA_VER,ACTIVE_DATE,BROM_DESC AMC_SCHEME,    
			DP_LEDGER =ACTUAL_AMOUNT, ACCRUAL_CHARGES=ACCRUAL_BAL , 
			ACCOUNT_STATUS=STATUS, CLIENT_SUB_TYPE=SUB_TYPE,    
			DATE_OF_BIRTH=BO_DOB,
			NOMINEE= ISNULL(LTRIM(RTRIM(NAME)),'')+' '+ISNULL(LTRIM(RTRIM(MIDDLENAME)),'') +' '+ISNULL(LTRIM(RTRIM(SEARCHNAME)),'')   
			,ISNULL(N.perc_OF_SHARES,0) PercentShare--,ISNULL(N.rel_WITH_BO,0)
			,ISNULL(N.DateOfBirth,'') NomineeDOB

			FROM TBL_CLIENT_MASTER T    
			LEFT OUTER JOIN    
			CITRUS_USR.VW_GET_NEXT_AMCDT A ON T.CLIENT_CODE=A.CLIENT_CODE    
			LEFT OUTER JOIN CITRUS_USR.NOMINEE N ON BOID=T.CLIENT_CODE      
			LEFT OUTER JOIN #LEDBALANCE  B ON B.CLIENT_CODE =T.CLIENT_CODE 
 ) A ON C.CL_CODE = A.CLIENT_ID
LEFT JOIN 
(
SELECT BROM_DESC,DPAM.DPAM_SBA_NO 
FROM [CITRUS_USR].DP_ACCT_MSTR DPAM
		LEFT OUTER JOIN 
        [CITRUS_USR].CLIENT_DP_BRKG     ON DPAM_ID = CLIDB_DPAM_ID AND CLIDB_DELETED_IND='1' AND GETDATE() BETWEEN CLIDB_EFF_FROM_DT AND CLIDB_EFF_TO_DT
        LEFT OUTER JOIN 
      	[CITRUS_USR].BROKERAGE_MSTR ON BROM_ID = CLIDB_BROM_ID  
        
		WHERE ISNUMERIC(DPAM.DPAM_SBA_NO)=1 
        --AND DPAM.DPAM_SBA_NO  BETWEEN '1203320054298611' AND '1203320054298611'
) T1 ON A.DPID =T1.DPAM_SBA_NO




	 
END

GO
