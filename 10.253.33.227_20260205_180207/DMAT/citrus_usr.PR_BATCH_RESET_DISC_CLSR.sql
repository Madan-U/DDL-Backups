-- Object: PROCEDURE citrus_usr.PR_BATCH_RESET_DISC_CLSR
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------




--begin tran
----[PR_BATCH_RESET] 3,'600033','cdsl','T','CDSL_BTCH_DMAT_CURNO','DMAT',''.
--	[PR_BATCH_RESET] 3,'600037','CDSL','T','CDSL_BTCH_DMAT_CURNO','DMAT',''	
--rollback
CREATE PROCEDURE [citrus_usr].[PR_BATCH_RESET_DISC_CLSR]  
(  
@PA_ID INTEGER,  
@PA_BATCHNO VARCHAR(20),  
@PA_BATCHTYPE  VARCHAR(16),  
@PA_TYPE CHAR(11),  
@PA_TRXTYPE VARCHAR(50),
@PA_TRXTYPECDSL VARCHAR(10),  
@PA_ERRMSG     VARCHAR(8000) OUTPUT    
)  
AS   
DECLARE @L_DPM_ID INTEGER,  
 @L_ERROR         BIGINT,  
 @T_ERRORSTR VARCHAR(8000) 

  
SET @L_ERROR=0  
SELECT @L_DPM_ID  =  DPM_ID FROM DP_MSTR WHERE DEFAULT_DP = @PA_ID  AND DPM_DELETED_IND = 1  

BEGIN   
BEGIN TRANSACTION  
  
IF @PA_BATCHTYPE='NSDL'  
BEGIN--1  
		IF @PA_TYPE = 'C'  
		BEGIN--2
				IF EXISTS(SELECT dpam_id FROM dp_acct_mstr WHERE dpam_batch_no = @PA_BATCHNO AND dpam_dpm_id = @L_DPM_ID AND dpam_sba_no = dpam_acct_no AND dpam_deleted_ind = 1 )  
				BEGIN--3
					UPDATE DP_ACCT_MSTR SET DPAM_BATCH_NO=NULL WHERE DPAM_BATCH_NO =  @PA_BATCHNO AND DPAM_DPM_ID=@L_DPM_ID AND DPAM_DELETED_IND=1 AND DPAM_BATCH_NO <> 1 AND dpam_sba_no = dpam_acct_no  	  
					--DELETE FROM BATCHNO_NSDL_MSTR WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='C'                      			                 
                    UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='C' 
				END--3  
				ELSE   
				BEGIN--4  
					SELECT @T_ERRORSTR = 'CAN NOT PROCESS, CLIENT WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED'  
				END--4 
		END--2   
 
    
		IF @PA_TYPE = 'T'  
			BEGIN
				IF @PA_TRXTYPECDSL='DMAT'
				BEGIN
					IF NOT EXISTS(SELECT DEMRM_ID FROM DEMAT_REQUEST_MSTR WHERE DEMRM_batch_no = @PA_BATCHNO  AND  isnull(DEMRM_status, '') <> 'P' and isnull(DEMRM_TRANSACTION_NO,0)<>0 AND DEMRM_deleted_ind = 1)  
						BEGIN
							UPDATE T1 SET T1.DEMRM_BATCH_NO=NULL,T1.DEMRM_status='P' FROM DEMAT_REQUEST_MSTR T1,DP_ACCT_MSTR T2 WHERE T1.DEMRM_BATCH_NO = @PA_BATCHNO AND  T1.DEMRM_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.DEMRM_DELETED_IND=1 AND DPAM_DELETED_IND=1    
							UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T' AND BATCHN_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHN_DELETED_IND=1
						END 
					ELSE
						BEGIN
print 'lk'
							SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
						END 
				END


				ELSE IF @PA_TRXTYPECDSL='RMAT'
				BEGIN
					IF NOT EXISTS(SELECT REMRM_ID FROM REMAT_REQUEST_MSTR WHERE REMRM_batch_no = @PA_BATCHNO  AND  isnull(REMRM_status, '') <> 'P' AND REMRM_deleted_ind = 1)  
						BEGIN
							UPDATE T1 SET T1.REMRM_BATCH_NO=NULL,T1.REMRM_status='P' FROM REMAT_REQUEST_MSTR T1,DP_ACCT_MSTR T2 WHERE T1.REMRM_BATCH_NO = @PA_BATCHNO AND  T1.REMRM_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.REMRM_DELETED_IND=1 AND DPAM_DELETED_IND=1    
							UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T' AND BATCHN_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHN_DELETED_IND=1
						END 
					ELSE
						BEGIN
							SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
						END 
				END

				ELSE IF @PA_TRXTYPECDSL='PLEDGE'
				BEGIN
					IF NOT EXISTS(SELECT PLDT_ID FROM nsdl_pledge_dtls WHERE PLDT_batch_no = @PA_BATCHNO  AND  isnull(PLDT_status, '') <> 'P' AND PLDT_deleted_ind = 1)  
						BEGIN
							UPDATE T1 SET T1.PLDT_BATCH_NO=NULL,T1.PLDT_status='P' FROM nsdl_pledge_dtls T1,DP_ACCT_MSTR T2 WHERE T1.PLDT_BATCH_NO = @PA_BATCHNO AND  T1.PLDT_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND T1.PLDT_DELETED_IND=1 AND DPAM_DELETED_IND=1    
							UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T' AND BATCHN_TRANS_TYPE = @PA_TRXTYPECDSL  AND BATCHN_DELETED_IND=1
						END 
					ELSE
						BEGIN
							SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
						END 
				END

				ELSE
				BEGIN
					IF NOT EXISTS(SELECT dptd_id FROM dp_trx_dtls WHERE dptd_batch_no = @PA_BATCHNO AND dptd_status <> 'P' AND dptd_deleted_ind = 1)  
						BEGIN    
							UPDATE T1 SET T1.DPTD_BATCH_NO=NULL,dptd_status='P' FROM DP_TRX_DTLS T1,DP_ACCT_MSTR T2 WHERE DPTD_BATCH_NO = @PA_BATCHNO AND  T1.DPTD_DPAM_ID=T2.DPAM_ID AND DPAM_DPM_ID=@L_DPM_ID AND DPTD_DELETED_IND=1 AND DPAM_DELETED_IND=1  
							UPDATE BATCHNO_NSDL_MSTR SET BATCHN_DELETED_IND=9,BATCHN_STATUS='C' WHERE BATCHN_NO = @PA_BATCHNO  AND BATCHN_DPM_ID = @L_DPM_ID AND BATCHN_TYPE='T'  AND BATCHN_DELETED_IND=1
						END 
					ELSE   
						BEGIN
							SELECT @T_ERRORSTR = 'CAN NOT PROCESS, TRANSACTION WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
						END
				END
			END
  
END--1  

ELSE IF @PA_BATCHTYPE='CDSL'  
BEGIN    
IF @PA_TYPE = 'DIS'
begin   

    IF  EXISTS( select isnull(slibd_batch_no,'0') from sliim_batch_dtls,slip_issue_mstr where slibd_batch_no = @PA_BATCHNO  and SLIIM_ID=slibd_sliim_id and sliim_dpm_id=@L_DPM_ID and sliim_deleted_ind=1 and slibd_dis_type='I' )  
    BEGIN  
    update s set slibd_deleted_ind=9  from sliim_batch_dtls s,slip_issue_mstr where  slibd_batch_no = @PA_BATCHNO  and SLIIM_ID=slibd_sliim_id and sliim_dpm_id=@L_DPM_ID and sliim_deleted_ind=1 and slibd_dis_type='I'
    
    --UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND=9,BATCHC_STATUS='C' WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='C'
    END  
    ELSE   
    BEGIN           
     SELECT @T_ERRORSTR = 'CAN NOT PROCESS, CLIENT WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
    END       
end

IF @PA_TYPE = 'DIC'
begin   
    IF  EXISTS(select isnull(slibd_batch_no,'0')  from sliim_batch_dtls,used_slip_block where  slibd_batch_no = @PA_BATCHNO  and uses_id=slibd_sliim_id and uses_dpm_id=@L_DPM_ID and uses_deleted_ind=1 and slibd_dis_type='C' )  
    BEGIN    
    
    update S set slibd_deleted_ind=9 from sliim_batch_dtls S ,used_slip_block U where  slibd_batch_no = @PA_BATCHNO  and uses_id=slibd_sliim_id and uses_dpm_id=@L_DPM_ID and uses_deleted_ind=1 and slibd_dis_type='C'
    
    --UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND=9,BATCHC_STATUS='C' WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='C'
    END 
    ELSE   
    BEGIN  
     SELECT @T_ERRORSTR = 'CAN NOT PROCESS, CLIENT WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
    END   
end

IF @PA_TYPE = 'AC'
begin   
    IF  EXISTS(SELECT CLSR_BATCH_NO  FROM CLOSURE_ACCT_CDSL where CLSR_BATCH_NO=@PA_BATCHNO and CLSR_DELETED_IND=1 and CLSR_DPM_ID=@L_DPM_ID)  
    BEGIN 
    update t set CLSR_BATCH_NO=null  FROM CLOSURE_ACCT_CDSL t where CLSR_BATCH_NO=@PA_BATCHNO and CLSR_DELETED_IND=1 and CLSR_DPM_ID=@L_DPM_ID
    
    UPDATE BATCHNO_CDSL_MSTR SET BATCHC_DELETED_IND=9,BATCHC_STATUS='C' WHERE BATCHC_NO = @PA_BATCHNO  AND BATCHC_DPM_ID = @L_DPM_ID AND BATCHC_TYPE='AC'
    END 
    ELSE   
    BEGIN           
     SELECT @T_ERRORSTR = 'CAN NOT PROCESS, CLIENT WITH BATCH NO' + ' ' + @PA_BATCHNO  + ' ' + 'IS ACTIVATED '  
    END    
end

end  
  
SET @L_ERROR = @@ERROR  
IF @L_ERROR <> 0   
BEGIN  
  IF EXISTS(SELECT ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = @L_ERROR)  
  BEGIN  
  --  
    SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': '+ ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = CONVERT(VARCHAR,@L_ERROR)  
  --  
  END  
  ELSE  
  BEGIN  
  --  
    SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': CAN NOT PROCESS, PLEASE CONTACT YOUR ADMINISTRATOR!'  
  --  
        END  
  
  ROLLBACK TRANSACTION   
END  
ELSE  
BEGIN   
  COMMIT TRANSACTION  
  IF ISNULL(@T_ERRORSTR,'') = ''  
  SELECT @T_ERRORSTR = 'PROCESS DONE SUCCESSFULLY'  
END  
SET @PA_ERRMSG = @T_ERRORSTR  
  
END

GO
