-- Object: PROCEDURE citrus_usr.pr_dump_client_2203
-- Server: 10.253.33.227 | DB: DMAT
--------------------------------------------------


CREATE PROC [citrus_usr].[pr_dump_client](@PA_ID VARCHAR(1))        
AS        
    
DECLARE @HOLDDATE VARCHAR(11)    
SET @HOLDDATE= ( SELECT TOP 1 HLD_HOLD_DATE FROM HOLDINGDATA WITH(NOLOCK))    
 /*   
BEGIN         
TRUNCATE TABLE TBL_CLIENT_MASTER_TMP
     
INSERT INTO  TBL_CLIENT_MASTER_TMP        
SELECT  * FROM  TBL_CLIENT_MASTER_FORDUMP  

      
IF (SELECT COUNT(*) FROM TBL_CLIENT_MASTER_TMP )>1
	BEGIN 
  
    BEGIN TRAN 
		TRUNCATE TABLE TBL_CLIENT_MASTER    
    
		INSERT INTO  TBL_CLIENT_MASTER        
		SELECT  * FROM  TBL_CLIENT_MASTER_TMP     
      
		     
		UPDATE T SET POA_VER = '2' FROM TBL_CLIENT_MASTER T, TBL_CLIENT_POA P    
		WHERE T.CLIENT_CODE=P.CLIENT_CODE AND HOLDER_INDI =1    
		AND ISNULL(POA_VER,'')= '' AND POA_STATUS ='A'  AND STATUS ='ACTIVE'    
		AND MASTER_POA ='2203320000000014'  AND POA_DATE_FROM >='2010-01-01'   
		  
		  
		    
		UPDATE T SET POA_VER ='' FROM TBL_CLIENT_MASTER T, TBL_CLIENT_POA P    
		WHERE T.CLIENT_CODE=P.CLIENT_CODE AND HOLDER_INDI =1    
		AND POA_VER='2' AND POA_STATUS ='D'  AND STATUS ='ACTIVE'    
		AND MASTER_POA ='2203320000000014'     
		    
		    
		UPDATE T SET POA_VER = '2' FROM TBL_CLIENT_MASTER T, TBL_CLIENT_POA P    
		WHERE T.CLIENT_CODE=P.CLIENT_CODE AND HOLDER_INDI =1    
		AND POA_VER= '' AND POA_STATUS ='A'  AND STATUS ='ACTIVE'    
		AND MASTER_POA ='2203320000000014'

		SELECT BOID,PRIPHNUM,PRI_EMAIL  INTO #TEST                                                                           
		FROM DPS8_PC1  WHERE PRI_EMAIL <>'' OR SMART_FLAG ='Y'

 
		UPDATE T SET FIRST_HOLD_MOBILE=RIGHT(PRIPHNUM,10),EMAIL_ADD =PRI_EMAIL  FROM TBL_CLIENT_MASTER  T,#TEST S
		WHERE T.CLIENT_CODE =S.BOID
		AND (  ISNULL(FIRST_HOLD_MOBILE,'')<>PRIPHNUM OR EMAIL_ADD<>PRI_EMAIL)
 



		
	COMMIT	
		    
 
     
   END  */



 BEGIN         
TRUNCATE TABLE TBL_CLIENT_MASTER_TMP
     
INSERT INTO  TBL_CLIENT_MASTER_TMP        
SELECT  DISTINCT T.* FROM  TBL_CLIENT_MASTER_FORDUMP T , CLIENT_INCR C WHERE T.CLIENT_CODE =C.BOID 

      
IF (SELECT COUNT(*) FROM TBL_CLIENT_MASTER_TMP )>1
	BEGIN 
  
    BEGIN TRAN 
	   
	    DELETE T FROM     TBL_CLIENT_MASTER T , CLIENT_INCR C WHERE T.CLIENT_CODE =C.BOID 
    
		INSERT INTO  TBL_CLIENT_MASTER        
		SELECT DISTINCT * FROM  TBL_CLIENT_MASTER_TMP  
      
		     
		UPDATE T SET POA_VER = '2' FROM TBL_CLIENT_MASTER T, TBL_CLIENT_POA P    
		WHERE T.CLIENT_CODE=P.CLIENT_CODE AND HOLDER_INDI =1    
		AND ISNULL(POA_VER,'')= '' AND POA_STATUS ='A'  AND STATUS ='ACTIVE'    
		AND MASTER_POA ='2203320000000014'  AND POA_DATE_FROM >='2010-01-01'   
		  
		  
		    
		UPDATE T SET POA_VER ='' FROM TBL_CLIENT_MASTER T, TBL_CLIENT_POA P    
		WHERE T.CLIENT_CODE=P.CLIENT_CODE AND HOLDER_INDI =1    
		AND POA_VER='2' AND POA_STATUS ='D'  AND STATUS ='ACTIVE'    
		AND MASTER_POA ='2203320000000014'     
		    
		    
		UPDATE T SET POA_VER = '2' FROM TBL_CLIENT_MASTER T, TBL_CLIENT_POA P    
		WHERE T.CLIENT_CODE=P.CLIENT_CODE AND HOLDER_INDI =1    
		AND POA_VER= '' AND POA_STATUS ='A'  AND STATUS ='ACTIVE'    
		AND MASTER_POA ='2203320000000014'

		SELECT BOID,PRIPHNUM,PRI_EMAIL  INTO #TEST                                                                           
		FROM DPS8_PC1  WHERE PRI_EMAIL <>'' OR SMART_FLAG ='Y'

 
		UPDATE T SET FIRST_HOLD_MOBILE=RIGHT(PRIPHNUM,10),EMAIL_ADD =PRI_EMAIL  FROM TBL_CLIENT_MASTER  T,#TEST S
		WHERE T.CLIENT_CODE =S.BOID
		AND (  ISNULL(FIRST_HOLD_MOBILE,'')<>PRIPHNUM OR EMAIL_ADD<>PRI_EMAIL)

		SELECT CONVERT(VARCHAR(16),DPAM.DPAM_SBA_NO ) CLIENT_CODE  ,CONVERT(VARCHAR(21),BROM_DESC) TABLE_NAME INTO #TEMP 
		FROM DP_ACCT_MSTR DPAM WITH(NOLOCK)  
		LEFT OUTER JOIN CLIENT_DP_BRKG   WITH(NOLOCK) ON DPAM_ID = CLIDB_DPAM_ID AND GETDATE() BETWEEN CLIDB_EFF_FROM_DT  
		AND  ISNULL(CLIDB_EFF_TO_DT ,'DEC 31 2100')  AND CLIDB_DELETED_IND = 1  
		LEFT OUTER JOIN BROKERAGE_MSTR WITH(NOLOCK) ON BROM_ID = CLIDB_BROM_ID   

		SELECT T.* INTO #T FROM #TEMP T,TBL_CLIENT_MASTER W
		WHERE T.CLIENT_CODE =W.CLIENT_CODE 
		AND T.TABLE_NAME <> W.TEMPLATE_CODE 

		UPDATE W SET  TEMPLATE_CODE =T.TABLE_NAME
		 FROM #T T,TBL_CLIENT_MASTER W
		WHERE T.CLIENT_CODE =W.CLIENT_CODE 
		AND T.TABLE_NAME <> W.TEMPLATE_CODE 

  
		
	COMMIT	
         
   END
	    
	SELECT *  INTO #SYNERGY_CLIENT_MASTER FROM SYNERGY_CLIENT_MASTER WITH(NOLOCK) WHERE 1=2    
	    
	INSERT INTO #SYNERGY_CLIENT_MASTER        
	SELECT DISTINCT S.* FROM  SYNERGY_CLIENT_MASTER_FORDUMP  S   , CLIENT_INCR C WHERE S.CM_CD =C.BOID     
	    
	    
	---TRUNCATE TABLE SYNERGY_CLIENT_MASTER    

	 DELETE FROM SYNERGY_CLIENT_MASTER WHERE CM_CD IN (SELECT DISTINCT BOID FROM CLIENT_INCR)

	INSERT INTO SYNERGY_CLIENT_MASTER        
	SELECT * FROM  #SYNERGY_CLIENT_MASTER        

	UPDATE T SET CM_MOBILE=RIGHT(PriPhNum,10),CM_EMAIL =pri_email  FROM Synergy_Client_Master  T,#TEST S
	WHERE T.CM_CD =S.BOId
	AND (  ISNULL(CM_MOBILE,'')<>PriPhNum OR CM_EMAIL<>pri_email)


	    
	DELETE FROM DBO.SYNERGY_HOLDING WHERE HLD_HOLD_DATE = @HOLDDATE    
	    
	INSERT INTO DBO.SYNERGY_HOLDING      
	SELECT * FROM HOLDINGDATA    

	TRUNCATE TABLE CLIENT_INCR
    
END

GO
