-- Object: PROCEDURE citrus_usr.pr_ins_upd_ledger_DN
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

--pr_ins_upd_ledgerR '0','INS','HO','2','2','01','0','1','09/07/2008','B|*~|1|*~|100|*~|*|~*P|*~|8180|*~|0|*~||*~|100|*~||*~|ss|*~|01190029547         |*~|*|~*',1,'*|~*','|*~|',''	
--begin tran
--[pr_ins_upd_ledger_JV]	'0','EDT','HO','2','3','01','45','3456','05/08/2008','E|*~|P|*~|101|*~||*~||*~||*~|23|*~|JGJGJGJGJ|*~|466|*~|*|~*E|*~|P|*~|101|*~||*~||*~||*~|56|*~|FHFH|*~|467|*~|*|~*E|*~|P|*~|101|*~||*~||*~||*~|45|*~|HJHJHJ|*~|468|*~|*|~*E|*~|P|*~|109|*~||*~||*~||*~|98|*~|FHF|*~|469|*~|*|~*E|*~|P|*~|139|*~||*~||*~||*~|57|*~|JGJ|*~|470|*~|*|~*E|*~|P|*~|128|*~||*~||*~||*~|200.31|*~|JUJ|*~|471|*~|*|~*E|*~|P|*~|105|*~||*~||*~||*~|45.79|*~|HJ|*~|472|*~|*|~*E|*~|P|*~|61161|*~||*~||*~||*~|78.52|*~|WRT|*~|473|*~|*|~*E|*~|P|*~|159|*~||*~||*~||*~|334|*~|GHHJ|*~|474|*~|*|~*E|*~|P|*~|105|*~||*~||*~||*~|23.9|*~|JGJGJ|*~|475|*~|*|~*E|*~|P|*~|105|*~||*~||*~||*~|456|*~|JJJJ|*~|476|*~|*|~*E|*~|P|*~|139|*~||*~||*~|23.0000|*~||*~|SYIY|*~|477|*~|*|~*E|*~|P|*~|148|*~||*~||*~|56.0000|*~||*~|JLJKHKHKKHG|*~|478|*~|*|~*E|*~|P|*~|880|*~||*~||*~|45.0000|*~||*~|SRSFS|*~|479|*~|*|~*E|*~|P|*~|3191|*~||*~||*~|98.0000|*~||*~|FSDFDS|*~|480|*~|*|~*E|*~|P|*~|123|*~||*~||*~|57.0000|*~||*~|DDSFDS|*~|481|*~|*|~*E|*~|P|*~|108|*~||*~||*~|200.3100|*~||*~|SASA|*~|482|*~|*|~*A|*~|P|*~|110|*~||*~||*~|45.79|*~||*~|SASA|*~|*|~*A|*~|P|*~|101|*~||*~||*~|78.52|*~||*~|DFDSADSA|*~|*|~*A|*~|P|*~|107|*~||*~||*~|334|*~||*~|EDSFSDF|*~|*|~*A|*~|P|*~|109|*~||*~||*~|23.9|*~||*~|DASDSA|*~|*|~*A|*~|P|*~|850|*~||*~||*~|456|*~||*~|ASDDSAD|*~|*|~*',0,'*|~*','|*~|',''	
--rollback 
--	0	EDT	HO	2	3	01	45	3456	05/08/2008	E|*~|P|*~|101|*~||*~||*~||*~|23|*~|JGJGJGJGJ|*~|466|*~|*|~*E|*~|P|*~|101|*~||*~||*~||*~|56|*~|FHFH|*~|467|*~|*|~*E|*~|P|*~|101|*~||*~||*~||*~|45|*~|HJHJHJ|*~|468|*~|*|~*E|*~|P|*~|109|*~||*~||*~||*~|98|*~|FHF|*~|469|*~|*|~*E|*~|P|*~|139|*~||*~||*~||*~|57|*~|JGJ|*~|470|*~|*|~*E|*~|P|*~|128|*~||*~||*~||*~|200.31|*~|JUJ|*~|471|*~|*|~*E|*~|P|*~|105|*~||*~||*~||*~|45.79|*~|HJ|*~|472|*~|*|~*E|*~|P|*~|61161|*~||*~||*~||*~|78.52|*~|WRT|*~|473|*~|*|~*E|*~|P|*~|159|*~||*~||*~||*~|334|*~|GHHJ|*~|474|*~|*|~*E|*~|P|*~|105|*~||*~||*~||*~|23.9|*~|JGJGJ|*~|475|*~|*|~*E|*~|P|*~|105|*~||*~||*~||*~|456|*~|JJJJ|*~|476|*~|*|~*E|*~|P|*~|139|*~||*~||*~|23.0000|*~||*~|SYIY|*~|477|*~|*|~*E|*~|P|*~|148|*~||*~||*~|56.0000|*~||*~|JLJKHKHKKHG|*~|478|*~|*|~*E|*~|P|*~|880|*~||*~||*~|45.0000|*~||*~|SRSFS|*~|479|*~|*|~*E|*~|P|*~|3191|*~||*~||*~|98.0000|*~||*~|FSDFDS|*~|480|*~|*|~*E|*~|P|*~|123|*~||*~||*~|57.0000|*~||*~|DDSFDS|*~|481|*~|*|~*E|*~|P|*~|108|*~||*~||*~|200.3100|*~||*~|SASA|*~|482|*~|*|~*A|*~|P|*~|110|*~||*~||*~|45.79|*~||*~|SASA|*~|*|~*A|*~|P|*~|101|*~||*~||*~|78.52|*~||*~|DFDSADSA|*~|*|~*A|*~|P|*~|107|*~||*~||*~|334|*~||*~|EDSFSDF|*~|*|~*A|*~|P|*~|109|*~||*~||*~|23.9|*~||*~|DASDSA|*~|*|~*A|*~|P|*~|850|*~||*~||*~|456|*~||*~|ASDDSAD|*~|*|~*	0	*|~*	|*~|	
CREATE PROCEDURE [citrus_usr].[pr_ins_upd_ledger_DN](@pa_id  VARCHAR(8000)      
                                  ,@pa_action          VARCHAR(20)      
                                  ,@pa_login_name      VARCHAR(20)      
                                  ,@pa_dpm_id          VARCHAR(50)    
                                  ,@pa_voucher_type    varchar(2)    
                                  ,@pa_book_type_cd    VARCHAR(4)    
                                  ,@pa_voucher_no      varchar(10)    
                                  ,@pa_ref_no          VARCHAR(25)      
                                  ,@pa_voucher_dt      VARCHAR(11)    
                                  ,@pa_values          VARCHAR(8000)     
                                  ,@pa_chk_yn          INT      
                                  ,@rowdelimiter       CHAR(4)       = '*|~*'      
                                  ,@coldelimiter       CHAR(4)       = '|*~|'      
                                  ,@pa_errmsg          VARCHAR(8000) output      
 )      
AS    
BEGIN
DECLARE @@l_acct_type    CHAR(1)    
      , @@l_amount       numeric(18,2)    
      , @@l_account_id   varchar(30) 
      , @@l_branch_id    INT    
      , @@l_cheque       VARCHAR(15)     
      , @@l_narration    VARCHAR(50)    
      , @@l_led_id         NUMERIC(10,0)    
      , @@l_cost_cntr    INT     
      , @@l_accbal_id      NUMERIC(10,0)    
      , @@l_acct_no      VARCHAR(25)
	  , @@fin_id		 varchar(10)
	  , @@currstring_value VARCHAR(8000)
	  , @@ledgertable varchar(20)
	  , @@SSQL VARCHAR(8000)
	  , @@CTR INT
      , @@TOTALRECORDS INT
	  , @@delind CHAR(1)
	  , @@srno INT
	  SET @@CTR = 1

	IF @PA_ACTION = 'APP' OR  @PA_ACTION = 'EDT'
	BEGIN
	 Create table #tmpvch(Acct_id bigint,dpm_id int,Vch_dt datetime,Vch_no bigint,Amt NUMERIC(18,2),clrg_dt datetime)
	END

	IF @PA_ACTION = 'APP'  
	BEGIN
			  SET @@TOTALRECORDS = citrus_usr.ufn_countstring(@pa_id,@rowdelimiter)
			  WHILE @@CTR <= @@TOTALRECORDS
			  BEGIN
  					  SET @@currstring_value = citrus_usr.FN_SPLITVALWITHDELIMETER(@rowdelimiter,@pa_id,@@CTR) 
			  
					  set @pa_voucher_no   = citrus_usr.fn_splitval(@@currstring_value,1)    
					  set @pa_voucher_dt   = citrus_usr.fn_splitval(@@currstring_value,2)    
					  set @pa_voucher_type = citrus_usr.fn_splitval(@@currstring_value,3)    
					  set @pa_dpm_id       = citrus_usr.fn_splitval(@@currstring_value,4)    
					  set @pa_book_type_cd = citrus_usr.fn_splitval(@@currstring_value,5) 

					  IF @@CTR = 1
					  BEGIN
							SELECT @@fin_id = FIN_ID FROM FINANCIAL_YR_MSTR WHERE FIN_DPM_ID = @pa_dpm_id AND (CONVERT(DATETIME,@pa_voucher_dt,103) BETWEEN FIN_START_DT AND FIN_END_DT)AND FIN_DELETED_IND =1  
					  END

				
					  SET @@SSQL= 'Insert into #tmpvch(Acct_id,dpm_id,Vch_dt,Vch_no,Amt,clrg_dt)
									 select ldg_account_id,ldg_dpm_id,ldg_voucher_dt,ldg_voucher_no,ldg_amount,ldg_bank_cl_date
									 from ledger' + @@fin_id + ' where ldg_voucher_dt   = convert(datetime,''' + @pa_voucher_dt + ''',103)
									 and ldg_voucher_type = ' + @pa_voucher_type + ' and ldg_voucher_no   = ' + @pa_voucher_no + ' and ldg_dpm_id = ' + @pa_dpm_id 
					  EXEC(@@SSQL)
					  IF @@rowcount > 0
					  BEGIN    
							SET @@SSQL=   'Update ledger' + @@fin_id + '  
										  Set ldg_deleted_ind = 0  
										  WHERE ldg_voucher_no   = ' + @pa_voucher_no + '
										  AND   ldg_voucher_dt   = convert(datetime,''' + @pa_voucher_dt + ''',103)  
										  AND   ldg_dpm_id       = ' + @pa_dpm_id + '
										  AND   ldg_voucher_type = ' + @pa_voucher_type + '
										  AND   ldg_book_type_cd = ''' + @pa_book_type_cd + ''''
							EXEC(@@SSQL)


							SET @@SSQL = 'Update acbal 
										  SET accbal_amount = accbal_amount - Amt
										  FROM #tmpvch,ACCOUNTBAL' + @@fin_id + ' acbal
										  WHERE Acct_id = ACCBAL_ACCT_ID AND dpm_id = accbal_dpm_id'
							EXEC(@@SSQL)

 							truncate table #tmpvch
							drop table #tmpvch
					  END


						SET @@SSQL= 'Insert into ledger' + @@fin_id + ' (LDG_ID,LDG_DPM_ID,LDG_VOUCHER_TYPE,LDG_BOOK_TYPE_CD,LDG_VOUCHER_NO,LDG_SR_NO,LDG_REF_NO,LDG_VOUCHER_DT,LDG_ACCOUNT_ID,LDG_ACCOUNT_TYPE,LDG_AMOUNT,LDG_NARRATION,LDG_BANK_ID,LDG_ACCOUNT_NO,LDG_INSTRUMENT_NO,LDG_BANK_CL_DATE,LDG_COST_CD_ID,LDG_BILL_BRKUP_ID,LDG_TRANS_TYPE,LDG_STATUS,LDG_CREATED_BY,LDG_CREATED_DT,LDG_LST_UPD_BY,LDG_LST_UPD_DT,LDG_DELETED_IND,LDG_BRANCH_ID)
									 select LDG_ID,LDG_DPM_ID,LDG_VOUCHER_TYPE,LDG_BOOK_TYPE_CD,LDG_VOUCHER_NO,LDG_SR_NO,LDG_REF_NO,LDG_VOUCHER_DT,LDG_ACCOUNT_ID,LDG_ACCOUNT_TYPE,LDG_AMOUNT,LDG_NARRATION,LDG_BANK_ID,LDG_ACCOUNT_NO,LDG_INSTRUMENT_NO,LDG_BANK_CL_DATE,LDG_COST_CD_ID,LDG_BILL_BRKUP_ID,LDG_TRANS_TYPE,LDG_STATUS,LDG_CREATED_BY,LDG_CREATED_DT,LDG_LST_UPD_BY=''' + @pa_login_name + ''',LDG_LST_UPD_DT=getdate(),LDG_DELETED_IND=1,LDG_BRANCH_ID
									 from ledger' + @@fin_id + '_mak where ldg_voucher_dt   = convert(datetime,''' + @pa_voucher_dt + ''',103)
									 and ldg_voucher_type = ' + @pa_voucher_type + ' and ldg_voucher_no   = ' + @pa_voucher_no + ' and ldg_dpm_id = ' + @pa_dpm_id + ' and ldg_deleted_ind in (0,6)'
						EXEC(@@SSQL)

						SET @@SSQL=   'Update ledger' + @@fin_id + '_mak  
									  Set ldg_deleted_ind = LDG_DELETED_IND+1  
									  WHERE ldg_voucher_no   = ' + @pa_voucher_no + '
									  AND   ldg_voucher_dt   = convert(datetime,''' + @pa_voucher_dt + ''',103)  
									  AND   ldg_dpm_id       = ' + @pa_dpm_id + '
									  AND   ldg_voucher_type = ' + @pa_voucher_type + '
									  AND   ldg_book_type_cd = ''' + @pa_book_type_cd + ''' 
									  AND ldg_deleted_ind in (0,4,6)'
						EXEC(@@SSQL)

						SET @@SSQL =  'Update accbal
									   Set accbal_amount = accbal_amount + LDG_AMOUNT
									   FROM ACCOUNTBAL' + @@fin_id + ' accbal,ledger' + @@fin_id + '
									   where accbal_acct_id = ldg_account_id and accbal_dpm_id = LDG_DPM_ID
									   and ldg_voucher_no   = ' + @pa_voucher_no + '
									   and ldg_voucher_type = ' + @pa_voucher_type + ' 
									   and ldg_book_type_cd = ''' + @pa_book_type_cd + '''
									   and ldg_deleted_ind=1
									   and exists(select accbal_acct_id from ACCOUNTBAL' + @@fin_id + ' where accbal_acct_id = LDG_ACCOUNT_ID and accbal_dpm_id = LDG_DPM_ID and accbal_deleted_ind = 1)'
						EXEC(@@SSQL)

						SET @@SSQL =  'INSERT INTO ACCOUNTBAL' + @@fin_id + '(accbal_dpm_id,accbal_acct_id,accbal_acct_type,accbal_amount,accbal_created_by,accbal_created_dt,accbal_lst_upd__by,accbal_lst_upd__dt,accbal_deleted_ind)
									   SELECT LDG_DPM_ID,LDG_ACCOUNT_ID,LDG_ACCOUNT_TYPE,LDG_AMOUNT,''' + @pa_login_name + ''',getdate(),''' + @pa_login_name + ''',getdate(),1
									   FROM ledger' + @@fin_id + ' WHERE ldg_voucher_dt = convert(datetime,''' + @pa_voucher_dt + ''',103)
									   and ldg_voucher_type = ' + @pa_voucher_type + ' and ldg_voucher_no = ' + @pa_voucher_no + ' and ldg_dpm_id = ' + @pa_dpm_id + ' and ldg_deleted_ind=1 
									   and not exists(select accbal_acct_id from ACCOUNTBAL' + @@fin_id + ' where accbal_acct_id = LDG_ACCOUNT_ID and accbal_dpm_id = LDG_DPM_ID and accbal_deleted_ind = 1)'
						EXEC(@@SSQL)

						SET @@CTR = @@CTR + 1
			END

				
			UPDATE FINANCIAL_YR_MSTR SET FIN_CF_BALANCES = 'Y' WHERE  FIN_ID = @@fin_id and FIN_DPM_ID = @pa_dpm_id and FIN_DELETED_IND =1  

	END
	IF @PA_ACTION = 'REJ'
	BEGIN
			  SET @@TOTALRECORDS = citrus_usr.ufn_countstring(@pa_id,@rowdelimiter)
			  WHILE @@CTR <= @@TOTALRECORDS
			  BEGIN
  					  SET @@currstring_value = citrus_usr.FN_SPLITVALWITHDELIMETER(@rowdelimiter,@pa_id,@@CTR) 
					  set @pa_voucher_no   = citrus_usr.fn_splitval(@@currstring_value,1)    
					  set @pa_voucher_dt   = citrus_usr.fn_splitval(@@currstring_value,2)    
					  set @pa_voucher_type = citrus_usr.fn_splitval(@@currstring_value,3)    
					  set @pa_dpm_id       = citrus_usr.fn_splitval(@@currstring_value,4)    
					  set @pa_book_type_cd = citrus_usr.fn_splitval(@@currstring_value,5)    
					  IF @@CTR = 1
					  BEGIN
							SELECT @@fin_id = FIN_ID FROM FINANCIAL_YR_MSTR WHERE FIN_DPM_ID = @pa_dpm_id AND (CONVERT(DATETIME,@pa_voucher_dt,103) BETWEEN FIN_START_DT AND FIN_END_DT)AND FIN_DELETED_IND =1  
					  END


					  Set @@ssql = 'update ledger' + @@fin_id + '_mak     
					  set    ldg_deleted_ind  = 3    
					  WHERE  ldg_voucher_no   = ' + @pa_voucher_no + '    
					  AND    ldg_voucher_dt   = convert(datetime,''' + @pa_voucher_dt + ''',103)   
					  AND    ldg_dpm_id       = ' + @pa_dpm_id + '   
					  AND    ldg_voucher_type = ' + @pa_voucher_type + '   
					  AND    ldg_book_type_cd = ''' + @pa_book_type_cd + '''
					  AND    ldg_deleted_ind in (0,4,6)'
					  exec(@@ssql)
					  SET @@CTR = @@CTR + 1
			  END
	END

	IF (@PA_ACTION = 'INS' OR @PA_ACTION = 'EDT' OR @PA_ACTION = 'DEL')
	BEGIN 
		SELECT @@fin_id = FIN_ID FROM FINANCIAL_YR_MSTR WHERE FIN_DPM_ID = @pa_dpm_id AND (CONVERT(DATETIME,@pa_voucher_dt,103) BETWEEN FIN_START_DT AND FIN_END_DT)AND FIN_DELETED_IND =1  

		IF @pa_chk_yn = 0 -- MASTER    
		BEGIN    

			SET @@ledgertable = 'Ledger' + @@fin_id
			SET @@delind = CASE WHEN @PA_ACTION = 'DEL'	THEN '0' ELSE '1' END 
		END
		ELSE
		BEGIN
			SET @@ledgertable = 'Ledger' + @@fin_id + '_mak'
			SET @@delind = CASE WHEN @PA_ACTION = 'DEL'	THEN 4 WHEN  @PA_ACTION = 'EDT' THEN 6 ELSE 0 END 
		END	
	END	 

	IF @PA_ACTION = 'INS'
	BEGIN
		  SET @@TOTALRECORDS = ISNULL(citrus_usr.ufn_countstring(@pa_values,@rowdelimiter),0)
		  BEGIN TRANSACTION
		  UPDATE FINANCIAL_YR_MSTR SET Ledger_currid = isnull(Ledger_currid,0) + @@TOTALRECORDS,VchNo_JV=ISNULL(VchNo_JV,0) + 1 WHERE fin_id = @@fin_id and fin_dpm_id = @pa_dpm_id and fin_deleted_ind =1
          SELECT @@l_led_id    = ISNULL(Ledger_currid,0) - @@TOTALRECORDS,@pa_voucher_no=VchNo_JV FROM FINANCIAL_YR_MSTR WHERE fin_id = @@fin_id and fin_dpm_id = @pa_dpm_id and fin_deleted_ind =1
		  COMMIT TRANSACTION


			  SET @@srno = 1
			  WHILE @@CTR <= @@TOTALRECORDS
			  BEGIN
						SET @@currstring_value = citrus_usr.FN_SPLITVALWITHDELIMETER(@rowdelimiter,@pa_values,@@CTR) 

						IF (LTRIM(RTRIM(citrus_usr.fn_splitval(@@currstring_value,1))) = 'A')
						BEGIN
								SET @@l_acct_type = citrus_usr.fn_splitval(@@currstring_value,2)                  
								SET @@l_account_id = citrus_usr.fn_splitval(@@currstring_value,3)   
								--SET @@l_branch_id = citrus_usr.fn_splitval(@currstring_value,4)       
								--SET @@l_cost_cntr = citrus_usr.fn_splitval(@currstring_value,5) 
								IF (LTRIM(RTRIM(citrus_usr.fn_splitval(@@currstring_value,6))) <> '')  
								BEGIN                 
									SET @@l_amount    = convert(numeric(18,2),citrus_usr.fn_splitval(@@currstring_value,6))
								END
								ELSE
								BEGIN
									SET @@l_amount    = convert(numeric(18,2),citrus_usr.fn_splitval(@@currstring_value,7)) * -1
								END
								SET @@l_narration = citrus_usr.fn_splitval(@@currstring_value,8)    

								SET @@SSQL = 'INSERT INTO ' + @@ledgertable + '(ldg_id,ldg_dpm_id,ldg_voucher_type,ldg_book_type_cd,ldg_voucher_no,ldg_sr_no,ldg_ref_no,ldg_voucher_dt,ldg_account_id,ldg_account_type,ldg_amount,ldg_narration,ldg_account_no,ldg_instrument_no,ldg_branch_id,ldg_cost_cd_id,ldg_bill_brkup_id,ldg_trans_type,ldg_status,ldg_created_by,ldg_created_dt,ldg_lst_upd_by,ldg_lst_upd_dt,ldg_deleted_ind)
								VALUES(' + convert(varchar,@@l_led_id) + ',' + @pa_dpm_id + ',' + @pa_voucher_type +',''' + @pa_book_type_cd + ''',' + @pa_voucher_no + ',' + convert(varchar,@@srno) + ',''' + @pa_ref_no + ''',convert(datetime,''' + @pa_voucher_dt+ ''',103) ,' + @@l_account_id  + ',''' + @@l_acct_type + ''',' + convert(varchar,@@l_amount) + ',''' + @@l_narration + ''',''' + isnull(@@l_acct_no,'') + ''','''',0,0,0 ,''N'',''P'' ,''' + @pa_login_name + ''',getdate(),''' + @pa_login_name+ ''',getdate() ,' + @@delind + ')'     
								EXEC(@@SSQL)
								SET @@l_led_id = @@l_led_id + 1


                                set @pa_errmsg = 'Generated Voucher No :  '+ @pa_voucher_no

								IF @pa_chk_yn = 0 -- MASTER ONLY   
								BEGIN    
										SET @@SSQL =   'IF EXISTS(SELECT accbal_acct_id FROM ACCOUNTBAL' + @@fin_id + ' WHERE accbal_dpm_id = ' + @pa_dpm_id + ' and accbal_acct_id = ' + @@l_account_id + ' and accbal_deleted_ind = 1)    
														BEGIN    
																UPDATE ACCOUNTBAL' + @@fin_id + '     
																SET    accbal_amount = accbal_amount + ' + convert(varchar,@@l_amount) + '    
																WHERE  accbal_dpm_id  = ' + @pa_dpm_id + ' and accbal_acct_id = ' + @@l_account_id + ' and accbal_deleted_ind = 1
														END    
														ELSE    
														BEGIN    
																INSERT INTO ACCOUNTBAL' + @@fin_id + '(accbal_dpm_id,accbal_acct_id,accbal_acct_type,accbal_amount,accbal_created_by,accbal_created_dt,accbal_lst_upd__by,accbal_lst_upd__dt,accbal_deleted_ind)
																VALUES (' + @pa_dpm_id + ',' + @@l_account_id + ',''' + @@l_acct_type + ''',' + convert(varchar,@@l_amount) + ',''' + @pa_login_name + ''',getdate(),''' + @pa_login_name + ''',getdate(),1)    
														END'    
										EXEC(@@SSQL)

									  IF @@CTR = 1
									  BEGIN
											UPDATE FINANCIAL_YR_MSTR SET FIN_CF_BALANCES = 'Y' WHERE FIN_ID = @@fin_id and FIN_DPM_ID = @pa_dpm_id and FIN_DELETED_IND =1                 
									  END
								END
						SET @@srno = @@srno + 1
						END
					SET @@CTR = @@CTR + 1
			END
	END

	IF @PA_ACTION = 'EDT'
	BEGIN

				SET @@SSQL= 'Insert into #tmpvch(Acct_id,dpm_id,Vch_dt,Vch_no,Amt,clrg_dt)
							 select ldg_account_id,ldg_dpm_id,ldg_voucher_dt,ldg_voucher_no,ldg_amount,ldg_bank_cl_date
							 from ledger' + @@fin_id + ' where ldg_voucher_dt   = convert(datetime,''' + @pa_voucher_dt + ''',103)
							 and ldg_voucher_type = ' + @pa_voucher_type + ' and ldg_voucher_no   = ' + @pa_voucher_no + ' and ldg_dpm_id = ' + @pa_dpm_id 
				EXEC(@@SSQL)


                SET @@SSQL=   'DELETE FROM  ' + @@ledgertable + '    
							  WHERE ldg_voucher_no   = ' + @pa_voucher_no + '
							  AND   ldg_dpm_id       = ' + @pa_dpm_id + '
							  AND   ldg_voucher_type = ' + @pa_voucher_type + '
							  AND   ldg_book_type_cd = ''' + @pa_book_type_cd + ''''
				EXEC(@@SSQL)

				IF @pa_chk_yn = 0 -- MASTER ONLY   
				BEGIN  
						SET @@SSQL = 'Update acbal 
									  SET accbal_amount = accbal_amount - Amt
									  FROM #tmpvch,ACCOUNTBAL' + @@fin_id + ' acbal
									  WHERE Acct_id = ACCBAL_ACCT_ID AND dpm_id = accbal_dpm_id'
						EXEC(@@SSQL)


				END

				SET @@SSQL = 'Update ldg 
							  SET ldg_bank_cl_date = clrg_dt
							  FROM #tmpvch,' + @@ledgertable + ' ldg
							  WHERE Acct_id = ldg_account_id and dpm_id = ldg_dpm_id
							  and ldg_voucher_no = Vch_no and ldg_voucher_dt = Vch_dt
							  and ldg_voucher_no   = ' + @pa_voucher_no + '
							  and ldg_voucher_type = ' + @pa_voucher_type + ' 
							  and ldg_book_type_cd = ''' + @pa_book_type_cd + '''
							  and ldg_amount = Amt'
				EXEC(@@SSQL)
 			    truncate table #tmpvch
			    drop table #tmpvch
				
			  SET @@TOTALRECORDS = ISNULL(citrus_usr.ufn_countstring(@pa_values,@rowdelimiter),0)				
			  BEGIN TRANSACTION
			  UPDATE FINANCIAL_YR_MSTR SET Ledger_currid = Ledger_currid + @@TOTALRECORDS WHERE fin_id = @@fin_id and fin_dpm_id = @pa_dpm_id and fin_deleted_ind =1
			  SELECT @@l_led_id    = ISNULL(Ledger_currid,0) - @@TOTALRECORDS FROM FINANCIAL_YR_MSTR WHERE fin_id = @@fin_id and fin_dpm_id = @pa_dpm_id and fin_deleted_ind =1
			  COMMIT TRANSACTION
			  SET @@srno = 1
			  WHILE @@CTR <= @@TOTALRECORDS
			  BEGIN
                    
					SET @@currstring_value = citrus_usr.FN_SPLITVALWITHDELIMETER(@rowdelimiter,@pa_values,@@CTR) 
                    IF (LTRIM(RTRIM(citrus_usr.fn_splitval(@@currstring_value,1))) = 'A' OR LTRIM(RTRIM(citrus_usr.fn_splitval(@@currstring_value,1))) = 'E')
					BEGIN				
							SET @@currstring_value = citrus_usr.FN_SPLITVALWITHDELIMETER(@rowdelimiter,@pa_values,@@CTR)  
                      
							SET @@l_acct_type = citrus_usr.fn_splitval(@@currstring_value,2)                  
							SET @@l_account_id = citrus_usr.fn_splitval(@@currstring_value,3)   
							--SET @@l_branch_id = citrus_usr.fn_splitval(@currstring_value,4)       
							--SET @@l_cost_cntr = citrus_usr.fn_splitval(@currstring_value,5) 
							IF (LTRIM(RTRIM(citrus_usr.fn_splitval(@@currstring_value,6))) <> '')  
							BEGIN                 
								SET @@l_amount    = convert(numeric(18,2),citrus_usr.fn_splitval(@@currstring_value,6))
							END
							ELSE
							BEGIN
								SET @@l_amount    = convert(numeric(18,2),citrus_usr.fn_splitval(@@currstring_value,7)) * -1
							END
							SET @@l_narration = citrus_usr.fn_splitval(@@currstring_value,8)    

							
							SET @@SSQL = 'INSERT INTO ' + @@ledgertable + '(ldg_id,ldg_dpm_id,ldg_voucher_type,ldg_book_type_cd,ldg_voucher_no,ldg_sr_no,ldg_ref_no,ldg_voucher_dt,ldg_account_id,ldg_account_type,ldg_amount,ldg_narration,ldg_account_no,ldg_instrument_no,ldg_branch_id,ldg_cost_cd_id,ldg_bill_brkup_id,ldg_trans_type,ldg_status,ldg_created_by,ldg_created_dt,ldg_lst_upd_by,ldg_lst_upd_dt,ldg_deleted_ind)
							VALUES(' + convert(varchar,@@l_led_id) + ',' + @pa_dpm_id + ',' + @pa_voucher_type +',''' + @pa_book_type_cd + ''',' + @pa_voucher_no +',' + convert(varchar,@@srno) + ',''' + @pa_ref_no + ''',convert(datetime,''' + @pa_voucher_dt+ ''',103) ,' + @@l_account_id  + ',''' + @@l_acct_type + ''',' + convert(varchar,@@l_amount) + ',''' + @@l_narration + ''',''' + isnull(@@l_acct_no,'') + ''','''',0,0,0 ,''N'',''P'' ,''' + @pa_login_name + ''',getdate(),''' + @pa_login_name+ ''',getdate() ,' + @@delind + ' )'     
							EXEC(@@SSQL)
							SET @@l_led_id = @@l_led_id + 1

							IF @pa_chk_yn = 0 -- MASTER ONLY   
							BEGIN    
									  SET @@SSQL =  'IF EXISTS(SELECT accbal_acct_id FROM ACCOUNTBAL' + @@fin_id + ' WHERE accbal_dpm_id = ' + @pa_dpm_id + ' and accbal_acct_id = ' + @@l_account_id + ')    
													BEGIN    
															UPDATE ACCOUNTBAL' + @@fin_id + '     
															SET    accbal_amount = accbal_amount + ' + convert(varchar,@@l_amount) + '    
															WHERE  accbal_dpm_id  = ' + @pa_dpm_id + ' and accbal_acct_id = ' + @@l_account_id + '
													END    
													ELSE    
													BEGIN    
															INSERT INTO ACCOUNTBAL' + @@fin_id + '(accbal_dpm_id,accbal_acct_id,accbal_acct_type,accbal_amount,accbal_created_by,accbal_created_dt,accbal_lst_upd__by,accbal_lst_upd__dt,accbal_deleted_ind)
															VALUES (' + @pa_dpm_id + ',' + @@l_account_id + ',''' + @@l_acct_type + ''',' + convert(varchar,@@l_amount) + ',''' + @pa_login_name + ''',getdate(),''' + @pa_login_name + ''',getdate(),1)    
													END'    
									  EXEC(@@SSQL)
									  IF @@CTR = 1
									  BEGIN
											UPDATE FINANCIAL_YR_MSTR SET FIN_CF_BALANCES = 'Y' WHERE FIN_ID = @@fin_id and FIN_DPM_ID = @pa_dpm_id and FIN_DELETED_IND =1                 
									  END
							END
					SET @@srno = @@srno + 1
					END
			SET @@CTR = @@CTR + 1
			END
	END
	IF @PA_ACTION = 'DEL'
	BEGIN
				IF @pa_chk_yn = 0 -- MASTER ONLY   
				BEGIN    

					  SET @@SSQL= 'UPDATE accb        
					  SET    accbal_amount  = accbal_amount - ldg_amount 
					  FROM   ACCOUNTBAL' + @@fin_id + ' accb, ' + @@ledgertable + '
					  WHERE  ldg_account_id   = accbal_acct_id  
					  AND	 ldg_dpm_id		  = accbal_dpm_id         
					  AND    ldg_account_type = accbal_acct_type     
					  AND    ldg_voucher_no   = ' + @pa_voucher_no + '      
					  AND    ldg_dpm_id       = ' + @pa_dpm_id + ' 
					  AND    ldg_voucher_type = ' + @pa_voucher_type + '
					  AND    ldg_voucher_dt   = convert(datetime,''' + @pa_voucher_dt + ''',103)'
					  EXEC(@@SSQL)
     
					  UPDATE FINANCIAL_YR_MSTR SET FIN_CF_BALANCES = 'Y' WHERE FIN_ID = @@fin_id and FIN_DPM_ID = @pa_dpm_id and FIN_DELETED_IND =1                 

			    END    


					  SET @@SSQL= 'UPDATE ' + @@ledgertable  + '  
					  SET    ldg_deleted_ind = ' + @@delind + '    
						   , ldg_lst_upd_by = ''' + @pa_login_name + '''
						   , ldg_lst_upd_dt = getdate()    
					  WHERE  ldg_voucher_type = ' + @pa_voucher_type + '
					  AND    ldg_voucher_no   = ' + @pa_voucher_no + '
					  AND    ldg_voucher_dt   = convert(datetime,''' + @pa_voucher_dt + ''',103)        
					  AND    ldg_dpm_id       = ' + @pa_dpm_id                      
					  EXEC(@@SSQL)              
			


	END




END

GO
