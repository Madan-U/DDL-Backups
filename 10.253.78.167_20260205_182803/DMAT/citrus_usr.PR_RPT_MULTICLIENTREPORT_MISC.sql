-- Object: PROCEDURE citrus_usr.PR_RPT_MULTICLIENTREPORT_MISC
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

--EXEC PR_RPT_MULTICLIENTREPORT_MISC 'MAY 02 2022', 'MAY 30 2022', 'HO'
CREATE  PROC [citrus_usr].[PR_RPT_MULTIclientreport_MISC]
(
@PA_FROM_DT DATETIME
, @PA_TO_DT DATETIME  
,@PA_LOGIN_NAME VARCHAR(100)    
)
AS 
BEGIN
 
SELECT DISTINCT   CONVERT (DATETIME, ACCP_VALUE,103) ACCP_VALUE, ACCP_CLISBA_ID , ACCP_ACCPM_PROP_CD 
INTO #ACCOUNT_PROPERTIES1 
FROM ACCOUNT_PROPERTIES O
WHERE ACCP_ACCPM_PROP_CD = 'BILL_START_DT' 
AND ACCP_VALUE NOT IN ('','//','//')
 AND ACCP_VALUE <> '' --AND ACCP_VALUE NOT IN ('','//')
AND ACCP_VALUE NOT IN ('','//','JAN  1 1900')

SELECT * INTO #ACCOUNT_PROPERTIES FROM #ACCOUNT_PROPERTIES1
WHERE  ACCP_VALUE  BETWEEN  @PA_FROM_DT AND @PA_TO_DT--CONVERT(VARCHAR(11),@PA_FROM_DT ,103) AND   CONVERT(VARCHAR(11),@PA_TO_DT,103) 
  AND    ACCP_VALUE  BETWEEN   DATEADD(D,-30, GETDATE ())  AND  GETDATE ()
--AND ACCP_VALUE  BETWEEN CONVERT(VARCHAR(11),@PA_FROM_DT,109) AND CONVERT(VARCHAR(11),@@PA_TO_DT,109)
--AND CONVERT (DATETIME, ACCP_VALUE,103) BETWEEN  @PA_FROM_DT AND @PA_TO_DT--CONVERT(VARCHAR(11),@PA_FROM_DT ,103) AND   CONVERT(VARCHAR(11),@PA_TO_DT,103) 
--  AND  CONVERT (DATETIME, ACCP_VALUE,103) BETWEEN   DATEADD(D,-30, GETDATE ())  AND  GETDATE ()
  
 
SELECT   
''''+DPAM_SBA_NO BOID 
,DPAM_SBA_NAME [CLIENT NAME]
, DPAM_BBO_CODE [TRADING CODE]
, SUBSTRING(BOACTDT,1,2 )+'/'+SUBSTRING(BOACTDT,3,2 )+'/'+SUBSTRING(BOACTDT,5,4 ) [ACC OPEN DATE]
, STAM_DESC [ACC STATUS ]
,CLICM_DESC [TYPE] 
, CASE WHEN ENTTM_CD IS NULL  
AND SUBCM_DESC  = 'CLIENT UNPAID SECURITIES ACCOUNT' THEN 'CLEARING MEMBER A/C' ELSE ENTTM_DESC END CATEGORY 
,   SUBCM_DESC [SUB TYPE],
DPAM_SBA_NAME  [FIRST HOLDER NAME]
,ISNULL(LTRIM(RTRIM(PC2.NAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC2.MIDDLENAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC2.SEARCHNAME)),'') [SECOND HOLDER NAME]
, ISNULL(LTRIM(RTRIM(PC3.NAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC3.MIDDLENAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC3.SEARCHNAME)),'') [THIRD HOLDER NAME]
, ISNULL(LTRIM(RTRIM(PC1.PANGIR)),'') [FIRST HOLDER PAN ]
,ISNULL(LTRIM(RTRIM(PC2.PANGIR)),'') [SECOND HOLDER PAN]
, ISNULL(LTRIM(RTRIM(PC3.PANGIR)),'') [THIRD HOLDER PAN]
, ISNULL(LTRIM(RTRIM(PC1.PRIPHNUM)),'') [MOBILE NO.]
,ISNULL(LTRIM(RTRIM( PC1.PRI_EMAIL)),'') [EMAIL ID]
, ISNULL(LTRIM(RTRIM(PC6.NAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC6.MIDDLENAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC6.SEARCHNAME)),'') [NOMINEE ]
, ISNULL(PC6.PERC_OF_SHARES,'') [PERCENTAGE]
, ISNULL(LTRIM(RTRIM(PC7.NAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC7.MIDDLENAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC7.SEARCHNAME)),'') [GUARDIAN NAME]
, ISNULL(LTRIM(RTRIM(PC7.NAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC7.MIDDLENAME)),'') + ' ' + ISNULL(LTRIM(RTRIM(PC7.SEARCHNAME)),'') [NOMINEE GUARDIAN NAME]
, DPAM_ACCT_NO [FORM NO.]

FROM DP_ACCT_MSTR   
LEFT  OUTER JOIN  DPS8_PC6 PC6  ON  PC6.BOID = DPAM_SBA_NO  AND PC6.TYPEOFTRANS IN ('',1,2)
LEFT  OUTER JOIN  DPS8_PC7 PC7  ON  PC7.BOID = DPAM_SBA_NO  AND PC7.TYPEOFTRANS IN ('',1,2)
LEFT  OUTER JOIN  DPS8_PC8 PC8  ON  PC8.BOID = DPAM_SBA_NO  AND PC8.TYPEOFTRANS IN ('',1,2)
LEFT OUTER JOIN DPS8_PC2 PC2  ON  PC2.BOID = DPAM_SBA_NO AND PC2.TYPEOFTRANS IN ('',1,2)
LEFT OUTER JOIN DPS8_PC3 PC3  ON  PC3.BOID = DPAM_SBA_NO AND PC3.TYPEOFTRANS IN ('',1,2)
LEFT OUTER JOIN SUB_CTGRY_MSTR ON DPAM_SUBCM_CD = SUBCM_CD AND SUBCM_DELETED_IND = '1'
LEFT OUTER JOIN CLIENT_CTGRY_MSTR ON DPAM_CLICM_CD  = CLICM_CD AND CLICM_DELETED_IND = '1' 
LEFT OUTER JOIN ENTITY_TYPE_MSTR  ON DPAM_ENTTM_CD = ENTTM_CD  AND ENTTM_DELETED_IND = '1'
, STATUS_MSTR 
, DPS8_PC1 PC1 
, #ACCOUNT_PROPERTIES  
WHERE  DPAM_DELETED_IND = '1' AND DPAM_ACCT_NO <> DPAM_SBA_NO AND DPAM_SBA_NO NOT LIKE '220%'
AND DPAM_SBA_NO   LIKE '12033201%'
AND DPAM_STAM_CD = STAM_CD 
AND DPAM_SBA_NO = PC1.BOID  
 AND ACCP_CLISBA_ID = DPAM_ID 
 
 DROP TABLE  #ACCOUNT_PROPERTIES 
 DROP TABLE  #ACCOUNT_PROPERTIES1
 
 END

GO
