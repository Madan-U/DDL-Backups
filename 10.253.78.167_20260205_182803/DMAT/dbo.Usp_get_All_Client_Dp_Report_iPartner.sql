-- Object: PROCEDURE dbo.Usp_get_All_Client_Dp_Report_iPartner
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------



CREATE PROCEDURE [dbo].[Usp_get_All_Client_Dp_Report_iPartner]
(
	@SUB_BROKER VARCHAR(100)='ET'
)
AS --USP_GET_ALL_CLIENT_DP_REPORT_IPARTNER 'JJRU'
BEGIN

SELECT CL_CODE INTO #CLT FROM [INTRANET].RISK.DBO.CLIENT_DETAILS WHERE SUB_BROKER = @SUB_BROKER

CREATE INDEX #IX_CL ON #CLT(CL_CODE)

 
Select D.* INTO #DP from citrus_usr.DP_ACCT_MSTR D, #CLT C where CL_CODE =DpAM_BBO_CODE

CREATE INDEX #IX_CL ON #DP(DPAM_ID)

 Declare @ledger varchar(20)

 Select @ledger='Ledger'+convert(varchar(2),Fin_id) from Citrus_usr.Financial_Yr_Mstr F where Getdate() between FIN_START_DT and FIN_END_DT
 
  Create Table #Temp (Party_Code varchar(15),Client_Code varchar(18),Brok_Bal money,Curr_Bal  Money)

  Insert into #Temp
  SELECT DPAM_BBO_CODE AS PARTY_CODE, DPAM_SBA_NO CLIENT_CODE, SUM(CLIC_CHARGE_AMT)*-1 BROK_BAL, '0' CURR_BAL  FROM     
  #DP (Nolock) , CITRUS_USR.CLIENT_CHARGES_CDSL (Nolock) WHERE 
  CLIC_DPAM_ID = DPAM_ID AND CLIC_TRANS_DT BETWEEN CITRUS_USR.UFN_GETFIRSTDAYOFMONTH(GETDATE())    
  AND DBO.UFN_GETLASTDAYOFMONTH(GETDATE()) GROUP BY DPAM_SBA_NO,DPAM_BBO_CODE     
   
  Declare @@SSQL Varchar(5000)

  Set @@SSQL= ' INSERT INTO #Temp  SELECT DPAM_BBO_CODE AS PARTY_CODE,DPAM_SBA_NO CLIENT_CODE,0 BROK_BAL  , SUM(LDG_AMOUNT)*-1 CURR_BAL   '
  Set @@SSQL =@@SSQL + ' FROM CITRUS_USR.'+@ledger+', #DP D  WHERE   LDG_ACCOUNT_ID = DPAM_ID AND LDG_ACCOUNT_TYPE =''P'' AND LDG_DELETED_IND = 1 '
  Set @@SSQL =@@SSQL + ' AND DPAM_DELETED_IND = 1   GROUP BY DPAM_SBA_NO,DPAM_BBO_CODE '
  Exec (@@SSQL)

/**** LEDGER BALANCE ****/
SELECT PARTY_CODE,CLIENT_CODE    
,SUM(CURR_BAL) ACTUAL_AMOUNT  
, SUM(BROK_BAL) ACCRUAL_BAL,'0' AS BRANCH_CODE  INTO #LEDBALANCE  
FROM (
SELECT  PARTY_CODE, CLIENT_CODE, SUM(BROK_BAL)  BROK_BAL, SUM(CURR_BAL)CURR_BAL
FROM  #Temp
  GROUP BY PARTY_CODE,CLIENT_CODE
  
  )   BALANCE   
GROUP BY PARTY_CODE,CLIENT_CODE   



/*** END******/


SELECT DISTINCT 
	 CLIENT_ID
	,FIRST_HOLD_NAME
	,DPID
	,ISNULL(POA_VER,0) AS POA_VER
	,CONVERT(VARCHAR(15),ACTIVE_DATE,103) AS ACTIVE_DATE
	,T1.BROM_DESC AMC_SCHEME
    ,ISNULL(DP_LEDGER,0) AS DP_LEDGER
	,ISNULL(ACCRUAL_CHARGES,0) AS ACCRUAL_CHARGES
	,ACCOUNT_STATUS
	,CLIENT_SUB_TYPE
	,DATE_OF_BIRTH AS DATE_OF_BIRTH
	,NOMINEE 
	--,T1.BROM_DESC SCHEME 
FROM #CLT C
	INNER JOIN (
			SELECT T.NISE_PARTY_CODE AS CLIENT_ID,FIRST_HOLD_NAME,T.CLIENT_CODE  AS DPID ,POA_VER,ACTIVE_DATE,     
			DP_LEDGER =ACTUAL_AMOUNT, ACCRUAL_CHARGES=ACCRUAL_BAL , 
			ACCOUNT_STATUS=STATUS, CLIENT_SUB_TYPE=SUB_TYPE,    
			DATE_OF_BIRTH=BO_DOB,NOMINEE= ISNULL(LTRIM(RTRIM(NAME)),'')+' '+ISNULL(LTRIM(RTRIM(MIDDLENAME)),'') +' '+ISNULL(LTRIM(RTRIM(SEARCHNAME)),'')   
			FROM #CLT C  , TBL_CLIENT_MASTER T 
			LEFT OUTER JOIN CITRUS_USR.NOMINEE ON BOID=T.CLIENT_CODE  
			LEFT OUTER JOIN  #LEDBALANCE  B ON  B.CLIENT_CODE =T.CLIENT_CODE 
			Where C.CL_CODE = T.NISE_PARTY_CODE  
			    
			
 ) A ON C.CL_CODE = A.CLIENT_ID
LEFT JOIN 
(
SELECT BROM_DESC,DPAM.DPAM_SBA_NO 
FROM  #CLT C, [CITRUS_USR].DP_ACCT_MSTR DPAM
		LEFT OUTER JOIN 
        [CITRUS_USR].CLIENT_DP_BRKG     ON DPAM_ID = CLIDB_DPAM_ID AND CLIDB_DELETED_IND='1' AND GETDATE() BETWEEN CLIDB_EFF_FROM_DT AND CLIDB_EFF_TO_DT
        LEFT OUTER JOIN 
      	[CITRUS_USR].BROKERAGE_MSTR ON BROM_ID = CLIDB_BROM_ID  
        
		WHERE DPAM_BBO_CODE=Cl_COde and  ISNUMERIC(DPAM.DPAM_SBA_NO)=1  
        --AND DPAM.DPAM_SBA_NO  BETWEEN '1203320054298611' AND '1203320054298611'
) T1 ON A.DPID =T1.DPAM_SBA_NO




	 
END

GO
