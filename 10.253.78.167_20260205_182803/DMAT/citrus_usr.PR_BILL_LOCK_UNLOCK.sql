-- Object: PROCEDURE citrus_usr.PR_BILL_LOCK_UNLOCK
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

/*SP FOR BILL PERIOD LOCK/UNLOCK DATE SEP 25 08*/
--PR_BILL_LOCK_UNLOCK	'30/08/2008','30/08/2008','12345678','Y','','VISHAL',''
CREATE PROCEDURE [citrus_usr].[PR_BILL_LOCK_UNLOCK]
(
 @PA_BILLING_FROM_DT VARCHAR(11)
,@PA_BILLING_TO_DT   VARCHAR(11)
,@PA_DPM_DPID          VARCHAR(16)
,@PA_POSTED_FLG      CHAR(1)
,@PA_LOCKUNLOCKFLG   CHAR(1)
,@PA_LOGIN_NAME   VARCHAR(20)
,@PA_ERRMSG VARCHAR(8000) OUT 
)
AS
BEGIN
DECLARE   @L_DPM_ID  INT
		 ,@L_ERROR         BIGINT
		 ,@T_ERRORSTR VARCHAR(8000)

		SET @L_ERROR=0

		SELECT @L_DPM_ID = DPM_ID FROM DP_MSTR WHERE DPM_DPID = @PA_DPM_DPID AND DPM_DELETED_IND = 1 

		BEGIN TRANSACTION
			IF (@PA_LOCKUNLOCKFLG='')
		BEGIN 
			UPDATE BILL_CYCLE SET BILLC_LOCKUNLOCK_FLG='Y' WHERE  BILLC_DPM_ID=@L_DPM_ID AND convert(varchar(11),billc_from_dt,103)=@PA_BILLING_FROM_DT AND convert(varchar(11),billc_to_dt,103)=@PA_BILLING_TO_DT AND BILLC_DELETED_IND=1 AND ISNULL(BILLC_LOCKUNLOCK_FLG,'')=''
		END
		ELSE
		BEGIN
			UPDATE BILL_CYCLE SET BILLC_LOCKUNLOCK_FLG=NULL WHERE  BILLC_DPM_ID=@L_DPM_ID AND convert(varchar(11),billc_from_dt,103)=@PA_BILLING_FROM_DT AND convert(varchar(11),billc_to_dt,103)=@PA_BILLING_TO_DT AND BILLC_DELETED_IND=1 AND BILLC_LOCKUNLOCK_FLG='Y'
		END

SET @L_ERROR = @@ERROR
IF @L_ERROR <> 0 
BEGIN
		IF EXISTS(SELECT ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = @L_ERROR)
		BEGIN
		--
				SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': '+ ERR_DESCRIPTION FROM TBLERROR WHERE ERR_CODE = CONVERT(VARCHAR,@L_ERROR)
		--
		END
		ELSE
		BEGIN
		--
				SELECT @T_ERRORSTR = 'ERROR '+CONVERT(VARCHAR,@L_ERROR) + ': CAN NOT PROCESS, PLEASE CONTACT YOUR ADMINISTRATOR!'
		--
		END

		ROLLBACK TRANSACTION 
END
ELSE
BEGIN 
		COMMIT TRANSACTION
        IF (@PA_LOCKUNLOCKFLG='')
        BEGIN 
			SELECT @T_ERRORSTR = 'Bill Period is Lock For the Period ' + ' From :' + convert(varchar(11),@PA_BILLING_FROM_DT) + ' To : ' + convert(varchar(11),@PA_BILLING_TO_DT)
        END
        ELSE
        BEGIN 
			SELECT @T_ERRORSTR = 'Bill Period is UnLock For the Period ' + ' From :' + convert(varchar(11),@PA_BILLING_FROM_DT) + ' To : ' + convert(varchar(11),@PA_BILLING_TO_DT)
        END
END

SET @PA_ERRMSG = @T_ERRORSTR
  
END

GO
