-- Object: PROCEDURE citrus_usr.ANGEL_NXT_LED_Bkp19Nov2018
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------




CREATE PROC [citrus_usr].[ANGEL_NXT_LED_Bkp19Nov2018] 
(@FROM_FIN_YEAR VARCHAR(4),@TO_FIN_YEAR VARCHAR(4),@DP_ID VARCHAR(16) ,@LTYPE VARCHAR(15))

AS
---Request From : Angel Next Team
---- Devleoper : Siva Kumar
--- For Led : EXEC CITRUS_USR.ANGEL_NXT_LED '2018' ,'2019' ,'1203320012480091' ,'L'
--- For Accural : ANGEL_NXT_LED '2018' ,'2019' ,'1203320012480091', 'A'

DECLARE  @LEDGER VARCHAR(50),@STRSQL NVARCHAR(MAX)

IF (@LTYPE ='L' ) 
		BEGIN 

			SELECT  @LEDGER='CITRUS_USR.LEDGER'+CONVERT(VARCHAR(2),FIN_ID)  
			FROM Financial_Yr_Mstr WHERE YEAR(FIN_START_DT) = @FROM_FIN_YEAR AND YEAR(FIN_END_DT) =@TO_FIN_YEAR

			SET @STRSQL = ' SELECT * FROM ( '
			SET @STRSQL = @STRSQL + ' SELECT  CASE WHEN LDG_ACCOUNT_TYPE =''P'' THEN DPAM_SBA_NO  ' 
			--SET @STRSQL = @STRSQL + ' CASE WHEN FINA_ACC_CODE LIKE ''%SGST'' THEN ''SGST'' '  
			--SET @STRSQL = @STRSQL + ' WHEN FINA_ACC_CODE LIKE ''%IGST'' THEN ''IGST'' ' 
			--SET @STRSQL = @STRSQL + ' WHEN FINA_ACC_CODE LIKE ''%CGST'' THEN ''CGST''  '
			--SET @STRSQL = @STRSQL + ' WHEN FINA_ACC_CODE LIKE ''%UGST'' THEN ''UGST''  '
			SET @STRSQL = @STRSQL + ' ELSE '''' END  '
			SET @STRSQL = @STRSQL + ' LD_CLIENTCD     '
			SET @STRSQL = @STRSQL + ' ,LDG_VOUCHER_DT  LD_DT ,CONVERT(NUMERIC(18,4),LDG_AMOUNT  ) LD_AMOUNT '   
			SET @STRSQL = @STRSQL + ' ,LDG_NARRATION  LD_PARTICULAR,LDG_INSTRUMENT_NO  LD_CHEQUENO  '   
			SET @STRSQL = @STRSQL + ' ,CASE WHEN LDG_AMOUNT < 0 THEN ''D'' ELSE ''C'' END   LD_DEBITFLAG   '      
			SET @STRSQL = @STRSQL + ' ,(CASE WHEN LDG_VOUCHER_TYPE =1 THEN ''P'' '   
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =2 THEN ''R''  '     
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =3 THEN ''J'' '   
			SET @STRSQL = @STRSQL + ' WHEN LDG_VOUCHER_TYPE =5 THEN ''B'' ELSE '''' END) LD_DOCUMENTTYPE '       
			SET @STRSQL = @STRSQL + ' ,LDG_VOUCHER_NO  LD_DOCUMENTNO,'''' LD_ENTRYNO ,'''' LD_COSTCENTER,LDG_CREATED_BY  MKRID ,LDG_LST_UPD_DT  MKRDT  '    
			SET @STRSQL = @STRSQL + ' ,YEAR(LDG_VOUCHER_DT) LD_ACCYEAR    '     
			SET @STRSQL = @STRSQL + ' ,LEFT(DPAM_SBA_NO,8) LD_DPID   '      
			SET @STRSQL = @STRSQL + ' ,'''' LD_COMMONDT    '     
			SET @STRSQL = @STRSQL + ' ,'''' LD_COMMON     '    
			SET @STRSQL = @STRSQL + ' FROM  ' +@LEDGER  + '  WITH(NOLOCK) '   
			SET @STRSQL = @STRSQL + ' LEFT OUTER JOIN  CITRUS_USR.DP_ACCT_MSTR  WITH(NOLOCK)ON  LDG_ACCOUNT_ID  = DPAM_ID '     
			--SET @STRSQL = @STRSQL + ' LEFT OUTER JOIN  CITRUS_USR.FIN_ACCOUNT_MSTR   WITH(NOLOCK)ON  LDG_ACCOUNT_ID  =   FINA_ACC_ID '    
			SET @STRSQL = @STRSQL + ' WHERE LDG_DELETED_IND=1  )A '
			SET @STRSQL = @STRSQL + ' WHERE  LD_CLIENTCD = ''' + @DP_ID   + ''' ORDER BY LD_DT   '

		--	PRINT (@STRSQL)
			EXEC (@STRSQL)

		END

IF (@LTYPE ='A' )
     BEGIN 
	   SELECT DPAM_BBO_CODE AS PARTY_CODE, DPAM_SBA_NO CLIENT_CODE, SUM(CLIC_CHARGE_AMT)*-1 BROK_BAL, '0' CURR_BAL  FROM     
		  DP_ACCT_MSTR , CLIENT_CHARGES_CDSL WHERE CLIC_DPAM_ID = DPAM_ID 
		  AND DPAM_BBO_CODE = @DP_ID AND CLIC_TRANS_DT BETWEEN CITRUS_USR.UFN_GETFIRSTDAYOFMONTH(GETDATE())    
		  AND DBO.UFN_GETLASTDAYOFMONTH(GETDATE()) GROUP BY DPAM_SBA_NO,DPAM_BBO_CODE     
		  UNION ALL
		  SELECT DPAM_BBO_CODE AS PARTY_CODE, DPAM_SBA_NO CLIENT_CODE, SUM(CLIC_CHARGE_AMT)*-1 BROK_BAL, '0' CURR_BAL  FROM     
		  DP_ACCT_MSTR , CLIENT_CHARGES_CDSL WHERE CLIC_DPAM_ID = DPAM_ID AND DPAM_BBO_CODE = @DP_ID
		  AND CLIC_TRANS_DT BETWEEN CITRUS_USR.UFN_GETFIRSTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE()))    
		  AND DBO.UFN_GETLASTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE())) 
		  AND NOT EXISTS (SELECT LDG_ACCOUNT_ID FROM LEDGER5 WHERE LDG_ACCOUNT_ID=DPAM_ID AND LDG_DELETED_IND=1 AND LDG_VOUCHER_TYPE='5'
		  AND LDG_VOUCHER_DT=DBO.UFN_GETLASTDAYOFMONTH(DATEADD(MONTH,-1,GETDATE())))
		  GROUP BY DPAM_SBA_NO,DPAM_BBO_CODE 

    END

GO
