-- Object: PROCEDURE citrus_usr.PR_CURRDATE_UPD_30DAYSLOGIC
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

--begin tran
--exec PR_CURRDATE_UPD_30DAYSLOGIC ''
--select * from slip_issue_mstr where sliim_dpam_acct_no='1201090000071000' order by 1 desc
--rollback
CREATE PROCEDURE PR_CURRDATE_UPD_30DAYSLOGIC
(@PA_LOGINNAME VARCHAR(30))
AS
BEGIN



SELECT sliim_id,SLIIM_DPAM_ACCT_NO,USES_LST_UPD_DT,USES_DPAM_ACCT_NO into #tmpMain  FROM SLIP_ISSUE_MSTR,USED_SLIP WHERE SLIIM_DT>='OCT 01 2001'
AND  SLIIM_DELETED_IND=1 AND SLIIM_SERIES_TYPE='' AND ISNULL(SLIIM_EXPIRY_DATE,'')='' 
AND  USES_SLIP_NO BETWEEN SLIIM_SLIP_NO_FR AND SLIIM_SLIP_NO_TO
AND  USES_DELETED_IND=1 and USES_DPAM_ACCT_NO=SLIIM_DPAM_ACCT_NO
and  uses_created_dt between 'OCT 01 2001' and getdate()
--getting records of used_slip of new issue

SELECT m.*,USES_LST_UPD_DT,USES_DPAM_ACCT_NO INTO  #TMP FROM SLIP_ISSUE_MSTR M,#tmpMain T WHERE SLIIM_DT>='OCT 01 2001'
AND CONVERT(VARCHAR(11),SLIIM_EXPIRY_DATE,109) >=CONVERT(VARCHAR(11),GETDATE(),109) 
AND  SLIIM_DELETED_IND=1 AND SLIIM_SERIES_TYPE='' AND ISNULL(SLIIM_EXPIRY_DATE,'')<>'' 
--AND NOT EXISTS (SELECT USES_ID FROM USED_SLIP WHERE USES_SLIP_NO BETWEEN SLIIM_SLIP_NO_FR AND SLIIM_SLIP_NO_TO
--AND USES_DELETED_IND=1 and USES_DPAM_ACCT_NO=m.SLIIM_DPAM_ACCT_NO)
and M.SLIIM_DPAM_ACCT_NO=t.SLIIM_DPAM_ACCT_NO
--taking that client previous data 

update m set SLIIM_EXPIRY_DATE =USES_LST_UPD_DT from  SLIP_ISSUE_MSTR M,#TMP T 
WHERE  t.SLIIM_DPAM_ACCT_NO=USES_DPAM_ACCT_NO
AND M.SLIIM_ID=T.SLIIM_ID and m.sliim_deleted_ind=1

END

GO
