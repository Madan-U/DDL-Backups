-- Object: PROCEDURE citrus_usr.REPORTING_HOLDING_DATA
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------


--- 172.31.16.94

--REPORTING_HOLDING_DATA 'oct  3 2020'

CREATE PROCEDURE REPORTING_HOLDING_DATA
(@date varchar(20))
as 
begin
 
 

create table #tmphldg 
(
	[DPHMCD_DPM_ID] [numeric](18, 0) NOT NULL,
	[DPHMCD_DPAM_ID] [numeric](10, 0) NOT NULL,
	[DPHMCD_ISIN] [varchar](20) NOT NULL,
	[DPHMCD_CURR_QTY] [numeric](18, 3) NULL,
	[DPHMCD_FREE_QTY] [numeric](18, 3) NULL,
	[DPHMCD_FREEZE_QTY] [numeric](18, 3) NULL,
	[DPHMCD_PLEDGE_QTY] [numeric](18, 3) NULL,
	[DPHMCD_DEMAT_PND_VER_QTY] [numeric](18, 3) NULL,
	[DPHMCD_REMAT_PND_CONF_QTY] [numeric](18, 3) NULL,
	[DPHMCD_DEMAT_PND_CONF_QTY] [numeric](18, 3) NULL,
	[DPHMCD_SAFE_KEEPING_QTY] [numeric](18, 3) NULL,
	[DPHMCD_LOCKIN_QTY] [numeric](18, 3) NULL,
	[DPHMCD_ELIMINATION_QTY] [numeric](18, 3) NULL,
	[DPHMCD_EARMARK_QTY] [numeric](18, 3) NULL,
	[DPHMCD_AVAIL_LEND_QTY] [numeric](18, 3) NULL,
	[DPHMCD_LEND_QTY] [numeric](18, 3) NULL,
	[DPHMCD_BORROW_QTY] [numeric](18, 3) NULL,
	[dphmcd_holding_dt] datetime
--, rate numeric(18,3),tradingid varchar(100)
	)  

	--insert into  #tmphldg
	--		exec  [pr_get_holding_fix_latest_isinwise]  '3','MAR 13 2020','MAR 13 2020','0','99999999999999999','INE528G01027',''

	--		SELECT DPAM_BBO_CODE,T.[DPHMCD_FREE_QTY] AS DP_HLD FROM #TMPHLDG T,DP_ACCT_MSTR D
	--		WHERE DPHMCD_DPAM_ID=DPAM_ID AND DPAM_BBO_CODE IS NOT NULL AND DPAM_BBO_CODE NOT IN ('','1') --AND DPAM_BBO_CODE = 'A101293'
	--		ORDER BY DPAM_BBO_CODE
 

 ---- AS ON DATE HOLDING


 --SELECT TRADINGID,SUM(FREE_QTY) AS [DP QTY] FROM HOLDING (NOLOCK) WHERE TRADINGID NOT IN ('','1') AND HLD_ISIN_CODE IN ('INE528G01027')
 --GROUP BY TRADINGID
 --ORDER BY TRADINGID


 --SELECT TRADINGID,SUM(FREE_QTY) AS [DP QTY],SUM(LOCKIN_QTY) AS [LOCKIN QTY]  FROM HOLDING (NOLOCK) WHERE TRADINGID NOT IN ('','1')
 -- AND HLD_ISIN_CODE IN ('INE528G01035')
 --GROUP BY TRADINGID
 --ORDER BY TRADINGID


 ---- FOR DAILY ANGEL DP HOLDING ----
  
  -- TRUNCATE TABLE #tmphldg
  
  CREATE INDEX IX_ID_TEMP
ON #tmphldg (DPHMCD_DPM_ID,DPHMCD_DPAM_ID);
 
			insert into  #tmphldg
			exec [pr_get_holding_fix_latest_REPORT] 3,@date,@date,'0','9999999999999999',''

----


			SELECT DISTINCT DPAM_SBA_NO,[DPHMCD_ISIN],T.[DPHMCD_CURR_QTY] AS DP_HLD FROM #TMPHLDG T,DP_ACCT_MSTR D
			WHERE DPHMCD_DPAM_ID=DPAM_ID 
			ORDER BY DPAM_SBA_NO,[DPHMCD_ISIN]


			--SELECT DPAM_SBA_NO,[DPHMCD_ISIN],T.[DPHMCD_FREE_QTY] AS FREE_HLD,T.DPHMCD_LOCKIN_QTY,T.[DPHMCD_CURR_QTY] AS DP_HLD
			-- FROM #TMPHLDG T,DP_ACCT_MSTR D
			--WHERE DPHMCD_DPAM_ID=DPAM_ID AND [DPHMCD_ISIN] = 'INE528G01035'
			
			end

GO
