-- Object: PROCEDURE citrus_usr.PR_RPT_INWARDOUTWARD_REGISTER
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

--[PR_RPT_INWARDOUTWARD_REGISTER] 'nsdl',4,'D','pr','jun 01 2009','jun 06 2009','ho',1,'',''
CREATE PROC [citrus_usr].[PR_RPT_INWARDOUTWARD_REGISTER]
@PA_DPTYPE VARCHAR(4),
@PA_EXCSM_ID INT,
@PA_IO_TYPE VARCHAR(10), -- D - DMAT,R - REMAT
@PA_STATUS_FOR VARCHAR(10), -- R- REJECTED ALL , RR - REJECTED BY RTA,RI - REJECTED BY INTERNAL OBJECTION, PR -PENDING WITH REGISTRAR,PD - PENDING WITH DP, DR- DISPATCHED TO RTA,DC -DISPATCHED TO CLIENT
@PA_FROM_DT DATETIME,
@PA_TO_DT DATETIME,
@PA_GROUPBY VARCHAR(10),
@PA_LOGIN_PR_ENTM_ID BIGINT,
@PA_LOGIN_ENTM_CD_CHAIN varchar(8000),      
@PA_OUTPUT varchar(20) OUT    
/*
,@PA_BASED_ON_DT VARCHAR,
-- FOR R  - REJECTED ALL , RR - REJECTED BY RTA,RI - REJECTED BY INTERNAL OBJECTION VALUE SHOULD BE (REQ- REQUEST DATE,ATH - AUTHORISE DATE,REJ - REJECTION DATE)
-- FOR PR - PENDING WITH REGISTRAR VALUE SHOULD BE (REQ- REQUEST DATE,ATH - AUTHORISE DATE,DISP - DISPATCH DATE)
-- FOR PD - PENDING WITH DP VALUE SHOULD BE (REQ- REQUEST DATE,ATH - AUTHORISE DATE)
-- FOR DR - DISPATCHED TO RTA VALUE SHOULD BE (REQ- REQUEST DATE,ATH - AUTHORISE DATE,DISP - DISPATCH DATE)
-- FOR DC - DISPATCHED TO CLIENT VALUE SHOULD BE (REQ- REQUEST DATE,ATH - AUTHORISE DATE,DISP - DISPATCH DATE)
*/
AS
BEGIN

DECLARE @@L_DPM_ID BIGINT,
@@SSQL VARCHAR(8000),
@@l_child_entm_id BIGINT
print '10'

  select @@L_DPM_ID = dpm_id from dp_mstr where default_dp = @PA_EXCSM_ID and dpm_deleted_ind =1              
  select @@l_child_entm_id    =  citrus_usr.fn_get_child(@pa_login_pr_entm_id , @pa_login_entm_cd_chain)                      
PRINT CONVERT(VARCHAR(22),GETDATE(),109)
  CREATE TABLE #ACLIST(dpam_id BIGINT,dpam_sba_no VARCHAR(16),dpam_sba_name VARCHAR(150),eff_from DATETIME,eff_to DATETIME,group_cd varchar(50),dpm_id numeric)
  INSERT INTO #ACLIST SELECT DPAM_ID,dpam_sba_no,dpam_sba_name,EFF_FROM,EFF_TO,'',@@L_DPM_ID 
  FROM citrus_usr.fn_acct_list_disdrf(@@L_DPM_ID ,@PA_LOGIN_PR_ENTM_ID,@@l_child_entm_id)		
  --FROM citrus_usr.fn_acct_list(@@L_DPM_ID ,@PA_LOGIN_PR_ENTM_ID,@@l_child_entm_id)		

 
 select @@ssql  = citrus_usr.fn_createheirarchy_update('#ACLIST',@Pa_groupby)
 
 print '11'

 EXEC(@@ssql)
PRINT CONVERT(VARCHAR(22),GETDATE(),109)
	IF @PA_IO_TYPE = 'D'
	BEGIN
IF @PA_STATUS_FOR = 'RDRC'
			BEGIN

					SELECT dpam_id,demrm_id,E.ENTM_NAME1, group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO
,DRN_NO=ISNULL(DEMRM_TRANSACTION_NO,'')
,ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME
,COMP_NAME=ISIN_NAME
,ISIN_CD
,REGISTRAR_NAME= isnull(case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end ,'')
,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103)
,REJ_DT=CONVERT(VARCHAR(11),DEMRM_EXECUTION_DT,103)
,REQ_QTY=convert(numeric(16,3)
,ISNULL(DEMRM_QTY,0))
,REJ_QTY=convert(numeric(16,3)
,ISNULL(DEMRM_QTY,0)-ISNULL(DEMRM_CONVERTED_QTY,0))
,NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0)
,REJREASON = [citrus_usr].fn_splitstrin_byspace_for_print(isnull(rej.descp,''),'20','',1)
,'' DISP_NAME
,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM DEMAT_REQUEST_MSTR left outer join fn_getsubtransdtls('DEMAT_REJ_CD_NSDL') rej on LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) + LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) = rej.cd
					,#ACLIST
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON (ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END) AND (R.ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END) AND R.ENTM_DELETED_IND =1
					,ENTITY_MSTR E
					WHERE DEMRM_DPAM_ID = DPAM_ID
					AND DEMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					AND DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and DEMRM_REQUEST_DT between eff_from and eff_to
					and demrm_isin = isin_cd
					AND (LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) <> '' OR LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) <> '')
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND DEMRM_DELETED_IND = 1
                    and ISNULL(DEMRM_RESPONSE_DT,'')=''                    
					ORDER BY DEMRM_LST_UPD_DT ,DRN_NO,E.ENTM_NAME1,group_cd,DEMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME


			END
			IF @PA_STATUS_FOR = 'R'
			BEGIN
			

					SELECT dpam_id,demrm_id,E.ENTM_NAME1, group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO
,DRN_NO=ISNULL(DEMRM_TRANSACTION_NO,'')
,ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME
,COMP_NAME=ISIN_NAME
,ISIN_CD
,REGISTRAR_NAME= isnull(case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end ,'')
,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103)
,REJ_DT=CONVERT(VARCHAR(11),DEMRM_EXECUTION_DT,103)
,REQ_QTY=convert(numeric(16,3)
,ISNULL(DEMRM_QTY,0))
,REJ_QTY=convert(numeric(16,3)
,ISNULL(DEMRM_QTY,0)-ISNULL(DEMRM_CONVERTED_QTY,0))
,NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0)
,REJREASON = [citrus_usr].fn_splitstrin_byspace_for_print(isnull(rej.descp,''),'20','',1)
,'' DISP_NAME
,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM DEMAT_REQUEST_MSTR left outer join fn_getsubtransdtls('DEMAT_REJ_CD_NSDL') rej on LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) + LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) = rej.cd
					,#ACLIST
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON (ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END) AND (R.ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END) AND R.ENTM_DELETED_IND =1
					,ENTITY_MSTR E
					WHERE DEMRM_DPAM_ID = DPAM_ID
					AND DEMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					AND DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and DEMRM_REQUEST_DT between eff_from and eff_to
					and demrm_isin = isin_cd
					AND (LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) <> '' OR LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) <> '')
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND DEMRM_DELETED_IND = 1
					ORDER BY DEMRM_LST_UPD_DT ,DRN_NO,E.ENTM_NAME1,group_cd,DEMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME


			END
			IF @PA_STATUS_FOR = 'RR'
			BEGIN

					SELECT demrm_id,E.ENTM_NAME1,group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO,DRN_NO=ISNULL(DEMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD,
                    --REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
					REGISTRAR_NAME=R.ENTM_NAME1
					,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103),
					REJ_DT=CONVERT(VARCHAR(11),DEMRM_EXECUTION_DT,103),REQ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)),REJ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)-ISNULL(DEMRM_CONVERTED_QTY,0)),
					NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0),REJREASON = [citrus_usr].[fn_splitstrin_byspace](isnull(rej.descp,''),'20','',1)
					,'' DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM DEMAT_REQUEST_MSTR
					,citrus_usr.fn_getsubtransdtls('DEMAT_REJ_CD_NSDL') rej 
					,#ACLIST 
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND ENTM_DELETED_IND =1
					,ENTITY_MSTR E
					WHERE DEMRM_DPAM_ID = DPAM_ID
					AND DEMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					AND DEMRM_lst_upd_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and DEMRM_lst_upd_DT between eff_from and eff_to
					and demrm_isin = isin_cd
					AND LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) = '' AND LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) <> ''
					and LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) = rej.cd
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND DEMRM_DELETED_IND = 1
					ORDER BY demrm_id ,DRN_NO,E.ENTM_NAME1,group_cd,DEMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
			END
			IF @PA_STATUS_FOR = 'RI'
			BEGIN
--					SELECT demrm_id,E.ENTM_NAME1,group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO,DRN_NO=ISNULL(DEMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
--					COMP_NAME=ISIN_NAME,ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
--					,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103),
--					REJ_DT=CONVERT(VARCHAR(11),DEMRM_LST_UPD_DT,103),REQ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)),REJ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)-ISNULL(DEMRM_CONVERTED_QTY,0)),
--					NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0),REJREASON = [citrus_usr].[fn_splitstrin_byspace](isnull(rej.descp,''),'20','',1)
--					FROM DEMAT_REQUEST_MSTR
--					,citrus_usr.fn_getsubtransdtls('DEMAT_REJ_CD_NSDL') rej 
--					,#ACLIST 
--					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND ENTM_DELETED_IND =1
--					,ENTITY_MSTR E
--					WHERE DEMRM_DPAM_ID = DPAM_ID
--					AND DEMRM_ISIN = ISIN_CD
--					AND DPM_ID = @@L_DPM_ID
--					AND DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
--					and DEMRM_REQUEST_DT between eff_from and eff_to
--					and demrm_isin = isin_cd
--					AND LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) <> '' AND LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) = ''
--					and LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) = rej.cd
--					AND group_cd = E.ENTM_ID
--					AND E.ENTM_DELETED_IND = 1
--					AND DEMRM_DELETED_IND = 1
--					ORDER BY DEMRM_LST_UPD_DT ,DRN_NO,E.ENTM_NAME1,group_cd,DEMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
--select * from #ACLIST
print @@L_DPM_ID
PRINT CONVERT(VARCHAR(22),GETDATE(),109)
SELECT d2.demrm_id,E.ENTM_NAME1,group_cd,DRF_NO=d2.DEMRM_SLIP_SERIAL_NO,DRN_NO=ISNULL(d1.DEMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
					,REQUEST_DT=CONVERT(VARCHAR(11),d2.DEMRM_REQUEST_DT,103),
					REJ_DT=CONVERT(VARCHAR(11),d2.DEMRM_LST_UPD_DT,103),REQ_QTY=convert(numeric(16,3),ISNULL(d2.DEMRM_QTY,0)),REJ_QTY=convert(numeric(16,3),ISNULL(d2.DEMRM_QTY,0)-ISNULL(d2.DEMRM_CONVERTED_QTY,0)),
					NO_OF_CERTIFICATE=ISNULL(d2.DEMRM_TOTAL_CERTIFICATES,0),REJREASON = [citrus_usr].[fn_splitstrin_byspace](isnull(rej.descp,''),'20','',1)
					,'' DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM demrm_mak d2 left outer join DEMAT_REQUEST_MSTR d1 on d1.demrm_dpam_id = d2.demrm_dpam_id and d1.demrm_slip_serial_no = d2.demrm_slip_serial_no
					,citrus_usr.fn_getsubtransdtls('DEMAT_REJ_CD_NSDL') rej 
					,#ACLIST 
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND ENTM_DELETED_IND =1
					,ENTITY_MSTR E
					WHERE d2.DEMRM_DPAM_ID = DPAM_ID                    
					AND d2.DEMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					AND d2.DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT + ' 23:59:59'
					--and d2.DEMRM_REQUEST_DT between eff_from and eff_to
					and d2.demrm_isin = isin_cd
					AND LTRIM(RTRIM(ISNULL(d2.demrm_res_desc_intobj,''))) <> '' AND LTRIM(RTRIM(ISNULL(d2.demrm_res_desc_compobj,''))) = ''
					and LTRIM(RTRIM(ISNULL(d2.demrm_res_CD_intobj,''))) = rej.cd
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND d2.DEMRM_DELETED_IND = 0
					ORDER BY d2.DEMRM_LST_UPD_DT ,d1.DEMRM_TRANSACTION_NO,E.ENTM_NAME1,group_cd,d2.DEMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
PRINT CONVERT(VARCHAR(22),GETDATE(),109)
			END


			IF @PA_STATUS_FOR = 'PR'
			BEGIN
					SELECT demrm_id,E.ENTM_NAME1,group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO,DRN_NO=ISNULL(DEMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD
                    ,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
                    ,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103),
					DISP_DT = CONVERT(VARCHAR(11),DISP_DT,103),REQ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)),NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0),DISPID = DISP_ID ,consno = ISNULL(disp_cons_no,'')
					,DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM DEMAT_REQUEST_MSTR,#ACLIST
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,ENTITY_MSTR E,DMAT_DISPATCH
					WHERE DEMRM_DPAM_ID = DPAM_ID
					AND DEMRM_ID = DISP_DEMRM_ID AND  DISP_TO = 'R'
					AND DPM_ID = @@L_DPM_ID
					AND DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and DEMRM_REQUEST_DT between eff_from and eff_to
					and demrm_isin = isin_cd
					AND LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) = '' AND LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) = ''
					AND DEMRM_STATUS <> '1C'
					AND ISNULL(DISP_DEMRM_ID,0) <> 0
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND DEMRM_DELETED_IND = 1
					ORDER BY DEMRM_LST_UPD_DT ,DRN_NO,E.ENTM_NAME1,group_cd,DEMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
			END
			IF @PA_STATUS_FOR = 'PD'
			BEGIN
print '111'
					SELECT demrm_id,E.ENTM_NAME1,group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO,DRN_NO=ISNULL('',''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=[citrus_usr].[fn_splitstrin_byspace](ISIN_NAME,'15','',1),ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
					,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103),
					REQ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)),NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0)
					,'' DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM demrm_mak,#ACLIST
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,ENTITY_MSTR E
					WHERE DEMRM_DPAM_ID = DPAM_ID
					AND DPM_ID = @@L_DPM_ID
					AND DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and DEMRM_REQUEST_DT between eff_from and eff_to
					and demrm_isin = isin_cd
					AND LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) = '' AND LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) = ''
					AND ISNULL(DEMRM_STATUS,'P') in( 'P','S')
					AND NOT EXISTS(SELECT DISP_DEMRM_ID  FROM DMAT_DISPATCH WHERE DISP_DEMRM_ID = DEMRM_ID AND DISP_TO = 'R')
					AND group_cd = E.entm_ID
					AND E.ENTM_DELETED_IND = 1
					AND DEMRM_DELETED_IND = 0 
					ORDER BY DEMRM_LST_UPD_DT ,DRN_NO,E.ENTM_NAME1,group_cd,DEMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
			END
            IF @PA_STATUS_FOR = 'AN' -- Accepted by NSDL
			BEGIN
					SELECT demrm_id,E.ENTM_NAME1,group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO,DRN_NO=ISNULL(DEMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=[citrus_usr].[fn_splitstrin_byspace](ISIN_NAME,'15','',1),ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103),
					REQ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)),NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0)
					,'' DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM DEMAT_REQUEST_MSTR,#ACLIST
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,ENTITY_MSTR E
					WHERE DEMRM_DPAM_ID = DPAM_ID
					AND DPM_ID = @@L_DPM_ID
					AND DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and DEMRM_REQUEST_DT between eff_from and eff_to
					and demrm_isin = isin_cd
					AND LTRIM(RTRIM(ISNULL(DEMRM_INTERNAL_REJ,''))) = '' AND LTRIM(RTRIM(ISNULL(DEMRM_COMPANY_OBJ,''))) = ''
					AND ISNULL(DEMRM_STATUS,'P') in ('A1')
					AND NOT EXISTS(SELECT DISP_DEMRM_ID  FROM DMAT_DISPATCH WHERE DISP_DEMRM_ID = DEMRM_ID AND DISP_TO = 'R')
					AND group_cd = E.entm_ID
					AND E.ENTM_DELETED_IND = 1
					AND DEMRM_DELETED_IND = 1
					ORDER BY DEMRM_LST_UPD_DT ,DRN_NO,E.ENTM_NAME1,group_cd,DEMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
			END
			IF @PA_STATUS_FOR = 'DR'
			BEGIN
			print '12'
print 'rr'
 

					SELECT demrm_id,E.ENTM_NAME1,group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO,DRN_NO=ISNULL(DEMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD,
					--REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
					REGISTRAR_NAME=R.ENTM_NAME1 --+ ' ' +  isin_adrcity + ' ' + isin_adrzip
					,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103),DISP_DT=CONVERT(VARCHAR(11),DISP_DT,103),
					REQ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)),
					NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0),DISPID = DISP_ID ,consno = ISNULL(disp_cons_no,'')
					,DISP_NAME
					--,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBSMS') MOBILE
					FROM DEMAT_REQUEST_MSTR
					LEFT OUTER JOIN DMAT_DISPATCH ON DEMRM_ID = DISP_DEMRM_ID AND DISP_TO = 'R'
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,#ACLIST ,ENTITY_MSTR E
					WHERE DEMRM_DPAM_ID = DPAM_ID
					AND DEMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					AND DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and DEMRM_REQUEST_DT between eff_from and eff_to
					and demrm_isin = isin_cd
					AND ISNULL(DISP_DEMRM_ID,0) <> 0
					AND group_cd = E.entm_ID
					AND E.ENTM_DELETED_IND = 1
					AND DEMRM_DELETED_IND = 1
					ORDER BY DEMRM_LST_UPD_DT ,DRN_NO, E.ENTM_NAME1,group_cd,DISP_DT,DPAM_SBA_NO,ISIN_NAME
			END
			IF @PA_STATUS_FOR = 'DC'
			BEGIN
					SELECT demrm_id,E.ENTM_NAME1,group_cd,DRF_NO=DEMRM_SLIP_SERIAL_NO,DRN_NO=ISNULL(DEMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
,REQUEST_DT=CONVERT(VARCHAR(11),DEMRM_REQUEST_DT,103),DISP_DT=CONVERT(VARCHAR(11),DISP_DT,103),
					REQ_QTY=convert(numeric(16,3),ISNULL(DEMRM_QTY,0)),
					NO_OF_CERTIFICATE=ISNULL(DEMRM_TOTAL_CERTIFICATES,0),DISPID = DISP_ID ,consno = ISNULL(disp_cons_no,'')
					,DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM DEMAT_REQUEST_MSTR 
					LEFT OUTER JOIN DMAT_DISPATCH ON DEMRM_ID = DISP_DEMRM_ID AND DISP_TO = 'C'
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,#ACLIST ,ENTITY_MSTR E
					WHERE DEMRM_DPAM_ID = DPAM_ID
					AND DEMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					--AND DEMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
                    AND DISP_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and DEMRM_REQUEST_DT between eff_from and eff_to
					and demrm_isin = isin_cd
					AND ISNULL(DISP_DEMRM_ID,0) <> 0
					AND group_cd = E.entm_ID
					AND E.ENTM_DELETED_IND = 1
					AND DEMRM_DELETED_IND = 1			
					ORDER BY DEMRM_LST_UPD_DT ,DRN_NO,E.ENTM_NAME1,group_cd,DISP_DT,DPAM_SBA_NO,ISIN_NAME
			END
	END
	IF @PA_IO_TYPE = 'R'
	BEGIN
			IF @PA_STATUS_FOR = 'R'
			BEGIN
					SELECT remrm_id,E.ENTM_NAME1,group_cd,RRF_NO=REMRM_SLIP_SERIAL_NO,RRN_NO=ISNULL(REMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
,REQUEST_DT=CONVERT(VARCHAR(11),REMRM_REQUEST_DT,103),
					REJ_DT=CONVERT(VARCHAR(11),REMRM_EXECUTION_DT,103),REQ_QTY=convert(numeric(16,3),ISNULL(REMRM_QTY,0)),REJ_QTY=convert(numeric(16,3),ISNULL(REMRM_QTY,0)-ISNULL(REMRM_CONVERTED_QTY,0)),
					NO_OF_CERTIFICATE=ISNULL(REMRM_CERTIFICATE_NO,0),REJREASON = [citrus_usr].[fn_splitstrin_byspace](isnull(rej.descp,''),'20','',1)
					,'' DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM REMAT_REQUEST_MSTR
					,citrus_usr.fn_getsubtransdtls('DEMAT_REJ_CD_NSDL') rej 
					,#ACLIST 
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON (ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END) AND (R.ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END) AND R.ENTM_DELETED_IND =1
					,ENTITY_MSTR E
					WHERE REMRM_DPAM_ID = DPAM_ID
					AND REMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					AND REMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and REMRM_REQUEST_DT between eff_from and eff_to
					and Remrm_isin = isin_cd
					AND LTRIM(RTRIM(ISNULL(REMRM_REJECTION_CD,''))) <> ''
					and LTRIM(RTRIM(ISNULL(REMRM_REJECTION_CD,''))) = rej.cd
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND REMRM_DELETED_IND = 1
					ORDER BY rEMRM_LST_UPD_DT ,RRN_NO,E.ENTM_NAME1,group_cd,REMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
			END
			IF @PA_STATUS_FOR = 'PR'
			BEGIN
					SELECT remrm_id,E.ENTM_NAME1,group_cd,RRF_NO=REMRM_SLIP_SERIAL_NO,RRN_NO=ISNULL(REMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
,REQUEST_DT=CONVERT(VARCHAR(11),REMRM_REQUEST_DT,103),
					DISP_DT = CONVERT(VARCHAR(11),DISPR_DT,103),REQ_QTY=convert(numeric(16,3),ISNULL(REMRM_QTY,0)),NO_OF_CERTIFICATE=ISNULL(REMRM_CERTIFICATE_NO,0),DISPID = DISPr_ID,consno = ISNULL(dispr_cons_no,'')
					,REJREASON = ''
					,DISPR_NAME DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM REMAT_REQUEST_MSTR,#ACLIST
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,ENTITY_MSTR E,DMAT_DISPATCH_REMAT
					WHERE REMRM_DPAM_ID = DPAM_ID
					AND REMRM_ID = DISPR_REMRM_ID AND  DISPR_TO = 'R'
					AND DPM_ID = @@L_DPM_ID
					AND REMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and REMRM_REQUEST_DT between eff_from and eff_to
					and Remrm_isin = isin_cd
					AND LTRIM(RTRIM(ISNULL(REMRM_REJECTION_CD,''))) = '' 
					AND REMRM_STATUS <> '1C'
					AND ISNULL(DISPR_REMRM_ID,0) <> 0
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND REMRM_DELETED_IND = 1
					ORDER BY rEMRM_LST_UPD_DT ,RRN_NO,E.ENTM_NAME1,group_cd,REMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
			END
			IF @PA_STATUS_FOR = 'PD'
			BEGIN
					SELECT remrm_id,E.ENTM_NAME1,group_cd,RRF_NO=REMRM_SLIP_SERIAL_NO,RRN_NO=ISNULL(REMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=[citrus_usr].[fn_splitstrin_byspace](ISIN_NAME,'15','',1),ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
,REQUEST_DT=CONVERT(VARCHAR(11),REMRM_REQUEST_DT,103),
					REQ_QTY=convert(numeric(16,3),ISNULL(REMRM_QTY,0)),NO_OF_CERTIFICATE=ISNULL(REMRM_CERTIFICATE_NO,0)
					,'' DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM REMAT_REQUEST_MSTR,#ACLIST
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,ENTITY_MSTR E
					WHERE REMRM_DPAM_ID = DPAM_ID
					AND DPM_ID = @@L_DPM_ID
					AND REMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and REMRM_REQUEST_DT between eff_from and eff_to
					and Remrm_isin = isin_cd
					AND LTRIM(RTRIM(ISNULL(REMRM_INTERNAL_REJ,''))) = '' AND LTRIM(RTRIM(ISNULL(REMRM_COMPANY_OBJ,''))) = ''
					AND ISNULL(REMRM_STATUS,'P') = 'P'
					AND NOT EXISTS(SELECT DISPR_REMRM_ID  FROM DMAT_DISPATCH_REMAT WHERE DISPR_REMRM_ID = REMRM_ID AND DISPR_TO = 'R')
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND REMRM_DELETED_IND = 1
					ORDER BY rEMRM_LST_UPD_DT ,RRN_NO,E.ENTM_NAME1,group_cd,REMRM_REQUEST_DT,DPAM_SBA_NO,ISIN_NAME
			END
			IF @PA_STATUS_FOR = 'DR'
			BEGIN
					SELECT remrm_id,E.ENTM_NAME1,group_cd,RRF_NO=REMRM_SLIP_SERIAL_NO,RRN_NO=ISNULL(REMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD,
REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
,REQUEST_DT=CONVERT(VARCHAR(11),REMRM_REQUEST_DT,103),DISP_DT=CONVERT(VARCHAR(11),DISPR_DT,103),
					REQ_QTY=convert(numeric(16,3),ISNULL(REMRM_QTY,0)),
					NO_OF_CERTIFICATE=ISNULL(REMRM_CERTIFICATE_NO,0),DISPID = DISPr_ID,consno = ISNULL(dispr_cons_no,'')
					,DISPR_NAME DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM REMAT_REQUEST_MSTR
					LEFT OUTER JOIN DMAT_DISPATCH_REMAT ON REMRM_ID = DISPR_REMRM_ID AND DISPR_TO = 'R'
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,#ACLIST ,ENTITY_MSTR E
					WHERE REMRM_DPAM_ID = DPAM_ID
					AND REMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					AND REMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and REMRM_REQUEST_DT between eff_from and eff_to
					and Remrm_isin = isin_cd
					AND ISNULL(DISPR_REMRM_ID,0) <> 0
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND REMRM_DELETED_IND = 1
					ORDER BY rEMRM_LST_UPD_DT ,RRN_NO,E.ENTM_NAME1,group_cd,DISPR_DT,DPAM_SBA_NO,ISIN_NAME
			END
			IF @PA_STATUS_FOR = 'DC'
			BEGIN
					SELECT remrm_id,E.ENTM_NAME1,group_cd,RRF_NO=REMRM_SLIP_SERIAL_NO,RRN_NO=ISNULL(REMRM_TRANSACTION_NO,''),ACCT_NO=DPAM_SBA_NO,CLIENT_NAME=DPAM_SBA_NAME,
					COMP_NAME=ISIN_NAME,ISIN_CD,REGISTRAR_NAME= case when citrus_usr.ufn_countstring(replace(R.ENTM_NAME1,' ','|'),'|') > 1 then  [citrus_usr].fn_splitstrin_byspace_for_print(R.ENTM_NAME1,'15','',1) else R.ENTM_NAME1 end 
,REQUEST_DT=CONVERT(VARCHAR(11),REMRM_REQUEST_DT,103),DISP_DT=CONVERT(VARCHAR(11),DISPR_DT,103),
					REQ_QTY=convert(numeric(16,3),ISNULL(REMRM_QTY,0)),
					NO_OF_CERTIFICATE=ISNULL(REMRM_CERTIFICATE_NO,0),DISPID = DISPr_ID,consno = ISNULL(dispr_cons_no,'')
					,DISPR_NAME DISP_NAME
					,citrus_usr.[fn_conc_value_DPAM_ID](DPAM_ID  , 'MOBILE1') MOBILE
					FROM REMAT_REQUEST_MSTR 
					LEFT OUTER JOIN DMAT_DISPATCH_REMAT ON REMRM_ID = DISPR_REMRM_ID AND DISPR_TO = 'C' 
					,ISIN_MSTR LEFT OUTER JOIN ENTITY_MSTR R ON ISIN_REG_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN  replace(ltrim(rtrim(R.entm_short_name)),'RTA_','') ELSE ltrim(rtrim(R.entm_short_name)) END AND ENTM_ENTTM_CD = CASE WHEN @PA_DPTYPE = 'CDSL' THEN 'RTA' ELSE 'SR' END AND R.ENTM_DELETED_IND =1
					,#ACLIST ,ENTITY_MSTR E
					WHERE REMRM_DPAM_ID = DPAM_ID
					AND REMRM_ISIN = ISIN_CD
					AND DPM_ID = @@L_DPM_ID
					AND REMRM_REQUEST_DT BETWEEN @PA_FROM_DT AND @PA_TO_DT 
					and REMRM_REQUEST_DT between eff_from and eff_to
					and Remrm_isin = isin_cd
					AND ISNULL(DISPR_REMRM_ID,0) <> 0
					AND group_cd = E.ENTM_ID
					AND E.ENTM_DELETED_IND = 1
					AND REMRM_DELETED_IND = 1			
					ORDER BY rEMRM_LST_UPD_DT ,RRN_NO,E.ENTM_NAME1,group_cd,DISPR_DT,DPAM_SBA_NO,ISIN_NAME
			END	END


END

GO
