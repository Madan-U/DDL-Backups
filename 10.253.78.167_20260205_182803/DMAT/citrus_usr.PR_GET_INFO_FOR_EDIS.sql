-- Object: PROCEDURE citrus_usr.PR_GET_INFO_FOR_EDIS
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------


-- EXEC PR_GET_INFO_FOR_CLIENTLOGIN 3,'VIEW','01/04/2009', '02/04/2009','','','',''    

--NLYKMLPNSPACVKNRW168P3EWAI2S9ZY8VNRGKUWNA0O=|*~|1206030000000025 |*~|*|~*RAVKXEFBL/6LDTNHND5O5FZPOOVNA+UMOE7TZKDCNRI=|*~|1206030000000031 |*~|*|~*

Create PROCEDURE [citrus_usr].[PR_GET_INFO_FOR_EDIS]

(

@PA_ID NUMERIC,

@PA_ACTION VARCHAR(10),

@PA_FROM_DT DATETIME, 

@PA_TO_DT DATETIME,

@PA_FROM_SBA_NO VARCHAR(50),

@PA_TO_SBA_NO VARCHAR(50),

@PA_VALUES VARCHAR(8000),

@PA_ERRMSG VARCHAR(8000)

)    



AS    

BEGIN  

 DECLARE @L_ROL_ID NUMERIC

 SET @L_ROL_ID= 0

 SELECT @L_ROL_ID = ROL_ID FROM ROLES WHERE ROL_CD = 'CLIENTLOGIN' AND ROL_DELETED_IND = 1



SET @PA_TO_DT =  DATEADD(HOUR, 23, @PA_TO_DT) 



IF @PA_FROM_SBA_NO = ''

BEGIN

  SET @PA_FROM_SBA_NO = '0'

  SET  @PA_TO_SBA_NO = '9999999999999999'

END

IF @PA_TO_SBA_NO = ''

BEGIN

    SET  @PA_TO_SBA_NO = @PA_FROM_SBA_NO

END



if @PA_FROM_DT='1900-01-01 00:00:00.000' and @PA_TO_DT='1900-01-01 23:00:00.000'

begin 

set @PA_FROM_DT='jan 01 1900' 

set @PA_TO_DT='jan 01 2900' 

end





IF @PA_ACTION = 'VIEW'  

BEGIN  



    



	SELECT DPAM_SBA_NAME     

	 , DPAM_SBA_NO     

	 , LTRIM(RTRIM(ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO , 'PAN_GIR_NO',''),''))) PAN_NO     

	 --, ENTTM_ID     

	 --, DPAM_CRN_NO    

	 --, CLIM_SHORT_NAME     

	 --, GETDATE()    

	 --, 'DEC 31 2100'    

	 --, 1 , 'MIG',GETDATE(),'MIG',GETDATE(), 1, 0, 0, 0, 'A'    

	 ,ISNULL( CITRUS_USR.FN_CONC_VALUE(DPAM_CRN_NO , 'EMAIL1'),'') EMAIL     

	 FROM CLIENT_MSTR , DP_ACCT_MSTR , ENTITY_TYPE_MSTR     

	 WHERE CLIM_CRN_NO = DPAM_CRN_NO     

	 AND   DPAM_ENTTM_CD = ENTTM_CD    

	 AND   DPAM_SBA_NO BETWEEN @PA_FROM_SBA_NO AND @PA_TO_SBA_NO  

	 AND   DPAM_DELETED_IND = 1    

	 AND   ENTTM_DELETED_IND = 1    

	 AND   CLIM_DELETED_IND = 1    

	 AND   DPAM_LST_UPD_DT >= @PA_FROM_DT  AND DPAM_LST_UPD_DT <= @PA_TO_DT      

	 AND   CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO , 'PAN_GIR_NO','') <> '' 

	 AND   RIGHT(DPAM_SBA_NO,16) NOT IN (SELECT LOGN_NAME FROM LOGIN_NAMES)  

	 AND   DPAM_STAM_CD = 'ACTIVE'  

	

 

END   

ELSE IF @PA_ACTION = 'SELECT'  
BEGIN  

Select * from TEMP_CLIENT_DATA_FOR_LOGIN_EDIS

END

ELSE IF @PA_ACTION = 'SAVE'  

BEGIN    



 IF @PA_VALUES = ''

 BEGIN

 





    SELECT RIGHT(DPAM_SBA_NO,16)  DPAM_SBA_NO   

	 , PAN_AS_PSW PAN_NO     

	 , ENTTM_ID     

	 , DPAM_CRN_NO    

	 , CLIM_SHORT_NAME     

	 , GETDATE()    FROM_DT

	 , 'DEC 31 2100'     TO_DT 

	 --, 1 , 'MIG',GETDATE(),'MIG',GETDATE(), 1, 0, 0, 0, 'A' ,''   

	 , ISNULL( CITRUS_USR.FN_CONC_VALUE(DPAM_CRN_NO , 'EMAIL1'),'') EMAIL ,'V'     PREF

	 INTO #TEMPCLIENTDATA FROM CLIENT_MSTR , DP_ACCT_MSTR , ENTITY_TYPE_MSTR , TEMP_CLIENT_DATA_FOR_LOGIN    

	 WHERE CLIM_CRN_NO = DPAM_CRN_NO     

     AND   SBA_NO = DPAM_SBA_NO

	 AND   DPAM_ENTTM_CD = ENTTM_CD    

	 --AND   DPAM_SBA_NO BETWEEN @PA_FROM_SBA_NO AND @PA_TO_SBA_NO  

	 AND   DPAM_DELETED_IND = 1    

	 AND   ENTTM_DELETED_IND = 1    

	 AND   CLIM_DELETED_IND = 1    

	 AND   DPAM_LST_UPD_DT >= @PA_FROM_DT  AND DPAM_LST_UPD_DT <= @PA_TO_DT      

	 AND   CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO , 'PAN_GIR_NO','') <> ''  

     AND   RIGHT(DPAM_SBA_NO,16) NOT IN (SELECT LOGN_NAME FROM LOGIN_NAMES)  



   INSERT INTO LOGIN_NAMES

   SELECT DPAM_SBA_NO     

	 , PAN_NO     

	 , ENTTM_ID     

	 , DPAM_CRN_NO    

	 , CLIM_SHORT_NAME     

	 , FROM_DT

	 , TO_DT

	 , 1 , 'MIG',GETDATE(),'MIG',GETDATE(), 1, 0, 0, 0, 'A' ,''   

	 ,  EMAIL ,PREF  ,0,''   

	 FROM #TEMPCLIENTDATA



    INSERT INTO ENTITY_ROLES 

    SELECT RIGHT(DPAM_SBA_NO,16) , FROM_DT, @L_ROL_ID, 'MIG',GETDATE(),'MIG',GETDATE(), 1 FROM #TEMPCLIENTDATA WHERE @L_ROL_ID <> 0

 END 

 ELSE IF @PA_VALUES <> ''

 BEGIN

 

    DECLARE @L_COUNT NUMERIC

           ,@L_COUNTER NUMERIC

           ,@L_ROW_VAL VARCHAR(8000)

    DECLARE @L_TEMPLOGINTBL TABLE(SBA_NO VARCHAR(16),PASSWORD VARCHAR(8000))



    SET @L_COUNTER = 1

    SELECT @L_COUNT = CITRUS_USR.UFN_COUNTSTRING(@PA_VALUES ,'*|~*')

    

    WHILE  @L_COUNTER <= @L_COUNT

    BEGIN

      SELECT @L_ROW_VAL = CITRUS_USR.FN_SPLITVAL_ROW(@PA_VALUES,@L_COUNTER)



      INSERT INTO @L_TEMPLOGINTBL

      SELECT CITRUS_USR.FN_SPLITVAL(@L_ROW_VAL ,2), CITRUS_USR.FN_SPLITVAL(@L_ROW_VAL ,1)



      SET @L_COUNTER = @L_COUNTER + 1

    END



    SELECT RIGHT(DPAM_SBA_NO,16)      DPAM_SBA_NO

	 , PASSWORD PAN_NO     

	 , ENTTM_ID     

	 , DPAM_CRN_NO    

	 , CLIM_SHORT_NAME     

	 , GETDATE()    FROM_DT

	 , 'DEC 31 2100'     TO_DT 

	 --, 1 , 'MIG',GETDATE(),'MIG',GETDATE(), 1, 0, 0, 0, 'A' ,''   

	 , ISNULL( CITRUS_USR.FN_CONC_VALUE(DPAM_CRN_NO , 'EMAIL1'),'') EMAIL ,'V'     PREF

	 INTO #TEMPCLIENTDATA1 FROM CLIENT_MSTR , DP_ACCT_MSTR , ENTITY_TYPE_MSTR  , @L_TEMPLOGINTBL   

	 WHERE CLIM_CRN_NO = DPAM_CRN_NO     

     AND   SBA_NO = DPAM_SBA_NO

	 AND   DPAM_ENTTM_CD = ENTTM_CD    

	 --AND   DPAM_SBA_NO BETWEEN @PA_FROM_SBA_NO AND @PA_TO_SBA_NO  

	 AND   DPAM_DELETED_IND = 1    

	 AND   ENTTM_DELETED_IND = 1    

	 AND   CLIM_DELETED_IND = 1    

	 AND   DPAM_LST_UPD_DT >= @PA_FROM_DT  AND DPAM_LST_UPD_DT <= @PA_TO_DT      

	 AND   CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO , 'PAN_GIR_NO','') <> ''  

     AND   RIGHT(DPAM_SBA_NO,16) NOT IN (SELECT LOGN_NAME FROM LOGIN_NAMES)  



   INSERT INTO LOGIN_NAMES

   SELECT DPAM_SBA_NO     

	 , PAN_NO     

	 , ENTTM_ID     

	 , DPAM_CRN_NO    

	 , CLIM_SHORT_NAME     

	 , FROM_DT

	 , TO_DT

	 , 1 , 'MIG',GETDATE(),'MIG',GETDATE(), 1, 0, 0, 0, 'A' ,''   

	 ,  EMAIL ,PREF  ,0,''   

	 FROM #TEMPCLIENTDATA1



    INSERT INTO ENTITY_ROLES 

    SELECT RIGHT(DPAM_SBA_NO,16) , FROM_DT, @L_ROL_ID, 'MIG',GETDATE(),'MIG',GETDATE(), 1 FROM #TEMPCLIENTDATA1 WHERE @L_ROL_ID <> 0

 END 

 

END   

  

END

GO
