-- Object: PROCEDURE citrus_usr.CLASS_AUTO_PROCESS_FILE
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

CREATE PROC [citrus_usr].[CLASS_AUTO_PROCESS_FILE] (@FILEPATH VARCHAR(100), @BUSINESS_DATE VARCHAR(11), @FLD_FILEDATE DATETIME OUTPUT, @FLD_FILENAME VARCHAR(200) OUTPUT)          
AS           
  
DECLARE @FILEPATH_INTERNAL VARCHAR(100)  
SET @FILEPATH_INTERNAL       =replace(@FILEPATH,'*','')  
  
  
SET @FILEPATH = 'DIR "' + @FILEPATH + '" /c'     
  --print @FILEPATH
CREATE TABLE #FILELIST           
( FILENAMELIST VARCHAR(100))          
INSERT INTO #FILELIST           
EXEC MASTER.DBO.XP_CMDSHELL @FILEPATH         
    
  
  
UPDATE #FILELIST SET FILENAMELIST = REPLACE(FILENAMELIST,' ','#')    
WHERE FILENAMELIST IS NOT NULL    
AND FILENAMELIST LIKE '%'    
AND FILENAMELIST LIKE '%/%'    
  
  
  
SELECT FLD_FILEDATE=CONVERT(DATETIME,LEFT(CONVERT(DATETIME,LTRIM(RTRIM(CITRUS_USR.PIECE(FILENAMELIST,'#',1))),101),11) + ' ' + LTRIM(RTRIM(CITRUS_USR.PIECE(FILENAMELIST,'#',3))) + ' ' + LTRIM(RTRIM(CITRUS_USR.PIECE(FILENAMELIST,'#',4)))),    
FLD_FILENAME=LTRIM(RTRIM(REVERSE(CITRUS_USR.PIECE(REVERSE(FILENAMELIST),'#',1))))    
INTO #FILELISTNEW       
FROM #FILELIST     
WHERE FILENAMELIST IS NOT NULL    
AND FILENAMELIST LIKE '%'    
AND FILENAMELIST LIKE '%/%'    
AND LTRIM(RTRIM(REVERSE(CITRUS_USR.PIECE(REVERSE(FILENAMELIST),'#',1)))) LIKE '%.%'    
  
--print @FILEPATH_INTERNAL
--print @BUSINESS_DATE

--SELECT FLD_FILENAME FROM TBL_AUTO_PROCESS_FILE_PATH F    
--WHERE CONVERT(VARCHAR,F.FLD_FILEDATE,109) LIKE @BUSINESS_DATE + '%'    
--and F.FLD_FILEPATH LIKE @FILEPATH_INTERNAL + '%'  
      
SELECT TOP 1 @FLD_FILEDATE = FLD_FILEDATE, @FLD_FILENAME = FLD_FILENAME FROM #FILELISTNEW N    
WHERE CONVERT(VARCHAR,FLD_FILEDATE,109) LIKE @BUSINESS_DATE + '%'    
--AND FLD_FILENAME NOT IN (SELECT FLD_FILENAME FROM TBL_AUTO_PROCESS_FILE F    
--WHERE CONVERT(VARCHAR,F.FLD_FILEDATE,109) LIKE @BUSINESS_DATE + '%'    
--AND N.FLD_FILEDATE = F.FLD_FILEDATE)    
AND FLD_FILENAME NOT IN (SELECT FLD_FILENAME FROM TBL_AUTO_PROCESS_FILE_PATH F    
WHERE CONVERT(VARCHAR,F.FLD_FILEDATE,109) LIKE @BUSINESS_DATE + '%'    
AND convert(varchar(11),N.FLD_FILEDATE,103) = convert(varchar(11),F.FLD_FILEDATE,103) and F.FLD_FILEPATH LIKE @FILEPATH_INTERNAL + '%'  
  
)  
ORDER BY FLD_FILEDATE --desc   

--print @FLD_FILEDATE
--print @FLD_FILENAME

GO
