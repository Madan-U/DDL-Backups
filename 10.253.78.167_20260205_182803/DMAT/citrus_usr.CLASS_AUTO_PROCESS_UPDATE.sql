-- Object: PROCEDURE citrus_usr.CLASS_AUTO_PROCESS_UPDATE
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

CREATE PROCEDURE [citrus_usr].[CLASS_AUTO_PROCESS_UPDATE]      
(      
 @PROCESSDATE VARCHAR(11),      
 @PROCESSFLAG VARCHAR(2),      
 @PROCESSID VARCHAR(max),      
 @TIME VARCHAR(5),      
 @UNAME VARCHAR(25),      
 @STATUSNAME VARCHAR(25),      
 @REQIP VARCHAR(100),      
 @STATUSID VARCHAR(25)      
)      
AS      
--exec CLASS_AUTO_PROCESS_UPDATE @PROCESSDATE='19/12/2014',@PROCESSFLAG='RS',@PROCESSID='51~63~55~59~',@TIME='15:52',@STATUSID='Broker',@STATUSNAME='Broker',@UNAME='YatinN',@REQIP='::1'      
      
      
/*      
 @PROCESSFLAG  : RS - RE SCHEDULE PROCESS      
 @PROCESSFLAG  : RM - MARK TO RESUMING A PROCESS      
 @PROCESSFLAG  : CM - MARK TO PROCESS COMPLETED      
      
 PROCESS_STATUS = 0  - 'PENDING'       
 PROCESS_STATUS = 100 - 'COMPLETTED'       
 PROCESS_STATUS = 99  - 'IN - PROCESS'       
 ELSE     -'HALT DUE TO SOME ISSUE'      
       
*/      
      
SET @PROCESSDATE = LEFT(CONVERT(DATETIME,@PROCESSDATE,103),11)      
      
DECLARE @NEWSTART_TIME DATETIME      
DECLARE @ERRCODE INT      
DECLARE @ERRSDESC VARCHAR(100)      
      
CREATE TABLE #PROCESSID (PSNO INT IDENTITY(1,1), PROCID INT)      
INSERT INTO #PROCESSID       
SELECT * FROM citrus_usr.fnSplitString2Tbl(@PROCESSID,'~')      
      
--------------------------------- RE SCHEDULE ----------------------------------      
IF @PROCESSFLAG='RS'        
BEGIN      
 SET @NEWSTART_TIME = CONVERT(DATETIME, @PROCESSDATE + ' ' + @TIME)      
 IF @NEWSTART_TIME < GETDATE()      
 BEGIN      
  SET @ERRCODE = -1      
  SET @ERRSDESC = 'INVALID PROCESS START NEW TIME'      
  SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC      
  RETURN      
 END      
        
 UPDATE TBL_AUTO_PROCESS_DETAIL SET       
 PROCESS_START_DATE = @NEWSTART_TIME,       
 PROCESS_END_DATE  = DATEADD(MI,  DATEDIFF(MI,PROCESS_START_DATE,PROCESS_END_DATE),@NEWSTART_TIME)      
 FROM #PROCESSID B      
 WHERE PROCESS_DATE = @PROCESSDATE      
 AND PROCESS_ID = B.PROCID      
 AND PROCESS_START_DATE < @NEWSTART_TIME      
      
 DROP TABLE #PROCESSID      
       
 SET @ERRCODE = 0      
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'      
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC      
 RETURN      
END      
      
      
--------------------------------- MARK TO RESUMING A PROCESS ---------------------------------      
IF @PROCESSFLAG='RM'        
BEGIN      
 SET @NEWSTART_TIME = CONVERT(DATETIME, @PROCESSDATE + ' ' + CONVERT(VARCHAR(5),GETDATE(),114))      
       
 UPDATE TBL_AUTO_PROCESS_DETAIL SET  PROCESS_STATUS = 0      
 FROM #PROCESSID B      
 WHERE PROCESS_DATE = @PROCESSDATE      
 AND PROCESS_ID = B.PROCID      
       
 -- RE SCHEDULING TO NEW TIMING       
 UPDATE TBL_AUTO_PROCESS_DETAIL SET       
 PROCESS_START_DATE = @NEWSTART_TIME,       
 PROCESS_END_DATE  = DATEADD(MI,  DATEDIFF(MI,PROCESS_START_DATE,PROCESS_END_DATE),@NEWSTART_TIME)      
 FROM #PROCESSID B      
 WHERE PROCESS_DATE = @PROCESSDATE      
 AND PROCESS_ID = B.PROCID      
 AND PROCESS_START_DATE < @NEWSTART_TIME      
      
 DROP TABLE #PROCESSID      
       
 SET @ERRCODE = 0      
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'      
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC      
 RETURN      
      
END      
       
--------------------------------- MARK TO COMPLETE ---------------------------------      
IF @PROCESSFLAG='CM'         
BEGIN      
       
 UPDATE TBL_AUTO_PROCESS_DETAIL SET  PROCESS_STATUS = 100,    
 PROCESS_HALTED_REASON = 'MARKED SUCCESS BY THE USER ' + upper(@UNAME),    
 PROCESS_STATUS_ALERT = 1, PROCESS_STATUS_ALERT_COUNT = 1,    
 PROCESS_ENDED_DATE = GETDATE()    
 FROM #PROCESSID B      
 WHERE PROCESS_DATE = @PROCESSDATE      
 AND PROCESS_ID = B.PROCID      
 AND B.PSNO = 1     
    
UPDATE TBL_AUTO_PROCESS_DETAIL SET  IS_DEPEND_ON = Replace(IS_DEPEND_ON,'#'+CONVERT(VARCHAR,C.PROCID)+',','')     
 FROM #PROCESSID B, #PROCESSID C      
 WHERE PROCESS_DATE = @PROCESSDATE      
 AND PROCESS_ID = B.PROCID      
 AND B.PSNO <> 1     
 AND C.PSNO = 1    
      
 DROP TABLE #PROCESSID      
       
 SET @ERRCODE = 0      
 SET @ERRSDESC = 'UPDATED SUCCESSFULLY'      
 SELECT @ERRCODE AS ERRCODE,@ERRSDESC AS ERRDESC      
 RETURN      
END      
      
/*------------------------------------------ END OF THE PROC ---------------------------*/

GO
