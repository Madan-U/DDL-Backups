-- Object: PROCEDURE citrus_usr.SP_CLIENT_DTLS_new
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

--exec Sp_Client_Dtls_new @pa_crn_no='00004621'


--select * from dp_acct_mstr where dpam_sba_no='1205810000007264'      
--[SP_CLIENT_DTLS_new] '357349'      
CREATE PROCEDURE [citrus_usr].[SP_CLIENT_DTLS_new]      
(@PA_CRN_NO VARCHAR(16))      
AS      
BEGIN -- MAIN      
DECLARE @C_CRN_NO CURSOR      
DECLARE @CRN_NO VARCHAR(16)      
      
SET @C_CRN_NO = CURSOR FAST_FORWARD FOR      
SELECT DISTINCT DPAM_id FROM DP_ACCT_MSTR WHERE right(DPAM_sba_NO,8) = right(@PA_CRN_NO,8) AND DPAM_DELETED_IND=1      

OPEN @C_CRN_NO      
FETCH NEXT FROM @C_CRN_NO INTO @CRN_NO      
WHILE @@FETCH_STATUS = 0                                                  
    BEGIN --#CURSOR          
    SELECT STAM_DESC   STATUS 
    ,CLICM_DESC  [CATEGORY]      
    ,SUBCM_DESC  [SUBCATEGORY]      
    ,ENTTM_DESC  [TYPE]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'PER_ADR1'),1) [PADDRESS1]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'PER_ADR1'),2) [PADDRESS2]
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'PER_ADR1'),3) [PADDRESS3]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'PER_ADR1'),4) [PCITY]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'PER_ADR1'),5) [PSTATE]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'PER_ADR1'),6) [PCOUNTRY]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'PER_ADR1'),7) [PPIN CODE]      
    ,ISNULL(CITRUS_USR.FN_CONC_VALUE(DPAM_CRN_NO,'RES_PH1'),'') [RESPHONENO]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'COR_ADR1'),1) [CADDRESS1]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'COR_ADR1'),2) [CADDRESS2]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'COR_ADR1'),3) [CADDRESS3]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'COR_ADR1'),4) [CCITY]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'COR_ADR1'),5) [CSTATE]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'COR_ADR1'),6) [CCOUNTRY]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(DPAM_CRN_NO,'COR_ADR1'),7) [CPIN CODE]      
    ,ISNULL(CITRUS_USR.FN_CONC_VALUE(DPAM_CRN_NO,'OFF_PH1'),'') [OFFPHONENO]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),1) [BADDRESS1]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),2) [BADDRESS2]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),3) [BADDRESS3]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),4) [BCITY]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),5) [BSTATE]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),6) [BCOUNTRY]      
    ,CITRUS_USR.FN_SPLITVAL(CITRUS_USR.FN_ADDR_VALUE(BANM_ID,'PER_ADR1'),7) [BPIN CODE]      
    ,BANM_NAME  
    ,ISNULL(CITRUS_USR.FN_CONC_VALUE(BANM_ID,'OFF_PH1'),'') [OFFPHONENO]      
    ,ISNULL(CITRUS_USR.FN_CONC_VALUE(DPAM_CRN_NO,'MOBILE1'),'') [MOBILE]      
    ,ISNULL(CITRUS_USR.FN_CONC_VALUE(DPAM_CRN_NO,'EMAIL1'),'') [EMAIL]      
    ,ISNULL(CITRUS_USR.FN_FIND_RELATIONS(DPAM_CRN_NO,'BR'),'') BRANCH      
    ,DPAM_SBA_NO CLIENTID      
    ,CLIM_SHORT_NAME SHORTNAME      
    ,CONVERT(VARCHAR(11),CLIM_CREATED_DT ,105) ACTDT      
    ,CLIM_NAME1      
    ,CLIBA_AC_NO      
    ,CLIBA_AC_TYPE      
    ,BANM_NAME      
    ,BANM_MICR      
    ,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO,'PAN_GIR_NO',''),'') PAN        
    ,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO,'PAN_FLAG',''),'') PANFLAG        
    ,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO,'SMS',''),'') SMS        
    ,Case when isnull(citrus_usr.fn_ucc_accp(dpam_id,'ecs_flg',''),'')=1 then 'YES' when isnull(citrus_usr.fn_ucc_accp(dpam_id,'ecs_flg',''),'')=0 then 'NO' else 'NO' end ECS  
    ,convert(char(50),ISNULL(citrus_usr.fn_ucc_accp(dpam_id,'RBI_REF_NO',''),'')) RBI_REG_NO  
    ,citrus_usr.fn_get_listing('TAX_DEDUCTION',isnull(citrus_usr.fn_ucc_entp(DPAM_CRN_NO,'TAX_DEDUCTION',''),''))  TAXDEDUCTION                                                                    --tax deduction status --20               
    ,ISNULL(DPPD_FNAME,'') DPPD_FNAME      
    ,ISNULL(DPPD_MNAME,'') DPPD_MNAME      
    ,ISNULL(DPPD_LNAME,'') DPPD_LNAME      
    ,CASE WHEN isnull(DPPD_DOB,'') ='1900-01-01 00:00:00.000' THEN '' ELSE ISNULL(DPPD_DOB,'') END DPPD_DOB      
    ,ISNULL(DPPD_PAN_NO,'')  DPPD_PAN_NO     
    ,ISNULL(DPHD_SH_FNAME,'') DPHD_SH_FNAME      
    ,ISNULL(DPHD_SH_MNAME,'') DPHD_SH_MNAME      
    ,ISNULL(DPHD_SH_LNAME,'') DPHD_SH_LNAME      
    ,CASE WHEN isnull(DPHD_SH_DOB,'') ='1900-01-01 00:00:00.000' THEN '' ELSE ISNULL(DPHD_SH_DOB,'') END DPHD_SH_DOB      
    ,ISNULL(DPHD_SH_PAN_NO,'')  DPHD_SH_PAN_NO      
    ,ISNULL(DPHD_TH_FNAME,'') DPHD_TH_FNAME      
    ,ISNULL(DPHD_TH_MNAME,'') DPHD_TH_MNAME      
    ,ISNULL(DPHD_TH_LNAME,'') DPHD_TH_LNAME      
    ,CASE WHEN isnull(DPHD_TH_DOB,'') ='1900-01-01 00:00:00.000' THEN '' ELSE ISNULL(DPHD_TH_DOB,'') END DPHD_TH_DOB      
    ,ISNULL(DPHD_TH_PAN_NO ,'') DPHD_TH_PAN_NO 
	,CASE WHEN isnull(CONVERT(VARCHAR(11),CLIM_DOB,105),'') ='1900-01-01 00:00:00.000' THEN '' ELSE ISNULL(CONVERT(VARCHAR(11),CLIM_DOB,105),'') END CLIM_DOB       
	,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO,'OCCUPATION',''),'') OCCUPATION
  --  ,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO,'EDUCATION',''),'') EDUCATION
    ,dpam_acct_no formno
    ,isnull(brom_desc,'') scheme
    ,ISNULL(CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO,'EDUCATION',''),'') EDUCATION
 ,ISNULL(CITRUS_USR.FN_ACCT_ENTPd(DPAM_CRN_NO,'RBI_REF_NO','RBI_APP_DT'),'') RBI_APP_DATE
 ,ISNULL(CITRUS_USR.FN_ACCT_ENTP(DPAM_CRN_NO,'SEBI_REG_NO'),'') SEBI_REG_NO
    ,ISNULL(CITRUS_USR.FN_UCC_ACCP(DPAM_ID,'BBO_CODE',''),'') BBO_CODE
    FROM DP_ACCT_MSTR       
      LEFT OUTER JOIN  
      client_dp_brkg     on dpam_id = clidb_dpam_id  
LEFT OUTER JOIN 
      	brokerage_mstr on brom_id = clidb_brom_id   
      left outer join 
      DP_HOLDER_DTLS ON  DPAM_ID = DPHD_DPAM_ID AND DPHD_DELETED_IND =1      
      LEFT OUTER JOIN       
      DP_POA_DTLS    ON   DPAM_ID = DPPD_DPAM_ID  AND DPPD_DELETED_IND =1      
    LEFT OUTER JOIN CLIENT_BANK_ACCTS  ON CLIBA_CLISBA_ID = DPAM_ID      
    LEFT OUTER JOIN BANK_MSTR ON CLIBA_BANM_ID = BANM_ID         
    ,CLIENT_CTGRY_MSTR      
    ,ENTITY_TYPE_MSTR      
    ,STATUS_MSTR      
    ,SUB_CTGRY_MSTR       
    ,CLIENT_MSTR      
  
    WHERE DPAM_id   = @CRN_NO       
    AND   DPAM_CLICM_CD = CLICM_CD       
    AND   DPAM_ENTTM_CD = ENTTM_CD      
    AND   DPAM_STAM_CD  = STAM_CD      
    AND   DPAM_SUBCM_CD = SUBCM_CD      
    AND   CLICM_ID      = SUBCM_CLICM_ID      
    AND   CLIM_CRN_NO   = DPAM_CRN_NO       
 
  
         
      
          FETCH NEXT FROM @C_CRN_NO INTO @CRN_NO       
    END --#CURSOR          
   CLOSE @C_CRN_NO                                                  
   DEALLOCATE @C_CRN_NO             
END -- MAIN

GO
