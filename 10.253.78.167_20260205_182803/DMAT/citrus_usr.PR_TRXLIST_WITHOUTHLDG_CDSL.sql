-- Object: PROCEDURE citrus_usr.PR_TRXLIST_WITHOUTHLDG_CDSL
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

-- PR_TRXLIST_WITHOUTHLDG '4','Jun  1 2009','Jun 30 2009','10000014',''
CREATE PROCEDURE [citrus_usr].[PR_TRXLIST_WITHOUTHLDG_CDSL]
(
@PA_EXCSM_ID INTEGER,
@PA_FROMDT VARCHAR(20),
@PA_TODT VARCHAR(20),
@PA_FROMACCT VARCHAR(20),
@PA_TOACCT VARCHAR(20)
)
AS 
BEGIN 
--IF @PA_FROMACCT=''
--BEGIN
-- SET @PA_FROMACCT='0'
--END
--IF (@PA_TOACCT='')
--BEGIN
-- SET @PA_TOACCT='9999999999999999'
--END
--IF (@PA_FROMACCT <> '0' AND @PA_TOACCT='')
--BEGIN
-- SET @PA_TOACCT = @PA_FROMACCT
--
--END

 IF @PA_FROMACCT = ''                                    
 BEGIN                                    
 SET @PA_FROMACCT = '0'                                    
 SET @PA_TOACCT = '99999999999999999'                                    
 END                                    
 IF @PA_TOACCT = ''                                    
 BEGIN                                
 SET @PA_TOACCT = @PA_FROMACCT                                    
 END   


select @PA_EXCSM_ID = dpm_id from dp_mstr where dpm_excsm_id = default_dp and dpm_excsm_id =  @PA_EXCSM_ID  and dpm_deleted_ind = 1
print  @PA_FROMDT
PRINT @PA_TODT

SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME FROM DP_ACCT_MSTR WHERE 
dpam_dpm_id = @pa_excsm_id and DPAM_SBA_NO 
NOT IN 
(
SELECT DPAM_SBA_NO      
FROM DP_DAILY_HLDG_CDSL D WITH(NOLOCK), 
(
SELECT DPAM_SBA_NO,DPAM_SBA_NAME,DPHMCD_DPAM_ID--, DPHMCD_BENF_CAT,DPHMCD_BENF_ACCT_TYP
, DPHMCD_ISIN, DPHMCD_HOLDING_DT = MAX(DPHMCD_HOLDING_DT)  
--,DPHMCD_BLK_LOCK_FLG,DPHMCD_BLK_LOCK_CD,DPHMCD_REL_DT           
FROM DP_DAILY_HLDG_CDSL WITH(NOLOCK),    
( SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME     
FROM CITRUS_USR.FN_ACCT_LIST(@PA_EXCSM_ID,1,0)    
WHERE ISNUMERIC(DPAM_SBA_NO)=1 AND (CONVERT(NUMERIC(18,0),DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC(18,0),@PA_FROMACCT) AND CONVERT(NUMERIC(18,0),@PA_TOACCT)) AND @PA_TODT BETWEEN EFF_FROM AND EFF_TO) ACCOUNT          
WHERE DPHMCD_DPAM_ID = ACCOUNT.DPAM_ID                                              
AND DPHMCD_HOLDING_DT  <= @PA_TODT      
--AND DPHMCD_BENF_ACCT_TYP NOT IN('20','30','40')     
AND DPHMCD_ISIN LIKE '' + '%'    

GROUP BY DPAM_SBA_NO,DPAM_SBA_NAME,DPHMCD_DPAM_ID--, DPHMCD_BENF_CAT,DPHMCD_BENF_ACCT_TYP
, DPHMCD_ISIN  --,DPHMCD_BLK_LOCK_FLG,DPHMCD_BLK_LOCK_CD,DPHMCD_REL_DT       
) D1	    
WHERE D.DPHMCD_HOLDING_DT  <= @PA_TODT       
AND D.DPHMCD_HOLDING_DT = D1.DPHMCD_HOLDING_DT      
AND D.DPHMCD_DPAM_ID = D1.DPHMCD_DPAM_ID   
--AND D.DPHMCD_BENF_CAT = D1.DPHMCD_BENF_CAT      
--AND D.DPHMCD_BENF_ACCT_TYP = D1.DPHMCD_BENF_ACCT_TYP      
AND D.DPHMCD_ISIN = D1.DPHMCD_ISIN        
--AND D.DPHMCD_BLK_LOCK_FLG = D1.DPHMCD_BLK_LOCK_FLG        
--AND D.DPHMCD_BLK_LOCK_CD = D1.DPHMCD_BLK_LOCK_CD  
--AND D.DPHMCD_REL_DT = D1.DPHMCD_REL_DT  
AND D.DPHMCD_DPM_ID = @PA_EXCSM_ID      
--and D.DPDHMD_DPAM_ID not in (12,16,17,31)
--AND D.DPHMCD_BENF_ACCT_TYP NOT IN('20','30','40') 
--AND D.DPHMCD_QTY <> 0   
union
Select DPAM_SBA_NO from dp_acct_mstr where dpam_id
in (select CDSHM_DPAM_ID from CDSL_holding_dtls where 
CDSHM_TRAS_DT between @PA_FROMDT and @PA_TODT)

)
and isnumeric(DPAM_SBA_NO) = 1 
and CONVERT(NUMERIC(18,0),DPAM_SBA_NO) BETWEEN CONVERT(NUMERIC(18,0),@PA_FROMACCT) AND CONVERT(NUMERIC(18,0),@PA_TOACCT)
AND DPAM_CREATED_DT <= @PA_TODT


END

GO
