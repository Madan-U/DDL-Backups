-- Object: PROCEDURE citrus_usr.PR_RPT_EMPSUBWSREV_29122010
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

--exec PR_RPT_EMPSUBWSREV '3','BR','A','JAN 1 2007','DEC 31 2010',''   

CREATE PROCEDURE [citrus_usr].[PR_RPT_EMPSUBWSREV_29122010](@PA_EXCSM_ID NUMERIC 
,@PA_ENTTM_CD VARCHAR(20)
,@PA_ACTION VARCHAR(20)
,@PA_FROM_DT DATETIME
,@PA_TO_DT DATETIME 
,@PA_OUT VARCHAR(8000) OUT)
AS
BEGIN 


SET DATEFORMAT DMY 

DECLARE @L_DPM_ID NUMERIC 

SELECT @L_DPM_ID = DPM_ID FROM DP_MSTR WHERE DPM_EXCSM_ID = @PA_EXCSM_ID AND DEFAULT_DP = DPM_EXCSM_ID AND DPM_DELETED_IND = 1 

select distinct CONVERT(VARCHAR,accp_value,103) accp_value, accp_clisba_id , accp_accpm_prop_cd into #account_properties from account_properties 
where accp_accpm_prop_cd = 'BILL_START_DT' 

--SELECT * FROM #account_properties

IF @PA_ACTION = 'A'
BEGIN 
	IF @PA_ENTTM_CD = 'BR'
	select COUNT(ENTR_SBA)*80 REV_VALUE, ENTM_SHORT_NAME  
	from DP_ACCT_MSTR , entity_relationship , ENTITY_MSTR , #account_properties
	WHERE DPAM_SBA_NO = ENTR_SBA 
	AND ACCP_CLISBA_ID = DPAM_ID 
	AND ENTR_AR = ENTM_ID 
	AND ENTM_ENTTM_CD = 'BR'
	--AND ENTR_TO_DT >= 'JAN 01 2009'
	AND isnull(ENTR_TO_DT,'') =  ''
	AND DPAM_DPM_ID = @L_DPM_ID 
	and dpam_stam_cd = 'ACTIVE'
	AND CONVERT(VARCHAR,ACCP_VALUE,103) BETWEEN CONVERT(VARCHAR,@PA_FROM_DT,103) AND CONVERT(VARCHAR,@PA_TO_DT,103)
	AND ENTR_DELETED_IND = 1
	AND ENTM_DELETED_IND = 1 
	GROUP BY ENTM_SHORT_NAME
END
ELSE
BEGIN
	PRINT ''
END
END

GO
