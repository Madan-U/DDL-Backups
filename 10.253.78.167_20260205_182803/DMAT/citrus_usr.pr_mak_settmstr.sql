-- Object: PROCEDURE citrus_usr.pr_mak_settmstr
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

create PROCEDURE [citrus_usr].[pr_mak_settmstr](@pa_id                   varchar(8000)  
                               ,@pa_action               varchar(20)  
                               ,@pa_login_name           varchar(20)  
                               ,@pa_settm_id             integer  
                               ,@pa_excm_id              integer  
                               ,@pa_ccm_id               integer  
                               ,@pa_setm_no              varchar(20) 
                               ,@pa_start_dt             varchar(11)  
                               ,@pa_end_dt               varchar(11)
                               ,@pa_deadline_dt          varchar(11)
                               ,@pa_deadline_time        varchar(20) 
                               ,@pa_payin_dt             varchar(11)
                               ,@pa_payout_dt            varchar(11)
                               ,@pa_auction_dt           varchar(11)
                               ,@pa_chk_yn               int 
                               ,@rowdelimiter            char(4) =  '*|~*'  
                               ,@coldelimiter            char(4) = '|*~|'  
                               ,@pa_errmsg               varchar(8000) output                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                               )  
AS  
BEGIN
--
  DECLARE @l_setm_id           bigint
        , @l_error             bigint
        , @t_errorstr          varchar(8000)
        , @delimeter           varchar(10)  
        , @remainingstring     varchar(8000)  
        , @currstring          varchar(8000)  
        , @foundat             integer  
        , @delimeterlength     int  
  --
  SET @DELIMETER       = '%'+ @ROWDELIMITER + '%'  
  SET @DELIMETERLENGTH = LEN(@ROWDELIMITER)  
  SET @REMAININGSTRING = @PA_ID  
  --  
  WHILE @REMAININGSTRING <> ''  
  BEGIN  
  --  
    SET @FOUNDAT = 0  
    SET @FOUNDAT =  PATINDEX('%'+@DELIMETER+'%',@REMAININGSTRING)  
   
  IF @FOUNDAT > 0  
  BEGIN  
  --  
   SET @CURRSTRING      = SUBSTRING(@REMAININGSTRING, 0,@FOUNDAT)  
   SET @REMAININGSTRING = SUBSTRING(@REMAININGSTRING, @FOUNDAT+@DELIMETERLENGTH,LEN(@REMAININGSTRING)- @FOUNDAT+@DELIMETERLENGTH)  
  --  
  END  
  ELSE  
  BEGIN  
  --  
   SET @CURRSTRING      = @REMAININGSTRING  
   SET @REMAININGSTRING = ''  
  --  
  END  
  IF @CURRSTRING <> ''  
  BEGIN  
  
  
   IF @PA_ACTION = 'INS'  --ACTION TYPE = INS BEGINS HERE  
   BEGIN  
   --  
        IF @PA_CHK_YN = 0 -- MAKER CHECKER FUNCTIONALITY IS NOT REQD STARTS HERE
         BEGIN  
         --
      	  SELECT @l_setm_id = ISNULL(MAX(SETM_ID),0)+1 FROM SETTLEMENT_MSTR WITH(NOLOCK) 
   
      	  INSERT INTO SETTLEMENT_MSTR(SETM_ID,SETM_SETTM_ID,SETM_EXCM_ID,SETM_CCM_ID,SETM_NO,SETM_START_DT,SETM_END_DT,SETM_DEADLINE_DT,SETM_DEADLINE_TIME,SETM_PAYIN_DT,SETM_PAYOUT_DT,SETM_AUCTION_DT,SETM_CREATED_BY,SETM_CREATED_DT,SETM_LST_UPD_BY,SETM_LST_UPD_DT,SETM_DELETED_IND)
      	  VALUES(@l_setm_id,@PA_SETTM_ID,@PA_EXCM_ID,@PA_CCM_ID,@PA_SETM_NO,CONVERT(DATETIME,@PA_START_DT,103),CONVERT(DATETIME,@PA_END_DT,103),CONVERT(DATETIME,@PA_DEADLINE_DT,103),@PA_DEADLINE_TIME,CONVERT(DATETIME,@PA_PAYIN_DT,103),CONVERT(DATETIME,@PA_PAYOUT_DT,103),CONVERT(DATETIME,@PA_AUCTION_DT,103),@PA_LOGIN_NAME,GETDATE(),@PA_LOGIN_NAME,GETDATE(),1)
      
      	  SET @L_ERROR = @@ERROR
      
      	  IF @L_ERROR > 0  
              BEGIN
       	  SELECT @T_ERRORSTR = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+CONVERT(VARCHAR,@PA_SETTM_ID)+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_CCM_ID),'')+@COLDELIMITER+@PA_SETM_NO+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_START_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_END_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_DEADLINE_DT,103)+@COLDELIMITER+@PA_DEADLINE_TIME+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_PAYIN_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_PAYOUT_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_AUCTION_DT,103)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER 
      	END  
  
    END  -- MAKER CHECKER FUNCTIONALITY IS NOT REQD ENDS HERE
  
        IF @PA_CHK_YN = 1 -- IF MAKER IS INSERTING  
         BEGIN  
         -- 
     SELECT @l_setm_id = ISNULL(MAX(SETM_ID),0)+1 FROM SETM_MAK WITH(NOLOCK) 
   
     SELECT @PA_ID = ISNULL(MAX(SETM_ID),0)+1 FROM SETTLEMENT_MSTR WITH(NOLOCK)  
   
     IF @PA_ID > @l_setm_id 
     BEGIN
      SET @l_setm_id = @PA_ID
     END
  
     INSERT INTO SETM_MAK(SETM_ID,SETM_SETTM_ID,SETM_EXCM_ID,SETM_CCM_ID,SETM_NO,SETM_START_DT,SETM_END_DT,SETM_DEADLINE_DT,SETM_DEADLINE_TIME,SETM_PAYIN_DT,SETM_PAYOUT_DT,SETM_AUCTION_DT,SETM_CREATED_BY,SETM_CREATED_DT,SETM_LST_UPD_BY,SETM_LST_UPD_DT,SETM_DELETED_IND)
     VALUES(@l_setm_id,@PA_SETTM_ID,@PA_EXCM_ID,@PA_CCM_ID,@PA_SETM_NO,CONVERT(DATETIME,@PA_START_DT,103),CONVERT(DATETIME,@PA_END_DT,103),CONVERT(DATETIME,@PA_DEADLINE_DT,103),@PA_DEADLINE_TIME,CONVERT(DATETIME,@PA_PAYIN_DT,103),CONVERT(DATETIME,@PA_PAYOUT_DT,103),CONVERT(DATETIME,@PA_AUCTION_DT,103),@PA_LOGIN_NAME,GETDATE(),@PA_LOGIN_NAME,GETDATE(),0)
  
  
     SET @L_ERROR = @@ERROR
     
     IF @L_ERROR > 0  
      BEGIN
      SELECT @T_ERRORSTR = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+CONVERT(VARCHAR,@PA_SETTM_ID)+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_CCM_ID),'')+@COLDELIMITER+@PA_SETM_NO+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_START_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_END_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_DEADLINE_DT,103)+@COLDELIMITER+@PA_DEADLINE_TIME+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_PAYIN_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_PAYOUT_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_AUCTION_DT,103)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER 
     END  
  
    END
  
  
   --
   END   --ACTION TYPE = INS ENDS HERE

         IF @PA_ACTION = 'APP'    --ACTION TYPE = APP STARTS HERE  
         BEGIN--APP  
    
       IF EXISTS(SELECT SETM_ID FROM SETTLEMENT_MSTR  WITH (NOLOCK) WHERE SETM_ID = CONVERT(INT, @CURRSTRING) AND SETM_DELETED_IND = 1)  
    BEGIN
     BEGIN TRANSACTION

     UPDATE SETM WITH(ROWLOCK)  
     SET  SETM.SETM_SETTM_ID    = SETMM.SETM_SETTM_ID  
      ,SETM.SETM_EXCM_ID     = SETMM.SETM_EXCM_ID  
      ,SETM.SETM_CCM_ID        = SETMM.SETM_CCM_ID  
      ,SETM.SETM_NO     = SETMM.SETM_NO  
      ,SETM.SETM_START_DT      =CONVERT(DATETIME,SETMM.SETM_START_DT,103)  
      ,SETM.SETM_END_DT     = CONVERT(DATETIME,SETMM.SETM_END_DT,103)  
      ,SETM.SETM_DEADLINE_DT   = CONVERT(DATETIME,SETMM.SETM_DEADLINE_DT,103)
      ,SETM.SETM_DEADLINE_TIME = SETMM.SETM_DEADLINE_TIME  
      ,SETM.SETM_PAYIN_DT    = CONVERT(DATETIME,SETMM.SETM_PAYIN_DT,103)  
      ,SETM.SETM_PAYOUT_DT     = CONVERT(DATETIME,SETMM.SETM_PAYOUT_DT,103)  
      ,SETM.SETM_AUCTION_DT    = CONVERT(DATETIME,SETMM.SETM_AUCTION_DT,103)  
      ,SETM.SETM_LST_UPD_BY   = @PA_LOGIN_NAME
      ,SETM.SETM_LST_UPD_DT   = GETDATE()
     FROM    SETTLEMENT_MSTR SETM,  
      SETM_MAK  SETMM  
     WHERE   SETM.SETM_ID           = CONVERT(INT,@CURRSTRING)  
     AND     SETMM.SETM_DELETED_IND = 0  
     AND     SETM.SETM_DELETED_IND  = 1  
     AND     SETMM.SETM_CREATED_BY <> @PA_LOGIN_NAME  
    

            SET @L_ERROR = @@ERROR  
              --  
            IF @L_ERROR > 0  
            BEGIN  
              --  
      SELECT @T_ERRORSTR       = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_SETTM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_CCM_ID),'')+@COLDELIMITER+ISNULL(SETM_NO,'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_START_DT),'')+@COLDELIMITER+CONVERT(VARCHAR,SETM_END_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_DEADLINE_DT)+@COLDELIMITER+ISNULL(SETM_DEADLINE_TIME,'')+@COLDELIMITER+CONVERT(VARCHAR,SETM_PAYIN_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_PAYOUT_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_AUCTION_DT)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER  
      FROM   SETM_MAK WITH(NOLOCK)  
      WHERE  SETM_ID          = CONVERT(INT,@CURRSTRING)  
      AND    SETM_DELETED_IND = 0  
      
      ROLLBACK TRANSACTION  
              --  
            END
     ELSE
     BEGIN
      COMMIT TRANSACTION
     END  

    END
    ELSE
    BEGIN
    --
     BEGIN TRANSACTION
     
     INSERT INTO SETTLEMENT_MSTR(SETM_ID,SETM_SETTM_ID,SETM_EXCM_ID,SETM_CCM_ID,SETM_NO,SETM_START_DT,SETM_END_DT,SETM_DEADLINE_DT,SETM_DEADLINE_TIME,SETM_PAYIN_DT,SETM_PAYOUT_DT,SETM_AUCTION_DT,SETM_CREATED_BY,SETM_CREATED_DT,SETM_LST_UPD_BY,SETM_LST_UPD_DT,SETM_DELETED_IND)
     SELECT SETM_ID,SETM_SETTM_ID,SETM_EXCM_ID,SETM_CCM_ID,SETM_NO,CONVERT(DATETIME,SETM_START_DT,103),CONVERT(DATETIME,SETM_END_DT,103),CONVERT(DATETIME,SETM_DEADLINE_DT,103),SETM_DEADLINE_TIME,CONVERT(DATETIME,SETM_PAYIN_DT,103),CONVERT(DATETIME,SETM_PAYOUT_DT,103),CONVERT(DATETIME,SETM_AUCTION_DT,103),SETM_CREATED_BY,SETM_CREATED_DT,@PA_LOGIN_NAME,GETDATE(),1
     FROM SETM_MAK WITH(NOLOCK)
     WHERE  SETM_ID      = CONVERT(INT,@CURRSTRING)  
     AND    SETM_DELETED_IND = 0 
  
  
     SET @L_ERROR = @@ERROR
     
     IF @L_ERROR > 0  
      BEGIN
      SELECT @T_ERRORSTR      = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_SETTM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_CCM_ID),'')+@COLDELIMITER+ISNULL(SETM_NO,'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_START_DT),'')+@COLDELIMITER+CONVERT(VARCHAR,SETM_END_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_DEADLINE_DT)+@COLDELIMITER+ISNULL(SETM_DEADLINE_TIME,'')+@COLDELIMITER+CONVERT(VARCHAR,SETM_PAYIN_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_PAYOUT_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_AUCTION_DT)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER  
      FROM   SETM_MAK WITH(NOLOCK)  
      WHERE  SETM_ID          = CONVERT(INT,@CURRSTRING)  
      AND    SETM_DELETED_IND = 0

      ROLLBACK TRANSACTION 
     END
     ELSE
     BEGIN
     --
       UPDATE setm_mak   
       SET    setm_deleted_ind = 1  
       , setm_lst_upd_by  = @pa_login_name  
       , setm_lst_upd_dt  = getdate()  
       WHERE  setm_id          = convert(numeric,@currstring)  
       AND    setm_deleted_ind = 0  
      COMMIT TRANSACTION
     --
     END  
     
    END

         END         --ACTION TYPE = APP ENDS HERE
         IF @PA_ACTION ='REJ'    --ACTION TYPE = REJ BEGINS HERE  
              BEGIN

    BEGIN TRANSACTION

    UPDATE SETM_MAK WITH(ROWLOCK)  
    SET  SETM_DELETED_IND   = 3  
     ,SETM_LST_UPD_BY   = @PA_LOGIN_NAME
     ,SETM_LST_UPD_DT   = GETDATE()
    FROM    SETM_MAK  
    WHERE   SETM_ID           = CONVERT(INT,@CURRSTRING)  
    AND     SETM_DELETED_IND = 0  
    AND     SETM_CREATED_BY <> @PA_LOGIN_NAME  

    SET @L_ERROR = @@ERROR
    IF @L_ERROR > 0  
     BEGIN
     SELECT @T_ERRORSTR      = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_SETTM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_CCM_ID),'')+@COLDELIMITER+ISNULL(SETM_NO,'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_START_DT),'')+@COLDELIMITER+CONVERT(VARCHAR,SETM_END_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_DEADLINE_DT)+@COLDELIMITER+ISNULL(SETM_DEADLINE_TIME,'')+@COLDELIMITER+CONVERT(VARCHAR,SETM_PAYIN_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_PAYOUT_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_AUCTION_DT)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER  
     FROM   SETM_MAK WITH(NOLOCK)  
     WHERE  SETM_ID          = CONVERT(INT,@CURRSTRING)  
     AND    SETM_DELETED_IND = 0

     ROLLBACK TRANSACTION
    END
    ELSE
    BEGIN
     COMMIT TRANSACTION
    END

        END       --ACTION TYPE = REJ ENDS HERE  

        IF @PA_ACTION = 'DEL'  --ACTION TYPE = DEL BEGINS HERE  
        BEGIN  
    IF @PA_CHK_YN = 1 -- IF  MAKER CHECKER  
    	BEGIN
    	  BEGIN TRANSACTION 	
    	  IF exists(SELECT * FROM SETM_MAK WHERE SETM_ID = convert(numeric,@currstring) and setm_deleted_ind in(0,4)) 
    	  BEGIN
    	    --
    	     DELETE FROM SETM_MAK   
	     WHERE SETM_ID = convert(numeric,@currstring)  
             AND   SETM_DELETED_IND = 0  
    	    --
    	  END
    	  ELSE
    	  BEGIN
    	    --
    	    INSERT INTO SETM_MAK
    	    (SETM_ID
    	    ,SETM_SETTM_ID
    	    ,SETM_EXCM_ID
    	    ,SETM_NO
    	    ,SETM_START_DT
    	    ,SETM_END_DT
    	    ,SETM_DEADLINE_DT
    	    ,SETM_DEADLINE_TIME
    	    ,SETM_PAYIN_DT
    	    ,SETM_PAYOUT_DT
    	    ,SETM_AUCTION_DT
    	    ,SETM_CREATED_BY
    	    ,SETM_CREATED_DT
    	    ,SETM_LST_UPD_BY
    	    ,SETM_LST_UPD_DT
    	    ,SETM_DELETED_IND
    	    ,SETM_CCM_ID
    	    )
    	    SELECT SETM_ID
    	    ,SETM_SETTM_ID
    	    ,SETM_EXCM_ID
    	    ,SETM_NO
    	    ,CONVERT(DATETIME,SETM_START_DT,103)
    	    ,CONVERT(DATETIME,SETM_END_DT,103)
    	    ,CONVERT(DATETIME,SETM_DEADLINE_DT,103)
    	    ,CONVERT(DATETIME,SETM_DEADLINE_TIME,103)
    	    ,CONVERT(DATETIME,SETM_PAYIN_DT,103)
    	    ,CONVERT(DATETIME,SETM_PAYOUT_DT,103)
    	    ,CONVERT(DATETIME,SETM_AUCTION_DT,103)
    	    ,SETM_CREATED_BY
    	    ,SETM_CREATED_DT
    	    ,@pa_login_name
    	    ,getdate()
    	    ,4
    	    ,SETM_CCM_ID
    	    FROM SETTLEMENT_MSTR
    	    WHERE SETM_ID=CONVERT(NUMERIC,@currstring)
    	    AND SETM_DELETED_IND=1
    	   --
    	  END
    	  COMMIT TRANSACTION
	END
  ELSE IF @PA_CHK_YN = 0    --NO MAKER CHECKER
  BEGIN
  --
    BEGIN TRANSACTION 
    
    	UPDATE SETTLEMENT_MSTR WITH(ROWLOCK)  
   	 SET  SETM_DELETED_IND   = 0  
     	,SETM_LST_UPD_BY   = @PA_LOGIN_NAME
     	,SETM_LST_UPD_DT   = GETDATE()
    	FROM    SETTLEMENT_MSTR  
    	WHERE   SETM_ID           = CONVERT(INT,@CURRSTRING)  
    	AND     SETM_DELETED_IND = 1  
  	-- AND     SETM_CREATED_BY <> @PA_LOGIN_NAME  
    
    	SET @L_ERROR = @@ERROR
    	IF @L_ERROR > 0  
    	 BEGIN
    		 SELECT @T_ERRORSTR      = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_SETTM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_CCM_ID),'')+@COLDELIMITER+ISNULL(SETM_NO,'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,SETM_START_DT),'')+@COLDELIMITER+CONVERT(VARCHAR,SETM_END_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_DEADLINE_DT)+@COLDELIMITER+ISNULL(SETM_DEADLINE_TIME,'')+@COLDELIMITER+CONVERT(VARCHAR,SETM_PAYIN_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_PAYOUT_DT)+@COLDELIMITER+CONVERT(VARCHAR,SETM_AUCTION_DT)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER  
    		 FROM   SETTLEMENT_MSTR WITH(NOLOCK)  
    		 WHERE  SETM_ID          = CONVERT(INT,@CURRSTRING)  
    		 AND    SETM_DELETED_IND = 1

     		ROLLBACK TRANSACTION
    	END
       ELSE
    	BEGIN
     		COMMIT TRANSACTION
    	END
   END
--   
END  --ACTION TYPE = DEL BEGINS HERE

  IF @PA_ACTION ='EDT'  --ACTION TYPE = EDT BEGINS HERE  
    BEGIN
    --
      IF @PA_CHK_YN = 0 -- IF NO MAKER CHECKER  
        BEGIN
        --
     		BEGIN TRANSACTION

     		UPDATE SETTLEMENT_MSTR WITH(ROWLOCK)  
     		SET  SETM_SETTM_ID   = @PA_SETTM_ID  
     		,SETM_EXCM_ID      = @PA_EXCM_ID 
      		,SETM_CCM_ID         = @PA_CCM_ID  
      		,SETM_NO    = @PA_SETM_NO  
      		,SETM_START_DT       = CONVERT(DATETIME,@PA_START_DT,103)  
      		,SETM_END_DT      = CONVERT(DATETIME,@PA_END_DT,103)  
      		,SETM_DEADLINE_DT    = CONVERT(DATETIME,@PA_DEADLINE_DT,103)
      		,SETM_DEADLINE_TIME  = @PA_DEADLINE_TIME  
      		,SETM_PAYIN_DT   = CONVERT(DATETIME,@PA_PAYIN_DT,103)  
      		,SETM_PAYOUT_DT      = CONVERT(DATETIME,@PA_PAYOUT_DT,103)  
      		,SETM_AUCTION_DT     = CONVERT(DATETIME,@PA_AUCTION_DT,103)  
      		,SETM_LST_UPD_BY    = @PA_LOGIN_NAME
      		,SETM_LST_UPD_DT    = GETDATE()
     		WHERE   SETM_ID        = CONVERT(INT,@CURRSTRING)  
     		AND     SETM_DELETED_IND    = 1

  
     		SET @L_ERROR = @@ERROR
     		IF @L_ERROR > 0  
     		 BEGIN
     		 --
      			SELECT @T_ERRORSTR      = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+CONVERT(VARCHAR,@PA_SETTM_ID)+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_CCM_ID),'')+@COLDELIMITER+@PA_SETM_NO+@COLDELIMITER+CONVERT(VARCHAR,@PA_START_DT)+@COLDELIMITER+CONVERT(VARCHAR,@PA_END_DT)+@COLDELIMITER+CONVERT(VARCHAR,@PA_DEADLINE_DT)+@COLDELIMITER+@PA_DEADLINE_TIME+@COLDELIMITER+CONVERT(VARCHAR,@PA_PAYIN_DT)+@COLDELIMITER+CONVERT(VARCHAR,@PA_PAYOUT_DT)+@COLDELIMITER+CONVERT(VARCHAR,@PA_AUCTION_DT)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER 
      
      			ROLLBACK TRANSACTION
     		END
     	       ELSE
     		BEGIN
     			COMMIT TRANSACTION
     		END
        --    
    	END

    IF @PA_CHK_YN = 1 -- IF MAKER OR CHEKER IS EDITING  
      BEGIN
      --
     		BEGIN TRANSACTION
     		UPDATE SETM_MAK    WITH(ROWLOCK)  
            	SET    SETM_DELETED_IND  = 2  
                  ,SETM_LST_UPD_BY   = @PA_LOGIN_NAME  
                  ,SETM_LST_UPD_DT   = GETDATE()  
            	WHERE  SETM_ID           = CONVERT(INT,@CURRSTRING)  
            	AND    SETM_DELETED_IND  = 0  


     		SET @L_ERROR = @@ERROR
     		IF @L_ERROR > 0  
     		 BEGIN
     			 SELECT @T_ERRORSTR = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+CONVERT(VARCHAR,@PA_SETTM_ID)+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_CCM_ID),'')+@COLDELIMITER+@PA_SETM_NO+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_START_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_END_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_DEADLINE_DT,103)+@COLDELIMITER+@PA_DEADLINE_TIME+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_PAYIN_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_PAYOUT_DT,103)+@COLDELIMITER+CONVERT(VARCHAR(11),@PA_AUCTION_DT,103)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER 
     			 ROLLBACK TRANSACTION
     		END
     		ELSE
     		 BEGIN

     			 INSERT INTO SETM_MAK(SETM_ID,SETM_SETTM_ID,SETM_EXCM_ID,SETM_CCM_ID,SETM_NO,SETM_START_DT,SETM_END_DT,SETM_DEADLINE_DT,SETM_DEADLINE_TIME,SETM_PAYIN_DT,SETM_PAYOUT_DT,SETM_AUCTION_DT,SETM_CREATED_BY,SETM_CREATED_DT,SETM_LST_UPD_BY,SETM_LST_UPD_DT,SETM_DELETED_IND)
     			 VALUES(CONVERT(INT,@CURRSTRING),@PA_SETTM_ID,@PA_EXCM_ID,@PA_CCM_ID,@PA_SETM_NO,CONVERT(DATETIME,@PA_START_DT,103),CONVERT(DATETIME,@PA_END_DT,103),CONVERT(DATETIME,@PA_DEADLINE_DT,103),@PA_DEADLINE_TIME,CONVERT(DATETIME,@PA_PAYIN_DT,103),CONVERT(DATETIME,@PA_PAYOUT_DT,103),CONVERT(DATETIME,@PA_AUCTION_DT,103),@PA_LOGIN_NAME,GETDATE(),@PA_LOGIN_NAME,GETDATE(),1)  

     			 SET @L_ERROR = @@ERROR
     			 IF @L_ERROR > 0  
       			   BEGIN
       			SELECT @T_ERRORSTR = ISNULL(@T_ERRORSTR,'')+@CURRSTRING+@COLDELIMITER+CONVERT(VARCHAR,@PA_SETTM_ID)+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_EXCM_ID),'')+@COLDELIMITER+ISNULL(CONVERT(VARCHAR,@PA_CCM_ID),'')+@COLDELIMITER+@PA_SETM_NO+@COLDELIMITER+CONVERT(VARCHAR,@PA_START_DT)+@COLDELIMITER+CONVERT(VARCHAR,@PA_END_DT)+@COLDELIMITER+CONVERT(VARCHAR,@PA_DEADLINE_DT)+@COLDELIMITER+@PA_DEADLINE_TIME+@COLDELIMITER+CONVERT(VARCHAR,@PA_PAYIN_DT)+@COLDELIMITER+CONVERT(VARCHAR,@PA_PAYOUT_DT)+@COLDELIMITER+CONVERT(VARCHAR,@PA_AUCTION_DT)+@COLDELIMITER+CONVERT(VARCHAR,@L_ERROR)+@ROWDELIMITER 
       			ROLLBACK TRANSACTION
      		END
      		ELSE
      		BEGIN
      			 COMMIT TRANSACTION
      		END
  
     	END

    END  -- IF MAKER OR CHEKER IS EDITING ENDS HERE
      

END     --ACTION TYPE = EDT ENDS HERE

END  -- END OF CURRSTRING CONDITION
     -- 
     SET @PA_ERRMSG = @T_ERRORSTR  
     --  
 END  -- END OF LOOP

END

GO
