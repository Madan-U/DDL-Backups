-- Object: PROCEDURE citrus_usr.AMC_CHARGES
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------


CREATE PROC [citrus_usr].[AMC_CHARGES] (@FROMDATE DATETIME,@TODATE DATETIME)
AS
SELECT * INTO #TEMP FROM  (
SELECT DPAM_SBA_NO  , CASE WHEN CITRUS_USR.UFN_COUNTSTRING(CLIC_CHARGE_NAME,'_') >=1
 THEN CITRUS_USR.FN_SPLITVAL_BY(CLIC_CHARGE_NAME ,2 ,'_') ELSE CLIC_CHARGE_NAME END  CHARGE_NAME 
,SUM(CLIC_CHARGE_AMT) AMT ,LEFT(DATENAME(MONTH, CLIC_TRANS_DT),3) +'-'+ DATENAME(YEAR, CLIC_TRANS_DT) AS MON_YEAR
FROM CLIENT_CHARGES_CDSL WITH(NOLOCK),DP_ACCT_MSTR  WITH(NOLOCK) ,CLIENT_DP_BRKG  WITH(NOLOCK) ,BROKERAGE_MSTR  WITH(NOLOCK) 
 WHERE CLIC_TRANS_DT  BETWEEN @FROMDATE AND @TODATE
AND CLIC_CHARGE_NAME NOT IN ('SERVICE TAX','SWACHH BHARAT CESS','KRISHI KALYAN CESS @ 0.50%'
,'TRANSACTION CHARGES','CGST @9%','SGST @9%','IGST @18%','UGST')
AND BROM_ID = CLIDB_BROM_ID 
AND CLIDB_DPAM_ID= DPAM_ID AND CLIDB_DELETED_IND =1 
AND CLIC_DPAM_ID = DPAM_ID-- AND DPAM_SBA_NO ='1203320000016304'
AND CLIC_TRANS_DT BETWEEN CLIDB_EFF_FROM_DT  AND ISNULL(CLIDB_EFF_TO_DT ,'DEC 31 2100')
GROUP BY DPAM_SBA_NO,CASE WHEN CITRUS_USR.UFN_COUNTSTRING(CLIC_CHARGE_NAME,'_') >=1 THEN CITRUS_USR.FN_SPLITVAL_BY(CLIC_CHARGE_NAME ,2 ,'_') ELSE CLIC_CHARGE_NAME END
,DATENAME(MONTH, CLIC_TRANS_DT) ,
    DATENAME(YEAR, CLIC_TRANS_DT) ) A
WHERE CHARGE_NAME IN ('AMC','ACMA','AC','ACMAIN')
 

 SELECT T.*,SUM(LD_AMOUNT) LEDGER_BALANCE  INTO #FINAL1 FROM #TEMP  T
  LEFT OUTER JOIN 
  SYNERGY_LEDGER  S
  ON T.DPAM_SBA_NO=LD_CLIENTCD   
  GROUP BY DPAM_SBA_NO,CHARGE_NAME,AMT,MON_YEAR
  
SELECT F.*,NISE_PARTY_CODE,STATUS,ACTIVE_DATE INTO #FIN  FROM  #FINAL1 F,TBL_CLIENT_MASTER WHERE DPAM_SBA_NO =CLIENT_CODE 

SELECT DPAM_SBA_NO AS DP_ID,	AMT*-1 AS AMC,MON_YEAR AS MON,	LEDGER_BALANCE AS NET_BALANCE,NISE_PARTY_CODE AS CL_CODE,F.STATUS,	ACTIVE_DATE
,(CASE WHEN B2C ='Y' THEN 'B2C' ELSE 'B2B' END) AS B2C,COMB_LAST_DATE  FROM #FIN F,INTRANET.RISK.DBO.CLIENT_DETAILS C
WHERE F.NISE_PARTY_CODE=CL_CODE

GO
