-- Object: PROCEDURE citrus_usr.PR_GET_fORMSTATUS
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------


CREATE PROC [citrus_usr].[PR_GET_fORMSTATUS] (@PA_FROM_DT DATETIME,@PA_TO_DT DATETIME,@PA_LOGIN_NAME VARCHAR(100),@PA_FORM_NO VARCHAR(100),@PA_ACTION varchar(100))
AS 
BEGIN 

if @PA_ACTION = 'CLIENT_ACCOUNT'
SELECT DPAM_ACCT_NO [FORM NO/DP ACCT NO]
,CASE WHEN DPAM_DELETED_IND IN (0) AND EXISTS (SELECT 1 FROM CLIENT_LIST WHERE CLIM_CRN_NO = DPAM_CRN_NO AND CLIM_DELETED_IND = 1 and clim_status ='0' ) THEN 'MAKER ENTERY DONE' 
WHEN DPAM_DELETED_IND IN (0) AND  EXISTS (SELECT 1 FROM CLIENT_LIST WHERE CLIM_CRN_NO = DPAM_CRN_NO AND CLIM_DELETED_IND = 1 AND CLIM_STATUS IN ('1','3')) THEN 'SENT TO CHECKER DONE' 
WHEN DPAM_DELETED_IND IN (0) AND  EXISTS (SELECT 1 FROM CLIENT_LIST WHERE CLIM_CRN_NO = DPAM_CRN_NO AND CLIM_DELETED_IND = 1 AND CLIM_STATUS IN ('4')) THEN 'CHECKER SENT TO MAKER DONE' 
WHEN DPAM_DELETED_IND IN (0) AND NOT EXISTS (SELECT 1 FROM CLIENT_LIST WHERE CLIM_CRN_NO = DPAM_CRN_NO ) THEN 'CONTACT YOUR ADMINISTRATOR' 
WHEN DPAM_DELETED_IND IN (1) THEN 'CHECKER APPROVE DONE' ELSE '' END STATUS ,CASE WHEN DPAM_CREATED_BY = 'KYC' THEN 'KYC' ELSE 'MANUAL' END  [SOURCE OF ACCOUNT]
,'MAKER : ' + CASE WHEN DPAM_CREATED_BY = 'KYC' THEN 'KYC' ELSE DPAM_CREATED_BY END [CREATED BY]
,CONVERT(VARCHAR(11),DPAM_CREATED_DT  ,109)  [CREATED DATE]
,CASE WHEN DPAM_LST_UPD_BY = DPAM_CREATED_BY THEN 'MAKER : ' WHEN DPAM_LST_UPD_BY <> DPAM_CREATED_BY AND DPAM_DELETED_IND = 1 THEN 'CHECKER : ' ELSE '' END  +  CASE WHEN DPAM_LST_UPD_BY = 'KYC' THEN 'KYC' ELSE DPAM_LST_UPD_BY END [LAST UPDATE/APPROVE BY]
,CONVERT(VARCHAR(11),DPAM_CREATED_DT  ,109) [LAST UPDATE/APPROVE DATE]
,CASE WHEN EXISTS (SELECT 1 FROM ACCD_MAK WHERE ACCD_CLISBA_ID = DPAM_ID ) THEN 'SIGNATORY IMPORT' ELSE 'SIGNATORY NOT IMPORT' END [SIGNATORY STATUS]
FROM DP_ACCT_MSTR_MAK  MAK
WHERE DPAM_DELETED_IND IN (0)
AND NOT EXISTS (SELECT	1 FROM DP_ACCT_MSTR MAIN WHERE MAK.DPAM_ID = MAIN.DPAM_ID AND MAIN.DPAM_DELETED_IND=1 AND ISNULL(dpam_batch_no ,'0')<>'0' ) 
AND (CONVERT(VARCHAR(11),DPAM_CREATED_DT  ,109) BETWEEN @PA_FROM_DT AND @PA_TO_DT 
OR CONVERT(VARCHAR(11),DPAM_LST_UPD_DT  ,109) BETWEEN @PA_FROM_DT AND @PA_TO_DT )
AND CASE WHEN @PA_FORM_NO ='' THEN '1' ELSE DPAM_ACCT_NO END = CASE WHEN @PA_FORM_NO ='' THEN '1' ELSE @PA_FORM_NO END 
UNION 
SELECT CASE WHEN MAIN.DPAM_ACCT_NO = MAIN.DPAM_SBA_NO THEN MAIN.DPAM_ACCT_NO ELSE MAIN.DPAM_ACCT_NO+ '/'+MAIN.DPAM_sba_NO  END   [FORM NO/DP ACCT NO]
,CASE WHEN ISNULL(MAIN.DPAM_BATCH_NO  ,'0')<>'0' THEN 'BATCH GENERATED BATCH NO : ' + CONVERT(VARCHAR,ISNULL(MAIN.DPAM_BATCH_NO  ,'0'))
WHEN ISNULL(MAIN.DPAM_BATCH_NO  ,'0')='0' THEN 'BATCH GENERATION PENDING ' + CONVERT(VARCHAR,ISNULL(MAIN.DPAM_BATCH_NO  ,'0')) ELSE '' END  STATUS ,CASE WHEN MAK.DPAM_CREATED_BY = 'KYC' THEN 'KYC' ELSE 'MANUAL' END  [SOURCE OF ACCOUNT]
,'MAKER : ' + CASE WHEN MAK.DPAM_CREATED_BY = 'KYC' THEN 'KYC' ELSE MAK.DPAM_CREATED_BY END [CREATED BY]
,CONVERT(VARCHAR(11),MAK.DPAM_CREATED_DT  ,109)  [CREATED DATE]
,CASE WHEN MAK.DPAM_LST_UPD_BY = MAK.DPAM_CREATED_BY THEN 'MAKER : ' WHEN MAK.DPAM_LST_UPD_BY <> MAK.DPAM_CREATED_BY AND MAK.DPAM_DELETED_IND = 1 THEN 'CHECKER : ' ELSE '' END  +  CASE WHEN MAK.DPAM_LST_UPD_BY = 'KYC' THEN 'KYC' ELSE MAK.DPAM_LST_UPD_BY END [LAST UPDATE/APPROVE BY]
,CONVERT(VARCHAR(11),MAK.DPAM_CREATED_DT  ,109) [LAST UPDATE/APPROVE DATE]
,CASE WHEN EXISTS (SELECT 1 FROM ACCD_MAK WHERE ACCD_CLISBA_ID = MAK.DPAM_ID ) THEN 'SIGNATORY IMPORT' ELSE 'SIGNATORY NOT IMPORT' END [SIGNATORY STATUS ]
FROM DP_ACCT_MSTR_MAK  MAK, DP_ACCT_MSTR MAIN
WHERE MAK.DPAM_DELETED_IND IN (1) AND  MAIN.DPAM_ID = MAK.DPAM_ID 
 AND ISNULL(MAIN.dpam_batch_no ,'0')<>'0' 
AND (CONVERT(VARCHAR(11),MAK.DPAM_CREATED_DT  ,109) BETWEEN @PA_FROM_DT AND @PA_TO_DT 
OR CONVERT(VARCHAR(11),MAK.DPAM_LST_UPD_DT  ,109) BETWEEN @PA_FROM_DT AND @PA_TO_DT )
AND CASE WHEN @PA_FORM_NO ='' THEN '1' ELSE MAIN.DPAM_ACCT_NO END = CASE WHEN @PA_FORM_NO ='' THEN '1' ELSE @PA_FORM_NO END 
ORDER BY [CREATED DATE]


if @PA_ACTION = 'CLIENT_MODIFICATION'
select  distinct dpam_Acct_no +'/' + clic_mod_dpam_sba_no [FORM NO/DP ACCT NO]
,CASE WHEN clic_mod_deleted_ind IN (0) AND CLIM_DELETED_IND = 1 and clim_status ='0' THEN 'MAKER ENTERY DONE'  + ':' + isnull(clic_mod_action,'')
WHEN clic_mod_deleted_ind IN (0) AND  CLIM_DELETED_IND = 1 AND CLIM_STATUS IN ('4') THEN 'CHECKER SENT TO MAKER DONE' + ':' + isnull(clic_mod_action,'')
WHEN clic_mod_deleted_ind IN (0) AND   CLIM_DELETED_IND = 1 AND CLIM_STATUS IN ('1','3') THEN 'SENT TO CHECKER DONE' + ':' + isnull(clic_mod_action,'')
WHEN clic_mod_deleted_ind IN (0) AND ISNULL(clim_deleted_ind,0)=0  THEN 'CONTACT YOUR ADMINISTRATOR' 
wHEN clic_mod_deleted_ind IN (1) and ISNULL(clic_mod_batch_no  ,'0')='0' THEN 'CHECKER APPROVE DONE' 
 WHEN ISNULL(clic_mod_batch_no  ,'0')<>'0' THEN 'BATCH GENERATED BATCH NO : ' + CONVERT(VARCHAR,ISNULL(clic_mod_batch_no  ,'0'))  
WHEN ISNULL(clic_mod_batch_no  ,'0')='0' and clic_mod_deleted_ind IN (1) THEN 'BATCH GENERATION PENDING ' + CONVERT(VARCHAR,ISNULL(clic_mod_batch_no  ,'0')) ELSE '' END   + ':' + isnull(clic_mod_action,'') 
--+ ' (MODIFICATION in ' + clic_mod_action  +')'   
STATUS
 ,CASE WHEN clic_mod_created_by = 'KYC' THEN 'KYC' ELSE 'MANUAL' END  [SOURCE OF ACCOUNT]
,'MAKER : ' + CASE WHEN clic_mod_created_by = 'KYC' THEN 'KYC' ELSE clic_mod_created_by END [CREATED BY]
,CONVERT(VARCHAR(11),clic_mod_created_dt  ,109)  [CREATED DATE]
,CASE WHEN clic_mod_lst_upd_by = clic_mod_created_by THEN 'MAKER : ' WHEN clic_mod_lst_upd_by <> clic_mod_created_by AND clic_mod_deleted_ind = 1 THEN 'CHECKER : ' ELSE '' END  +  CASE WHEN clic_mod_lst_upd_by = 'KYC' THEN 'KYC' ELSE clic_mod_lst_upd_by END [LAST UPDATE/APPROVE BY]
,CONVERT(VARCHAR(11),clic_mod_lst_upd_dt  ,109) [LAST UPDATE/APPROVE DATE]
,CASE WHEN EXISTS (SELECT 1 FROM ACCD_MAK WHERE ACCD_CLISBA_ID = DPAM_ID 
union SELECT 1 FROM account_documents WHERE ACCD_CLISBA_ID = DPAM_ID  ) THEN 'SIGNATORY IMPORT' ELSE 'SIGNATORY NOT IMPORT' END [SIGNATORY STATUS]
FROM client_list_modified   ,dp_acct_mstr mak 
left outer join CLIENT_LIST on CLIM_CRN_NO = DPAM_CRN_NO  and CLIM_DELETED_IND in (2,1) and (CONVERT(VARCHAR(11),clim_created_dt  ,109) BETWEEN @PA_FROM_DT AND @PA_TO_DT 
OR CONVERT(VARCHAR(11),clim_lst_upd_dt  ,109) BETWEEN @PA_FROM_DT AND @PA_TO_DT )
WHERE clic_mod_deleted_ind IN (0,1) and dpam_sba_no = clic_mod_dpam_sba_no  
and case when clic_mod_action='G NAMENDTLS' then 'dp holder dtls'
when clic_mod_action='N CONTACTS' then 'CONTACT CHANNELS'
when clic_mod_action='FST HOLDER GENDER' then 'CLIENT MSTR'
when clic_mod_action='G ADDRESS' then 'ADDRESSES'
when clic_mod_action='FIRST RESIDENCENO' then 'CONTACT CHANNELS'
when clic_mod_action='N ADDRESS' then 'ADDRESSES'
when clic_mod_action='CONTACTS' then 'CONTACT CHANNELS'
when clic_mod_action='POA DEACTIVATION' then 'dp poa dtls'
when clic_mod_action='EMAIL STMT FLAG' then 'CONTACT CHANNELS'
when clic_mod_action='FIRST MOBILENO' then 'CONTACT CHANNELS'
when clic_mod_action='POA ACTIVATION' then 'dp poa dtls'
when clic_mod_action='FST HOLDER DOB' then 'CLIENT MSTR'
when clic_mod_action='NG ADDRESS' then 'ADDRESSES'
when clic_mod_action='FIRST OFFICENO' then 'CONTACT CHANNELS'
when clic_mod_action='FIRST EMAILID' then 'CONTACT CHANNELS'
when clic_mod_action='N NAMENDTLS' then 'dp holder dtls'
when clic_mod_action='CONF WAIVED FLAG' then 'ACCOUNT PROPERTIES'
when clic_mod_action='SH NAMENDTLS' then 'dp holder dtls'
when clic_mod_action='SH FatherNameChange' then 'dp holder dtls'
when clic_mod_action='BANK' then 'Client Bank Accts'
when clic_mod_action='P ADDRESS' then 'ADDRESSES'
when clic_mod_action='MOBILE SMS DELETE' then 'CONTACT CHANNELS'
when clic_mod_action='MOBILESMS' then 'CONTACT CHANNELS'
when clic_mod_action='NG NAMENDTLS' then 'dp holder dtls'
when clic_mod_action='NOMINEE DEL' then 'dp holder dtls'
when clic_mod_action='SIGNATURE' then 'Account Documents'
when clic_mod_action='C ADDRESS' then 'ADDRESSES'
when clic_mod_action='FIRST EMAILID DELETE' then 'CONTACT CHANNELS'
when clic_mod_action='GENERAL' then 'CLIENT MSTR'
when clic_mod_action='FST HOLDER NAME' then 'CLIENT MSTR'
when clic_mod_action='MOBILE SMS' then 'CONTACT CHANNELS'
when clic_mod_action='TH NAMENDTLS' then 'dp holder dtls'
when clic_mod_action='FIRST MOBILENO DELETE' then 'CONTACT CHANNELS'
when clic_mod_action='RTA EMAIL FLG' then 'ACCOUNT PROPERTIES'
when clic_mod_action='SUB STATUS' then 'dp acct mstr'
when clic_mod_action='INCOME DETAILS' then 'ENTITY PROPERTIES' end 
=ISNULL(clim_tab,'')
AND EXISTS (SELECT	1 FROM DP_ACCT_MSTR MAIN WHERE MAK.DPAM_ID = MAIN.DPAM_ID AND MAIN.DPAM_DELETED_IND=1 AND ISNULL(dpam_batch_no ,'0')<>'0' ) 
--and CONVERT(VARCHAR(11),clic_mod_lst_upd_dt  ,109) BETWEEN 'sep 14 2015' and 'sep 15 2015'
AND (CONVERT(VARCHAR(11),clic_mod_created_dt  ,109) BETWEEN @PA_FROM_DT AND @PA_TO_DT 
OR CONVERT(VARCHAR(11),clic_mod_lst_upd_dt  ,109) BETWEEN @PA_FROM_DT AND @PA_TO_DT )
AND CASE WHEN @PA_FORM_NO ='' THEN '1' ELSE dpam_acct_no  END = CASE WHEN @PA_FORM_NO ='' THEN '1' ELSE @PA_FORM_NO END 
ORDER BY [CREATED DATE]




END  
--select * from I3872125
--SELECT * FROM dp_acct_mstr_MAK WHERE DPAM_ACCT_NO = 'I3876947'
--SELECT * FROM CLIENT_LIST WHERE CLIM_CRN_NO in (1684398)
--,1692307
--,1692305)
--select * from CLIENT_MSTR_MAK where CLIM_CRN_NO in (1692306
--,1692307
--,1692305)

GO
