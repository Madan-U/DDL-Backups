-- Object: PROCEDURE citrus_usr.Pr_get_Margin_Pledge_Rpt
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

CREATE  PROC [citrus_usr].[Pr_get_Margin_Pledge_Rpt] (@PA_FROM_DT DATETIME, @PA_TO_DT DATETIME,@pa_login_name varchar(100))
AS
BEGIN 

SELECT
 CDSHM_BEN_ACCT_NO 
, DPAM_BBO_CODE 
--, CITRUS_USR.FN_UCC_ACCP(DPAM_ID,'PAN_GIR_NO','') PAN_NO 
, CDSHM_ISIN,ISIN_NAME , SUM(CDSHM_QTY) HOLDING
--, (SELECT TOP 1 CLOPM_CDSL_RT FROM CLOSING_PRICE_MSTR_CDSL WHERE CLOPM_ISIN_CD = CDSHM_ISIN AND CLOPM_DT < @PA_FROM_DT AND CLOPM_CDSL_RT <> 0 ORDER BY  CLOPM_DT DESC )  RATE_T_MINUS_1
,@PA_FROM_DT HOLDINGDATE
FROM CDSL_HOLDING_DTLS  LEFT OUTER JOIN ISIN_MSTR ON ISIN_CD=CDSHM_ISIN , DP_ACCT_MSTR WHERE CDSHM_BEN_ACCT_NO = DPAM_SBA_NO 
AND  CDSHM_COUNTER_BOID LIKE '%1203320030135829%'
AND CDSHM_TRATM_CD IN (2230,2280 ) AND CDSHM_TRAS_DT <= @PA_FROM_DT
--AND DPAM_BBO_CODE  IN  (SELECT BBOCODE FROM MP_BBO )
GROUP BY CDSHM_BEN_ACCT_NO, CDSHM_ISIN, DPAM_BBO_CODE ,DPAM_ID,ISIN_NAME
HAVING SUM(CDSHM_QTY)<> 0 

END

GO
