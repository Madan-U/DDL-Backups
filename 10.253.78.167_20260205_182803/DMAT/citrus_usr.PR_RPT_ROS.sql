-- Object: PROCEDURE citrus_usr.PR_RPT_ROS
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

--EXEC PR_RPT_ROS '3','APR  1 2018','JAN  8 2019','1','1203320006684234','1203320006684234'
CREATE PROCEDURE [citrus_usr].[PR_RPT_ROS] (@PA_DPMID NUMERIC,@PA_FROMDATE DATETIME,@PA_TODATE DATETIME ,@PA_FLAG CHAR(1),@PA_FROMACCID VARCHAR(16),@PA_TOACCID VARCHAR(16))

AS
BEGIN
CREATE TABLE #TMPHLDG     
(    
[DPHMCD_DPM_ID] [NUMERIC](18, 0) NOT NULL,    
[DPHMCD_DPAM_ID] [NUMERIC](10, 0) NOT NULL,    
[DPHMCD_ISIN] [VARCHAR](20) NOT NULL,    
[DPHMCD_CURR_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_FREE_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_FREEZE_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_PLEDGE_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_DEMAT_PND_VER_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_REMAT_PND_CONF_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_DEMAT_PND_CONF_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_SAFE_KEEPING_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_LOCKIN_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_ELIMINATION_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_EARMARK_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_AVAIL_LEND_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_LEND_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_BORROW_QTY] [NUMERIC](18, 3) NULL,    
[DPHMCD_HOLDING_DT] DATETIME    
)      
IF @PA_FLAG=1
BEGIN  
DECLARE @PA_BASEHOLDATE    VARCHAR(11)
SET @PA_BASEHOLDATE = CONVERT(VARCHAR(11),DATEADD(D,-1,@PA_FROMDATE),109)

--PRINT @PA_BASEHOLDATE

CREATE INDEX IX_1_HLDG ON #TMPHLDG([DPHMCD_DPM_ID],[DPHMCD_DPAM_ID],[DPHMCD_ISIN],[DPHMCD_HOLDING_DT])    


INSERT INTO #TMPHLDG    
EXEC  [PR_GET_HOLDING_FIX_LATEST_SOC]   @PA_DPMID,@PA_BASEHOLDATE,@PA_BASEHOLDATE,@PA_FROMACCID,@PA_TOACCID,''    


SELECT DPHMCD_HOLDING_DT, DPAM_SBA_NO,SUBCM_DESC,ISNULL(ACCP_VALUE,'') UCC,DPAM_SBA_NAME,ISNULL(ENTP_VALUE,'') PANNO , DPHMCD_ISIN
,ISIN_NAME , CASE WHEN  DPHMCD_ISIN LIKE 'INE%' THEN 'EQ' WHEN DPHMCD_ISIN LIKE 'INF%' THEN 'MF' ELSE '' END  SEC_TYPE,DPHMCD_PLEDGE_QTY,DPHMCD_FREE_QTY,(DPHMCD_PLEDGE_QTY+DPHMCD_FREE_QTY) TOTALQTY
FROM #TMPHLDG,DP_ACCT_MSTR,SUB_CTGRY_MSTR,ISIN_MSTR,ACCOUNT_PROPERTIES,ENTITY_PROPERTIES WITH(NOLOCK) WHERE DPAM_ID=DPHMCD_DPAM_ID AND DPAM_DELETED_IND=1
AND SUBCM_CD=DPAM_SUBCM_CD AND DPHMCD_ISIN=ISIN_CD
AND ACCP_CLISBA_ID=DPAM_ID AND ACCP_ACCPM_PROP_CD='BBO_CODE'
AND DPAM_CRN_NO=ENTP_ENT_ID AND ENTP_ENTPM_CD='PAN_GIR_NO'

RETURN
END


CREATE TABLE #TEMPMAINCDSL                                
(                            
DPAM_ID BIGINT,                              
DPAM_SBA_NAME VARCHAR(200),                            
DPAM_ACCTNO VARCHAR(16),                              
TRANS_DESC VARCHAR(200),                                
DPM_TRANS_NO VARCHAR(10),                                
TRANS_DATE DATETIME,                                
ISIN_CD VARCHAR(12),      
SETT_TYPE VARCHAR(50),        
SETT_NO VARCHAR(10),                                
OPENING_BAL NUMERIC(19,3),                            
QTY NUMERIC(19,3),                            
ORDER_BY INT,            
LINE_NO BIGINT,    
CDSHM_TRG_SETTM_NO VARCHAR(13),TRATM_CD VARCHAR(25) ,EXEDT DATETIME  ,C_D_FLAG CHAR(1)      
,RATE NUMERIC    
,VALUATION NUMERIC     
,EASIFLG                       NUMERIC    
,CDSHM_COUNTER_BOID VARCHAR(16)
)                                
         


CREATE TABLE #ACLIST(DPAM_ID BIGINT,DPAM_SBA_NO VARCHAR(16),DPAM_SBA_NAME VARCHAR(150),EFF_FROM DATETIME,EFF_TO DATETIME)  
INSERT INTO #ACLIST SELECT DPAM_ID,DPAM_SBA_NO,DPAM_SBA_NAME,EFF_FROM,ISNULL(EFF_TO,'DEC 31 2100') 
FROM CITRUS_USR.[FN_ACCT_LIST_ROS](@PA_DPMID ,'1','0',@PA_FROMACCID,@PA_TOACCID)      
--DELETE FROM #ACLIST WHERE DPAM_SBA_NO NOT IN (SELECT TOC_BOID FROM TBL_OWN_ACCOUNT)

CREATE TABLE #FORSTAT_CDSL_HOLDING_DTLS(  
[CDSHM_DPM_ID] [NUMERIC](18, 0) NULL,  
[CDSHM_BEN_ACCT_NO] [VARCHAR](16) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_DPAM_ID] [NUMERIC](10, 0) NULL,  
[CDSHM_TRATM_CD] [VARCHAR](25) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_TRATM_DESC] [VARCHAR](200) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_TRAS_DT] [DATETIME] NULL,  
[CDSHM_ISIN] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_QTY] [NUMERIC](18, 5) NULL,  
[CDSHM_INT_REF_NO] [VARCHAR](50) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_TRANS_NO] [VARCHAR](50) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_SETT_TYPE] [VARCHAR](6) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_SETT_NO] [VARCHAR](10) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_COUNTER_BOID] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_COUNTER_DPID] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_COUNTER_CMBPID] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_EXCM_ID] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_TRADE_NO] [VARCHAR](20) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_CREATED_BY] [VARCHAR](25) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_CREATED_DT] [DATETIME] NULL,  
[CDSHM_LST_UPD_BY] [VARCHAR](25) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_LST_UPD_DT] [DATETIME] NULL,  
[CDSHM_DELETED_IND] [SMALLINT] NULL,  
[CDSHM_SLIP_NO] [VARCHAR](50) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_TRATM_TYPE_DESC] [VARCHAR](80) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_INTERNAL_TRASTM] [VARCHAR](50) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_BAL_TYPE] [VARCHAR](30) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_ID] [NUMERIC](10, 0) NULL,  
[CDSHM_OPN_BAL] [NUMERIC](18, 5) NULL,  
[CDSHM_CHARGE] [NUMERIC](10, 5) NULL,  
[CDSHM_DP_CHARGE] [NUMERIC](10, 5) NULL,  
[CDSHM_TRG_SETTM_NO] [VARCHAR](13) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[WAIVE_FLAG] [CHAR](1) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_TRANS_CDAS_CODE] [VARCHAR](8000) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_CDAS_TRAS_TYPE] [VARCHAR](25) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_CDAS_SUB_TRAS_TYPE] [VARCHAR](25) COLLATE SQL_LATIN1_GENERAL_CP1_CI_AS NULL,  
[CDSHM_POST_TOACCT] [NUMERIC](18, 0) NULL  
)   

INSERT INTO #FORSTAT_CDSL_HOLDING_DTLS     
SELECT * FROM CDSL_HOLDING_DTLS WITH (NOLOCK)    
WHERE CDSHM_TRAS_DT BETWEEN @PA_FROMDATE AND  @PA_TODATE  
AND EXISTS  (SELECT DPAM_SBA_NO FROM #ACLIST WHERE CDSHM_BEN_ACCT_NO=DPAM_SBA_NO)

CREATE INDEX IX_1 ON #FORSTAT_CDSL_HOLDING_DTLS(CDSHM_TRAS_DT,CDSHM_BEN_ACCT_NO)


SELECT * ,CASE WHEN CITRUS_USR.FN_SPLITVAL_BY(CDSHM_TRANS_CDAS_CODE,16,'~') =  ''     
THEN REPLACE(CONVERT(VARCHAR(10), CDSHM_TRAS_DT, 103), '/', '')+'000000' ELSE CITRUS_USR.FN_SPLITVAL_BY(CDSHM_TRANS_CDAS_CODE,16,'~') END EXEDT    
,CITRUS_USR.FN_SPLITVAL_BY(CDSHM_TRANS_CDAS_CODE,9,'~') EXETIME INTO #TMP_CDSL_HOLDING_DTLS     
FROM #FORSTAT_CDSL_HOLDING_DTLS WITH (NOLOCK)    
WHERE CDSHM_TRAS_DT >=@PA_FROMDATE AND CDSHM_TRAS_DT <=@PA_TODATE      
--AND CDSHM_BEN_ACCT_NO BETWEEN @PA_FROMACCID AND @PA_TOACCID    
AND EXISTS  (SELECT DPAM_SBA_NO FROM #ACLIST WHERE CDSHM_BEN_ACCT_NO=DPAM_SBA_NO)

TRUNCATE TABLE #FORSTAT_CDSL_HOLDING_DTLS    
DROP TABLE #FORSTAT_CDSL_HOLDING_DTLS                               



INSERT INTO #TEMPMAINCDSL(DPAM_ID,DPAM_SBA_NAME,DPAM_ACCTNO,TRANS_DESC,DPM_TRANS_NO,TRANS_DATE,ISIN_CD ,SETT_TYPE
,SETT_NO  ,OPENING_BAL,QTY,ORDER_BY,LINE_NO,CDSHM_TRG_SETTM_NO,TRATM_CD,EXEDT,C_D_FLAG,CDSHM_COUNTER_BOID)--,RATE,VALUATION)                      


SELECT CDSHM_DPAM_ID,                            
DPAM_SBA_NAME,                            
CDSHM_BEN_ACCT_NO,                                        
CDSHM_TRATM_DESC=REPLACE(CDSHM_TRATM_DESC,'        ',''),                                
CDSHM_TRANS_NO,                                        
CDSHM_TRAS_DT,                                        
CDSHM_ISIN, CDSHM_SETT_TYPE  ,CDSHM_SETT_NO,                                     
'0',                              
CDSHM_QTY,                            
0,                                      
CDSHM_ID,    
ISNULL(CDSHM_TRG_SETTM_NO,'')  ,CDSHM_TRATM_CD      
,CONVERT(DATETIME, CASE WHEN EXEDT <> '' THEN SUBSTRING(EXEDT,5,4)+'-'    
+SUBSTRING(EXEDT,3,2)    
+'-'+SUBSTRING(EXEDT,1,2)    
+ ' ' +     
REPLACE(    
SUBSTRING(EXEDT,9,2)    
+':'+SUBSTRING(EXEDT,11,2)+':'+SUBSTRING(EXETIME,13,2)    
, '00:00:00', '00:00:00') ELSE     
SUBSTRING(EXETIME,5,4)+'-'    
+SUBSTRING(EXETIME,3,2)    
+'-'+SUBSTRING(EXETIME,1,2)    
+ ' ' +     
REPLACE(    
SUBSTRING(EXETIME,9,2)    
+':'+SUBSTRING(EXETIME,11,2)+':'+SUBSTRING(EXETIME,13,2)    
, '00:00:00', '00:00:00') END )    
,CASE WHEN CDSHM_QTY > 0 THEN 'C' ELSE 'D' END     


,CDSHM_COUNTER_BOID
FROM #TMP_CDSL_HOLDING_DTLS WITH(NOLOCK)     
                           
,#ACLIST ACCOUNT                                          
WHERE   CDSHM_TRAS_DT >=@PA_FROMDATE AND CDSHM_TRAS_DT <=@PA_TODATE                                        
AND CDSHM_TRATM_CD IN('2246','2277','2201','3102','2270','2220','2262','2251','2202','2205','2280','2255') --'2252'  --,'4456'  '2280', -ADD 2205    
                
AND CDSHM_DPAM_ID = ACCOUNT.DPAM_ID                                
AND (CDSHM_TRAS_DT BETWEEN EFF_FROM AND EFF_TO)                            


   
DELETE FROM   #TEMPMAINCDSL    
WHERE      
TRATM_CD NOT IN ('2246','2277','3102','2201','2270','2220','2262','2251','2202','2205','2280','2255')       

AND    TRANS_DESC LIKE '%DEMAT%'    
AND    EXISTS     
(SELECT CDSHM_BEN_ACCT_NO , CDSHM_TRANS_NO, CDSHM_ISIN, CDSHM_QTY     
FROM #TMP_CDSL_HOLDING_DTLS WHERE CDSHM_BEN_ACCT_NO = DPAM_ACCTNO    
AND CDSHM_TRANS_NO = DPM_TRANS_NO AND ISIN_CD =CDSHM_ISIN AND QTY =  CDSHM_QTY    
    
AND CDSHM_TRATM_CD IN('2246','2277','3102','4456') )     



SELECT DISTINCT TRANS_DATE,EXEDT,CITRUS_USR.FN_UCC_ACCP(T.DPAM_ID,'BBO_CODE','CDSL') BOCODE, T.DPAM_SBA_NAME,CITRUS_USR.FN_UCC_ENTP(DPAM_CRN_NO,'PAN_GIR_NO','') PANNO,
DPAM_SBA_NO,CDSHM_COUNTER_BOID,CDSHM_TRG_SETTM_NO,T.ISIN_CD,I.ISIN_NAME,QTY,DPM_TRANS_NO FROM #TEMPMAINCDSL T,DP_ACCT_MSTR D,ISIN_MSTR I WHERE D.DPAM_ID=T.DPAM_ID 
AND I.ISIN_CD=T.ISIN_CD
ORDER BY TRANS_DATE,DPAM_SBA_NO,ISIN_CD

END

GO
