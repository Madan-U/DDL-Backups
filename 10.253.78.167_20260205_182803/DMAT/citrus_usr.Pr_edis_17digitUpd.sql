-- Object: PROCEDURE citrus_usr.Pr_edis_17digitUpd
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------

--EXEC PR_EDIS_17DIGITUPD 'SELECT'
--begin tran
--EXEC PR_EDIS_17DIGITUPD 'UPDATE'
--rollback -- commit
CREATE PROCEDURE [citrus_usr].[Pr_edis_17digitUpd] (@PA_ACTION VARCHAR(20))
AS
BEGIN 
IF @PA_ACTION='SELECT'
BEGIN
SELECT COUNT(*) MASTERCNT FROM DP_TRX_DTLS_CDSL WHERE LEN(DPTDC_SLIP_NO)='17'
SELECT COUNT(*) MAKERCNT FROM DPTDC_MAK WHERE LEN(DPTDC_SLIP_NO)='17'

SELECT COUNT(*) PREEDISCNT FROM EDIS_PRE_DPTDC_MAK WHERE DPTDC_TRANS_NO IN 
(SELECT DPTDC_SLIP_NO FROM DPTDC_MAK WHERE LEN(DPTDC_SLIP_NO)='17')
END

IF @PA_ACTION='UPDATE'
BEGIN
--declare @datetime datetime
--Set @datetime =  CONVERT(VARCHAR(8), GETDATE(), 108) 
--declare @lstr varchar(8000)
--Set @lstr= @lstr + 'SELECT * into DP_TRX_DTLS_CDSL_bak' + @datetime  + 'FROM DP_TRX_DTLS_CDSL WHERE LEN(DPTDC_SLIP_NO)=''17''
--@lstrSELECT COUNT(*) MAKERCNT FROM DPTDC_MAK WHERE LEN(DPTDC_SLIP_NO)=''17''

--SELECT COUNT(*) PREEDISCNT FROM EDIS_PRE_DPTDC_MAK WHERE DPTDC_TRANS_NO IN 
--(SELECT DPTDC_SLIP_NO FROM DPTDC_MAK WHERE LEN(DPTDC_SLIP_NO)='17')

UPDATE T SET DPTDC_TRANS_NO=SUBSTRING(DPTDC_TRANS_NO,2,16)  FROM EDIS_PRE_DPTDC_MAK T WHERE DPTDC_TRANS_NO IN 
(SELECT DPTDC_SLIP_NO FROM DP_TRX_DTLS_CDSL WHERE LEN(DPTDC_SLIP_NO)='17')


UPDATE T SET DPTDC_SLIP_NO=SUBSTRING(DPTDC_SLIP_NO,2,16) FROM DP_TRX_DTLS_CDSL T WHERE LEN(DPTDC_SLIP_NO)='17'
UPDATE T SET DPTDC_SLIP_NO=SUBSTRING(DPTDC_SLIP_NO,2,16) FROM  DPTDC_MAK T  WHERE LEN(DPTDC_SLIP_NO)='17'



END

END

GO
