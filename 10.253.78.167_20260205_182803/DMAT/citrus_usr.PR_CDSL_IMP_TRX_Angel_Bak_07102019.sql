-- Object: PROCEDURE citrus_usr.PR_CDSL_IMP_TRX_Angel_Bak_07102019
-- Server: 10.253.78.167 | DB: DMAT
--------------------------------------------------




--BEGIN TRAN
--PR_CDSL_IMP_TRX_ANGEL 'HO','50' ,3,'BULK','','INTERDP','1',''
--SELECT * FROM DPTDC_MAK WHERE DPTDC_slip_no='48705953'
--SELECT * FROM BITMAP_REF_MSTR 
--ROLLBACK
--SELEC 
--SELECT * FROM USED_SLIP WHERE LTRIM(RTRIM(USES_SLIP_NO)) = '5036'
--UPDATE TMP_DP_TRX_DTLS SET TMPDPTD_ACCT_ID ='12345678' , TMPDPTD_INTERNAL_REF_NO = ''
--DELETE  FROM DPTD_MAK

CREATE PROCEDURE [citrus_usr].[PR_CDSL_IMP_TRX_Angel_Bak_07102019] (  
@PA_LOGIN_NAME VARCHAR(20),  
@PA_BATCH_NO VARCHAR(100)  ,
@PA_EXCSM_ID INT,
@PA_MODE          VARCHAR(10),  																																
@PA_DB_SOURCE     VARCHAR(250),  
@PA_TRX_TAB VARCHAR(100),
@PA_TASK_ID  NUMERIC,
@PA_ERRMSG   VARCHAR(1000) OUTPUT

)  
AS 
  
BEGIN  
SET NOCOUNT ON  

DECLARE  @L_MAX_DPTDC_ID1 BIGINT 
, @L_MAX_DPTDC_ID2 BIGINT 
, @L_MAX_DPTDC_DTLS_ID1 BIGINT 
, @L_MAX_DPTDC_DTLS_ID2 BIGINT
, @L_DPM_ID BIGINT 
, @L_ERR_MSTR VARCHAR(8000)
, @L_USES_ID NUMERIC(10,0)
, @L_ERR_MISSING_ISIN VARCHAR(8000)
, @l_id_used_slip numeric

DECLARE @L_ID1 NUMERIC(10,0)
, @L_ID2 NUMERIC(10,0)

DECLARE @@SSQL VARCHAR(8000)

SELECT @L_DPM_ID = DPM_ID FROM DP_MSTR WHERE DPM_EXCSM_ID = @PA_EXCSM_ID AND DEFAULT_DP = @PA_EXCSM_ID AND DPM_DELETED_IND = 1   --
DECLARE @TRASTM VARCHAR(3)
,@CLTDPID VARCHAR(16)
,@SETTID VARCHAR(13)
,@DATE VARCHAR(13)
,@CTRDPID VARCHAR(8)
,@CTRCLIENT VARCHAR(8)



IF @PA_MODE = 'BULK'  
BEGIN
--



SELECT @TRASTM=CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,2,'~') 
,@CLTDPID=CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,4,'~')
,@SETTID=CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,5,'~')
,@DATE=CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,10,'~') 
,@CTRDPID =CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,13,'~') 
,@CTRCLIENT =CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,12,'~') 
FROM BROKER_ANGEL_RECORDS WHERE PA_VALUES LIKE '00%'


IF @TRASTM='904'
BEGIN
DELETE FROM TMP_DP_OFFM_DTLS_CDSL_POA



PRINT @DATE
PRINT @SETTID
PRINT @CLTDPID
PRINT @TRASTM
--PRINT 

SELECT IDENTITY(NUMERIC,1,1) IDI,DPAM_ID,@DATE A ,SLIPNO,CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,3,'~') B
,'' C ,@DATE D ,'1' E,CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,5,'~') F,'' G,'' H,'' I,'' J,'' K,@DATE L,
LEFT(@SETTID,6) M,RIGHT(@SETTID,7) N,'' O,'' P,@CLTDPID Q,@TRASTM R,DPAM_ID AS DTLSID ,'' S, 'BOBO' T,'' U,'' V,'X' W,
CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,4,'~') X
,'' Y,'' Z,'' Z1 INTO #TMP904
FROM BROKER_ANGEL_RECORDS,DP_ACCT_MSTR WHERE PA_VALUES LIKE '01%'
AND DPAM_SBA_NO=CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,4,'~')



INSERT INTO TMP_DP_OFFM_DTLS_CDSL_POA
SELECT * FROM #TMP904


create table #tmp_dptdc (ID1 bigint  IDENTITY( 1, 1),DPTDC_SLIP_NO varchar(20))	
insert INTO #tmp_dptdc(DPTDC_SLIP_NO)
 
select distinct TMPOFFM_SLIP_NO   FROM TMP_DP_OFFM_DTLS_CDSL_POA
--SELECT DISTINCT TMPOFFM_SLIP_NO AS DPTDC_SLIP_NO INTO #TMP_DPTDC FROM TMP_DP_OFFM_DTLS_CDSL_POA


select TMPOFFM_SLIP_NO into #tempused_off from TMP_DP_OFFM_DTLS_CDSL_POA, used_slip 
where  isnumeric(rtrim(ltrim(TMPOFFM_SLIP_NO))) = 1
and    convert(varchar,convert(numeric,rtrim(ltrim(TMPOFFM_SLIP_NO)))) =  ltrim(rtrim(USES_SLIP_NO))



if exists(select 1 from #tempused_off 

)

begin

SELECT distinct @L_ERR_MISSING_ISIN = ISNULL(@L_ERR_MISSING_ISIN,'')  +  TMPOFFM_SLIP_NO  + ',' from #tempused_off 

UPDATE filetask
SET    usermsg = 'File Could Not Be Uploaded Please Verify. ERROR : Following Slips are already used : ' + @L_ERR_MISSING_ISIN
,      status = 'FAILED'
WHERE  task_id = @pa_task_id

return 

end 

BEGIN TRANSACTION

SELECT @L_MAX_DPTDC_ID1 = BITRM_BIT_LOCATION FROM BITMAP_REF_MSTR WHERE BITRM_PARENT_CD = 'DPTDC_ID' 
SELECT @L_MAX_DPTDC_DTLS_ID1 = BITRM_BIT_LOCATION FROM BITMAP_REF_MSTR WHERE BITRM_PARENT_CD = 'DPTDC_DTLS_ID' 




SELECT @L_ID1 = COUNT (DISTINCT TMPOFFM_SLIP_NO) FROM TMP_DP_OFFM_DTLS_CDSL_POA
SELECT @L_ID2 = COUNT (*) FROM TMP_DP_OFFM_DTLS_CDSL_POA

UPDATE BITMAP_REF_MSTR SET BITRM_BIT_LOCATION =  @L_MAX_DPTDC_DTLS_ID1+@L_ID1+1  WHERE BITRM_PARENT_CD = 'DPTDC_DTLS_ID' 
UPDATE BITMAP_REF_MSTR SET BITRM_BIT_LOCATION =  @L_MAX_DPTDC_ID1+@L_ID2  WHERE BITRM_PARENT_CD = 'DPTDC_ID' 

COMMIT TRANSACTION



PRINT 'YY'

INSERT INTO DPTDC_MAK  
(DPTDC_ID
,DPTDC_DPAM_ID
,DPTDC_REQUEST_DT
,DPTDC_SLIP_NO
,DPTDC_ISIN
,DPTDC_BATCH_NO
,DPTDC_LINE_NO
,DPTDC_QTY
,DPTDC_INTERNAL_REF_NO
,DPTDC_TRANS_NO
,DPTDC_MKT_TYPE
,DPTDC_SETTLEMENT_NO
,DPTDC_EXECUTION_DT
,DPTDC_OTHER_SETTLEMENT_TYPE
,DPTDC_OTHER_SETTLEMENT_NO
,DPTDC_COUNTER_DP_ID
,DPTDC_COUNTER_CMBP_ID
,DPTDC_COUNTER_DEMAT_ACCT_NO
,DPTDC_CREATED_BY
,DPTDC_CREATED_DT
,DPTDC_LST_UPD_BY
,DPTDC_LST_UPD_DT
,DPTDC_DELETED_IND
,DPTDC_TRASTM_CD
,DPTDC_DTLS_ID
,DPTDC_BOOKING_NARRATION
,DPTDC_BOOKING_TYPE
,DPTDC_CONVERTED_QTY
,DPTDC_REASON_CD
,DPTDC_STATUS
,DPTDC_INTERNAL_TRASTM
,DPTDC_RMKS
,DPTDC_BROKERBATCH_NO
,DPTDC_BROKER_INTERNAL_REF_NO
,DPTDC_CASH_TRF
)                   
SELECT    
@L_MAX_DPTDC_ID1  + (TMPOFFM_ID),  
CONVERT(NUMERIC,TMPOFFM_ACCT_ID),  
CONVERT(DATETIME,TMPOFFM_REQUEST_DT,103),  
TMPOFFM_SLIP_NO,  
TMPOFFM_ISIN,     
TMPOFFM_BATCH_NO ,  
'RELEASE FOR CLIENT PAY OUT',--TMPOFFM_LINE_NO,  
TMPOFFM_QTY ,  
@L_MAX_DPTDC_ID1  + (TMPOFFM_ID),--TMPOFFM_INTERNAL_REF_NO,  
TMPOFFM_TRANS_NO ,  
CITRUS_USR.FN_MERGE_STR( 'SETTM_TYPE_CDSL',0,TMPOFFM_MKT_TYPE),  
TMPOFFM_SETTLEMENT_NO,  
CONVERT(DATETIME,TMPOFFM_EXECUTION_DT,103),  
CASE WHEN TMPOFFM_OTHER_SETTLEMENT_TYPE<>'' THEN CITRUS_USR.FN_MERGE_STR('SETTM_TYPE_CDSL',0,TMPOFFM_OTHER_SETTLEMENT_TYPE) ELSE CITRUS_USR.FN_MERGE_STR('SETTM_TYPE_CDSL',0,TMPOFFM_TRG_SETTLEMENT_TYPE) END ,  
CASE WHEN TMPOFFM_OTHER_SETTLEMENT_NO<>'' THEN TMPOFFM_OTHER_SETTLEMENT_NO ELSE TMPOFFM_TRG_SETTLEMENT_NO END ,  
TMPOFFM_COUNTER_DP_ID  ,  
TMPOFFM_COUNTER_CMBP_ID ,  
TMPOFFM_COUNTER_DEMAT_ACCT_NO ,  
@PA_LOGIN_NAME,  
GETDATE(),  
@PA_LOGIN_NAME,  
GETDATE() ,  
0,--CASE WHEN CASE WHEN CITRUS_USR.FN_GET_HIGH_VAL('',0,'DORMANT',TMPOFFM_ACCT_ID,CONVERT(DATETIME,TMPOFFM_REQUEST_DT,103)) = 'Y' THEN 'Y' ELSE CITRUS_USR.FN_GET_HIGH_VAL(TMPOFFM_ISIN,ABS(TMPOFFM_QTY),'HIGH_VALUE','','') END = 'Y' THEN 0 ELSE 0 END,  
--CASE WHEN (TMPOFFM_CMBP_YN = 'N' AND ISNULL(TMPOFFM_MKT_TYPE,'') = '' ) THEN 'BOBO'
--WHEN (TMPOFFM_CMBP_YN = 'Y' AND ISNULL(TMPOFFM_B_S_FLAG,'')IN ('S','B') ) THEN 'CMBO'
--WHEN (TMPOFFM_CMBP_YN = 'N' AND ISNULL(TMPOFFM_MKT_TYPE,'') <> '' ) THEN 'BOCM' 
--WHEN (TMPOFFM_CMBP_YN = 'Y' AND ISNULL(TMPOFFM_MKT_TYPE,'') <> '' ) THEN 'CMCM' END,
TMPOFFM_TRASTM_CD,
@L_MAX_DPTDC_DTLS_ID1,  
NULL, 
NULL,
NULL,
'6', --NULL, -- reason code
'P' ,  
--CASE WHEN (TMPOFFM_CMBP_YN = 'N' AND ISNULL(TMPOFFM_MKT_TYPE,'') = '' ) THEN 'BOBO'
--WHEN (TMPOFFM_CMBP_YN = 'Y' AND ISNULL(TMPOFFM_B_S_FLAG,'') IN ('S','B')) THEN 'CMBO'
--WHEN (TMPOFFM_CMBP_YN = 'N' AND ISNULL(TMPOFFM_MKT_TYPE,'') <> '' ) THEN 'BOCM' 
--WHEN (TMPOFFM_CMBP_YN = 'Y' AND ISNULL(TMPOFFM_MKT_TYPE,'') <> '' ) THEN 'CMCM' END,  
TMPOFFM_INTERNAL_TRASTM,
'',  
TMPOFFM_BROKERBATCH_NO,
TMPOFFM_BROKER_INTERNAL_REF_NO  ,
TMPOFFM_CASH_TRFX

FROM TMP_DP_OFFM_DTLS_CDSL_POA  
, #tmp_dptdc
WHERE  DPTDC_SLIP_NO =  TMPOFFM_SLIP_NO  ORDER BY TMPOFFM_ID

--SELECT * FROM TMP_DP_OFFM_DTLS_CDSL


--DECLARE @l_id_used_slip numeric
SELECT @l_id_used_slip = max(uses_id) FROM used_slip WHERE uses_deleted_ind = 1
INSERT INTO used_slip
SELECT distinct @l_id_used_slip + ID1 , '3' , TMPOFFM_BO_ID , convert(numeric,replace(rtrim(ltrim(TMPOFFM_SLIP_NO)),ltrim(rtrim(SLIIM_SERIES_TYPE)),''))
,'1',SLIIM_SERIES_TYPE,'U','HO',getdate(),'HO',getdate(),1 ,''
FROM #tmp_dptdc,TMP_DP_OFFM_DTLS_CDSL_POA , slip_issue_mstr WHERE TMPOFFM_SLIP_NO = DPTDC_SLIP_NO 
and rtrim(ltrim(TMPOFFM_SLIP_NO)) like ltrim(rtrim(SLIIM_SERIES_TYPE)) + '%' 
and isnumeric(rtrim(ltrim(TMPOFFM_SLIP_NO))) = 1
and convert(numeric,rtrim(ltrim(TMPOFFM_SLIP_NO))) between convert(numeric,SLIIM_SLIP_NO_FR) and convert(numeric,SLIIM_SLIP_NO_TO) 
UNION ALL
SELECT distinct @l_id_used_slip + ID1 , '3' , dppd_master_id , convert(numeric,replace(rtrim(ltrim(TMPOFFM_SLIP_NO)),ltrim(rtrim(SLIIM_SERIES_TYPE)),''))
,'1',SLIIM_SERIES_TYPE,'U','HO',getdate(),'HO',getdate(),1 ,''
FROM #tmp_dptdc,TMP_DP_OFFM_DTLS_CDSL_POA , slip_issue_mstr_POA ,DP_ACCT_MSTR,DP_POA_DTLS WHERE TMPOFFM_SLIP_NO = DPTDC_SLIP_NO 
and rtrim(ltrim(TMPOFFM_SLIP_NO)) like ltrim(rtrim(SLIIM_SERIES_TYPE)) + '%' 
AND DPAM_SBA_NO=TMPOFFM_BO_ID AND DPAM_ID=DPPD_DPAM_ID AND DPPD_DELETED_IND=1 AND DPAM_DELETED_IND=1 AND SLIIM_DPAM_ACCT_NO=dppd_master_id
and isnumeric(rtrim(ltrim(TMPOFFM_SLIP_NO))) = 1
and convert(numeric,rtrim(ltrim(TMPOFFM_SLIP_NO))) between convert(numeric,SLIIM_SLIP_NO_FR) and convert(numeric,SLIIM_SLIP_NO_TO) 


SELECT distinct dptdc_id INTERNAL_REF_NO, TMPOFFM_BROKER_INTERNAL_REF_NO BROKER_INTERNAL_REF_NO, TMPOFFM_BROKERBATCH_NO BROKER_BATCH_NO,ERROR = '' FROM 
TMP_DP_OFFM_DTLS_CDSL_poa,dptdc_mak where dptdc_slip_no=TMPOFFM_SLIP_NO and DPTDC_DELETED_IND in (0,-1)


END

IF @TRASTM='925'
BEGIN

SELECT
@SETTID=CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,13,'~')
FROM BROKER_ANGEL_RECORDS WHERE PA_VALUES LIKE '00%'


--INSERT INTO TMP_DP_INTDP_DTLS_CDSL
--SELECT '1',DPAM_ID,@DATE,SLIPNO,CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,3,'~') 
--,@DATE,@DATE,'1',CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,5,'~'),'','','','','',@DATE,
--LEFT(@SETTID,6),RIGHT(@SETTID,7),'','','',@TRASTM,DPAM_ID,'',@TRASTM,'','',
--CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,3,'~')
--,'','',''
--FROM BROKER_ANGEL_RECORDS,DP_ACCT_MSTR WHERE PA_VALUES LIKE '01%'
--AND DPAM_SBA_NO=CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,4,'~')


--SELECT '1' INTERNAL_REF_NO, '2' BROKER_INTERNAL_REF_NO --FROM TMP_DP_INTDP_DTLS_CDSL_POA


DELETE FROM TMP_DP_INTDP_DTLS_CDSL_POA


SELECT IDENTITY(NUMERIC,1,1) IDI,
DPAM_ID,
@DATE A ,
SLIPNO,
CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,3,'~') B,
'' C ,
@DATE D ,
'1' E,
CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,5,'~') F, -- qty
'' G,
'' H,
'' I,
'' J,
'' K,
@DATE L,
--LEFT(@SETTID,6) M
--,RIGHT(@SETTID,7) N
'' M
,'' N
,@CTRDPID O -- ctr dpid
,'' P
,@CTRCLIENT Q
,@TRASTM R
,DPAM_ID AS DTLSID 
,'' S
,'ID' T ----- TMPINTDP_INTERNAL_TRASTM
--,'' U
,'S' V
,'X' W
,
CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,4,'~') X
,'' Y
,'' Z
,'' Z1 

INTO #TMP925
FROM BROKER_ANGEL_RECORDS,DP_ACCT_MSTR WHERE PA_VALUES LIKE '01%'
AND DPAM_SBA_NO=CITRUS_USR.FN_SPLITVAL_BY(PA_VALUES,4,'~')



INSERT INTO TMP_DP_INTDP_DTLS_CDSL_POA
SELECT * FROM #TMP925


create table #tmp_dptdc925 (ID1 bigint  IDENTITY( 1, 1),DPTDC_SLIP_NO varchar(20))	
insert INTO #tmp_dptdc925(DPTDC_SLIP_NO)
 
select distinct TMPintdp_SLIP_NO   FROM TMP_DP_INTDP_DTLS_CDSL_POA
--SELECT DISTINCT TMPOFFM_SLIP_NO AS DPTDC_SLIP_NO INTO #TMP_DPTDC FROM TMP_DP_OFFM_DTLS_CDSL_POA

BEGIN TRANSACTION

SELECT @L_MAX_DPTDC_ID1 = BITRM_BIT_LOCATION FROM BITMAP_REF_MSTR WHERE BITRM_PARENT_CD = 'DPTDC_ID' 
SELECT @L_MAX_DPTDC_DTLS_ID1 = BITRM_BIT_LOCATION FROM BITMAP_REF_MSTR WHERE BITRM_PARENT_CD = 'DPTDC_DTLS_ID' 




SELECT @L_ID1 = COUNT (DISTINCT TMPintdp_SLIP_NO) FROM TMP_DP_INTDP_DTLS_CDSL_pOa
SELECT @L_ID2 = COUNT (*) FROM TMP_DP_INTDP_DTLS_CDSL_pOa

UPDATE BITMAP_REF_MSTR SET BITRM_BIT_LOCATION =  @L_MAX_DPTDC_DTLS_ID1+@L_ID1+1  WHERE BITRM_PARENT_CD = 'DPTDC_DTLS_ID' 
UPDATE BITMAP_REF_MSTR SET BITRM_BIT_LOCATION =  @L_MAX_DPTDC_ID1+@L_ID2  WHERE BITRM_PARENT_CD = 'DPTDC_ID' 

COMMIT TRANSACTION





INSERT INTO DPTDC_MAK  
(DPTDC_ID
,DPTDC_DPAM_ID
,DPTDC_REQUEST_DT
,DPTDC_SLIP_NO
,DPTDC_ISIN
,DPTDC_BATCH_NO
,DPTDC_LINE_NO
,DPTDC_QTY
,DPTDC_INTERNAL_REF_NO
,DPTDC_TRANS_NO
,DPTDC_MKT_TYPE
,DPTDC_SETTLEMENT_NO
,DPTDC_EXECUTION_DT
,DPTDC_OTHER_SETTLEMENT_TYPE
,DPTDC_OTHER_SETTLEMENT_NO
,DPTDC_COUNTER_DP_ID
,DPTDC_COUNTER_CMBP_ID
,DPTDC_COUNTER_DEMAT_ACCT_NO

,DPTDC_TRASTM_CD
,DPTDC_DTLS_ID
,DPTDC_BOOKING_NARRATION
,DPTDC_BOOKING_TYPE
,DPTDC_CONVERTED_QTY
,DPTDC_REASON_CD
,DPTDC_STATUS
,DPTDC_INTERNAL_TRASTM
,DPTDC_EXCM_ID
,DPTDC_CASH_TRF
,DPTDC_CM_ID

,DPTDC_CREATED_BY
,DPTDC_CREATED_DT
,DPTDC_LST_UPD_BY
,DPTDC_LST_UPD_DT
,DPTDC_DELETED_IND
,DPTDC_RMKS
,DPTDC_ERRMSG
,DPTDC_BROKERBATCH_NO
,DPTDC_BROKER_INTERNAL_REF_NO
,dptdc_mid_chk
,dptdc_res_cd
,dptdc_res_desc 
)                   
SELECT    
@L_MAX_DPTDC_ID1  + (TMPIntdp_ID),  
CONVERT(NUMERIC,TMPIntdp_ACCT_ID),  
CONVERT(DATETIME,TMPIntdp_REQUEST_DT,103),  
TMPIntdp_SLIP_NO,  
TMPIntdp_ISIN,     
TMPIntdp_BATCH_NO ,  
'RELEASE FOR CLIENT PAY OUT',--TMPIntdp_LINE_NO,  
TMPIntdp_QTY ,  
@L_MAX_DPTDC_ID1  + (TMPIntdp_ID),--TMPOFFM_INTERNAL_REF_NO,  
TMPIntdp_TRANS_NO ,  
CITRUS_USR.FN_MERGE_STR( 'SETTM_TYPE_CDSL',0,TMPIntdp_MKT_TYPE),  
TMPIntdp_SETTLEMENT_NO,  
CONVERT(DATETIME,TMPIntdp_EXECUTION_DT,103),  
CASE WHEN TMPIntdp_OTHER_SETTLEMENT_TYPE<>'' THEN CITRUS_USR.FN_MERGE_STR('SETTM_TYPE_CDSL',0,TMPIntdp_OTHER_SETTLEMENT_TYPE) ELSE CITRUS_USR.FN_MERGE_STR('SETTM_TYPE_CDSL',0,TMPIntdp_TRG_SETTLEMENT_TYPE) END ,  
CASE WHEN TMPIntdp_OTHER_SETTLEMENT_NO<>'' THEN TMPIntdp_OTHER_SETTLEMENT_NO ELSE TMPIntdp_TRG_SETTLEMENT_NO END ,  
TMPIntdp_COUNTER_DP_ID  ,  
TMPIntdp_COUNTER_CMBP_ID ,  
TMPIntdp_COUNTER_DEMAT_ACCT_NO ,  
TMPIntdp_TRASTM_CD,
@L_MAX_DPTDC_DTLS_ID1,
'0',
'0',
'0',
'6',
'P',
tmpintdp_INTERNAL_TRASTM,
'0' tmpintdp_EXCM_ID,
'X' tmpintdp_CASH_TRF,
'0',
@PA_LOGIN_NAME,  
GETDATE(),  
@PA_LOGIN_NAME,  
GETDATE() ,  
0,
'' dptdc_rmks,
'' DPTDC_ERRMSG,
@PA_BATCH_NO ,--'' DPTDC_BROKERBATCH_NO,
'' DPTDC_BROKER_INTERNAL_REF_NO,
'' dptdc_mid_chk,
'' dptdc_res_cd,
'' dptdc_res_desc  


FROM TMP_DP_INTDP_DTLS_CDSL_POA  
, #tmp_dptdc925
WHERE  DPTDC_SLIP_NO =  TMPIntdp_SLIP_NO  ORDER BY TMPIntdp_ID

--SELECT * FROM #tmp_dptdc925


SELECT @l_id_used_slip = max(uses_id) FROM used_slip WHERE uses_deleted_ind = 1
INSERT INTO used_slip
SELECT distinct @l_id_used_slip + ID1 , '3' , TMPintdp_BO_ID , convert(numeric,replace(rtrim(ltrim(TMPintdp_SLIP_NO)),ltrim(rtrim(SLIIM_SERIES_TYPE)),''))
,'1',SLIIM_SERIES_TYPE,'U','HO',getdate(),'HO',getdate(),1 ,''
FROM #tmp_dptdc925,TMP_DP_INTDP_DTLS_CDSL_POA , slip_issue_mstr WHERE TMPintdp_SLIP_NO = DPTDC_SLIP_NO 
and rtrim(ltrim(TMPintdp_SLIP_NO)) like ltrim(rtrim(SLIIM_SERIES_TYPE)) + '%' 
and isnumeric(rtrim(ltrim(TMPintdp_SLIP_NO))) = 1
and convert(numeric,rtrim(ltrim(TMPintdp_SLIP_NO))) between convert(numeric,SLIIM_SLIP_NO_FR) and convert(numeric,SLIIM_SLIP_NO_TO) 
UNION ALL
SELECT distinct @l_id_used_slip + ID1 , '3' , dppd_master_id , convert(numeric,replace(rtrim(ltrim(TMPintdp_SLIP_NO)),ltrim(rtrim(SLIIM_SERIES_TYPE)),''))
,'1',SLIIM_SERIES_TYPE,'U','HO',getdate(),'HO',getdate(),1 ,''
FROM #tmp_dptdc925,TMP_DP_INTDP_DTLS_CDSL_POA , slip_issue_mstr_POA ,DP_ACCT_MSTR,DP_POA_DTLS WHERE TMPintdp_SLIP_NO = DPTDC_SLIP_NO 
and rtrim(ltrim(TMPintdp_SLIP_NO)) like ltrim(rtrim(SLIIM_SERIES_TYPE)) + '%' 
AND DPAM_SBA_NO=TMPINTDP_BO_ID AND DPAM_ID=DPPD_DPAM_ID AND DPPD_DELETED_IND=1 AND DPAM_DELETED_IND=1 AND SLIIM_DPAM_ACCT_NO=dppd_master_id
and isnumeric(rtrim(ltrim(TMPintdp_SLIP_NO))) = 1
and convert(numeric,rtrim(ltrim(TMPINTDP_SLIP_NO))) between convert(numeric,SLIIM_SLIP_NO_FR) and convert(numeric,SLIIM_SLIP_NO_TO) 


SELECT distinct dptdc_id INTERNAL_REF_NO, TMPintdp_BROKER_INTERNAL_REF_NO BROKER_INTERNAL_REF_NO,
 TMPintdp_BROKERBATCH_NO BROKER_BATCH_NO,ERROR = '' FROM 
TMP_DP_INTDP_DTLS_CDSL_POA,dptdc_mak where dptdc_slip_no=TMPintdp_SLIP_NO and DPTDC_DELETED_IND in (0,-1)

END
--
END 
--
END

GO
